using COSMO,
    CSV,
    Clarabel,
    HiGHS,
    LinearAlgebra,
    OrderedCollections,
    PortfolioOptimiser,
    Statistics,
    Test,
    TimeSeries

prices = TimeArray(CSV.File("./assets/stock_prices.csv"); timestamp = :date)

rf = 1.0329^(1 / 252) - 1
l = 2.0

@testset "$(:HRP), $(:HERC), $(:NCO), $(:SD)" begin
    portfolio = HCPortfolio(
        prices = prices,
        solvers = OrderedDict(
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
        ),
    )
    asset_statistics!(portfolio)

    w1 = opt_port!(portfolio; type = :HRP, rm = :SD, rf = rf, l = l, linkage = :DBHT)
    w2 = opt_port!(portfolio; type = :HERC, rm = :SD, rf = rf, l = l, linkage = :DBHT)
    w3 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Min_Risk,
        rf = rf,
        l = l,
        cluster = false,
    )
    w4 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Utility,
        rf = rf,
        l = l,
        cluster = false,
    )
    w5 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Sharpe,
        rf = rf,
        l = l,
        cluster = false,
    )
    w6 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Max_Ret,
        rf = rf,
        l = l,
        cluster = false,
    )
    w7 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Equal,
        rf = rf,
        l = l,
        cluster = false,
    )
    w8 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Min_Risk,
        obj_o = :Sharpe,
        rf = rf,
        l = l,
        cluster = false,
    )
    w9 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Sharpe,
        obj_o = :Min_Risk,
        rf = rf,
        l = l,
        cluster = false,
    )
    w10 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Equal,
        obj_o = :Sharpe,
        rf = rf,
        l = l,
        cluster = false,
    )
    w11 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SD,
        obj = :Sharpe,
        obj_o = :Equal,
        rf = rf,
        l = l,
        cluster = false,
    )

    w1t = [
        0.03692879524929352,
        0.06173471900996101,
        0.05788485449055379,
        0.02673494374797732,
        0.051021461747188426,
        0.06928891082994745,
        0.024148698656475776,
        0.047867702815293824,
        0.03125471206249845,
        0.0647453556976089,
        0.10088112288028349,
        0.038950479132407664,
        0.025466032983548218,
        0.046088041928035575,
        0.017522279227008376,
        0.04994166864441962,
        0.076922254387969,
        0.05541444481863126,
        0.03819947378487138,
        0.07900404790602693,
    ]

    w2t = [
        0.04414470568410749,
        0.09179295067888649,
        0.03988345772432875,
        0.03195896901776689,
        0.03515448610066942,
        0.04581729858991488,
        0.032884067201388985,
        0.050021575151391134,
        0.03689357244197575,
        0.08760528183690483,
        0.059737295315921264,
        0.023064734096888414,
        0.030993923115529922,
        0.05116016324833899,
        0.01945065635759669,
        0.06078246420345067,
        0.10474753188814133,
        0.05790789306651554,
        0.045091282572348464,
        0.050907691707934126,
    ]

    w3t = [
        0.025110084676904985,
        0.0024072043691457027,
        0.022131010847542314,
        0.024287124319864878,
        0.011436259658313023,
        0.06564901809923375,
        2.63164426952892e-5,
        0.13509808681926533,
        7.488940413328548e-6,
        7.323985175041516e-5,
        0.2420077978406655,
        0.006175255683734641,
        2.081662938420102e-6,
        0.11544046014733363,
        5.277576340805123e-7,
        2.542942782872028e-5,
        0.004098561315789697,
        0.19633523242335496,
        0.041554271004415,
        0.10813454871117643,
    ]

    w4t = [
        7.766245844537851e-9,
        0.0007499306762073744,
        4.521156798112541e-8,
        5.041455975571854e-8,
        0.8059997861132897,
        2.7911723268365223e-19,
        0.030168550042525746,
        1.1371070006277296e-8,
        6.886320880414425e-16,
        5.00443088921232e-8,
        1.51378253271611e-15,
        1.8839581457880405e-19,
        2.1654220382372163e-16,
        6.150855869911519e-17,
        2.196410145913958e-17,
        7.066817209213057e-8,
        0.16308142043655438,
        1.3379231760651016e-8,
        4.668474244005647e-8,
        1.7191521558665625e-8,
    ]

    w5t = [
        2.8827999879674876e-10,
        0.03273675534922566,
        0.03166387699337444,
        0.023020837616192273,
        0.46917330788347095,
        1.7899184506262896e-11,
        0.02979193004065076,
        3.955332220592653e-9,
        2.70373025377355e-10,
        0.028622875545023355,
        5.506596966175203e-10,
        1.983395086106402e-11,
        5.3886532079228104e-11,
        4.173716737941434e-11,
        1.0187054289168763e-11,
        0.11114834385497208,
        0.2136479220104585,
        0.003039004633947739,
        0.05715512195801641,
        1.8906478971120764e-8,
    ]

    w6t = [
        3.5470437040666906e-14,
        1.488158342101384e-7,
        5.119559450781639e-14,
        4.44103404384708e-14,
        1.5080369724560962e-6,
        9.215797090311397e-16,
        0.9999980306220989,
        2.5081869081132618e-14,
        1.0945240779015975e-13,
        1.1011912550096345e-14,
        2.104342763173577e-15,
        9.605642353231626e-16,
        1.7440131500154973e-15,
        1.404582295421992e-15,
        6.154293965257424e-16,
        5.700592750757033e-8,
        2.1304134377873232e-7,
        2.6490033873279397e-14,
        4.2477479461105805e-8,
        3.295643720342401e-14,
    ]

    w7t = [
        0.036868517647378266,
        0.08857050773217715,
        0.03550282387737573,
        0.03365142028202789,
        0.03241016006814263,
        0.04372860546359345,
        0.035016342750398624,
        0.0589104349212394,
        0.03280516637754979,
        0.09590014180820772,
        0.06533183037607224,
        0.02703407226272167,
        0.03467055356530615,
        0.04660549160799435,
        0.022776594296513932,
        0.06581413753388214,
        0.09949899087728453,
        0.0602676675157174,
        0.037338533903805926,
        0.04729800713261096,
    ]

    w8t = [
        0.0010408874013922965,
        0.3566484161420694,
        0.0009173959653139009,
        0.001006773256477595,
        0.0004740668440810784,
        2.2963059738495353e-11,
        0.0038990115363986898,
        0.005600215942390388,
        2.6195210692923182e-15,
        0.007672333725607141,
        8.46507637112972e-11,
        2.1600134971057037e-12,
        0.00021806724598806248,
        4.037937290388133e-11,
        1.8460184827926966e-16,
        0.0026638920217650144,
        0.607237765298803,
        0.008138677049817413,
        1.4535072040554169e-11,
        0.004482497405205028,
    ]

    w9t = [
        9.207376078686123e-11,
        0.04506682138768791,
        0.010113126987793776,
        0.0073526262822031395,
        0.1498492822878779,
        9.706876493066787e-11,
        0.04101284857383581,
        1.2632937221849326e-9,
        1.46625538357711e-9,
        0.028989349803876133,
        2.9862732924539796e-9,
        1.0756116364437701e-10,
        5.4576470687067085e-11,
        2.2634412689621362e-10,
        5.524524191508721e-11,
        0.11257143661421957,
        0.29411689211049913,
        0.0009706278162348274,
        0.30995697574853875,
        6.038541103700144e-9,
    ]

    w10t = [
        0.05770020263571035,
        0.20756802321347473,
        0.05556285586139335,
        0.05266536039835973,
        0.05072275542167395,
        2.7203689990215912e-11,
        0.08206200044425406,
        0.09219638459088021,
        2.040818742677057e-11,
        3.4872431520210023e-10,
        4.0643117730422845e-11,
        1.6817973342883288e-11,
        1.2607348458273443e-10,
        2.899340905350932e-11,
        1.4169384175563139e-11,
        2.393217529127325e-10,
        0.2331792983572393,
        0.09432048940231248,
        2.3228408275081374e-11,
        0.07402262878911796,
    ]

    w11t = [
        1.2955071122615352e-10,
        0.03248044664206342,
        0.014229491472841513,
        0.010345379140584112,
        0.21084270840269012,
        8.420568170415045e-11,
        0.029558677508714423,
        1.7774944652846946e-9,
        1.2719543121278865e-9,
        0.04511783699736455,
        2.5905467997413312e-9,
        9.330767848994134e-11,
        8.494058421487245e-11,
        1.9635009798094963e-10,
        4.792440966662475e-11,
        0.17520157444305318,
        0.21197518987514943,
        0.0013657042229457167,
        0.26888297652189935,
        8.49641948006916e-9,
    ]

    @test isapprox(w1.weights, w1t)
    @test isapprox(w2.weights, w2t)
    @test isapprox(w3.weights, w3t)
    @test isapprox(w4.weights, w4t)
    @test isapprox(w5.weights, w5t)
    @test isapprox(w6.weights, w6t)
    @test isapprox(w7.weights, w7t)
    @test isapprox(w8.weights, w8t)
    @test isapprox(w9.weights, w9t)
    @test isapprox(w10.weights, w10t)
    @test isapprox(w11.weights, w11t)
end

@testset "$(:HRP), $(:HERC), $(:NCO), $(:SSD)" begin
    portfolio = HCPortfolio(
        prices = prices,
        solvers = OrderedDict(
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
        ),
    )
    asset_statistics!(portfolio)

    w1 = opt_port!(portfolio; type = :HRP, rm = :SSD, rf = rf, l = l, linkage = :DBHT)
    w2 = opt_port!(portfolio; type = :HERC, rm = :SSD, rf = rf, l = l, linkage = :DBHT)
    w3 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Min_Risk,
        rf = rf,
        l = l,
        cluster = false,
    )
    w4 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Utility,
        rf = rf,
        l = l,
        cluster = false,
    )
    w5 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Sharpe,
        rf = rf,
        l = l,
        cluster = false,
    )
    w6 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Max_Ret,
        rf = rf,
        l = l,
        cluster = false,
    )
    w7 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Equal,
        rf = rf,
        l = l,
        cluster = false,
    )
    w8 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Min_Risk,
        obj_o = :Sharpe,
        rf = rf,
        l = l,
        cluster = false,
    )
    w9 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Sharpe,
        obj_o = :Min_Risk,
        rf = rf,
        l = l,
        cluster = false,
    )
    w10 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Equal,
        obj_o = :Sharpe,
        rf = rf,
        l = l,
        cluster = false,
    )
    w11 = opt_port!(
        portfolio;
        type = :NCO,
        rm = :SSD,
        obj = :Sharpe,
        obj_o = :Equal,
        rf = rf,
        l = l,
        cluster = false,
    )

    w1t = [
        0.03685118468964678,
        0.060679678711961914,
        0.05670047906355952,
        0.026116775736648376,
        0.05374470957245603,
        0.07054365460247647,
        0.025708179197816795,
        0.04589886455582043,
        0.03028786387008358,
        0.0634613352386214,
        0.10260291820653494,
        0.038697426540672014,
        0.027823289120792207,
        0.04746469792344547,
        0.01859405658396672,
        0.052617311519562025,
        0.07250127037171229,
        0.05655029966386585,
        0.03752315313496762,
        0.07563285169538961,
    ]

    w2t = [
        0.04458318301190374,
        0.08923261844696723,
        0.0386901731987397,
        0.03159651452603008,
        0.036673272540490374,
        0.046431350386991595,
        0.03571458733541658,
        0.04710646865985023,
        0.037030915268657386,
        0.08746809871032526,
        0.06001952275591192,
        0.022636793508911755,
        0.03398552513326154,
        0.052297035105064366,
        0.020487100360053728,
        0.06427086874342236,
        0.10072097804729256,
        0.05803814418069801,
        0.0458770123345119,
        0.04713983774549962,
    ]

    w3t = [
        0.018187443289737027,
        0.00044753319482864043,
        6.049805177405795e-9,
        0.019592871512766584,
        0.0178723742061117,
        0.062187542526660186,
        4.161951729707088e-13,
        0.12115687510539876,
        1.6611119269554933e-9,
        1.2715247783761365e-9,
        0.255724554118471,
        0.01005878702480125,
        3.4200535177968427e-11,
        0.1280358467816251,
        5.293387215900223e-10,
        4.924929542819093e-10,
        0.0007744876146257587,
        0.22935679935384753,
        0.03671943535904271,
        0.09988543987319361,
    ]

    w4t = [
        0.011815073118454212,
        0.010780179150189908,
        6.30750020542261e-9,
        0.020027927841892904,
        0.03729094057380963,
        0.03297647882124728,
        1.126343827098314e-11,
        0.12201587639766563,
        5.970704144934237e-10,
        5.386850811241261e-10,
        0.24170004552003954,
        0.0074566970240480274,
        2.9765884574429157e-12,
        0.10598635914181115,
        1.0982477527482656e-10,
        2.2594233563162794e-10,
        0.019647153193340476,
        0.22911368724636835,
        0.06094459068414003,
        0.10024498349372997,
    ]

    w5t = [
        1.3113648513898847e-9,
        0.01219354254601431,
        5.251429373618801e-9,
        2.530543516012152e-9,
        0.6589435966421197,
        1.0246367530996652e-11,
        0.018754424451295545,
        4.199834668620207e-9,
        2.7800232537404553e-10,
        0.019117714777968565,
        2.4403236918197824e-10,
        1.0930848123322397e-11,
        1.1300536852316676e-11,
        2.639376581697133e-11,
        4.005323771265213e-12,
        0.1519585412769984,
        0.11938083350604307,
        1.0819595675333878e-8,
        0.019651317335923686,
        4.765957081281191e-9,
    ]

    w6t = [
        8.191863340708682e-12,
        9.211591204018666e-7,
        1.2626012115872571e-11,
        1.0915767009084885e-11,
        4.450729454855096e-5,
        1.6702195024225544e-13,
        0.9999505430491591,
        5.463121371861769e-12,
        2.0302991811258166e-11,
        2.2409245620376714e-12,
        4.295640077655596e-13,
        1.8430659547832975e-13,
        3.8089532971577737e-13,
        2.6765280659944193e-13,
        1.1695095842702918e-13,
        1.5578279433378499e-6,
        1.3373821711886017e-6,
        5.799461049486718e-12,
        1.133212413754835e-6,
        7.557214320949884e-12,
    ]

    w7t = [
        0.03754844098300919,
        0.08680041787053981,
        0.03389183000114803,
        0.03277213059086383,
        0.03320752877178498,
        0.04331700156529129,
        0.037633843557708824,
        0.05764895433246242,
        0.03208049588246182,
        0.0939356459430743,
        0.06696242782914329,
        0.02713647380528876,
        0.0380939037248661,
        0.04717402044229326,
        0.024240034460649925,
        0.0688395222010592,
        0.09548573951989676,
        0.06001050286483363,
        0.03771243943429284,
        0.04550864621933167,
    ]

    w8t = [
        0.001098555251985528,
        0.3506906289283113,
        3.654194350053954e-10,
        0.0011834457190567865,
        0.0010795244959281231,
        1.0338148716144361e-10,
        3.2613390169171995e-10,
        0.0073180995998649205,
        2.761456947372526e-18,
        0.008377856387202816,
        4.251202674093581e-10,
        1.6721875787556288e-11,
        0.00022534139873579267,
        2.1284867856909692e-10,
        8.799804916982116e-19,
        0.0032449507181074636,
        0.6068947550902725,
        0.013853575375871495,
        6.104293047950748e-11,
        0.00603326552399483,
    ]

    w9t = [
        3.0909578666815647e-10,
        0.028304414662088006,
        1.2377903004267514e-9,
        5.964627906190747e-10,
        0.15531656896108528,
        1.7300444637227477e-10,
        0.04353394466087989,
        9.89923741968133e-10,
        4.6939208696199814e-9,
        0.01831898713435886,
        4.1203562920737975e-9,
        1.8456153580613036e-10,
        1.082840661727534e-11,
        4.4564464714261946e-10,
        6.762775388382429e-11,
        0.14560979672200497,
        0.27711426777817116,
        2.550237207558349e-9,
        0.3318020035785962,
        1.123361855935011e-9,
    ]

    w10t = [
        0.056331156322712087,
        0.2167050029967595,
        0.05084541258907015,
        0.04916561015616197,
        0.04981880593074,
        1.122131530348982e-10,
        0.09395625483181962,
        0.08648647382756333,
        8.310486561421124e-11,
        8.007799352526373e-10,
        1.7346688113336067e-10,
        7.029732386602455e-11,
        3.2474183204962084e-10,
        1.2220480143768866e-10,
        6.279406695323108e-11,
        5.868412100385516e-10,
        0.2383886849446839,
        0.09002933089587331,
        9.769447525542677e-11,
        0.06827326507047765,
    ]

    w11t = [
        4.758967098460148e-10,
        0.02161483911959314,
        1.90575335174275e-9,
        9.18338883428181e-10,
        0.2391318398413062,
        1.4017035850748457e-10,
        0.033244962714122916,
        1.524127704486835e-9,
        3.80307318624984e-9,
        0.02520605599426584,
        3.3383640175106555e-9,
        1.4953405639627022e-10,
        1.4899373066963704e-11,
        3.6106684693239817e-10,
        5.4792849003161377e-11,
        0.20035216262610134,
        0.21162000300228642,
        3.926451115643559e-9,
        0.268830118360281,
        1.7295745664108087e-9,
    ]

    @test isapprox(w1.weights, w1t)
    @test isapprox(w2.weights, w2t)
    @test isapprox(w3.weights, w3t)
    @test isapprox(w4.weights, w4t)
    @test isapprox(w5.weights, w5t)
    @test isapprox(w6.weights, w6t)
    @test isapprox(w7.weights, w7t)
    @test isapprox(w8.weights, w8t)
    @test isapprox(w9.weights, w9t)
    @test isapprox(w10.weights, w10t)
    @test isapprox(w11.weights, w11t)
end