using CSV, TimeSeries, DataFrames, StatsBase, Statistics, LinearAlgebra, Test, Clarabel,
      PortfolioOptimiser

prices = TimeArray(CSV.File("./assets/stock_prices.csv"); timestamp = :date)
rf = 1.0329^(1 / 252) - 1
l = 2.0

@testset "HRP" begin
    portfolio = HCPortfolio2(; prices = prices,
                             solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
                                                              :params => Dict("verbose" => false,
                                                                              "max_step_fraction" => 0.75))))

    asset_statistics2!(portfolio)
    hclust_alg = DBHT()
    hclust_opt = HClustOpt()
    type = HRP2()
    w1 = optimise2!(portfolio; rm = SD2(), cluster = true, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03692879524929352, 0.06173471900996101, 0.05788485449055379,
          0.02673494374797732, 0.051021461747188426, 0.06928891082994745,
          0.024148698656475776, 0.047867702815293824, 0.03125471206249845,
          0.0647453556976089, 0.10088112288028349, 0.038950479132407664,
          0.025466032983548218, 0.046088041928035575, 0.017522279227008376,
          0.04994166864441962, 0.076922254387969, 0.05541444481863126, 0.03819947378487138,
          0.07900404790602693]
    @test isapprox(w1.weights, wt)

    w2 = optimise2!(portfolio; rm = MAD2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03818384697661099, 0.0622147651480733, 0.06006655971419491,
          0.025623934919921716, 0.05562388497425944, 0.0707725175955155,
          0.025813212789699617, 0.0505495225915194, 0.030626076629624386,
          0.06238080360591265, 0.09374966122500297, 0.04170897361395994, 0.0238168503353984,
          0.04472819614772452, 0.016127737407569318, 0.05166088174144377,
          0.07470415476814536, 0.05398093542616027, 0.03829328495650196, 0.0793741994327616]
    @test isapprox(w2.weights, wt)

    w3 = optimise2!(portfolio; rm = SSD2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03685118468964678, 0.060679678711961914, 0.05670047906355952,
          0.026116775736648376, 0.05374470957245603, 0.07054365460247647,
          0.025708179197816795, 0.04589886455582043, 0.03028786387008358,
          0.0634613352386214, 0.10260291820653494, 0.038697426540672014,
          0.027823289120792207, 0.04746469792344547, 0.01859405658396672,
          0.052617311519562025, 0.07250127037171229, 0.05655029966386585,
          0.03752315313496762, 0.07563285169538961]
    @test isapprox(w3.weights, wt)

    w4 = optimise2!(portfolio; rm = FLPM2(; target = rf), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.039336538617540336, 0.06395492117890568, 0.06276820986537449,
          0.026249574972701337, 0.06242254734451266, 0.06144221460126541,
          0.026935168312631458, 0.05003386507226852, 0.031591718694359686,
          0.062032838812258684, 0.08971950983943798, 0.03794006123084816,
          0.021868414535268534, 0.04077527283143069, 0.014126622482894119,
          0.053377350594462684, 0.07977242881987609, 0.05414859107042937,
          0.04026174326124142, 0.0812424078622927]
    @test isapprox(w4.weights, wt)

    w5 = optimise2!(portfolio; rm = SLPM2(; target = rf), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03752644591926642, 0.06162667128035028, 0.058061904976983145,
          0.02658920517037755, 0.056905956197316004, 0.06572780540966205,
          0.026284445157011994, 0.04570757302464124, 0.030832527351205462,
          0.06360209500884424, 0.10038131818271241, 0.03703703080055575,
          0.02666888092950761, 0.04516285946254531, 0.01726932945234202,
          0.053613204742961086, 0.07517335594118413, 0.05681780552493213,
          0.03852165318888371, 0.07648993227871743]
    @test isapprox(w5.weights, wt)

    w6 = optimise2!(portfolio; rm = WR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05025200880802368, 0.055880855583038826, 0.05675550980104009,
          0.03045034754117226, 0.046067750416348405, 0.054698528388037695,
          0.02387947919504387, 0.03257444044988314, 0.02852023603441257,
          0.06948149861799151, 0.10142635777300404, 0.02403801691456373, 0.0376186609725536,
          0.0489137277286356, 0.023542345142850748, 0.05182849839922806,
          0.12037415047550741, 0.06259799738419287, 0.03040731610608419,
          0.050692274268387696]
    @test isapprox(w6.weights, wt)

    w7 = optimise2!(portfolio; rm = CVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03557588495882196, 0.06070721124578364, 0.055279033097091264,
          0.02659326453716366, 0.053554687039556674, 0.06617470037072191,
          0.0262740407048504, 0.04720203604560211, 0.02912774720142737, 0.06321093829691052,
          0.10241165286325946, 0.03903551330484258, 0.029865777325086773,
          0.04683826432227621, 0.01880807994439806, 0.05468860348477102,
          0.07181506647247264, 0.0597967463434774, 0.035892100831017446,
          0.07714865161046885]
    @test isapprox(w7.weights, wt)

    w8 = optimise2!(portfolio; rm = EVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.04298217683837017, 0.058906176713889875, 0.0574016331486885,
          0.03020450525284909, 0.0498349903258857, 0.060682817777209165,
          0.024220257509343413, 0.03449220187183893, 0.028790726943045256,
          0.06651915441075427, 0.1102093216711328, 0.026320946186565213, 0.0350510342557288,
          0.04934072008028962, 0.021946092606624574, 0.05048203603428413,
          0.09622970122852144, 0.06481150812979522, 0.03384174474956397,
          0.057732254265619835]
    @test isapprox(w8.weights, wt, rtol = 5.0e-7)

    w9 = optimise2!(portfolio; rm = RVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.04746219128450875, 0.05772052034931984, 0.057894023300070915,
          0.030899831490444826, 0.047780697436069414, 0.056496204023026735,
          0.02359615954618457, 0.032640369565769795, 0.028784216596900798,
          0.06836029362987105, 0.10450059856679983, 0.02457130647918195,
          0.03686881087305981, 0.048996934209302734, 0.0227965377657541,
          0.05134221596812637, 0.11116746180000622, 0.06399587050591148,
          0.031665735616057476, 0.052460020993633505]
    @test isapprox(w9.weights, wt, rtol = 1.0e-7)

    w10 = optimise2!(portfolio; rm = MDD2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06921730086136976, 0.04450738292959614, 0.08140658224086754,
          0.018672719501981218, 0.053316921973365496, 0.02979463558079051,
          0.021114260172381653, 0.029076952717003283, 0.026064071405076886,
          0.07316497416971823, 0.11123520904148268, 0.018576814647316645,
          0.013991436918012332, 0.05469682002741476, 0.012327710930761682,
          0.08330184420498327, 0.07332958900751246, 0.060105980885656114,
          0.049926342635393445, 0.07617245014931591]
    @test isapprox(w10.weights, wt)

    w11 = optimise2!(portfolio; rm = ADD2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05548273429645013, 0.03986073873648723, 0.09599318831154405,
          0.014621119350699974, 0.08212398553813219, 0.024721555415213262,
          0.017757328803291575, 0.024648542319161523, 0.04053046304894661,
          0.06980177121920025, 0.07760681699761883, 0.01027851528431043,
          0.00777588366272761, 0.021591614519396285, 0.0034064806929941845,
          0.06991915064946408, 0.12960468534402678, 0.062161540752826025,
          0.08184195485513887, 0.07027193020237012]
    @test isapprox(w11.weights, wt)

    w12 = optimise2!(portfolio; rm = CDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06282520890507177, 0.03706824571002148, 0.08139181669684024,
          0.015787409071561908, 0.05742532060680956, 0.022473205432788673,
          0.018010510386343107, 0.028690055814249292, 0.031947471924376705,
          0.07945270069786842, 0.10413378630449394, 0.015162575734861551,
          0.011642750066910313, 0.04691738037936903, 0.008558622422573802,
          0.08506702725550051, 0.07867872568683776, 0.06853164241553955,
          0.06271444623431467, 0.08352109825366769]
    @test isapprox(w12.weights, wt)

    w13 = optimise2!(portfolio; rm = UCI2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.056222127504695026, 0.03676156065449049, 0.09101083070457834,
          0.014331694009042086, 0.06981598298437515, 0.02449761185808867,
          0.017540488246254482, 0.025783651111609372, 0.03897771757340407,
          0.07792753098849892, 0.09069642716675666, 0.011419250355786286,
          0.009579825814905836, 0.03155851948684042, 0.005020862393829734,
          0.07891456352044066, 0.10481408027151863, 0.06296146942913426, 0.0767246147903293,
          0.0754411911354216]
    @test isapprox(w13.weights, wt)

    w14 = optimise2!(portfolio; rm = EDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06368313885096026, 0.03964177645523946, 0.08253885356726247,
          0.01658630133298382, 0.055878822739450135, 0.025248628049312456,
          0.019039909877211127, 0.028999411295580237, 0.030719786342128182,
          0.07837842859043447, 0.10479226890649017, 0.01598505374262056,
          0.012462054946453145, 0.0503667610779172, 0.009778781140263914,
          0.08402144368015278, 0.07578137459372361, 0.0651773824278426, 0.05986313372528741,
          0.0810566886586861]
    @test isapprox(w14.weights, wt, rtol = 1.0e-7)

    w15 = optimise2!(portfolio; rm = RDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06626057100148959, 0.042384460290778865, 0.08229559342069401,
          0.017571400016583083, 0.054533052228267126, 0.02751643858660513,
          0.02021038180000024, 0.02882973184000429, 0.028405177937391907,
          0.0760417757563507, 0.10819526671824652, 0.01714761122061998,
          0.013186013461541538, 0.05250570179214284, 0.01096704678455384,
          0.08422872826614602, 0.07476238567443566, 0.0621153409498924,
          0.054747390549717716, 0.07809593170453868]
    @test isapprox(w15.weights, wt)

    w16 = optimise2!(portfolio; rm = Kurt2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.029481521953684118, 0.05982735944410474, 0.03557911826015237,
          0.028474368121041888, 0.025828635808911045, 0.05929340372085539,
          0.00400811258716055, 0.04856579375773367, 0.028712479333209244,
          0.0657391879397804, 0.16216057544981644, 0.011489226379288793,
          0.009094526296241098, 0.08053893478316498, 0.012724404070883372,
          0.021335119185650623, 0.0855020913192837, 0.11267092582579596,
          0.03851809818436267, 0.08045611757887891]
    @test isapprox(w16.weights, wt)

    w17 = optimise2!(portfolio; rm = SKurt2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.041695764288341326, 0.04968730030116381, 0.04519046227953908,
          0.02228610752801017, 0.036916599549008534, 0.06695518729855642,
          0.008601057788011419, 0.03832875671733724, 0.023603809923922775,
          0.05953659154802947, 0.15949334007294313, 0.010345061127586078,
          0.01551106764201746, 0.07844578132980796, 0.01457102407508962,
          0.034738374409788796, 0.09106192787421133, 0.1097918256490279, 0.0352173258407637,
          0.058022634756843806]
    @test isapprox(w17.weights, wt)

    w18 = optimise2!(portfolio; rm = Skew2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [4.18164303203965e-6, 0.11905148244884775, 0.13754035964680367,
          4.18164303203965e-6, 0.13754035964680367, 1.658199358060021e-6,
          0.028721218707620826, 1.1383557170375464e-10, 8.355416012626526e-16,
          1.8128635217880256e-6, 0.08532736996421339, 0.007291462719384035,
          0.10926054871992093, 0.00021830908182616843, 0.2370505968817962,
          0.10926054871992093, 0.028721218707620826, 3.684313367457248e-6,
          4.824826616435831e-11, 1.0059308456231142e-6]
    @test isapprox(w18.weights, wt, rtol = 5.0e-5)

    w19 = optimise2!(portfolio; rm = SSkew2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03073561997154973, 0.06271788007944147, 0.059839304178611136,
          0.019020703463231065, 0.054114343500047124, 0.07478195087196789,
          0.015025906923294915, 0.037423537539572865, 0.02195663364580543,
          0.07120487867873436, 0.14238956696393482, 0.022992175030255378,
          0.02427916555268004, 0.040541588877064376, 0.010704183865328891,
          0.053000134123666075, 0.07802885174200914, 0.06680453879901624,
          0.030056876315924044, 0.08438215987786517]
    @test isapprox(w19.weights, wt)

    hclust_alg = HAClustering()
    w20 = optimise2!(portfolio; rm = DVar2(), cluster = true, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.034616203287809656, 0.05339682894540566, 0.0277781553250953,
          0.04211296639608739, 0.05429852976387857, 0.07556907274344477,
          0.012918417022839884, 0.0639503232740957, 0.025141332254925024,
          0.05293567401349993, 0.12067634196508455, 0.0237681969964296,
          0.008823211105214881, 0.08942720087787832, 0.016861747398793574,
          0.03288067246055758, 0.07170919770494971, 0.0812323656620027, 0.03793954600227262,
          0.07396401679973474]
    @test isapprox(w20.weights, wt)

    w21 = optimise2!(portfolio; rm = Variance2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03360421525593201, 0.053460257098811775, 0.027429766590708997,
          0.04363053745921338, 0.05279180956461212, 0.07434468966041922,
          0.012386194792256387, 0.06206960160806503, 0.025502890164538234,
          0.0542097204834031, 0.12168116639250848, 0.023275086688903004,
          0.009124639465879256, 0.08924750757276853, 0.017850423121104797,
          0.032541204698588386, 0.07175228284814082, 0.08318399209117079,
          0.03809545426566615, 0.07381856017730955]
    @test isapprox(w21.weights, wt)

    w22 = optimise2!(portfolio; rm = Equal2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05, 0.05000000000000001, 0.05, 0.04999999999999999, 0.04999999999999999,
          0.05000000000000001, 0.05000000000000001, 0.05, 0.05, 0.05000000000000001,
          0.04999999999999999, 0.04999999999999999, 0.05, 0.04999999999999999, 0.05,
          0.04999999999999999, 0.04999999999999999, 0.05, 0.05, 0.04999999999999999]
    @test isapprox(w22.weights, wt)

    w23 = optimise2!(portfolio; rm = VaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03403717939776512, 0.05917176810341441, 0.029281627698577888,
          0.04641795773733506, 0.06002080678226616, 0.07336909341225178,
          0.032392046758139795, 0.05383361136188931, 0.02967264551919885,
          0.05284095110693102, 0.09521120378350553, 0.04261320776949539,
          0.01642971834566978, 0.07971670573840162, 0.021147864266696195,
          0.050803448662520866, 0.06563107532995796, 0.05200824347813839,
          0.034112945793535646, 0.07128789895430926]
    @test isapprox(w23.weights, wt)

    w24 = optimise2!(portfolio; rm = DaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.057660532702867646, 0.04125282312548106, 0.05922785740065619,
          0.03223509018499126, 0.10384639449297382, 0.02480551517770064,
          0.030513023620218654, 0.037564939241009405, 0.02260728843785307,
          0.05164502511939685, 0.08286147806113833, 0.01696931547695469,
          0.00418787314771699, 0.06308172456210165, 0.007685315296496237,
          0.0694006227527249, 0.09119842783020647, 0.09248808273195344,
          0.044542968010494795, 0.06622570262706394]
    @test isapprox(w24.weights, wt)

    w25 = optimise2!(portfolio; rm = DaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05820921825149978, 0.04281381004716568, 0.061012991673039425,
          0.037261284520695284, 0.10225280827507012, 0.03171774621579708,
          0.029035913030571646, 0.03777811595747374, 0.021478656618637317,
          0.05210098246314737, 0.08336111731195082, 0.0224554330786605,
          0.008018398540074134, 0.060923985355596684, 0.009489132849269694,
          0.06345531419794387, 0.0883323204747975, 0.08122137323769983,
          0.039962166984027804, 0.06911923091688174]
    @test isapprox(w25.weights, wt)

    w26 = optimise2!(portfolio; rm = MDD_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.054750291482807016, 0.05626561538767235, 0.044927537922610235,
          0.037029800949262545, 0.06286000734501392, 0.038964408950160866,
          0.033959752237812064, 0.04828571977339982, 0.01937785058895953,
          0.05279062837229332, 0.10144994531515807, 0.02678668518638289,
          0.010335110450233378, 0.07434568383344507, 0.01192345099055306,
          0.05711412672965212, 0.06785463405921893, 0.09152771438398988,
          0.032677346602089874, 0.07677368943928506]
    @test isapprox(w26.weights, wt)

    w27 = optimise2!(portfolio; rm = ADD_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05216718533133331, 0.04708278318245931, 0.07158823871210457,
          0.029511984859220904, 0.12867669205129983, 0.03859596234440916,
          0.022402839001206605, 0.026020360199894607, 0.030904469636691148,
          0.054239105004183275, 0.07390114503735276, 0.019880342325388017,
          0.00476824739544596, 0.03991945523395664, 0.0054480039590591904,
          0.059645486519252305, 0.11611402694084015, 0.06374794181935534,
          0.059893035563107475, 0.055492694883439435]
    @test isapprox(w27.weights, wt)

    w28 = optimise2!(portfolio; rm = CDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.055226953695215866, 0.047934679854074826, 0.05395157314076186,
          0.036982877818185954, 0.08463665680704126, 0.033820937721103415,
          0.03026563101495272, 0.04118023926554901, 0.02122427296619385,
          0.05288666614109493, 0.09090289747478623, 0.02380032651263032,
          0.008673469487824291, 0.06662055705080387, 0.010138402407857017,
          0.060505269563432176, 0.08319151689594376, 0.08557053458440436,
          0.038056791259321536, 0.07442974633882277]
    @test isapprox(w28.weights, wt)

    w29 = optimise2!(portfolio; rm = UCI_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05276898612268049, 0.04614128625526376, 0.06552577565455027, 0.0320518739448942,
          0.1111735166748811, 0.039154188455666976, 0.025443440854672504,
          0.03239581981059534, 0.027120969094009423, 0.05445935205465669,
          0.08028963951603105, 0.02075298500986429, 0.0058131044419531056,
          0.04948420047533672, 0.006850658262213453, 0.06288836730781266,
          0.1025592250558978, 0.07454814435900761, 0.050977607512044276,
          0.05960085913796832]
    @test isapprox(w29.weights, wt, rtol = 1.0e-7)

    w30 = optimise2!(portfolio; rm = EDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.055560528232119676, 0.05252278252766485, 0.04995930852013699,
          0.036469686665161705, 0.07360443788124264, 0.035484250062529706,
          0.03187063749286862, 0.04362148704778408, 0.021541875055852516,
          0.05435689568806405, 0.09401418942704692, 0.024881512156616555,
          0.009270444002026255, 0.06971378686582017, 0.01078203039784278,
          0.05939090630801511, 0.07729538472655453, 0.08736656785459875,
          0.03800312958595158, 0.07429015950210269]
    @test isapprox(w30.weights, wt, rtol = 1.0e-7)

    w31 = optimise2!(portfolio; rm = RDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.055263520718878155, 0.05470886033764548, 0.04729258737064928,
          0.03659066826504964, 0.06763240307582324, 0.03707186354483175,
          0.03301695115922358, 0.04590027827321353, 0.020741988491439888,
          0.05389295853521278, 0.09778300148886963, 0.025642106200246102,
          0.00971015663966544, 0.07161140382368784, 0.011262111599036555,
          0.05878170332530692, 0.07257021270894684, 0.08962515902013113,
          0.035691384041053154, 0.07521068138108908]
    @test isapprox(w31.weights, wt, rtol = 5.0e-8)
end

@testset "HERC" begin
    portfolio = HCPortfolio2(; prices = prices,
                             solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
                                                              :params => Dict("verbose" => false,
                                                                              "max_step_fraction" => 0.75))))

    asset_statistics2!(portfolio)
    hclust_alg = DBHT()
    hclust_opt = HClustOpt()
    type = HERC2()
    w1 = optimise2!(portfolio; rm = SD2(), cluster = true, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.07698450455880468, 0.07670235654605057, 0.06955326092716153,
          0.055733645924582964, 0.061306348146154536, 0.026630781912285295,
          0.0274779863650835, 0.08723325075122691, 0.021443967931440197,
          0.050919570266336714, 0.034721621146346957, 0.013406113465936382,
          0.018014864090601306, 0.029736261019180265, 0.01130547202588631,
          0.03532911363416089, 0.08752722816710831, 0.10098629923304404,
          0.026208793387783046, 0.08877856050082561]
    @test isapprox(w1.weights, wt)

    w2 = optimise2!(portfolio; rm = MAD2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.0797145490968226, 0.07455683155558127, 0.070334401927198, 0.05349383521987859,
          0.06513229159697068, 0.026966237124386894, 0.029595506806349627,
          0.09315224544455303, 0.020640678885583085, 0.047472627309343436,
          0.032958383881734096, 0.014663096865841139, 0.017152340172727078,
          0.029195401656427377, 0.010527045845271121, 0.03720496223361964,
          0.08565021870448736, 0.09947562485956811, 0.025808052654604105,
          0.08630566815905283]
    @test isapprox(w2.weights, wt)

    w3 = optimise2!(portfolio; rm = SSD2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.07837975159477181, 0.07443043390995964, 0.06801950779661087,
          0.055548455549923444, 0.0644736826243098, 0.02739674778042435,
          0.029790140405552036, 0.08281583015461562, 0.021850035315318022,
          0.05161041880598439, 0.035414428250310895, 0.013356805631372573,
          0.02005310749097011, 0.03085778614009161, 0.012088382453633814,
          0.03792292849371053, 0.08401306865550462, 0.10203433260227453,
          0.027069661454433437, 0.08287449489022782]
    @test isapprox(w3.weights, wt)

    w4 = optimise2!(portfolio; rm = FLPM2(; target = rf), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.08074577526070313, 0.0758057372636474, 0.0723712035349317, 0.05388227729039704,
          0.0719726576355769, 0.023357700765219442, 0.030259361503984363,
          0.09069744656455722, 0.020432554010122735, 0.045981867419973635,
          0.03127471464903142, 0.013225268293206591, 0.01541923284313144,
          0.026677624195275505, 0.00924248201367476, 0.03763591530781149,
          0.08961751171161211, 0.09815629750095696, 0.02604005979180501,
          0.08720431244438119]
    @test isapprox(w4.weights, wt)

    w5 = optimise2!(portfolio; rm = SLPM2(; target = rf), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.07895203150464367, 0.07513349407323168, 0.06901069326760172,
          0.05594112932547382, 0.06763676613416904, 0.025518328924508955,
          0.030140432803640472, 0.08170116913851065, 0.021723048018546902,
          0.05096388176098718, 0.0345040083464426, 0.012730715665077913,
          0.018968393009821956, 0.029479897263328572, 0.01127249390583484,
          0.03813269633505064, 0.0862014575477909, 0.1015604380650207, 0.02714041935142286,
          0.08328850555889497]
    @test isapprox(w5.weights, wt)

    w6 = optimise2!(portfolio; rm = WR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.09799469653109426, 0.07931044806875052, 0.07697883394077526,
          0.05938016484003881, 0.062482774302560766, 0.024174945904638732,
          0.021508124985828447, 0.05117445754264079, 0.023413964946189022,
          0.07738784752841718, 0.02842727729869877, 0.006737256345835118,
          0.024299987114092203, 0.030479447210160812, 0.014669862619463056,
          0.033478912079376394, 0.10842038272038522, 0.0983414761742503,
          0.02496318167060388, 0.05637595817620051]
    @test isapprox(w6.weights, wt)

    w7 = optimise2!(portfolio; rm = CVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.07701588327689891, 0.07520448896018464, 0.06541770521947644,
          0.05757000169964883, 0.06337709857771338, 0.025926148616162506,
          0.030149122854382444, 0.08115573202397372, 0.021487151979485357,
          0.053917172483500996, 0.03629492645395641, 0.013834276128551553,
          0.02188007667915268, 0.030097549937467067, 0.012085783569165435,
          0.04006561840657164, 0.08240686258336018, 0.10281015669469054,
          0.02647712574837549, 0.08282711810728184]
    @test isapprox(w7.weights, wt)

    w8 = optimise2!(portfolio; rm = EVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.08699441730392812, 0.07712958717175648, 0.07366521524310121,
          0.06113285849402033, 0.06395471849180502, 0.025641689880494402,
          0.024561083982710123, 0.05538393000042802, 0.023397235003817983,
          0.06889218377773806, 0.032808220114320844, 0.0078354841769452,
          0.024451109097834427, 0.03131096206947751, 0.01392669730115599,
          0.03521555916294673, 0.09758384164962133, 0.10406746553380812,
          0.027502023704060772, 0.06454571784002953]
    @test isapprox(w8.weights, wt, rtol = 5.0e-7)

    w9 = optimise2!(portfolio; rm = RVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.09291265811652286, 0.07830058121386262, 0.07669383422811399,
          0.06048994792338911, 0.0632964281903878, 0.024835265241643308,
          0.022359240252220428, 0.05137247534829683, 0.023653937183085144,
          0.07457499324960506, 0.02985537439802565, 0.007019917248757973,
          0.024398011725401916, 0.03105422675169787, 0.01444843160813441,
          0.033975817433097084, 0.10534002288596125, 0.10072270393057964,
          0.026021876211112602, 0.058674256860104405]
    @test isapprox(w9.weights, wt, rtol = 5.0e-7)

    w10 = optimise2!(portfolio; rm = MDD2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.11942828911415344, 0.06790696087036098, 0.09708343396881959, 0.0322181147701282,
          0.06358441456867103, 0.010918315222441926, 0.029080597027890735,
          0.05067903550079908, 0.019797098917560686, 0.032160771893579174,
          0.04334920387136981, 0.0072395254377313496, 0.004408762771082226,
          0.030601955352742596, 0.0068971479386845886, 0.02624877427854606,
          0.100996587649217, 0.10476039799498128, 0.03792180923631091, 0.11471880361492931]
    @test isapprox(w10.weights, wt)

    w11 = optimise2!(portfolio; rm = ADD2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.10441410900507704, 0.06337257015393993, 0.1388818998669592,
          0.027515787911662204, 0.1188160882745767, 0.009101280957417223,
          0.02353511836320865, 0.03744216548824482, 0.015577834189637181,
          0.01767347121199722, 0.025141762273107857, 0.0033298619605358548,
          0.0018130367073894856, 0.014126651605875161, 0.002228743288689212,
          0.016302454122944926, 0.17177480035356854, 0.09442597723364114,
          0.03145585583242577, 0.08307053119910199]
    @test isapprox(w11.weights, wt)

    w12 = optimise2!(portfolio; rm = CDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.11749818113343935, 0.05870055826126679, 0.11385134924830828,
          0.029526234501200906, 0.08032687433988389, 0.008852903280265263,
          0.026595918536857853, 0.04345063385165379, 0.02084656630749761,
          0.029413320573451408, 0.04005512791398602, 0.005832294513804399,
          0.0033062821268677552, 0.02971553377155059, 0.005420678468821243,
          0.02415714416132541, 0.11618399112873753, 0.10379008396251159,
          0.040922826850160604, 0.10155349706840978]
    @test isapprox(w12.weights, wt)

    w13 = optimise2!(portfolio; rm = UCI2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.10987855273964697, 0.060729473692400754, 0.13188113586803757,
          0.028009359764792043, 0.10116830124988405, 0.00894518902343889,
          0.02515249217180455, 0.040355519105512605, 0.018050336913773852,
          0.021728169704026638, 0.031807104420907735, 0.0040047144063036725,
          0.0023194434166183132, 0.020203823344076888, 0.0032143655180704735,
          0.019106596337899368, 0.15029999715584982, 0.09854472399816692,
          0.03553068862836474, 0.08907001254042422]
    @test isapprox(w13.weights, wt)

    w14 = optimise2!(portfolio; rm = EDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.1177308542531208, 0.06254095321442733, 0.10519293286493245,
          0.030663052419603157, 0.07121563960435068, 0.009654306131028573,
          0.02799873014876406, 0.046417936073046444, 0.020983248093459222,
          0.03096550906654087, 0.04162305259732029, 0.006349196745551905,
          0.0037357551287625196, 0.030460451517300507, 0.00591394170374592,
          0.02518714132643887, 0.11143867125608797, 0.10432624097459507,
          0.040889704525289054, 0.10671268235563422]
    @test isapprox(w14.weights, wt, rtol = 5.0e-8)

    w15 = optimise2!(portfolio; rm = RDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.1183325674687939, 0.0652819692615648, 0.10043845905125683, 0.03138018351723441,
          0.06655539507649458, 0.01031117836998939, 0.02870698570180175,
          0.048504100847745896, 0.020662238620582297, 0.03196981829418142,
          0.04288859208876169, 0.006797311243319078, 0.004081222092532856,
          0.030487185781576095, 0.00636796350460292, 0.026069755474491547,
          0.10619308223996969, 0.10450491799042878, 0.03982385359055927, 0.1106432197841129]
    @test isapprox(w15.weights, wt)

    w16 = optimise2!(portfolio; rm = Kurt2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.053466892258046884, 0.10328667521887797, 0.054404919323835864,
          0.05164034525881938, 0.03949521281426285, 0.02166132115612342,
          0.005325106752082301, 0.06987092753743517, 0.019722628041309125,
          0.058905384535264414, 0.04756653865024671, 0.00337013314805977,
          0.005397558580038606, 0.03531833344651656, 0.005579968832386527,
          0.012662292885364586, 0.11359655047116007, 0.16209808354457939,
          0.02645811650511682, 0.11017301104047358]
    @test isapprox(w16.weights, wt)

    w17 = optimise2!(portfolio; rm = SKurt2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.09195751022271098, 0.07943849543837476, 0.06646961117264624, 0.0491506750340217,
          0.05429977685689461, 0.026897931456943396, 0.010291696410768226,
          0.05363160327577018, 0.01926078898577857, 0.06072467774497688,
          0.047686505861964906, 0.0030930433701959084, 0.009416070036669964,
          0.037424766409940795, 0.006951516870884198, 0.021088101344911066,
          0.10896121609215866, 0.1536264710999023, 0.028737457378644478,
          0.07089208493584212]
    @test isapprox(w17.weights, wt)

    w18 = optimise2!(portfolio; rm = Skew2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05013622008238557, 0.05843253495835018, 0.0326340699568634, 0.03810785845352964,
          0.04151978371454936, 0.020776349162705425, 0.014419467673840766,
          0.06450029254562262, 0.02337036891691671, 0.0768704564650501, 0.03525278374131375,
          0.007885328106569226, 0.23227643708915915, 0.029736303978302396,
          0.019940256048870408, 0.05591386120058815, 0.04641584792557699,
          0.06294077176658942, 0.036661874867119304, 0.0522091333460975]
    @test isapprox(w18.weights, wt)

    w19 = optimise2!(portfolio; rm = SSkew2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06664919970362215, 0.065688537645969, 0.05827905623198537, 0.04923706156165528,
          0.055949261956495855, 0.030046317963353407, 0.027319842253653435,
          0.08126769722698507, 0.02377683386943261, 0.08094977263933717,
          0.04476608242725907, 0.012406273321936936, 0.028493003361406897,
          0.03436511159723589, 0.014308519726637069, 0.05423891622864567,
          0.07452547794485952, 0.09337434382384531, 0.028961215530580075,
          0.07539747498510434]
    @test isapprox(w19.weights, wt)

    hclust_alg = HAClustering()
    w20 = optimise2!(portfolio; rm = DVar2(), cluster = true, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.11814156791628717, 0.1127352219498846, 0.0948040083033778, 0.05910201284574831,
          0.0762034280232549, 0.021900080015085997, 0.005240769029403859,
          0.02492257943111223, 0.013821146124791104, 0.015571892677105771,
          0.036219350442415844, 0.012370220354411125, 0.004197597088141013,
          0.02684034894442968, 0.008021889189561834, 0.01711283206712795,
          0.1478163099569289, 0.03165769900663641, 0.020856810764390717, 0.1524642358699047]
    @test isapprox(w20.weights, wt)

    w21 = optimise2!(portfolio; rm = Variance2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.11540105921544155, 0.1145567201312018, 0.09419723372475931,
          0.060483660234210215, 0.07318364748176763, 0.02168713926476103,
          0.005201942574220557, 0.023749598552788367, 0.014061923482203057,
          0.015961970718579934, 0.03686671320264766, 0.012132318435028086,
          0.00441044709602619, 0.02704002898133752, 0.00862810493627861,
          0.016962353908264397, 0.14917275390007956, 0.03182856610967728,
          0.021005280556336624, 0.15346853749439043]
    @test isapprox(w21.weights, wt)

    w22 = optimise2!(portfolio; rm = Equal2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.09923664122137407, 0.09923664122137407, 0.09923664122137407,
          0.09923664122137407, 0.09923664122137407, 0.023487962419260135,
          0.02348796241926013, 0.023487962419260135, 0.023487962419260135,
          0.023487962419260135, 0.023487962419260135, 0.02348796241926013,
          0.02348796241926013, 0.023487962419260135, 0.02348796241926013,
          0.02348796241926013, 0.09923664122137407, 0.023487962419260135,
          0.023487962419260135, 0.09923664122137407]
    @test isapprox(w22.weights, wt)

    w23 = optimise2!(portfolio; rm = VaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.10414300257102177, 0.09871202573006761, 0.08959251861207183,
          0.07555514734087271, 0.09769669156091847, 0.022943300926461043,
          0.016563538745652133, 0.028652238501006684, 0.019401391461582398,
          0.017501979293453335, 0.030610780860929044, 0.02395924092174919,
          0.013446069288029138, 0.025629238086958404, 0.01730739640456328,
          0.028564197108681265, 0.11491557263229325, 0.027680710219061735,
          0.02230467164850204, 0.12482028808612478]
    @test isapprox(w23.weights, wt)

    w24 = optimise2!(portfolio; rm = DaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.14733227960307277, 0.06614386458233755, 0.15133705565662284,
          0.035584333675786964, 0.11463609164605132, 0.005518410268992302,
          0.013171538035678308, 0.010620417669043803, 0.014023858241571917,
          0.017001289131758357, 0.026781482271749004, 0.007217550381915265,
          0.0035803904597587304, 0.020388510168558176, 0.0065705021611778035,
          0.029518131826492447, 0.16035186159841677, 0.026148373666210922,
          0.027631100950263884, 0.11644295800454063]
    @test isapprox(w24.weights, wt)

    w25 = optimise2!(portfolio; rm = DaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.14774355938966005, 0.0684328493553202, 0.15485994881153173, 0.0411979500128519,
          0.11305584705890495, 0.007216566584313541, 0.011970976561070937,
          0.011775533919110818, 0.013661517786887336, 0.016951592576994145,
          0.02646193157189205, 0.008427695298573155, 0.006529147510212775,
          0.019339548023735872, 0.007726723460706738, 0.02381526338245954,
          0.15152867379279225, 0.025316906660827858, 0.025417970255231653,
          0.11856979798692265]
    @test isapprox(w25.weights, wt)

    w26 = optimise2!(portfolio; rm = MDD_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.15079446061615842, 0.08603152475897777, 0.12374041606663375,
          0.050529282163624914, 0.0857760767414279, 0.009923344774006223,
          0.0134887577916876, 0.016005392064562644, 0.0148967949294955,
          0.020046408045779833, 0.029228399800324625, 0.0099793139298191,
          0.008133340149925354, 0.02141948291605225, 0.00938330394572054,
          0.02127772796435491, 0.12849798956868397, 0.030338927541390587,
          0.025120832103469992, 0.14538822412790406]
    @test isapprox(w26.weights, wt)

    w27 = optimise2!(portfolio; rm = ADD_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.12371584689868499, 0.07328365011343618, 0.16977338386193674,
          0.03354181126220188, 0.14624734118080304, 0.009376911249269603,
          0.008150033847862812, 0.008167198562468324, 0.012903517155053858,
          0.011746529657682171, 0.021870250127331976, 0.005917245694323535,
          0.0032768170628257485, 0.011813734015517456, 0.003743956814916424,
          0.01775306443497017, 0.19872759251615896, 0.020009027345803686,
          0.025007088649056427, 0.09497499954969608]
    @test isapprox(w27.weights, wt)

    w28 = optimise2!(portfolio; rm = CDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.1482304036785224, 0.07559110451590667, 0.14480725317353932, 0.04480939008007434,
          0.10254791389098332, 0.00791620073213515, 0.011996465335688086,
          0.012913340180870978, 0.014391268171680365, 0.01805225079803855,
          0.0270384713414632, 0.008561039338370812, 0.006787624092846017,
          0.01981584825797337, 0.0079340412211216, 0.021763902803450537, 0.1447239549586514,
          0.026833292915610436, 0.025804676072481453, 0.12948155844059195]
    @test isapprox(w28.weights, wt)

    w29 = optimise2!(portfolio; rm = UCI_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.13177358314927293, 0.07247391549233687, 0.16362956503582105,
          0.03659195084440874, 0.126920998889531, 0.00897565819404876, 0.010308036952094911,
          0.010070348969290802, 0.013930178878301605, 0.014394572348790095,
          0.025070306799710288, 0.006958517882519902, 0.004449124903473799,
          0.01545135954194139, 0.005243228396110122, 0.021086596858518908,
          0.17918434540380382, 0.02317354007700532, 0.02618369531594223,
          0.10413047606707744]
    @test isapprox(w29.weights, wt)

    w30 = optimise2!(portfolio; rm = EDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.1488274121958717, 0.07965043465691322, 0.1338236845244531, 0.04685245137285603,
          0.09455930834611771, 0.008714107998123267, 0.012663731601521146,
          0.014222803628373831, 0.015035762837750218, 0.01910358970690992,
          0.028184597388505987, 0.009107245853358044, 0.007272820589254927,
          0.020899558111554476, 0.008458685760279014, 0.021738533486077228,
          0.14067164133836854, 0.028485905052245995, 0.026525362442459087,
          0.13520236310900652]
    @test isapprox(w30.weights, wt, rtol = 1.0e-7)

    w31 = optimise2!(portfolio; rm = RDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.14968299216723, 0.08274800409125811, 0.12809346731596793, 0.0484163890815167,
          0.08949048752314671, 0.009338809076442186, 0.013100309780119947,
          0.015211346871070416, 0.015288347829970085, 0.01979313346063202,
          0.029044996716584604, 0.009477734654729942, 0.00761013719713636,
          0.021271110083134277, 0.008826450239538248, 0.021726662479268907,
          0.13497973924683532, 0.029701767255421313, 0.02630713511281022,
          0.13989097981718657]
    @test isapprox(w31.weights, wt)
end

# @testset "HRP" begin
portfolio = HCPortfolio2(; prices = prices,
                         solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
                                                          :params => Dict("verbose" => false,
                                                                          "max_step_fraction" => 0.75))))

asset_statistics2!(portfolio)
hclust_alg = DBHT()
hclust_opt = HClustOpt()
type = NCO2()
w1 = optimise2!(portfolio; rm = SD2(), cluster = true, type = type, hclust_alg = hclust_alg,
                hclust_opt = hclust_opt)
wt = [0.03692879524929352, 0.06173471900996101, 0.05788485449055379, 0.02673494374797732,
      0.051021461747188426, 0.06928891082994745, 0.024148698656475776, 0.047867702815293824,
      0.03125471206249845, 0.0647453556976089, 0.10088112288028349, 0.038950479132407664,
      0.025466032983548218, 0.046088041928035575, 0.017522279227008376, 0.04994166864441962,
      0.076922254387969, 0.05541444481863126, 0.03819947378487138, 0.07900404790602693]
@test isapprox(w1.weights, wt)

w2 = optimise2!(portfolio; rm = MAD2(), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03818384697661099, 0.0622147651480733, 0.06006655971419491, 0.025623934919921716,
      0.05562388497425944, 0.0707725175955155, 0.025813212789699617, 0.0505495225915194,
      0.030626076629624386, 0.06238080360591265, 0.09374966122500297, 0.04170897361395994,
      0.0238168503353984, 0.04472819614772452, 0.016127737407569318, 0.05166088174144377,
      0.07470415476814536, 0.05398093542616027, 0.03829328495650196, 0.0793741994327616]
@test isapprox(w2.weights, wt)

w3 = optimise2!(portfolio; rm = SSD2(), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03685118468964678, 0.060679678711961914, 0.05670047906355952, 0.026116775736648376,
      0.05374470957245603, 0.07054365460247647, 0.025708179197816795, 0.04589886455582043,
      0.03028786387008358, 0.0634613352386214, 0.10260291820653494, 0.038697426540672014,
      0.027823289120792207, 0.04746469792344547, 0.01859405658396672, 0.052617311519562025,
      0.07250127037171229, 0.05655029966386585, 0.03752315313496762, 0.07563285169538961]
@test isapprox(w3.weights, wt)

w4 = optimise2!(portfolio; rm = FLPM2(; target = rf), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.039336538617540336, 0.06395492117890568, 0.06276820986537449, 0.026249574972701337,
      0.06242254734451266, 0.06144221460126541, 0.026935168312631458, 0.05003386507226852,
      0.031591718694359686, 0.062032838812258684, 0.08971950983943798, 0.03794006123084816,
      0.021868414535268534, 0.04077527283143069, 0.014126622482894119, 0.053377350594462684,
      0.07977242881987609, 0.05414859107042937, 0.04026174326124142, 0.0812424078622927]
@test isapprox(w4.weights, wt)

w5 = optimise2!(portfolio; rm = SLPM2(; target = rf), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03752644591926642, 0.06162667128035028, 0.058061904976983145, 0.02658920517037755,
      0.056905956197316004, 0.06572780540966205, 0.026284445157011994, 0.04570757302464124,
      0.030832527351205462, 0.06360209500884424, 0.10038131818271241, 0.03703703080055575,
      0.02666888092950761, 0.04516285946254531, 0.01726932945234202, 0.053613204742961086,
      0.07517335594118413, 0.05681780552493213, 0.03852165318888371, 0.07648993227871743]
@test isapprox(w5.weights, wt)

w6 = optimise2!(portfolio; rm = WR2(), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.05025200880802368, 0.055880855583038826, 0.05675550980104009, 0.03045034754117226,
      0.046067750416348405, 0.054698528388037695, 0.02387947919504387, 0.03257444044988314,
      0.02852023603441257, 0.06948149861799151, 0.10142635777300404, 0.02403801691456373,
      0.0376186609725536, 0.0489137277286356, 0.023542345142850748, 0.05182849839922806,
      0.12037415047550741, 0.06259799738419287, 0.03040731610608419, 0.050692274268387696]
@test isapprox(w6.weights, wt)

w7 = optimise2!(portfolio; rm = CVaR2(), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03557588495882196, 0.06070721124578364, 0.055279033097091264, 0.02659326453716366,
      0.053554687039556674, 0.06617470037072191, 0.0262740407048504, 0.04720203604560211,
      0.02912774720142737, 0.06321093829691052, 0.10241165286325946, 0.03903551330484258,
      0.029865777325086773, 0.04683826432227621, 0.01880807994439806, 0.05468860348477102,
      0.07181506647247264, 0.0597967463434774, 0.035892100831017446, 0.07714865161046885]
@test isapprox(w7.weights, wt)

w8 = optimise2!(portfolio; rm = EVaR2(), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.04298217683837017, 0.058906176713889875, 0.0574016331486885, 0.03020450525284909,
      0.0498349903258857, 0.060682817777209165, 0.024220257509343413, 0.03449220187183893,
      0.028790726943045256, 0.06651915441075427, 0.1102093216711328, 0.026320946186565213,
      0.0350510342557288, 0.04934072008028962, 0.021946092606624574, 0.05048203603428413,
      0.09622970122852144, 0.06481150812979522, 0.03384174474956397, 0.057732254265619835]
@test isapprox(w8.weights, wt, rtol = 5.0e-7)

w9 = optimise2!(portfolio; rm = RVaR2(), cluster = false, type = type,
                hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.04746219128450875, 0.05772052034931984, 0.057894023300070915, 0.030899831490444826,
      0.047780697436069414, 0.056496204023026735, 0.02359615954618457, 0.032640369565769795,
      0.028784216596900798, 0.06836029362987105, 0.10450059856679983, 0.02457130647918195,
      0.03686881087305981, 0.048996934209302734, 0.0227965377657541, 0.05134221596812637,
      0.11116746180000622, 0.06399587050591148, 0.031665735616057476, 0.052460020993633505]
@test isapprox(w9.weights, wt, rtol = 1.0e-7)

w10 = optimise2!(portfolio; rm = MDD2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.06921730086136976, 0.04450738292959614, 0.08140658224086754, 0.018672719501981218,
      0.053316921973365496, 0.02979463558079051, 0.021114260172381653, 0.029076952717003283,
      0.026064071405076886, 0.07316497416971823, 0.11123520904148268, 0.018576814647316645,
      0.013991436918012332, 0.05469682002741476, 0.012327710930761682, 0.08330184420498327,
      0.07332958900751246, 0.060105980885656114, 0.049926342635393445, 0.07617245014931591]
@test isapprox(w10.weights, wt)

w11 = optimise2!(portfolio; rm = ADD2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.05548273429645013, 0.03986073873648723, 0.09599318831154405, 0.014621119350699974,
      0.08212398553813219, 0.024721555415213262, 0.017757328803291575, 0.024648542319161523,
      0.04053046304894661, 0.06980177121920025, 0.07760681699761883, 0.01027851528431043,
      0.00777588366272761, 0.021591614519396285, 0.0034064806929941845, 0.06991915064946408,
      0.12960468534402678, 0.062161540752826025, 0.08184195485513887, 0.07027193020237012]
@test isapprox(w11.weights, wt)

w12 = optimise2!(portfolio; rm = CDaR2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.06282520890507177, 0.03706824571002148, 0.08139181669684024, 0.015787409071561908,
      0.05742532060680956, 0.022473205432788673, 0.018010510386343107, 0.028690055814249292,
      0.031947471924376705, 0.07945270069786842, 0.10413378630449394, 0.015162575734861551,
      0.011642750066910313, 0.04691738037936903, 0.008558622422573802, 0.08506702725550051,
      0.07867872568683776, 0.06853164241553955, 0.06271444623431467, 0.08352109825366769]
@test isapprox(w12.weights, wt)

w13 = optimise2!(portfolio; rm = UCI2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.056222127504695026, 0.03676156065449049, 0.09101083070457834, 0.014331694009042086,
      0.06981598298437515, 0.02449761185808867, 0.017540488246254482, 0.025783651111609372,
      0.03897771757340407, 0.07792753098849892, 0.09069642716675666, 0.011419250355786286,
      0.009579825814905836, 0.03155851948684042, 0.005020862393829734, 0.07891456352044066,
      0.10481408027151863, 0.06296146942913426, 0.0767246147903293, 0.0754411911354216]
@test isapprox(w13.weights, wt)

w14 = optimise2!(portfolio; rm = EDaR2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.06368313885096026, 0.03964177645523946, 0.08253885356726247, 0.01658630133298382,
      0.055878822739450135, 0.025248628049312456, 0.019039909877211127,
      0.028999411295580237, 0.030719786342128182, 0.07837842859043447, 0.10479226890649017,
      0.01598505374262056, 0.012462054946453145, 0.0503667610779172, 0.009778781140263914,
      0.08402144368015278, 0.07578137459372361, 0.0651773824278426, 0.05986313372528741,
      0.0810566886586861]
@test isapprox(w14.weights, wt, rtol = 1.0e-7)

w15 = optimise2!(portfolio; rm = RDaR2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.06626057100148959, 0.042384460290778865, 0.08229559342069401, 0.017571400016583083,
      0.054533052228267126, 0.02751643858660513, 0.02021038180000024, 0.02882973184000429,
      0.028405177937391907, 0.0760417757563507, 0.10819526671824652, 0.01714761122061998,
      0.013186013461541538, 0.05250570179214284, 0.01096704678455384, 0.08422872826614602,
      0.07476238567443566, 0.0621153409498924, 0.054747390549717716, 0.07809593170453868]
@test isapprox(w15.weights, wt)

w16 = optimise2!(portfolio; rm = Kurt2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.029481521953684118, 0.05982735944410474, 0.03557911826015237, 0.028474368121041888,
      0.025828635808911045, 0.05929340372085539, 0.00400811258716055, 0.04856579375773367,
      0.028712479333209244, 0.0657391879397804, 0.16216057544981644, 0.011489226379288793,
      0.009094526296241098, 0.08053893478316498, 0.012724404070883372, 0.021335119185650623,
      0.0855020913192837, 0.11267092582579596, 0.03851809818436267, 0.08045611757887891]
@test isapprox(w16.weights, wt)

w17 = optimise2!(portfolio; rm = SKurt2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.041695764288341326, 0.04968730030116381, 0.04519046227953908, 0.02228610752801017,
      0.036916599549008534, 0.06695518729855642, 0.008601057788011419, 0.03832875671733724,
      0.023603809923922775, 0.05953659154802947, 0.15949334007294313, 0.010345061127586078,
      0.01551106764201746, 0.07844578132980796, 0.01457102407508962, 0.034738374409788796,
      0.09106192787421133, 0.1097918256490279, 0.0352173258407637, 0.058022634756843806]
@test isapprox(w17.weights, wt)

w18 = optimise2!(portfolio; rm = Skew2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [4.18164303203965e-6, 0.11905148244884775, 0.13754035964680367, 4.18164303203965e-6,
      0.13754035964680367, 1.658199358060021e-6, 0.028721218707620826,
      1.1383557170375464e-10, 8.355416012626526e-16, 1.8128635217880256e-6,
      0.08532736996421339, 0.007291462719384035, 0.10926054871992093,
      0.00021830908182616843, 0.2370505968817962, 0.10926054871992093, 0.028721218707620826,
      3.684313367457248e-6, 4.824826616435831e-11, 1.0059308456231142e-6]
@test isapprox(w18.weights, wt, rtol = 5.0e-5)

w19 = optimise2!(portfolio; rm = SSkew2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03073561997154973, 0.06271788007944147, 0.059839304178611136, 0.019020703463231065,
      0.054114343500047124, 0.07478195087196789, 0.015025906923294915, 0.037423537539572865,
      0.02195663364580543, 0.07120487867873436, 0.14238956696393482, 0.022992175030255378,
      0.02427916555268004, 0.040541588877064376, 0.010704183865328891, 0.053000134123666075,
      0.07802885174200914, 0.06680453879901624, 0.030056876315924044, 0.08438215987786517]
@test isapprox(w19.weights, wt)

hclust_alg = HAClustering()
w20 = optimise2!(portfolio; rm = DVar2(), cluster = true, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.034616203287809656, 0.05339682894540566, 0.0277781553250953, 0.04211296639608739,
      0.05429852976387857, 0.07556907274344477, 0.012918417022839884, 0.0639503232740957,
      0.025141332254925024, 0.05293567401349993, 0.12067634196508455, 0.0237681969964296,
      0.008823211105214881, 0.08942720087787832, 0.016861747398793574, 0.03288067246055758,
      0.07170919770494971, 0.0812323656620027, 0.03793954600227262, 0.07396401679973474]
@test isapprox(w20.weights, wt)

w21 = optimise2!(portfolio; rm = Variance2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03360421525593201, 0.053460257098811775, 0.027429766590708997, 0.04363053745921338,
      0.05279180956461212, 0.07434468966041922, 0.012386194792256387, 0.06206960160806503,
      0.025502890164538234, 0.0542097204834031, 0.12168116639250848, 0.023275086688903004,
      0.009124639465879256, 0.08924750757276853, 0.017850423121104797, 0.032541204698588386,
      0.07175228284814082, 0.08318399209117079, 0.03809545426566615, 0.07381856017730955]
@test isapprox(w21.weights, wt)

w22 = optimise2!(portfolio; rm = Equal2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.05, 0.05000000000000001, 0.05, 0.04999999999999999, 0.04999999999999999,
      0.05000000000000001, 0.05000000000000001, 0.05, 0.05, 0.05000000000000001,
      0.04999999999999999, 0.04999999999999999, 0.05, 0.04999999999999999, 0.05,
      0.04999999999999999, 0.04999999999999999, 0.05, 0.05, 0.04999999999999999]
@test isapprox(w22.weights, wt)

w23 = optimise2!(portfolio; rm = VaR2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.03403717939776512, 0.05917176810341441, 0.029281627698577888, 0.04641795773733506,
      0.06002080678226616, 0.07336909341225178, 0.032392046758139795, 0.05383361136188931,
      0.02967264551919885, 0.05284095110693102, 0.09521120378350553, 0.04261320776949539,
      0.01642971834566978, 0.07971670573840162, 0.021147864266696195, 0.050803448662520866,
      0.06563107532995796, 0.05200824347813839, 0.034112945793535646, 0.07128789895430926]
@test isapprox(w23.weights, wt)

w24 = optimise2!(portfolio; rm = DaR2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.057660532702867646, 0.04125282312548106, 0.05922785740065619, 0.03223509018499126,
      0.10384639449297382, 0.02480551517770064, 0.030513023620218654, 0.037564939241009405,
      0.02260728843785307, 0.05164502511939685, 0.08286147806113833, 0.01696931547695469,
      0.00418787314771699, 0.06308172456210165, 0.007685315296496237, 0.0694006227527249,
      0.09119842783020647, 0.09248808273195344, 0.044542968010494795, 0.06622570262706394]
@test isapprox(w24.weights, wt)

w25 = optimise2!(portfolio; rm = DaR_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.05820921825149978, 0.04281381004716568, 0.061012991673039425, 0.037261284520695284,
      0.10225280827507012, 0.03171774621579708, 0.029035913030571646, 0.03777811595747374,
      0.021478656618637317, 0.05210098246314737, 0.08336111731195082, 0.0224554330786605,
      0.008018398540074134, 0.060923985355596684, 0.009489132849269694, 0.06345531419794387,
      0.0883323204747975, 0.08122137323769983, 0.039962166984027804, 0.06911923091688174]
@test isapprox(w25.weights, wt)

w26 = optimise2!(portfolio; rm = MDD_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.054750291482807016, 0.05626561538767235, 0.044927537922610235, 0.037029800949262545,
      0.06286000734501392, 0.038964408950160866, 0.033959752237812064, 0.04828571977339982,
      0.01937785058895953, 0.05279062837229332, 0.10144994531515807, 0.02678668518638289,
      0.010335110450233378, 0.07434568383344507, 0.01192345099055306, 0.05711412672965212,
      0.06785463405921893, 0.09152771438398988, 0.032677346602089874, 0.07677368943928506]
@test isapprox(w26.weights, wt)

w27 = optimise2!(portfolio; rm = ADD_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.05216718533133331, 0.04708278318245931, 0.07158823871210457, 0.029511984859220904,
      0.12867669205129983, 0.03859596234440916, 0.022402839001206605, 0.026020360199894607,
      0.030904469636691148, 0.054239105004183275, 0.07390114503735276, 0.019880342325388017,
      0.00476824739544596, 0.03991945523395664, 0.0054480039590591904, 0.059645486519252305,
      0.11611402694084015, 0.06374794181935534, 0.059893035563107475, 0.055492694883439435]
@test isapprox(w27.weights, wt)

w28 = optimise2!(portfolio; rm = CDaR_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.055226953695215866, 0.047934679854074826, 0.05395157314076186, 0.036982877818185954,
      0.08463665680704126, 0.033820937721103415, 0.03026563101495272, 0.04118023926554901,
      0.02122427296619385, 0.05288666614109493, 0.09090289747478623, 0.02380032651263032,
      0.008673469487824291, 0.06662055705080387, 0.010138402407857017, 0.060505269563432176,
      0.08319151689594376, 0.08557053458440436, 0.038056791259321536, 0.07442974633882277]
@test isapprox(w28.weights, wt)

w29 = optimise2!(portfolio; rm = UCI_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.05276898612268049, 0.04614128625526376, 0.06552577565455027, 0.0320518739448942,
      0.1111735166748811, 0.039154188455666976, 0.025443440854672504, 0.03239581981059534,
      0.027120969094009423, 0.05445935205465669, 0.08028963951603105, 0.02075298500986429,
      0.0058131044419531056, 0.04948420047533672, 0.006850658262213453, 0.06288836730781266,
      0.1025592250558978, 0.07454814435900761, 0.050977607512044276, 0.05960085913796832]
@test isapprox(w29.weights, wt, rtol = 1.0e-7)

w30 = optimise2!(portfolio; rm = EDaR_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.055560528232119676, 0.05252278252766485, 0.04995930852013699, 0.036469686665161705,
      0.07360443788124264, 0.035484250062529706, 0.03187063749286862, 0.04362148704778408,
      0.021541875055852516, 0.05435689568806405, 0.09401418942704692, 0.024881512156616555,
      0.009270444002026255, 0.06971378686582017, 0.01078203039784278, 0.05939090630801511,
      0.07729538472655453, 0.08736656785459875, 0.03800312958595158, 0.07429015950210269]
@test isapprox(w30.weights, wt, rtol = 5.0e-8)

w31 = optimise2!(portfolio; rm = RDaR_r2(), cluster = false, type = type,
                 hclust_alg = hclust_alg, hclust_opt = hclust_opt)
wt = [0.055263520718878155, 0.05470886033764548, 0.04729258737064928, 0.03659066826504964,
      0.06763240307582324, 0.03707186354483175, 0.03301695115922358, 0.04590027827321353,
      0.020741988491439888, 0.05389295853521278, 0.09778300148886963, 0.025642106200246102,
      0.00971015663966544, 0.07161140382368784, 0.011262111599036555, 0.05878170332530692,
      0.07257021270894684, 0.08962515902013113, 0.035691384041053154, 0.07521068138108908]
@test isapprox(w31.weights, wt)
# end

# struct POCorDist <: Distances.UnionMetric end
# function Distances.pairwise(::POCorDist, mtx, i)
#     return sqrt.(clamp!((1 .- mtx) / 2, 0, 1))
# end
# dbht_d(corr, dist) = 2 .- (dist .^ 2) / 2
# portfolio2 = HCPortfolio(; prices = prices,
#                          solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
#                                                           :params => Dict("verbose" => false,
#                                                                           "max_step_fraction" => 0.75))))
# asset_statistics!(portfolio2; cor_opt = CorOpt(; dist = DistOpt(; method = POCorDist())))

# cluster_opt = ClusterOpt(; linkage = :ward, genfunc = GenericFunction(; func = dbht_d))
# rm = :DVar
# w1 = optimise!(portfolio2; type = :HERC, rm = rm, rf = rf, cluster_opt = cluster_opt)
