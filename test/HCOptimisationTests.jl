using CSV, TimeSeries, DataFrames, StatsBase, Statistics, LinearAlgebra, Test, Clarabel,
      PortfolioOptimiser

prices = TimeArray(CSV.File("./assets/stock_prices.csv"); timestamp = :date)
rf = 1.0329^(1 / 252) - 1
l = 2.0

@testset "HRP" begin
    portfolio = HCPortfolio2(; prices = prices,
                             solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
                                                              :params => Dict("verbose" => false,
                                                                              "max_step_fraction" => 0.75))))

    asset_statistics2!(portfolio)
    hclust_alg = DBHT()
    hclust_opt = HClustOpt()
    type = HRP2()
    w1 = optimise2!(portfolio; rm = SD2(), cluster = true, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03692879524929352, 0.06173471900996101, 0.05788485449055379,
          0.02673494374797732, 0.051021461747188426, 0.06928891082994745,
          0.024148698656475776, 0.047867702815293824, 0.03125471206249845,
          0.0647453556976089, 0.10088112288028349, 0.038950479132407664,
          0.025466032983548218, 0.046088041928035575, 0.017522279227008376,
          0.04994166864441962, 0.076922254387969, 0.05541444481863126, 0.03819947378487138,
          0.07900404790602693]
    @test isapprox(w1.weights, wt)

    w2 = optimise2!(portfolio; rm = MAD2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03818384697661099, 0.0622147651480733, 0.06006655971419491,
          0.025623934919921716, 0.05562388497425944, 0.0707725175955155,
          0.025813212789699617, 0.0505495225915194, 0.030626076629624386,
          0.06238080360591265, 0.09374966122500297, 0.04170897361395994, 0.0238168503353984,
          0.04472819614772452, 0.016127737407569318, 0.05166088174144377,
          0.07470415476814536, 0.05398093542616027, 0.03829328495650196, 0.0793741994327616]
    @test isapprox(w2.weights, wt)

    w3 = optimise2!(portfolio; rm = SSD2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03685118468964678, 0.060679678711961914, 0.05670047906355952,
          0.026116775736648376, 0.05374470957245603, 0.07054365460247647,
          0.025708179197816795, 0.04589886455582043, 0.03028786387008358,
          0.0634613352386214, 0.10260291820653494, 0.038697426540672014,
          0.027823289120792207, 0.04746469792344547, 0.01859405658396672,
          0.052617311519562025, 0.07250127037171229, 0.05655029966386585,
          0.03752315313496762, 0.07563285169538961]
    @test isapprox(w3.weights, wt)

    w4 = optimise2!(portfolio; rm = FLPM2(; target = rf), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.039336538617540336, 0.06395492117890568, 0.06276820986537449,
          0.026249574972701337, 0.06242254734451266, 0.06144221460126541,
          0.026935168312631458, 0.05003386507226852, 0.031591718694359686,
          0.062032838812258684, 0.08971950983943798, 0.03794006123084816,
          0.021868414535268534, 0.04077527283143069, 0.014126622482894119,
          0.053377350594462684, 0.07977242881987609, 0.05414859107042937,
          0.04026174326124142, 0.0812424078622927]
    @test isapprox(w4.weights, wt)

    w5 = optimise2!(portfolio; rm = SLPM2(; target = rf), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03752644591926642, 0.06162667128035028, 0.058061904976983145,
          0.02658920517037755, 0.056905956197316004, 0.06572780540966205,
          0.026284445157011994, 0.04570757302464124, 0.030832527351205462,
          0.06360209500884424, 0.10038131818271241, 0.03703703080055575,
          0.02666888092950761, 0.04516285946254531, 0.01726932945234202,
          0.053613204742961086, 0.07517335594118413, 0.05681780552493213,
          0.03852165318888371, 0.07648993227871743]
    @test isapprox(w5.weights, wt)

    w6 = optimise2!(portfolio; rm = WR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05025200880802368, 0.055880855583038826, 0.05675550980104009,
          0.03045034754117226, 0.046067750416348405, 0.054698528388037695,
          0.02387947919504387, 0.03257444044988314, 0.02852023603441257,
          0.06948149861799151, 0.10142635777300404, 0.02403801691456373, 0.0376186609725536,
          0.0489137277286356, 0.023542345142850748, 0.05182849839922806,
          0.12037415047550741, 0.06259799738419287, 0.03040731610608419,
          0.050692274268387696]
    @test isapprox(w6.weights, wt)

    w7 = optimise2!(portfolio; rm = CVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03557588495882196, 0.06070721124578364, 0.055279033097091264,
          0.02659326453716366, 0.053554687039556674, 0.06617470037072191,
          0.0262740407048504, 0.04720203604560211, 0.02912774720142737, 0.06321093829691052,
          0.10241165286325946, 0.03903551330484258, 0.029865777325086773,
          0.04683826432227621, 0.01880807994439806, 0.05468860348477102,
          0.07181506647247264, 0.0597967463434774, 0.035892100831017446,
          0.07714865161046885]
    @test isapprox(w7.weights, wt)

    w8 = optimise2!(portfolio; rm = EVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.04298217683837017, 0.058906176713889875, 0.0574016331486885,
          0.03020450525284909, 0.0498349903258857, 0.060682817777209165,
          0.024220257509343413, 0.03449220187183893, 0.028790726943045256,
          0.06651915441075427, 0.1102093216711328, 0.026320946186565213, 0.0350510342557288,
          0.04934072008028962, 0.021946092606624574, 0.05048203603428413,
          0.09622970122852144, 0.06481150812979522, 0.03384174474956397,
          0.057732254265619835]
    @test isapprox(w8.weights, wt)

    w9 = optimise2!(portfolio; rm = RVaR2(), cluster = false, type = type,
                    hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.04746219128450875, 0.05772052034931984, 0.057894023300070915,
          0.030899831490444826, 0.047780697436069414, 0.056496204023026735,
          0.02359615954618457, 0.032640369565769795, 0.028784216596900798,
          0.06836029362987105, 0.10450059856679983, 0.02457130647918195,
          0.03686881087305981, 0.048996934209302734, 0.0227965377657541,
          0.05134221596812637, 0.11116746180000622, 0.06399587050591148,
          0.031665735616057476, 0.052460020993633505]
    @test isapprox(w9.weights, wt)

    w10 = optimise2!(portfolio; rm = MDD2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06921730086136976, 0.04450738292959614, 0.08140658224086754,
          0.018672719501981218, 0.053316921973365496, 0.02979463558079051,
          0.021114260172381653, 0.029076952717003283, 0.026064071405076886,
          0.07316497416971823, 0.11123520904148268, 0.018576814647316645,
          0.013991436918012332, 0.05469682002741476, 0.012327710930761682,
          0.08330184420498327, 0.07332958900751246, 0.060105980885656114,
          0.049926342635393445, 0.07617245014931591]
    @test isapprox(w10.weights, wt)

    w11 = optimise2!(portfolio; rm = ADD2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05548273429645013, 0.03986073873648723, 0.09599318831154405,
          0.014621119350699974, 0.08212398553813219, 0.024721555415213262,
          0.017757328803291575, 0.024648542319161523, 0.04053046304894661,
          0.06980177121920025, 0.07760681699761883, 0.01027851528431043,
          0.00777588366272761, 0.021591614519396285, 0.0034064806929941845,
          0.06991915064946408, 0.12960468534402678, 0.062161540752826025,
          0.08184195485513887, 0.07027193020237012]
    @test isapprox(w11.weights, wt)

    w12 = optimise2!(portfolio; rm = CDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06282520890507177, 0.03706824571002148, 0.08139181669684024,
          0.015787409071561908, 0.05742532060680956, 0.022473205432788673,
          0.018010510386343107, 0.028690055814249292, 0.031947471924376705,
          0.07945270069786842, 0.10413378630449394, 0.015162575734861551,
          0.011642750066910313, 0.04691738037936903, 0.008558622422573802,
          0.08506702725550051, 0.07867872568683776, 0.06853164241553955,
          0.06271444623431467, 0.08352109825366769]
    @test isapprox(w12.weights, wt)

    w13 = optimise2!(portfolio; rm = UCI2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.056222127504695026, 0.03676156065449049, 0.09101083070457834,
          0.014331694009042086, 0.06981598298437515, 0.02449761185808867,
          0.017540488246254482, 0.025783651111609372, 0.03897771757340407,
          0.07792753098849892, 0.09069642716675666, 0.011419250355786286,
          0.009579825814905836, 0.03155851948684042, 0.005020862393829734,
          0.07891456352044066, 0.10481408027151863, 0.06296146942913426, 0.0767246147903293,
          0.0754411911354216]
    @test isapprox(w13.weights, wt)

    w14 = optimise2!(portfolio; rm = EDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06368313885096026, 0.03964177645523946, 0.08253885356726247,
          0.01658630133298382, 0.055878822739450135, 0.025248628049312456,
          0.019039909877211127, 0.028999411295580237, 0.030719786342128182,
          0.07837842859043447, 0.10479226890649017, 0.01598505374262056,
          0.012462054946453145, 0.0503667610779172, 0.009778781140263914,
          0.08402144368015278, 0.07578137459372361, 0.0651773824278426, 0.05986313372528741,
          0.0810566886586861]
    @test isapprox(w14.weights, wt)

    w15 = optimise2!(portfolio; rm = RDaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.06626057100148959, 0.042384460290778865, 0.08229559342069401,
          0.017571400016583083, 0.054533052228267126, 0.02751643858660513,
          0.02021038180000024, 0.02882973184000429, 0.028405177937391907,
          0.0760417757563507, 0.10819526671824652, 0.01714761122061998,
          0.013186013461541538, 0.05250570179214284, 0.01096704678455384,
          0.08422872826614602, 0.07476238567443566, 0.0621153409498924,
          0.054747390549717716, 0.07809593170453868]
    @test isapprox(w15.weights, wt)

    w16 = optimise2!(portfolio; rm = Kurt2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.029481521953684118, 0.05982735944410474, 0.03557911826015237,
          0.028474368121041888, 0.025828635808911045, 0.05929340372085539,
          0.00400811258716055, 0.04856579375773367, 0.028712479333209244,
          0.0657391879397804, 0.16216057544981644, 0.011489226379288793,
          0.009094526296241098, 0.08053893478316498, 0.012724404070883372,
          0.021335119185650623, 0.0855020913192837, 0.11267092582579596,
          0.03851809818436267, 0.08045611757887891]
    @test isapprox(w16.weights, wt)

    w17 = optimise2!(portfolio; rm = SKurt2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.041695764288341326, 0.04968730030116381, 0.04519046227953908,
          0.02228610752801017, 0.036916599549008534, 0.06695518729855642,
          0.008601057788011419, 0.03832875671733724, 0.023603809923922775,
          0.05953659154802947, 0.15949334007294313, 0.010345061127586078,
          0.01551106764201746, 0.07844578132980796, 0.01457102407508962,
          0.034738374409788796, 0.09106192787421133, 0.1097918256490279, 0.0352173258407637,
          0.058022634756843806]
    @test isapprox(w17.weights, wt)

    w18 = optimise2!(portfolio; rm = Skew2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [4.18164303203965e-6, 0.11905148244884775, 0.13754035964680367,
          4.18164303203965e-6, 0.13754035964680367, 1.658199358060021e-6,
          0.028721218707620826, 1.1383557170375464e-10, 8.355416012626526e-16,
          1.8128635217880256e-6, 0.08532736996421339, 0.007291462719384035,
          0.10926054871992093, 0.00021830908182616843, 0.2370505968817962,
          0.10926054871992093, 0.028721218707620826, 3.684313367457248e-6,
          4.824826616435831e-11, 1.0059308456231142e-6]
    @test isapprox(w18.weights, wt)

    w19 = optimise2!(portfolio; rm = SSkew2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03073561997154973, 0.06271788007944147, 0.059839304178611136,
          0.019020703463231065, 0.054114343500047124, 0.07478195087196789,
          0.015025906923294915, 0.037423537539572865, 0.02195663364580543,
          0.07120487867873436, 0.14238956696393482, 0.022992175030255378,
          0.02427916555268004, 0.040541588877064376, 0.010704183865328891,
          0.053000134123666075, 0.07802885174200914, 0.06680453879901624,
          0.030056876315924044, 0.08438215987786517]
    @test isapprox(w19.weights, wt)

    hclust_alg = HAClustering()
    w20 = optimise2!(portfolio; rm = DVar2(), cluster = true, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.034616203287809656, 0.05339682894540566, 0.0277781553250953,
          0.04211296639608739, 0.05429852976387857, 0.07556907274344477,
          0.012918417022839884, 0.0639503232740957, 0.025141332254925024,
          0.05293567401349993, 0.12067634196508455, 0.0237681969964296,
          0.008823211105214881, 0.08942720087787832, 0.016861747398793574,
          0.03288067246055758, 0.07170919770494971, 0.0812323656620027, 0.03793954600227262,
          0.07396401679973474]
    @test isapprox(w20.weights, wt)

    w21 = optimise2!(portfolio; rm = Variance2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03360421525593201, 0.053460257098811775, 0.027429766590708997,
          0.04363053745921338, 0.05279180956461212, 0.07434468966041922,
          0.012386194792256387, 0.06206960160806503, 0.025502890164538234,
          0.0542097204834031, 0.12168116639250848, 0.023275086688903004,
          0.009124639465879256, 0.08924750757276853, 0.017850423121104797,
          0.032541204698588386, 0.07175228284814082, 0.08318399209117079,
          0.03809545426566615, 0.07381856017730955]
    @test isapprox(w21.weights, wt)

    w22 = optimise2!(portfolio; rm = Equal2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05, 0.05000000000000001, 0.05, 0.04999999999999999, 0.04999999999999999,
          0.05000000000000001, 0.05000000000000001, 0.05, 0.05, 0.05000000000000001,
          0.04999999999999999, 0.04999999999999999, 0.05, 0.04999999999999999, 0.05,
          0.04999999999999999, 0.04999999999999999, 0.05, 0.05, 0.04999999999999999]
    @test isapprox(w22.weights, wt)

    w23 = optimise2!(portfolio; rm = VaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.03403717939776512, 0.05917176810341441, 0.029281627698577888,
          0.04641795773733506, 0.06002080678226616, 0.07336909341225178,
          0.032392046758139795, 0.05383361136188931, 0.02967264551919885,
          0.05284095110693102, 0.09521120378350553, 0.04261320776949539,
          0.01642971834566978, 0.07971670573840162, 0.021147864266696195,
          0.050803448662520866, 0.06563107532995796, 0.05200824347813839,
          0.034112945793535646, 0.07128789895430926]
    @test isapprox(w23.weights, wt)

    w24 = optimise2!(portfolio; rm = DaR2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.057660532702867646, 0.04125282312548106, 0.05922785740065619,
          0.03223509018499126, 0.10384639449297382, 0.02480551517770064,
          0.030513023620218654, 0.037564939241009405, 0.02260728843785307,
          0.05164502511939685, 0.08286147806113833, 0.01696931547695469,
          0.00418787314771699, 0.06308172456210165, 0.007685315296496237,
          0.0694006227527249, 0.09119842783020647, 0.09248808273195344,
          0.044542968010494795, 0.06622570262706394]
    @test isapprox(w24.weights, wt)

    w25 = optimise2!(portfolio; rm = DaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05820921825149978, 0.04281381004716568, 0.061012991673039425,
          0.037261284520695284, 0.10225280827507012, 0.03171774621579708,
          0.029035913030571646, 0.03777811595747374, 0.021478656618637317,
          0.05210098246314737, 0.08336111731195082, 0.0224554330786605,
          0.008018398540074134, 0.060923985355596684, 0.009489132849269694,
          0.06345531419794387, 0.0883323204747975, 0.08122137323769983,
          0.039962166984027804, 0.06911923091688174]
    @test isapprox(w25.weights, wt)

    w26 = optimise2!(portfolio; rm = MDD_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.054750291482807016, 0.05626561538767235, 0.044927537922610235,
          0.037029800949262545, 0.06286000734501392, 0.038964408950160866,
          0.033959752237812064, 0.04828571977339982, 0.01937785058895953,
          0.05279062837229332, 0.10144994531515807, 0.02678668518638289,
          0.010335110450233378, 0.07434568383344507, 0.01192345099055306,
          0.05711412672965212, 0.06785463405921893, 0.09152771438398988,
          0.032677346602089874, 0.07677368943928506]
    @test isapprox(w26.weights, wt)

    w27 = optimise2!(portfolio; rm = ADD_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05216718533133331, 0.04708278318245931, 0.07158823871210457,
          0.029511984859220904, 0.12867669205129983, 0.03859596234440916,
          0.022402839001206605, 0.026020360199894607, 0.030904469636691148,
          0.054239105004183275, 0.07390114503735276, 0.019880342325388017,
          0.00476824739544596, 0.03991945523395664, 0.0054480039590591904,
          0.059645486519252305, 0.11611402694084015, 0.06374794181935534,
          0.059893035563107475, 0.055492694883439435]
    @test isapprox(w27.weights, wt)

    w27 = optimise2!(portfolio; rm = CDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.055226953695215866, 0.047934679854074826, 0.05395157314076186,
          0.036982877818185954, 0.08463665680704126, 0.033820937721103415,
          0.03026563101495272, 0.04118023926554901, 0.02122427296619385,
          0.05288666614109493, 0.09090289747478623, 0.02380032651263032,
          0.008673469487824291, 0.06662055705080387, 0.010138402407857017,
          0.060505269563432176, 0.08319151689594376, 0.08557053458440436,
          0.038056791259321536, 0.07442974633882277]
    @test isapprox(w27.weights, wt)

    w28 = optimise2!(portfolio; rm = UCI_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.05276898612268049, 0.04614128625526376, 0.06552577565455027, 0.0320518739448942,
          0.1111735166748811, 0.039154188455666976, 0.025443440854672504,
          0.03239581981059534, 0.027120969094009423, 0.05445935205465669,
          0.08028963951603105, 0.02075298500986429, 0.0058131044419531056,
          0.04948420047533672, 0.006850658262213453, 0.06288836730781266,
          0.1025592250558978, 0.07454814435900761, 0.050977607512044276,
          0.05960085913796832]
    @test isapprox(w28.weights, wt)

    w29 = optimise2!(portfolio; rm = EDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.055560528232119676, 0.05252278252766485, 0.04995930852013699,
          0.036469686665161705, 0.07360443788124264, 0.035484250062529706,
          0.03187063749286862, 0.04362148704778408, 0.021541875055852516,
          0.05435689568806405, 0.09401418942704692, 0.024881512156616555,
          0.009270444002026255, 0.06971378686582017, 0.01078203039784278,
          0.05939090630801511, 0.07729538472655453, 0.08736656785459875,
          0.03800312958595158, 0.07429015950210269]
    @test isapprox(w29.weights, wt)

    w30 = optimise2!(portfolio; rm = RDaR_r2(), cluster = false, type = type,
                     hclust_alg = hclust_alg, hclust_opt = hclust_opt)
    wt = [0.055263520718878155, 0.05470886033764548, 0.04729258737064928,
          0.03659066826504964, 0.06763240307582324, 0.03707186354483175,
          0.03301695115922358, 0.04590027827321353, 0.020741988491439888,
          0.05389295853521278, 0.09778300148886963, 0.025642106200246102,
          0.00971015663966544, 0.07161140382368784, 0.011262111599036555,
          0.05878170332530692, 0.07257021270894684, 0.08962515902013113,
          0.035691384041053154, 0.07521068138108908]
    @test isapprox(w30.weights, wt)
end

# struct POCorDist <: Distances.UnionMetric end
# function Distances.pairwise(::POCorDist, mtx, i)
#     return sqrt.(clamp!((1 .- mtx) / 2, 0, 1))
# end
# dbht_d(corr, dist) = 2 .- (dist .^ 2) / 2
# portfolio2 = HCPortfolio(; prices = prices,
#                         solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
#                                                                 :params => Dict("verbose" => false,
#                                                                                 "max_step_fraction" => 0.75))))
# asset_statistics!(portfolio2; cor_opt = CorOpt(; dist = DistOpt(; method = POCorDist())))

# cluster_opt = ClusterOpt(; linkage = :DBHT, genfunc = GenericFunction(; func = dbht_d))
# rm = :DVar
# w1 = optimise!(portfolio2; type = :HRP, rm = rm, rf = rf, cluster_opt = cluster_opt)
