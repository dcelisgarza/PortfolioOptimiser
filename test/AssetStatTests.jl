using Test, PortfolioOptimiser, CSV, TimeSeries, DataFrames, StatsBase, Logging

Logging.disable_logging(Logging.Warn)

A = TimeArray(CSV.File("./assets/stock_prices.csv"), timestamp = :date)
Y = percentchange(A)
returns = dropmissing!(DataFrame(Y))

@testset "Asset statistics" begin
    portfolio = HCPortfolio(returns = returns)

    asset_statistics!(portfolio, mu_type = :JS, mu_target = :GM)
    jsgm = copy(portfolio.mu)
    jsgmt = [
        0.0006341475601844101,
        0.0006789058959280285,
        0.0008178383518190523,
        0.0007639436970922277,
        0.0013856285900496848,
        -0.0002523200512863443,
        0.0014200748323063197,
        0.0003576843329880906,
        0.000716221244111695,
        0.0004491661692147687,
        0.0003248478475254554,
        -0.00015878941972113393,
        -0.0007869829861367987,
        0.00011240543858372297,
        -0.0007127483820581668,
        0.0009418444136399807,
        0.0008403726820401893,
        0.00040878369315988205,
        0.0007395087768546029,
        0.0005917202666292221,
    ]
    @test isapprox(jsgm, jsgmt)

    asset_statistics!(portfolio, mu_type = :BS, mu_target = :GM)
    bsgm = copy(portfolio.mu)
    bsgmt = [
        0.000596098181618497,
        0.0006308701348944901,
        0.0007388042835731622,
        0.0006969344869229568,
        0.0011799103994799723,
        -9.258270551964977e-5,
        0.0012066710711265273,
        0.00038131882803247186,
        0.0006598597637974114,
        0.000452389436043844,
        0.0003558087477472064,
        -1.992042492707195e-5,
        -0.000507952809884533,
        0.00019076602676948228,
        -0.000450281269117916,
        0.0008351423827437062,
        0.0007563108030747699,
        0.000421017010165618,
        0.0006779514329132588,
        0.0005631371734706867,
    ]
    @test isapprox(bsgm, bsgmt)

    asset_statistics!(portfolio, mu_type = :BOP, mu_target = :GM)
    bopgm = copy(portfolio.mu)
    bopgmt = [
        0.00016917378887231472,
        0.00018160113183457628,
        0.00022017632122135324,
        0.00020521224029664158,
        0.0003778257043783738,
        -7.695772718287296e-5,
        0.00038738985056862576,
        9.24125938068311e-5,
        0.00019196189753174021,
        0.00011781291610921848,
        8.32954034613955e-5,
        -5.0988548109821304e-5,
        -0.0002254091731583472,
        2.4309861845846202e-5,
        -0.00020479761847862714,
        0.0002546071335838931,
        0.00022643307419105795,
        0.00010660054926711702,
        0.00019842778039652644,
        0.00015739366972331245,
    ]
    @test isapprox(bsgm, bsgmt)

    asset_statistics!(portfolio, mu_type = :JS, mu_target = :VW)
    jsvw = copy(portfolio.mu)
    jsvwt = [
        0.0005962555831924726,
        0.0006415098938267387,
        0.0007819818843870736,
        0.0007274900136324292,
        0.001356063904844158,
        -0.00030003512981584556,
        0.001390891851892819,
        0.0003167288189678275,
        0.0006792387398634284,
        0.00040922438130752903,
        0.0002835284667077342,
        -0.0002054680690806927,
        -0.000840622757491449,
        6.873194654195269e-5,
        -0.0007655655468742032,
        0.0009073620789126582,
        0.0008047659214344713,
        0.00036839442002307234,
        0.000702784325800534,
        0.0005533581454299117,
    ]
    @test isapprox(jsvw, jsvwt)

    asset_statistics!(portfolio, mu_type = :BS, mu_target = :VW)
    bsvw = copy(portfolio.mu)
    bsvwt = [
        0.0005338285186301338,
        0.0005684298660735894,
        0.0006758344444072082,
        0.0006341700785954429,
        0.0011147763081207544,
        -0.00015147341032380464,
        0.0011414056806530696,
        0.0003201029629179168,
        0.0005972772596601718,
        0.00039082486862451814,
        0.00029471804581950544,
        -7.91676414513528e-5,
        -0.0005648055341960804,
        0.00013048509387008866,
        -0.0005074169542728796,
        0.0007716998683304457,
        0.000693255069558542,
        0.00035960636906711714,
        0.0006152801634355449,
        0.0005010292310561348,
    ]
    @test isapprox(bsvw, bsvwt)

    asset_statistics!(portfolio, mu_type = :BOP, mu_target = :VW)
    bopvw = copy(portfolio.mu)
    bopvwt = [
        0.00015313828431741356,
        0.00016556562727967512,
        0.00020414081666645203,
        0.0001891767357417404,
        0.00036179019982347235,
        -9.299323173777384e-5,
        0.00037135434601372436,
        7.637708925193004e-5,
        0.00017592639297683903,
        0.0001017774115543174,
        6.725989890649445e-5,
        -6.70240526647222e-5,
        -0.00024144467771324788,
        8.27435729094522e-6,
        -0.00022083312303352787,
        0.00023857162902899187,
        0.00021039756963615674,
        9.056504471221594e-5,
        0.00018239227584162526,
        0.00014135816516841132,
    ]
    @test isapprox(bsvw, bsvwt)

    asset_statistics!(portfolio, mu_type = :JS, mu_target = :SE)
    jsse = copy(portfolio.mu)
    jsset = [
        0.0005441589609781389,
        0.0005935020904084804,
        0.0007466660103623951,
        0.0006872506885098965,
        0.0013726175062978338,
        -0.0004331134367079999,
        0.0014105922290353827,
        0.0002393763863887135,
        0.0006346398142441448,
        0.0003402291104782567,
        0.00020317631493160286,
        -0.0003300020501394817,
        -0.0010225442535071647,
        -3.102750669731119e-5,
        -0.0009407054716041901,
        0.000883374559885473,
        0.0007715086313905049,
        0.00029571007933939126,
        0.0006603127916494866,
        0.0004973856526660391,
    ]
    @test isapprox(jsse, jsset)

    asset_statistics!(portfolio, mu_type = :BS, mu_target = :SE)
    bsse = copy(portfolio.mu)
    bsset = [
        0.00039511694346837297,
        0.0004306923523558474,
        0.00054112047359735,
        0.0004982832155335399,
        0.0009924189759160213,
        -0.0003094768985417447,
        0.00101979799107727,
        0.00017537480635680485,
        0.00046035182801232744,
        0.00024808760220746524,
        0.0001492752792552546,
        -0.00023513565224304845,
        -0.000734444722038041,
        -1.958098936102768e-5,
        -0.0006754405980057115,
        0.0006396846020554542,
        0.0005590315062196169,
        0.0002159902716505294,
        0.00047886153096587204,
        0.0003613943241810836,
    ]
    @test isapprox(bsse, bsset)

    asset_statistics!(portfolio, mu_type = :BOP, mu_target = :SE)
    bopse = copy(portfolio.mu)
    bopset = [
        0.00013646827659120816,
        0.00014889561955346972,
        0.00018747080894024668,
        0.00017250672801553501,
        0.00034512019209726716,
        -0.00010966323946397949,
        0.0003546843382875191,
        5.970708152572455e-5,
        0.00015925638525063365,
        8.510740382811192e-5,
        5.058989118028895e-5,
        -8.369406039092783e-5,
        -0.0002581146854394537,
        -8.395650435260338e-6,
        -0.00023750313075973365,
        0.00022190162130278655,
        0.00019372756190995139,
        7.389503698601047e-5,
        0.00016572226811541988,
        0.0001246881574422059,
    ]
    @test isapprox(bsse, bsset)

    portfolio.mu_type = :Default
    asset_statistics!(portfolio)
    mu1 = copy(portfolio.mu)
    asset_statistics!(
        portfolio,
        mu_weights = eweights(size(portfolio.returns, 1), eps(), scale = true),
    )
    mu2 = copy(portfolio.mu)
    @test isapprox(mu1, mu2)
    asset_statistics!(
        portfolio,
        mu_weights = eweights(size(portfolio.returns, 1), 1 - eps(), scale = true),
    )
    mu3 = copy(portfolio.mu)
    @test isapprox(mu3, portfolio.returns[end, 1:end])

    asset_statistics!(portfolio, cov_type = :Full)
    cov1 = copy(portfolio.cov)
    cov2 = cov(portfolio.returns)
    @test isapprox(cov1, cov2)

    asset_statistics!(portfolio, cov_type = :Semi)
    cov3 = copy(portfolio.cov)

    semiret = min.(portfolio.returns .- 0, 0)
    cov4 = cov(StatsBase.SimpleCovariance(; corrected = true), semiret, mean = 0)
    @test isapprox(cov3, cov4)

    cov5 = transpose(semiret) * semiret / (size(semiret, 1) - 1)
    @test isapprox(cov3, cov5)

    asset_statistics!(
        portfolio,
        cov_type = :Semi,
        cov_est = StatsBase.SimpleCovariance(; corrected = false),
    )
    cov6 = copy(portfolio.cov)
    cov7 = transpose(semiret) * semiret / (size(semiret, 1))
    @test isapprox(cov6, cov7)

    portfolio = Portfolio(returns = returns)

    asset_statistics!(portfolio, cov_type = :Gerber1, std_kwargs = (; corrected = false))
    covg1 = copy(portfolio.cov)
    asset_statistics!(portfolio, cov_type = :Gerber2, std_kwargs = (; corrected = false))
    covg2 = copy(portfolio.cov)

    covgt1 = reshape(
        [
            0.00020974121242454938,
            6.250133585184752e-5,
            0.00010308920030405359,
            8.336113386524584e-5,
            0.00011572025672346055,
            3.836287594271049e-5,
            9.653212653585173e-5,
            3.1883152115014425e-5,
            5.7365584297502435e-5,
            4.797874155062979e-5,
            2.5019111703636648e-5,
            7.07499647690489e-5,
            1.919340415249585e-5,
            2.7635142768275865e-5,
            2.4899996577966644e-5,
            4.5818889711417205e-5,
            7.148890225301703e-5,
            3.797093766066356e-5,
            5.4206126776390346e-5,
            5.430868038079555e-5,
            6.250133585184752e-5,
            0.00021128710779431086,
            6.896931621089687e-5,
            6.31356778021311e-5,
            7.774945281161811e-5,
            3.882158442508595e-5,
            0.00010925451077843667,
            3.1930988237114795e-5,
            5.6506739289969694e-5,
            4.376206209763014e-5,
            2.554935233529653e-5,
            6.568371505107873e-5,
            2.8093343086444576e-5,
            3.1902179088675707e-5,
            3.5839879298544966e-5,
            6.0635288777962045e-5,
            5.847041542925502e-5,
            3.3677708529122014e-5,
            5.2554705292333276e-5,
            4.311682087740567e-5,
            0.00010308920030405359,
            6.896931621089687e-5,
            0.000256954022085703,
            8.21464016388811e-5,
            0.00011861824072234456,
            3.8297316476982224e-5,
            9.80211544843378e-5,
            2.0360337189652927e-5,
            5.7171168770933466e-5,
            4.5506304922970216e-5,
            2.2893293275143936e-5,
            7.52738320561967e-5,
            3.178132158303975e-5,
            2.0006874569844294e-5,
            1.990610418838896e-5,
            3.691354862764159e-5,
            7.193345065702455e-5,
            3.421692126589264e-5,
            5.1298725984165446e-5,
            5.3008504387511776e-5,
            8.336113386524584e-5,
            6.31356778021311e-5,
            8.21464016388811e-5,
            0.00040018011445070714,
            0.00010006056914689232,
            4.528543402192555e-5,
            0.0001378096166007681,
            3.118006736324835e-5,
            5.6536213903168096e-5,
            5.1978594587131e-5,
            2.2370446526698464e-5,
            8.790417559576765e-5,
            8.060293394984372e-5,
            3.153793507418763e-5,
            5.350327040620056e-5,
            5.50822067069581e-5,
            7.258446776763506e-5,
            3.4135496213278316e-5,
            5.646446357340958e-5,
            4.608290500591353e-5,
            0.00011572025672346055,
            7.774945281161811e-5,
            0.00011861824072234456,
            0.00010006056914689232,
            0.0003307345138947058,
            4.4508885077778627e-5,
            0.00011250016908942395,
            3.7174698433196484e-5,
            6.079712484932821e-5,
            4.837353612463215e-5,
            2.68574184309218e-5,
            7.559463647185589e-5,
            2.2896731194239402e-5,
            2.8836199417850844e-5,
            4.604151609381458e-5,
            5.330073489964903e-5,
            7.997168181991059e-5,
            3.5112726024940944e-5,
            5.6762531126068076e-5,
            6.203182070762331e-5,
            3.836287594271049e-5,
            3.882158442508595e-5,
            3.8297316476982224e-5,
            4.528543402192555e-5,
            4.4508885077778627e-5,
            0.00017888762723415697,
            6.470846121620126e-5,
            3.0341843550686635e-5,
            6.249225264851627e-5,
            5.851363025893238e-5,
            3.053607713353194e-5,
            7.857664921604262e-5,
            8.306038548137086e-5,
            4.024004073885486e-5,
            5.282807111447673e-5,
            4.46476686450183e-5,
            4.065334993458338e-5,
            3.411287236071691e-5,
            5.325683752452865e-5,
            3.777397463136236e-5,
            9.653212653585173e-5,
            0.00010925451077843667,
            9.80211544843378e-5,
            0.0001378096166007681,
            0.00011250016908942395,
            6.470846121620126e-5,
            0.001646344075294454,
            6.0281863383345436e-5,
            0.00011357544396509415,
            0.00010109560209650115,
            4.335739142933189e-5,
            9.240270648661293e-5,
            0.00012294016376712317,
            5.961962445537456e-5,
            0.00014475297064541138,
            0.00010536703797465925,
            0.00010640975822559856,
            5.3980004767739685e-5,
            9.176142515359876e-5,
            5.944895152347324e-5,
            3.1883152115014425e-5,
            3.1930988237114795e-5,
            2.0360337189652927e-5,
            3.118006736324835e-5,
            3.7174698433196484e-5,
            3.0341843550686635e-5,
            6.0281863383345436e-5,
            0.00016335269313907342,
            2.531913850897123e-5,
            3.518064521742837e-5,
            2.9224613819028337e-5,
            4.795930367789056e-5,
            5.9195505169616165e-5,
            1.8254144202435076e-5,
            1.6292977451999615e-5,
            5.874257792193607e-5,
            3.315916914318532e-5,
            2.8443441523077334e-5,
            2.7726145996789834e-5,
            3.239414212027499e-5,
            5.7365584297502435e-5,
            5.6506739289969694e-5,
            5.7171168770933466e-5,
            5.6536213903168096e-5,
            6.079712484932821e-5,
            6.249225264851627e-5,
            0.00011357544396509415,
            2.531913850897123e-5,
            0.00027589119578696634,
            7.955472135571965e-5,
            2.7895636897735858e-5,
            9.799192063537893e-5,
            0.00010121329413385771,
            5.187498163984717e-5,
            7.752656073980324e-5,
            8.280895619323395e-5,
            6.655277228781742e-5,
            4.16772440706494e-5,
            0.0001389129064723086,
            4.4587790083641915e-5,
            4.797874155062979e-5,
            4.376206209763014e-5,
            4.5506304922970216e-5,
            5.1978594587131e-5,
            4.837353612463215e-5,
            5.851363025893238e-5,
            0.00010109560209650115,
            3.518064521742837e-5,
            7.955472135571965e-5,
            0.00024305024441962947,
            2.991273017596313e-5,
            0.0001012798687186678,
            0.00010058404532128184,
            4.0095676833583735e-5,
            5.6053840090225026e-5,
            8.42718184647058e-5,
            4.8328610883378295e-5,
            3.485291477532223e-5,
            6.623082399674407e-5,
            4.480131845962774e-5,
            2.5019111703636648e-5,
            2.554935233529653e-5,
            2.2893293275143936e-5,
            2.2370446526698464e-5,
            2.68574184309218e-5,
            3.053607713353194e-5,
            4.335739142933189e-5,
            2.9224613819028337e-5,
            2.7895636897735858e-5,
            2.991273017596313e-5,
            0.00010523207922672109,
            3.8346589452670114e-5,
            3.3153772652402006e-5,
            2.7120949554690233e-5,
            3.291338337848911e-5,
            3.27809275373234e-5,
            2.663584778392028e-5,
            2.292264662243813e-5,
            3.3651246862384525e-5,
            2.2611451951324402e-5,
            7.07499647690489e-5,
            6.568371505107873e-5,
            7.52738320561967e-5,
            8.790417559576765e-5,
            7.559463647185589e-5,
            7.857664921604262e-5,
            9.240270648661293e-5,
            4.795930367789056e-5,
            9.799192063537893e-5,
            0.0001012798687186678,
            3.8346589452670114e-5,
            0.0007058986609157664,
            0.00017970842171632237,
            4.680044428300821e-5,
            0.00010728338804722919,
            0.00012036203496431589,
            6.863703788105435e-5,
            5.073287772575147e-5,
            8.21914782720405e-5,
            7.641141558976833e-5,
            1.919340415249585e-5,
            2.8093343086444576e-5,
            3.178132158303975e-5,
            8.060293394984372e-5,
            2.2896731194239402e-5,
            8.306038548137086e-5,
            0.00012294016376712317,
            5.9195505169616165e-5,
            0.00010121329413385771,
            0.00010058404532128184,
            3.3153772652402006e-5,
            0.00017970842171632237,
            0.0019417957296906064,
            5.041904922331697e-5,
            0.0001423909951567325,
            0.00013461278518958278,
            4.480714465918543e-5,
            3.29588900215982e-5,
            7.08238354754046e-5,
            5.863305409330455e-5,
            2.7635142768275865e-5,
            3.1902179088675707e-5,
            2.0006874569844294e-5,
            3.153793507418763e-5,
            2.8836199417850844e-5,
            4.024004073885486e-5,
            5.961962445537456e-5,
            1.8254144202435076e-5,
            5.187498163984717e-5,
            4.0095676833583735e-5,
            2.7120949554690233e-5,
            4.680044428300821e-5,
            5.041904922331697e-5,
            0.00014347473100888376,
            9.490198692412218e-5,
            4.2408320469182906e-5,
            3.80851702989904e-5,
            2.607301255274926e-5,
            4.937558691036947e-5,
            1.8775056994051316e-5,
            2.4899996577966644e-5,
            3.5839879298544966e-5,
            1.990610418838896e-5,
            5.350327040620056e-5,
            4.604151609381458e-5,
            5.282807111447673e-5,
            0.00014475297064541138,
            1.6292977451999615e-5,
            7.752656073980324e-5,
            5.6053840090225026e-5,
            3.291338337848911e-5,
            0.00010728338804722919,
            0.0001423909951567325,
            9.490198692412218e-5,
            0.0009925919307124018,
            7.958886029744778e-5,
            3.416694732093082e-5,
            1.71643678873937e-5,
            5.863617440251285e-5,
            2.135666399668303e-5,
            4.5818889711417205e-5,
            6.0635288777962045e-5,
            3.691354862764159e-5,
            5.50822067069581e-5,
            5.330073489964903e-5,
            4.46476686450183e-5,
            0.00010536703797465925,
            5.874257792193607e-5,
            8.280895619323395e-5,
            8.42718184647058e-5,
            3.27809275373234e-5,
            0.00012036203496431589,
            0.00013461278518958278,
            4.2408320469182906e-5,
            7.958886029744778e-5,
            0.0005048938009079831,
            5.583734790614842e-5,
            3.2682879382105955e-5,
            6.487903321451377e-5,
            4.903860852666143e-5,
            7.148890225301703e-5,
            5.847041542925502e-5,
            7.193345065702455e-5,
            7.258446776763506e-5,
            7.997168181991059e-5,
            4.065334993458338e-5,
            0.00010640975822559856,
            3.315916914318532e-5,
            6.655277228781742e-5,
            4.8328610883378295e-5,
            2.663584778392028e-5,
            6.863703788105435e-5,
            4.480714465918543e-5,
            3.80851702989904e-5,
            3.416694732093082e-5,
            5.583734790614842e-5,
            0.00016225723157954668,
            3.968226502212513e-5,
            6.106654743182969e-5,
            4.9497511584460304e-5,
            3.797093766066356e-5,
            3.3677708529122014e-5,
            3.421692126589264e-5,
            3.4135496213278316e-5,
            3.5112726024940944e-5,
            3.411287236071691e-5,
            5.3980004767739685e-5,
            2.8443441523077334e-5,
            4.16772440706494e-5,
            3.485291477532223e-5,
            2.292264662243813e-5,
            5.073287772575147e-5,
            3.29588900215982e-5,
            2.607301255274926e-5,
            1.71643678873937e-5,
            3.2682879382105955e-5,
            3.968226502212513e-5,
            0.00012188927616787188,
            4.1230763833977815e-5,
            3.171017222109923e-5,
            5.4206126776390346e-5,
            5.2554705292333276e-5,
            5.1298725984165446e-5,
            5.646446357340958e-5,
            5.6762531126068076e-5,
            5.325683752452865e-5,
            9.176142515359876e-5,
            2.7726145996789834e-5,
            0.0001389129064723086,
            6.623082399674407e-5,
            3.3651246862384525e-5,
            8.21914782720405e-5,
            7.08238354754046e-5,
            4.937558691036947e-5,
            5.863617440251285e-5,
            6.487903321451377e-5,
            6.106654743182969e-5,
            4.1230763833977815e-5,
            0.00018469455212296524,
            4.1818740776637804e-5,
            5.430868038079555e-5,
            4.311682087740567e-5,
            5.3008504387511776e-5,
            4.608290500591353e-5,
            6.203182070762331e-5,
            3.777397463136236e-5,
            5.944895152347324e-5,
            3.239414212027499e-5,
            4.4587790083641915e-5,
            4.480131845962774e-5,
            2.2611451951324402e-5,
            7.641141558976833e-5,
            5.863305409330455e-5,
            1.8775056994051316e-5,
            2.135666399668303e-5,
            4.903860852666143e-5,
            4.9497511584460304e-5,
            3.171017222109923e-5,
            4.1818740776637804e-5,
            0.0001577154410284821,
        ],
        20,
        20,
    )

    covgt2 = reshape(
        [
            0.00020974121242454936,
            8.70065424759032e-5,
            0.00013662231814612843,
            0.0001183229955995031,
            0.000155490860814295,
            5.470393847285265e-5,
            0.00014484835373731222,
            4.66528587758943e-5,
            8.0701287312996e-5,
            6.816628249900913e-5,
            3.643033465333079e-5,
            0.00010446441111282032,
            2.830452275749481e-5,
            4.014494241623802e-5,
            3.602179536253007e-5,
            6.714489577947147e-5,
            9.634380592297494e-5,
            5.440874346418598e-5,
            7.550849319735956e-5,
            7.743947610504054e-5,
            8.70065424759032e-5,
            0.00021128710779431083,
            9.579166305475039e-5,
            8.977604140159876e-5,
            0.00010946906408577506,
            5.568221796905987e-5,
            0.0001622603419926778,
            4.646235640248941e-5,
            8.101472553307369e-5,
            6.322290581474791e-5,
            3.656762437904325e-5,
            9.677012573113802e-5,
            4.151462663988477e-5,
            4.58612104902158e-5,
            5.140571820872446e-5,
            8.878331036982379e-5,
            8.143216919644634e-5,
            4.7772650083271003e-5,
            7.471184893264415e-5,
            6.073456693430828e-5,
            0.00013662231814612843,
            9.579166305475039e-5,
            0.00025695402208570294,
            0.00011625231675956524,
            0.00015898359903319308,
            5.439415682228453e-5,
            0.00014622547271329835,
            2.9944008816319307e-5,
            8.158169064997873e-5,
            6.514594822408642e-5,
            3.247454896021071e-5,
            0.0001131472029456251,
            4.7518529968612995e-5,
            2.8844281828734148e-5,
            2.8471008882917638e-5,
            5.454434482943973e-5,
            9.860345228040192e-5,
            4.8908760235395564e-5,
            7.302191921587462e-5,
            7.557579819604379e-5,
            0.0001183229955995031,
            8.977604140159876e-5,
            0.00011625231675956524,
            0.0004001801144507071,
            0.00014229922894717735,
            6.463635339853627e-5,
            0.0002027189842201594,
            4.570209170875722e-5,
            8.111209884156549e-5,
            7.357754025709192e-5,
            3.1976988826564284e-5,
            0.00013088167641490484,
            0.00011791199161477501,
            4.573201135639379e-5,
            7.596389534870286e-5,
            8.173478702354349e-5,
            0.00010149887516408042,
            4.8948901064002e-5,
            8.024387174882533e-5,
            6.614156203006114e-5,
            0.000155490860814295,
            0.00010946906408577506,
            0.00015898359903319308,
            0.00014229922894717735,
            0.0003307345138947058,
            6.502823894711227e-5,
            0.00016637867628405356,
            5.4403654986591854e-5,
            8.692231844976575e-5,
            6.886409340988716e-5,
            3.814222669770251e-5,
            0.0001130768288552334,
            3.420722302422444e-5,
            4.1968740411643694e-5,
            6.687992350286982e-5,
            7.862374531990129e-5,
            0.00011061901224732318,
            5.179435437716664e-5,
            8.23355500962909e-5,
            9.030508849626846e-5,
            5.470393847285265e-5,
            5.568221796905987e-5,
            5.439415682228453e-5,
            6.463635339853627e-5,
            6.502823894711227e-5,
            0.00017888762723415697,
            9.673193707013383e-5,
            4.437157156581276e-5,
            8.980341947137229e-5,
            8.320349298869806e-5,
            4.3168787974994604e-5,
            0.00011261612762585564,
            0.00012200734510681284,
            5.8325937820590826e-5,
            7.589529243381545e-5,
            6.507970307648992e-5,
            5.6909879471024164e-5,
            4.8542225267319e-5,
            7.584668909730006e-5,
            5.548616626560539e-5,
            0.00014484835373731222,
            0.0001622603419926778,
            0.00014622547271329835,
            0.0002027189842201594,
            0.00016637867628405356,
            9.673193707013383e-5,
            0.0016463440752944537,
            9.07041636108483e-5,
            0.00016403817375841968,
            0.00015138047294022854,
            6.491313951500416e-5,
            0.0001423334990172544,
            0.00018725504603040656,
            9.032051677504037e-5,
            0.0002156275323104518,
            0.00015802022844391839,
            0.0001561756396807977,
            8.197698540076858e-5,
            0.00013833120393823137,
            8.933091031704791e-5,
            4.66528587758943e-5,
            4.646235640248941e-5,
            2.9944008816319307e-5,
            4.570209170875722e-5,
            5.4403654986591854e-5,
            4.437157156581276e-5,
            9.07041636108483e-5,
            0.0001633526931390734,
            3.7077618371382444e-5,
            5.1370845637867264e-5,
            4.1587766511183166e-5,
            7.043861136733189e-5,
            8.752898754425453e-5,
            2.6338967892948126e-5,
            2.408516833155571e-5,
            8.494325539139998e-5,
            4.797240157327402e-5,
            4.1859048788647364e-5,
            4.050556718736145e-5,
            4.739590741697392e-5,
            8.0701287312996e-5,
            8.101472553307369e-5,
            8.158169064997873e-5,
            8.111209884156549e-5,
            8.692231844976575e-5,
            8.980341947137229e-5,
            0.00016403817375841968,
            3.7077618371382444e-5,
            0.0002758911957869664,
            0.0001103121676939658,
            3.937951993657368e-5,
            0.00014419900642482117,
            0.0001479490455259325,
            7.435687139964868e-5,
            0.00011141911162049639,
            0.00011922886171465122,
            9.029642879293375e-5,
            5.905845551468503e-5,
            0.00017014049270036387,
            6.346874873329079e-5,
            6.816628249900913e-5,
            6.322290581474791e-5,
            6.514594822408642e-5,
            7.357754025709192e-5,
            6.886409340988716e-5,
            8.320349298869806e-5,
            0.00015138047294022854,
            5.1370845637867264e-5,
            0.0001103121676939658,
            0.00024305024441962945,
            4.19751887723022e-5,
            0.0001465521948763164,
            0.00014508752113268447,
            5.827063122995585e-5,
            7.98468591338854e-5,
            0.0001196812130624784,
            6.905576797643164e-5,
            4.9328616318109774e-5,
            9.261616612023958e-5,
            6.367751664975844e-5,
            3.643033465333079e-5,
            3.656762437904325e-5,
            3.247454896021071e-5,
            3.1976988826564284e-5,
            3.814222669770251e-5,
            4.3168787974994604e-5,
            6.491313951500416e-5,
            4.1587766511183166e-5,
            3.937951993657368e-5,
            4.19751887723022e-5,
            0.00010523207922672109,
            5.619590801029284e-5,
            4.852744431453035e-5,
            3.852876031486888e-5,
            4.622259911245658e-5,
            4.7798269379021414e-5,
            3.714917018621213e-5,
            3.294908550197259e-5,
            4.7716725535356175e-5,
            3.1649465077283306e-5,
            0.00010446441111282032,
            9.677012573113802e-5,
            0.0001131472029456251,
            0.00013088167641490484,
            0.0001130768288552334,
            0.00011261612762585564,
            0.0001423334990172544,
            7.043861136733189e-5,
            0.00014419900642482117,
            0.0001465521948763164,
            5.619590801029284e-5,
            0.0007058986609157663,
            0.0002679071114442697,
            7.077340619506927e-5,
            0.0001569275191097776,
            0.00017876289201031217,
            9.947001305320075e-5,
            7.630993326897423e-5,
            0.00012214946001818907,
            0.00011339384027598847,
            2.830452275749481e-5,
            4.151462663988477e-5,
            4.7518529968612995e-5,
            0.00011791199161477501,
            3.420722302422444e-5,
            0.00012200734510681284,
            0.00018725504603040656,
            8.752898754425453e-5,
            0.0001479490455259325,
            0.00014508752113268447,
            4.852744431453035e-5,
            0.0002679071114442697,
            0.0019417957296906068,
            7.363576423154904e-5,
            0.0002029062787455756,
            0.0001987797776016755,
            6.499408649491043e-5,
            4.928429542640213e-5,
            0.00010278103162016824,
            8.522821576009881e-5,
            4.014494241623802e-5,
            4.58612104902158e-5,
            2.8844281828734148e-5,
            4.573201135639379e-5,
            4.1968740411643694e-5,
            5.8325937820590826e-5,
            9.032051677504037e-5,
            2.6338967892948126e-5,
            7.435687139964868e-5,
            5.827063122995585e-5,
            3.852876031486888e-5,
            7.077340619506927e-5,
            7.363576423154904e-5,
            0.00014347473100888379,
            0.00013455366620922977,
            6.265196393368165e-5,
            5.3434365294935004e-5,
            3.761355291236558e-5,
            7.015695550795746e-5,
            2.7215871982211317e-5,
            3.602179536253007e-5,
            5.140571820872446e-5,
            2.8471008882917638e-5,
            7.596389534870286e-5,
            6.687992350286982e-5,
            7.589529243381545e-5,
            0.0002156275323104518,
            2.408516833155571e-5,
            0.00011141911162049639,
            7.98468591338854e-5,
            4.622259911245658e-5,
            0.0001569275191097776,
            0.0002029062787455756,
            0.00013455366620922977,
            0.0009925919307124016,
            0.00011547316588305963,
            4.7962405424236676e-5,
            2.505921297910968e-5,
            8.592012571786864e-5,
            3.0519816829842606e-5,
            6.714489577947147e-5,
            8.878331036982379e-5,
            5.454434482943973e-5,
            8.173478702354349e-5,
            7.862374531990129e-5,
            6.507970307648992e-5,
            0.00015802022844391839,
            8.494325539139998e-5,
            0.00011922886171465122,
            0.0001196812130624784,
            4.7798269379021414e-5,
            0.00017876289201031217,
            0.0001987797776016755,
            6.265196393368165e-5,
            0.00011547316588305963,
            0.000504893800907983,
            8.091319798773893e-5,
            4.7943893927250424e-5,
            9.329148647305474e-5,
            7.175792614465586e-5,
            9.634380592297494e-5,
            8.143216919644634e-5,
            9.860345228040192e-5,
            0.00010149887516408042,
            0.00011061901224732318,
            5.6909879471024164e-5,
            0.0001561756396807977,
            4.797240157327402e-5,
            9.029642879293375e-5,
            6.905576797643164e-5,
            3.714917018621213e-5,
            9.947001305320075e-5,
            6.499408649491043e-5,
            5.3434365294935004e-5,
            4.7962405424236676e-5,
            8.091319798773893e-5,
            0.0001622572315795467,
            5.6248126683981794e-5,
            8.406589751415287e-5,
            6.97134918583332e-5,
            5.440874346418598e-5,
            4.7772650083271003e-5,
            4.8908760235395564e-5,
            4.8948901064002e-5,
            5.179435437716664e-5,
            4.8542225267319e-5,
            8.197698540076858e-5,
            4.1859048788647364e-5,
            5.905845551468503e-5,
            4.9328616318109774e-5,
            3.294908550197259e-5,
            7.630993326897423e-5,
            4.928429542640213e-5,
            3.761355291236558e-5,
            2.505921297910968e-5,
            4.7943893927250424e-5,
            5.6248126683981794e-5,
            0.00012188927616787188,
            5.7504006732060984e-5,
            4.427454016404935e-5,
            7.550849319735956e-5,
            7.471184893264415e-5,
            7.302191921587462e-5,
            8.024387174882533e-5,
            8.23355500962909e-5,
            7.584668909730006e-5,
            0.00013833120393823137,
            4.050556718736145e-5,
            0.00017014049270036387,
            9.261616612023958e-5,
            4.7716725535356175e-5,
            0.00012214946001818907,
            0.00010278103162016824,
            7.015695550795746e-5,
            8.592012571786864e-5,
            9.329148647305474e-5,
            8.406589751415287e-5,
            5.7504006732060984e-5,
            0.00018469455212296524,
            5.932547174202987e-5,
            7.743947610504054e-5,
            6.073456693430828e-5,
            7.557579819604379e-5,
            6.614156203006114e-5,
            9.030508849626846e-5,
            5.548616626560539e-5,
            8.933091031704791e-5,
            4.739590741697392e-5,
            6.346874873329079e-5,
            6.367751664975844e-5,
            3.1649465077283306e-5,
            0.00011339384027598847,
            8.522821576009881e-5,
            2.7215871982211317e-5,
            3.0519816829842606e-5,
            7.175792614465586e-5,
            6.97134918583332e-5,
            4.427454016404935e-5,
            5.932547174202987e-5,
            0.00015771544102848213,
        ],
        20,
        20,
    )
    @test isapprox(covgt1, covg1)
    @test isapprox(covgt2, covg2)

    portfolio = HCPortfolio(
        returns = returns,
        solvers = Dict(
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false),
            ),
        ),
        alloc_solvers = Dict(
            :HiGHS => Dict(
                :solver => (HiGHS.Optimizer),
                :params => Dict("log_to_console" => false),
            ),
        ),
        latest_prices = Vector(DataFrame(A[end])[1, 2:end]),
    )

    asset_statistics!(portfolio, jlogo = true)

    covj = copy(portfolio.cov)
    covjt = reshape(
        [
            0.00020997582228184737,
            9.803674633175464e-5,
            0.00014077374362954793,
            0.00011822768246482305,
            0.00015839638863970605,
            4.134249512939413e-5,
            9.741361595383921e-5,
            3.088472057695859e-5,
            8.723400768938203e-5,
            4.695561415789377e-5,
            2.410793390349611e-5,
            7.697761692810674e-5,
            5.0213913154013506e-5,
            4.657297911600372e-5,
            6.041300540147265e-5,
            4.007622815237787e-5,
            9.852662188755091e-5,
            4.2581217516476454e-5,
            7.891750241335416e-5,
            8.308464134357728e-5,
            9.803674633175465e-5,
            0.00021152344684106046,
            8.070483057492823e-5,
            7.345023656198462e-5,
            8.622173019184438e-5,
            4.428661971580518e-5,
            0.0001302364476786511,
            3.0805102198474415e-5,
            9.441947447077707e-5,
            5.079396190194336e-5,
            2.5625742533149956e-5,
            6.843664330541139e-5,
            5.434336230275222e-5,
            4.824450286505276e-5,
            6.332376221790682e-5,
            4.338668439198836e-5,
            9.258430057865659e-5,
            4.32569168917907e-5,
            8.569427917973395e-5,
            5.800692429397668e-5,
            0.00014077374362954793,
            8.070483057492824e-5,
            0.0002572414426920628,
            9.907520278111458e-5,
            0.00015334295879523472,
            3.9753234112169053e-5,
            9.26118854903671e-5,
            3.091630885459725e-5,
            8.337939553449811e-5,
            4.4888780957011246e-5,
            2.328729997945842e-5,
            7.756460767061063e-5,
            4.799509093176798e-5,
            4.566092116229601e-5,
            5.8836037779678905e-5,
            3.829743915517536e-5,
            0.00010166996305493107,
            4.2204522581317837e-5,
            7.526496401459743e-5,
            8.802924838121843e-5,
            0.000118227682464823,
            7.345023656198461e-5,
            9.907520278111457e-5,
            0.0004006277432140748,
            0.00013259642444595363,
            3.656822111047857e-5,
            8.810273446710931e-5,
            2.9742503351053496e-5,
            7.622510549864202e-5,
            4.1020950028742595e-5,
            2.1533972054045348e-5,
            6.244898023158406e-5,
            4.386538350476626e-5,
            4.293671627681013e-5,
            5.492306428908416e-5,
            3.499344009076798e-5,
            0.00010093601577900456,
            4.0169975051465906e-5,
            6.85725638068425e-5,
            6.258847359456458e-5,
            0.00015839638863970608,
            8.622173019184438e-5,
            0.00015334295879523472,
            0.00013259642444595363,
            0.0003311044630153935,
            4.038058059540701e-5,
            9.583901646637e-5,
            3.161780823422457e-5,
            8.463726955701523e-5,
            4.555542067291643e-5,
            2.367290551940056e-5,
            7.328255734548557e-5,
            4.87135900731346e-5,
            4.653304028701638e-5,
            5.9897079161003374e-5,
            3.886927014428788e-5,
            0.00010448970386759234,
            4.309114571855092e-5,
            7.634401145955454e-5,
            7.776687178020369e-5,
            4.134249512939419e-5,
            4.4286619715805225e-5,
            3.9753234112169114e-5,
            3.656822111047864e-5,
            4.0380580595407055e-5,
            0.00017908772525119732,
            6.489402909991504e-5,
            2.5028507197328273e-5,
            9.962273724791334e-5,
            8.680193208085993e-5,
            5.277338640116081e-5,
            6.097685395858871e-5,
            7.124243170541165e-5,
            6.946631411775527e-5,
            0.00010068570060338062,
            5.388381392162784e-5,
            5.3206272630080165e-5,
            4.00742109894251e-5,
            9.128928696697807e-5,
            3.6671470230580326e-5,
            9.741361595383927e-5,
            0.00013023644767865114,
            9.261188549036715e-5,
            8.810273446710938e-5,
            9.583901646637e-5,
            6.4894029099915e-5,
            0.0016481856234771088,
            4.424596013731999e-5,
            0.00013873440279034985,
            7.462295424808122e-5,
            3.7471916631902144e-5,
            9.514621072757057e-5,
            7.984666848657677e-5,
            7.004888096269947e-5,
            9.22439789559985e-5,
            6.375373838021073e-5,
            0.00013058586088202266,
            6.246142917350003e-5,
            0.00012602293719272368,
            7.362065024292618e-5,
            3.08847205769586e-5,
            3.080510219847442e-5,
            3.091630885459727e-5,
            2.9742503351053513e-5,
            3.161780823422457e-5,
            2.5028507197328253e-5,
            4.4245960137319985e-5,
            0.0001635354142723386,
            5.178413394383976e-5,
            2.8116150979283105e-5,
            1.469733389523753e-5,
            3.4709767831462856e-5,
            2.991739160561292e-5,
            2.901108129345606e-5,
            3.718896301005846e-5,
            2.3872325284642976e-5,
            4.6014215745053086e-5,
            4.450058196330504e-5,
            4.723912468936465e-5,
            2.5631155975938334e-5,
            8.723400768938216e-5,
            9.441947447077717e-5,
            8.337939553449825e-5,
            7.622510549864213e-5,
            8.463726955701532e-5,
            9.962273724791336e-5,
            0.0001387344027903499,
            5.1784133943839795e-5,
            0.0002761997989142426,
            0.0001258404123778019,
            5.5197475609638086e-5,
            0.0001417373885547038,
            0.0001484507282492688,
            9.14050552075807e-5,
            0.0001353618737737425,
            0.00011844433793628722,
            0.00010985321115130256,
            7.870483515637123e-5,
            0.0002011793054113852,
            7.788398396676904e-5,
            4.6955614157893846e-5,
            5.079396190194342e-5,
            4.488878095701133e-5,
            4.102095002874267e-5,
            4.555542067291649e-5,
            8.680193208085995e-5,
            7.462295424808129e-5,
            2.8116150979283132e-5,
            0.00012584041237780196,
            0.00024332211270197752,
            3.679005664812949e-5,
            7.277466203867336e-5,
            0.0001457443295728806,
            5.72686623984398e-5,
            8.137270380669468e-5,
            0.00010005844523863923,
            5.910666680743218e-5,
            4.341172302514207e-5,
            0.00010817672206732099,
            4.1999000458699494e-5,
            2.4107933903496137e-5,
            2.5625742533149973e-5,
            2.3287299979458445e-5,
            2.1533972054045372e-5,
            2.3672905519400578e-5,
            5.277338640116079e-5,
            3.747191663190216e-5,
            1.4697333895237537e-5,
            5.5197475609638065e-5,
            3.6790056648129484e-5,
            0.00010534978848760097,
            3.447283147876063e-5,
            3.476298535587916e-5,
            4.853189091930909e-5,
            5.9253564059689923e-5,
            2.7163178806229894e-5,
            3.156891859240837e-5,
            2.412239965940403e-5,
            5.140975472359201e-5,
            2.1234135644375778e-5,
            7.697761692810682e-5,
            6.843664330541146e-5,
            7.75646076706107e-5,
            6.244898023158416e-5,
            7.328255734548563e-5,
            6.097685395858872e-5,
            9.514621072757063e-5,
            3.4709767831462876e-5,
            0.0001417373885547038,
            7.277466203867336e-5,
            3.447283147876066e-5,
            0.0007066882567333448,
            7.998599079162263e-5,
            6.019307841605814e-5,
            8.302509502935594e-5,
            6.388032472082338e-5,
            8.383990731316273e-5,
            5.15179129885043e-5,
            0.00012182889805680192,
            0.00010811590662763465,
            5.021391315401357e-5,
            5.43433623027523e-5,
            4.799509093176807e-5,
            4.386538350476632e-5,
            4.871359007313466e-5,
            7.124243170541166e-5,
            7.984666848657684e-5,
            2.991739160561294e-5,
            0.00014845072824926883,
            0.0001457443295728806,
            3.4762985355879176e-5,
            7.998599079162263e-5,
            0.0019439677607081564,
            5.6091190985797525e-5,
            8.143828238380116e-5,
            0.00023386599375945137,
            6.320360210863741e-5,
            4.576565505327067e-5,
            0.00011581541521370314,
            4.487264327698091e-5,
            4.657297911600371e-5,
            4.824450286505274e-5,
            4.5660921162296005e-5,
            4.293671627681013e-5,
            4.6533040287016354e-5,
            6.94663141177552e-5,
            7.00488809626994e-5,
            2.901108129345604e-5,
            9.140505520758058e-5,
            5.72686623984397e-5,
            4.853189091930907e-5,
            6.019307841605804e-5,
            5.609119098579743e-5,
            0.00014363521728517984,
            0.00015453720776819601,
            4.42507949454857e-5,
            6.444039069141756e-5,
            5.124788460850674e-5,
            8.774182747957663e-5,
            4.0057278945382356e-5,
            6.041300540147268e-5,
            6.332376221790682e-5,
            5.883603777967893e-5,
            5.49230642890842e-5,
            5.989707916100338e-5,
            0.00010068570060338056,
            9.224397895599845e-5,
            3.718896301005845e-5,
            0.00013536187377374235,
            8.137270380669458e-5,
            5.925356405968988e-5,
            8.302509502935583e-5,
            8.143828238380108e-5,
            0.00015453720776819607,
            0.0009937022125140933,
            6.413867647869578e-5,
            8.159223034002054e-5,
            6.341331115400401e-5,
            0.00012057821002300521,
            5.249442561506602e-5,
            4.007622815237791e-5,
            4.33866843919884e-5,
            3.8297439155175416e-5,
            3.4993440090768036e-5,
            3.8869270144287924e-5,
            5.388381392162783e-5,
            6.375373838021077e-5,
            2.3872325284642983e-5,
            0.00011844433793628725,
            0.00010005844523863921,
            2.7163178806229897e-5,
            6.388032472082338e-5,
            0.00023386599375945131,
            4.4250794945485765e-5,
            6.413867647869583e-5,
            0.0005054585590745461,
            5.040215722614181e-5,
            3.648074552416068e-5,
            9.256991406046881e-5,
            3.582548495164837e-5,
            9.85266218875509e-5,
            9.258430057865655e-5,
            0.00010166996305493103,
            0.00010093601577900456,
            0.00010448970386759227,
            5.320627263008006e-5,
            0.00013058586088202253,
            4.601421574505306e-5,
            0.00010985321115130236,
            5.910666680743206e-5,
            3.156891859240832e-5,
            8.383990731316258e-5,
            6.320360210863729e-5,
            6.444039069141754e-5,
            8.159223034002047e-5,
            5.0402157226141716e-5,
            0.00016243872736431124,
            6.127832941435988e-5,
            9.838072451447072e-5,
            7.735879911530241e-5,
            4.258121751647646e-5,
            4.325691689179071e-5,
            4.220452258131785e-5,
            4.016997505146593e-5,
            4.309114571855092e-5,
            4.007421098942506e-5,
            6.24614291735e-5,
            4.450058196330504e-5,
            7.870483515637113e-5,
            4.341172302514201e-5,
            2.412239965940402e-5,
            5.151791298850423e-5,
            4.576565505327062e-5,
            5.124788460850676e-5,
            6.341331115400401e-5,
            3.6480745524160645e-5,
            6.12783294143599e-5,
            0.00012202561764009533,
            7.235602099204436e-5,
            3.5948219586652974e-5,
            7.891750241335428e-5,
            8.569427917973406e-5,
            7.526496401459755e-5,
            6.857256380684262e-5,
            7.634401145955463e-5,
            9.128928696697808e-5,
            0.00012602293719272376,
            4.723912468936469e-5,
            0.0002011793054113852,
            0.00010817672206732099,
            5.140975472359204e-5,
            0.00012182889805680191,
            0.00011581541521370316,
            8.774182747957677e-5,
            0.00012057821002300536,
            9.256991406046881e-5,
            9.838072451447094e-5,
            7.235602099204444e-5,
            0.0001849011455817144,
            7.089867226693533e-5,
            8.308464134357728e-5,
            5.800692429397668e-5,
            8.802924838121843e-5,
            6.25884735945646e-5,
            7.776687178020369e-5,
            3.667147023058028e-5,
            7.362065024292616e-5,
            2.5631155975938327e-5,
            7.788398396676894e-5,
            4.199900045869944e-5,
            2.1234135644375764e-5,
            0.00010811590662763458,
            4.487264327698086e-5,
            4.005727894538237e-5,
            5.249442561506602e-5,
            3.582548495164833e-5,
            7.735879911530245e-5,
            3.5948219586652974e-5,
            7.089867226693525e-5,
            0.00015789185651061675,
        ],
        20,
        20,
    )

    @test isapprox(covjt, covj)
end
