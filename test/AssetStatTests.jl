using Test,
    PortfolioOptimiser,
    CSV,
    TimeSeries,
    DataFrames,
    StatsBase,
    Logging,
    GLM,
    LinearAlgebra,
    Clarabel

Logging.disable_logging(Logging.Warn)

A = TimeArray(CSV.File("./assets/stock_prices.csv"), timestamp = :date)
Y = percentchange(A)
returns = dropmissing!(DataFrame(Y))

@testset "Asset statistics" begin
    portfolio = HCPortfolio(returns = returns)

    asset_statistics!(portfolio)
    ret = cov_returns(portfolio.cov, seed = 0)
    @test isapprox(cov(ret), portfolio.cov)

    asset_statistics!(portfolio, codep_type = :Gerber0, cov_type = :Gerber0)
    covg0t = reshape(
        [
            0.00020997582228184753,
            0.00014286676675886976,
            0.0002025737223838591,
            0.00020336009590876273,
            0.00023711682736108787,
            9.656632715639064e-5,
            0.0002899203129180782,
            8.658423983214427e-5,
            0.00013683073396803812,
            0.0001186466538545447,
            6.610266383366646e-5,
            0.0001979065243169616,
            5.955796528697859e-5,
            7.442833914452206e-5,
            6.426266756609735e-5,
            0.00012772960592290366,
            0.00014724810908125564,
            9.709168576998946e-5,
            0.00012565948542829657,
            0.00013409062219316967,
            0.00014286676675886976,
            0.0002115234468410606,
            0.0001569237797659973,
            0.00015540195407949992,
            0.00018463523092379728,
            9.847866826406869e-5,
            0.00031384220837842085,
            8.482302611560734e-5,
            0.0001431654785547068,
            0.00011387453949672762,
            6.413429372873145e-5,
            0.00018313953332354252,
            7.94931442428848e-5,
            8.16189854014901e-5,
            9.035466557592565e-5,
            0.00016557742869947607,
            0.00013409269078622013,
            8.219757212168931e-5,
            0.00012930777288853835,
            0.00010375957260205976,
            0.0002025737223838591,
            0.0001569237797659973,
            0.0002572414426920628,
            0.0001988448157471263,
            0.00024082355078522343,
            9.390342561873313e-5,
            0.00028673999183567446,
            5.593774380992676e-5,
            0.0001424324326066504,
            0.00011458854695037505,
            5.5672094030821864e-5,
            0.0002271305139154119,
            9.408508252820126e-5,
            5.172212883671979e-5,
            4.9639759305660214e-5,
            0.00010438121177244035,
            0.00015664882134419384,
            8.577392138199345e-5,
            0.00012679783034381874,
            0.00013156808791280544,
            0.00020336009590876273,
            0.00015540195407949992,
            0.0001988448157471263,
            0.00040062774321407494,
            0.00024516925506005787,
            0.00011272757232496984,
            0.0003801405056246958,
            8.460686602422237e-5,
            0.00014364255248387715,
            0.0001260235138318128,
            5.6029392529102485e-5,
            0.0002530379772088931,
            0.0002197531290502378,
            8.252003827398015e-5,
            0.00013061883030894824,
            0.0001577924890167392,
            0.0001688708963919953,
            8.636863427512415e-5,
            0.00013865266001363816,
            0.00011724394537803321,
            0.00023711682736108787,
            0.00018463523092379728,
            0.00024082355078522343,
            0.00024516925506005787,
            0.0003311044630153933,
            0.00012069587922426419,
            0.00031954355816227566,
            0.00010090346071919407,
            0.00015180196599655967,
            0.00011881666444846987,
            6.505355559831275e-5,
            0.000223256623741852,
            6.71513565154453e-5,
            7.702349396124648e-5,
            0.0001200562294689135,
            0.0001499401842021239,
            0.0001783311215410475,
            9.870807705821862e-5,
            0.00014970553352583975,
            0.00016466229269763917,
            9.656632715639064e-5,
            9.847866826406869e-5,
            9.390342561873313e-5,
            0.00011272757232496984,
            0.00012069587922426419,
            0.00017908772525119756,
            0.00019130117204927265,
            8.223369724845751e-5,
            0.00015936107858123753,
            0.0001436635274781824,
            7.31900488521991e-5,
            0.00019797054896726008,
            0.00022918697200291464,
            0.00010581407984150122,
            0.00013329924333630916,
            0.0001200888580606255,
            9.461733779925786e-5,
            8.422106585826263e-5,
            0.00013182167247545573,
            0.00010422902345208292,
            0.0002899203129180782,
            0.00031384220837842085,
            0.00028673999183567446,
            0.0003801405056246958,
            0.00031954355816227566,
            0.00019130117204927265,
            0.0016481856234771104,
            0.00018145721648285984,
            0.00029311009671658777,
            0.000298179846042747,
            0.00012682068622340908,
            0.0003099937291903275,
            0.0003883913604131519,
            0.00018750236887427732,
            0.00041231013794800007,
            0.00031594755565468715,
            0.0002903695990772725,
            0.00017010741906466848,
            0.00027994594693702497,
            0.00017622756396002136,
            8.658423983214427e-5,
            8.482302611560734e-5,
            5.593774380992676e-5,
            8.460686602422237e-5,
            0.00010090346071919407,
            8.223369724845751e-5,
            0.00018145721648285984,
            0.00016353541427233863,
            6.847158970171526e-5,
            9.440353647463813e-5,
            7.226513446465351e-5,
            0.0001316937977156593,
            0.00016555094543734756,
            4.813207689836868e-5,
            4.4065717612351573e-5,
            0.00015292934764504643,
            8.60566863602655e-5,
            7.930608983674266e-5,
            7.473589162794392e-5,
            8.734539766790026e-5,
            0.00013683073396803812,
            0.0001431654785547068,
            0.0001424324326066504,
            0.00014364255248387715,
            0.00015180196599655967,
            0.00015936107858123753,
            0.00029311009671658777,
            6.847158970171526e-5,
            0.00027619979891424485,
            0.00018002796663055896,
            6.690599847398476e-5,
            0.0002711475800319714,
            0.00027514352202038367,
            0.00013252723403667975,
            0.00019740768913210043,
            0.00021222805417218973,
            0.00014051086168613723,
            0.00010121606288131914,
            0.0002196021868091999,
            0.00010982877127024863,
            0.0001186466538545447,
            0.00011387453949672762,
            0.00011458854695037505,
            0.0001260235138318128,
            0.00011881666444846987,
            0.0001436635274781824,
            0.000298179846042747,
            9.440353647463813e-5,
            0.00018002796663055896,
            0.000243322112701978,
            7.035800256838621e-5,
            0.00026296274093344296,
            0.0002605141945640116,
            0.00010650832950165452,
            0.00013851300927705332,
            0.00020558171765143452,
            0.000121045941248928,
            8.42127815375368e-5,
            0.00015391355828978692,
            0.00010984984254107777,
            6.610266383366646e-5,
            6.413429372873145e-5,
            5.5672094030821864e-5,
            5.6029392529102485e-5,
            6.505355559831275e-5,
            7.31900488521991e-5,
            0.00012682068622340908,
            7.226513446465351e-5,
            6.690599847398476e-5,
            7.035800256838621e-5,
            0.00010534978848760108,
            0.00010357325748642824,
            9.050891501223953e-5,
            6.602847298190458e-5,
            7.765263621733655e-5,
            8.733925745547636e-5,
            6.140353570284915e-5,
            5.819964844193133e-5,
            8.171086672037168e-5,
            5.274128077439961e-5,
            0.0001979065243169616,
            0.00018313953332354252,
            0.0002271305139154119,
            0.0002530379772088931,
            0.000223256623741852,
            0.00019797054896726008,
            0.0003099937291903275,
            0.0001316937977156593,
            0.0002711475800319714,
            0.00026296274093344296,
            0.00010357325748642824,
            0.0007066882567333455,
            0.000521499603982297,
            0.00014929518247749159,
            0.0002904608452361733,
            0.00034630967643106323,
            0.00017839486626999187,
            0.00015382000990227045,
            0.000236604799234509,
            0.00021683064979684466,
            5.955796528697859e-5,
            7.94931442428848e-5,
            9.408508252820126e-5,
            0.0002197531290502378,
            6.71513565154453e-5,
            0.00022918697200291464,
            0.0003883913604131519,
            0.00016555094543734756,
            0.00027514352202038367,
            0.0002605141945640116,
            9.050891501223953e-5,
            0.000521499603982297,
            0.0019439677607081577,
            0.0001390565339965727,
            0.0003523601724604699,
            0.0003780226419869559,
            0.00011841630362403248,
            9.740921243349548e-5,
            0.00018720648980610917,
            0.00015615197831923987,
            7.442833914452206e-5,
            8.16189854014901e-5,
            5.172212883671979e-5,
            8.252003827398015e-5,
            7.702349396124648e-5,
            0.00010581407984150122,
            0.00018750236887427732,
            4.813207689836868e-5,
            0.00013252723403667975,
            0.00010650832950165452,
            6.602847298190458e-5,
            0.00014929518247749159,
            0.0001390565339965727,
            0.0001436352172851801,
            0.00023155304867105092,
            0.00012160879298617265,
            8.919585582300928e-5,
            6.836545269423191e-5,
            0.00012127793442183968,
            5.059989444492049e-5,
            6.426266756609735e-5,
            9.035466557592565e-5,
            4.9639759305660214e-5,
            0.00013061883030894824,
            0.0001200562294689135,
            0.00013329924333630916,
            0.00041231013794800007,
            4.4065717612351573e-5,
            0.00019740768913210043,
            0.00013851300927705332,
            7.765263621733655e-5,
            0.0002904608452361733,
            0.0003523601724604699,
            0.00023155304867105092,
            0.0009937022125140937,
            0.0002071625032574508,
            8.035315122131548e-5,
            4.588944938522433e-5,
            0.00015949587534148653,
            5.337556464304998e-5,
            0.00012772960592290366,
            0.00016557742869947607,
            0.00010438121177244035,
            0.0001577924890167392,
            0.0001499401842021239,
            0.0001200888580606255,
            0.00031594755565468715,
            0.00015292934764504643,
            0.00021222805417218973,
            0.00020558171765143452,
            8.733925745547636e-5,
            0.00034630967643106323,
            0.0003780226419869559,
            0.00012160879298617265,
            0.0002071625032574508,
            0.0005054585590745467,
            0.00014614768501647687,
            9.001417279485967e-5,
            0.00016595797808106479,
            0.00013245978445977562,
            0.00014724810908125564,
            0.00013409269078622013,
            0.00015664882134419384,
            0.0001688708963919953,
            0.0001783311215410475,
            9.461733779925786e-5,
            0.0002903695990772725,
            8.60566863602655e-5,
            0.00014051086168613723,
            0.000121045941248928,
            6.140353570284915e-5,
            0.00017839486626999187,
            0.00011841630362403248,
            8.919585582300928e-5,
            8.035315122131548e-5,
            0.00014614768501647687,
            0.0001624387273643113,
            9.632966451635503e-5,
            0.00013479386329074463,
            0.00011782402206418734,
            9.709168576998946e-5,
            8.219757212168931e-5,
            8.577392138199345e-5,
            8.636863427512415e-5,
            9.870807705821862e-5,
            8.422106585826263e-5,
            0.00017010741906466848,
            7.930608983674266e-5,
            0.00010121606288131914,
            8.42127815375368e-5,
            5.819964844193133e-5,
            0.00015382000990227045,
            9.740921243349548e-5,
            6.836545269423191e-5,
            4.588944938522433e-5,
            9.001417279485967e-5,
            9.632966451635503e-5,
            0.00012202561764009547,
            9.50759670517442e-5,
            7.318813513694667e-5,
            0.00012565948542829657,
            0.00012930777288853835,
            0.00012679783034381874,
            0.00013865266001363816,
            0.00014970553352583975,
            0.00013182167247545573,
            0.00027994594693702497,
            7.473589162794392e-5,
            0.0002196021868091999,
            0.00015391355828978692,
            8.171086672037168e-5,
            0.000236604799234509,
            0.00018720648980610917,
            0.00012127793442183968,
            0.00015949587534148653,
            0.00016595797808106479,
            0.00013479386329074463,
            9.50759670517442e-5,
            0.0001849011455817157,
            0.00010200814620602652,
            0.00013409062219316967,
            0.00010375957260205976,
            0.00013156808791280544,
            0.00011724394537803321,
            0.00016466229269763917,
            0.00010422902345208292,
            0.00017622756396002136,
            8.734539766790026e-5,
            0.00010982877127024863,
            0.00010984984254107777,
            5.274128077439961e-5,
            0.00021683064979684466,
            0.00015615197831923987,
            5.059989444492049e-5,
            5.337556464304998e-5,
            0.00013245978445977562,
            0.00011782402206418734,
            7.318813513694667e-5,
            0.00010200814620602652,
            0.00015789185651061686,
        ],
        20,
        20,
    )
    codepg0t = reshape(
        [
            1.0,
            0.6779026217228464,
            0.8716216216216216,
            0.7011494252873564,
            0.8992805755395683,
            0.4979757085020243,
            0.49282296650717705,
            0.4672489082969432,
            0.5681818181818182,
            0.524904214559387,
            0.4444444444444444,
            0.5137614678899083,
            0.09322033898305085,
            0.42857142857142855,
            0.14068441064638784,
            0.3920704845814978,
            0.7972972972972973,
            0.6065573770491803,
            0.6377358490566037,
            0.7364341085271318,
            0.6779026217228464,
            1.0,
            0.6727272727272727,
            0.5338345864661654,
            0.6976744186046512,
            0.5059760956175299,
            0.5315315315315315,
            0.4560669456066946,
            0.5923076923076923,
            0.5019455252918288,
            0.42962962962962964,
            0.47368421052631576,
            0.12396694214876032,
            0.46825396825396826,
            0.19708029197080293,
            0.5063829787234042,
            0.723404255319149,
            0.5116279069767442,
            0.6538461538461539,
            0.5677655677655677,
            0.8716216216216216,
            0.6727272727272727,
            1.0,
            0.6194029850746269,
            0.8251748251748252,
            0.4375,
            0.44036697247706424,
            0.2727272727272727,
            0.5343511450381679,
            0.4580152671755725,
            0.3381818181818182,
            0.5327102803738317,
            0.13304721030042918,
            0.26907630522088355,
            0.09818181818181818,
            0.2894736842105263,
            0.7663230240549829,
            0.48412698412698413,
            0.5813953488372093,
            0.6528301886792452,
            0.7011494252873564,
            0.5338345864661654,
            0.6194029850746269,
            1.0,
            0.6731517509727628,
            0.42084942084942084,
            0.4678111587982833,
            0.3305439330543933,
            0.4318181818181818,
            0.4036363636363637,
            0.2727272727272727,
            0.47555555555555556,
            0.2490118577075099,
            0.344,
            0.20701754385964916,
            0.35064935064935066,
            0.6619718309859155,
            0.390625,
            0.5094339622641509,
            0.46616541353383456,
            0.8992805755395683,
            0.6976744186046512,
            0.8251748251748252,
            0.6731517509727628,
            1.0,
            0.4956521739130435,
            0.4325581395348837,
            0.43362831858407086,
            0.5019762845849802,
            0.4186046511627907,
            0.34831460674157305,
            0.46153846153846156,
            0.08370044052863437,
            0.35319148936170214,
            0.20930232558139536,
            0.3665158371040724,
            0.7689530685920578,
            0.49107142857142855,
            0.6050420168067226,
            0.720164609053498,
            0.4979757085020243,
            0.5059760956175299,
            0.4375,
            0.42084942084942084,
            0.4956521739130435,
            1.0,
            0.352112676056338,
            0.4805194805194805,
            0.7165354330708661,
            0.688212927756654,
            0.5328467153284672,
            0.5564853556485355,
            0.3884297520661157,
            0.6597510373443983,
            0.3159851301115242,
            0.39914163090128757,
            0.5547445255474452,
            0.5697211155378487,
            0.7244094488188977,
            0.6198347107438017,
            0.49282296650717705,
            0.5315315315315315,
            0.44036697247706424,
            0.4678111587982833,
            0.4325581395348837,
            0.352112676056338,
            1.0,
            0.34951456310679613,
            0.4344262295081967,
            0.4708520179372198,
            0.30434782608695654,
            0.2872340425531915,
            0.2169811320754717,
            0.3853658536585366,
            0.32217573221757323,
            0.34615384615384615,
            0.5611814345991561,
            0.3793103448275862,
            0.5071090047393365,
            0.34545454545454546,
            0.4672489082969432,
            0.4560669456066946,
            0.2727272727272727,
            0.3305439330543933,
            0.43362831858407086,
            0.4805194805194805,
            0.34951456310679613,
            1.0,
            0.32217573221757323,
            0.4732510288065844,
            0.550561797752809,
            0.38738738738738737,
            0.2936170212765957,
            0.3140495867768595,
            0.10931174089068826,
            0.5319148936170213,
            0.528,
            0.5614035087719298,
            0.42978723404255326,
            0.5435684647302904,
            0.5681818181818182,
            0.5923076923076923,
            0.5343511450381679,
            0.4318181818181818,
            0.5019762845849802,
            0.7165354330708661,
            0.4344262295081967,
            0.32217573221757323,
            1.0,
            0.6944444444444444,
            0.392226148409894,
            0.6137339055793991,
            0.375494071146245,
            0.6653696498054474,
            0.37681159420289856,
            0.568,
            0.6633663366336634,
            0.5513307984790875,
            0.9717514124293786,
            0.5259259259259259,
            0.524904214559387,
            0.5019455252918288,
            0.4580152671755725,
            0.4036363636363637,
            0.4186046511627907,
            0.688212927756654,
            0.4708520179372198,
            0.4732510288065844,
            0.6944444444444444,
            1.0,
            0.4394463667820069,
            0.6341463414634146,
            0.37878787878787873,
            0.5697211155378487,
            0.28169014084507044,
            0.5862068965517241,
            0.6088560885608856,
            0.4887218045112782,
            0.7256317689530686,
            0.5604395604395604,
            0.4444444444444444,
            0.42962962962962964,
            0.3381818181818182,
            0.2727272727272727,
            0.34831460674157305,
            0.5328467153284672,
            0.30434782608695654,
            0.550561797752809,
            0.392226148409894,
            0.4394463667820069,
            1.0,
            0.3795918367346939,
            0.2,
            0.5367647058823529,
            0.24,
            0.3784860557768924,
            0.46938775510204084,
            0.5133079847908745,
            0.5854545454545454,
            0.40893470790378006,
            0.5137614678899083,
            0.47368421052631576,
            0.5327102803738317,
            0.47555555555555556,
            0.46153846153846156,
            0.5564853556485355,
            0.2872340425531915,
            0.38738738738738737,
            0.6137339055793991,
            0.6341463414634146,
            0.3795918367346939,
            1.0,
            0.44493392070484583,
            0.46859903381642515,
            0.34661354581673315,
            0.5794392523364486,
            0.5265306122448979,
            0.5238095238095238,
            0.6545454545454545,
            0.6491228070175439,
            0.09322033898305085,
            0.12396694214876032,
            0.13304721030042918,
            0.2490118577075099,
            0.08370044052863437,
            0.3884297520661157,
            0.2169811320754717,
            0.2936170212765957,
            0.375494071146245,
            0.37878787878787873,
            0.2,
            0.44493392070484583,
            1.0,
            0.2631578947368421,
            0.2535211267605634,
            0.3813559322033898,
            0.210727969348659,
            0.2,
            0.31225296442687744,
            0.28185328185328185,
            0.42857142857142855,
            0.46825396825396826,
            0.26907630522088355,
            0.344,
            0.35319148936170214,
            0.6597510373443983,
            0.3853658536585366,
            0.3140495867768595,
            0.6653696498054474,
            0.5697211155378487,
            0.5367647058823529,
            0.46859903381642515,
            0.2631578947368421,
            1.0,
            0.6129032258064516,
            0.45132743362831856,
            0.583941605839416,
            0.5163934426229508,
            0.7441860465116279,
            0.336,
            0.14068441064638784,
            0.19708029197080293,
            0.09818181818181818,
            0.20701754385964916,
            0.20930232558139536,
            0.3159851301115242,
            0.32217573221757323,
            0.10931174089068826,
            0.37681159420289856,
            0.28169014084507044,
            0.24,
            0.34661354581673315,
            0.2535211267605634,
            0.6129032258064516,
            1.0,
            0.2923076923076923,
            0.2,
            0.13178294573643412,
            0.37209302325581395,
            0.1347517730496454,
            0.3920704845814978,
            0.5063829787234042,
            0.2894736842105263,
            0.35064935064935066,
            0.3665158371040724,
            0.39914163090128757,
            0.34615384615384615,
            0.5319148936170213,
            0.568,
            0.5862068965517241,
            0.3784860557768924,
            0.5794392523364486,
            0.3813559322033898,
            0.45132743362831856,
            0.2923076923076923,
            1.0,
            0.5100401606425703,
            0.3624454148471616,
            0.5428571428571428,
            0.46887966804979253,
            0.7972972972972973,
            0.723404255319149,
            0.7663230240549829,
            0.6619718309859155,
            0.7689530685920578,
            0.5547445255474452,
            0.5611814345991561,
            0.528,
            0.6633663366336634,
            0.6088560885608856,
            0.46938775510204084,
            0.5265306122448979,
            0.210727969348659,
            0.583941605839416,
            0.2,
            0.5100401606425703,
            1.0,
            0.6842105263157895,
            0.7777777777777778,
            0.7357142857142858,
            0.6065573770491803,
            0.5116279069767442,
            0.48412698412698413,
            0.390625,
            0.49107142857142855,
            0.5697211155378487,
            0.3793103448275862,
            0.5614035087719298,
            0.5513307984790875,
            0.4887218045112782,
            0.5133079847908745,
            0.5238095238095238,
            0.2,
            0.5163934426229508,
            0.13178294573643412,
            0.3624454148471616,
            0.6842105263157895,
            1.0,
            0.6329588014981273,
            0.5272727272727272,
            0.6377358490566037,
            0.6538461538461539,
            0.5813953488372093,
            0.5094339622641509,
            0.6050420168067226,
            0.7244094488188977,
            0.5071090047393365,
            0.42978723404255326,
            0.9717514124293786,
            0.7256317689530686,
            0.5854545454545454,
            0.6545454545454545,
            0.31225296442687744,
            0.7441860465116279,
            0.37209302325581395,
            0.5428571428571428,
            0.7777777777777778,
            0.6329588014981273,
            1.0,
            0.5970149253731343,
            0.7364341085271318,
            0.5677655677655677,
            0.6528301886792452,
            0.46616541353383456,
            0.720164609053498,
            0.6198347107438017,
            0.34545454545454546,
            0.5435684647302904,
            0.5259259259259259,
            0.5604395604395604,
            0.40893470790378006,
            0.6491228070175439,
            0.28185328185328185,
            0.336,
            0.1347517730496454,
            0.46887966804979253,
            0.7357142857142858,
            0.5272727272727272,
            0.5970149253731343,
            1.0,
        ],
        20,
        20,
    )
    distg0t = reshape(
        [
            0.0,
            0.401308720486581,
            0.25335585485476586,
            0.38655567174253413,
            0.22440969727312554,
            0.5010111233785013,
            0.5035757308949782,
            0.5161158260037454,
            0.4646601886422925,
            0.4873888516577975,
            0.5270462766947299,
            0.49307125859762485,
            0.6733422833213986,
            0.5345224838248488,
            0.6554828713832316,
            0.5513299898511337,
            0.3183572699835067,
            0.4435327625727437,
            0.4255961412791452,
            0.36301920849513475,
            0.401308720486581,
            0.0,
            0.40451991747794525,
            0.48278639869710216,
            0.3887965929604765,
            0.4970029700024287,
            0.483977514182461,
            0.5215041008435626,
            0.45149324894859044,
            0.49902628924144427,
            0.5340273262532407,
            0.5129891760425771,
            0.6618281717527744,
            0.5156287578025647,
            0.6336085968597637,
            0.4967982594960432,
            0.37188421899890495,
            0.4941518456017623,
            0.41602514716892186,
            0.4648840889051981,
            0.25335585485476586,
            0.40451991747794525,
            0.0,
            0.436232171512701,
            0.2956561979945413,
            0.5303300858899106,
            0.5289768556009496,
            0.6030226891555273,
            0.4825188364001099,
            0.5205692714828775,
            0.5752469825293227,
            0.48336824452283184,
            0.6583892426595269,
            0.6045344054638728,
            0.6714976477316141,
            0.5960395606792697,
            0.3418164536304661,
            0.50787450018337,
            0.457495710997814,
            0.4166352189390347,
            0.38655567174253413,
            0.48278639869710216,
            0.436232171512701,
            0.0,
            0.40425749778280995,
            0.5381220025006314,
            0.5158434070537864,
            0.5785568541403717,
            0.5330017908890261,
            0.546060269733862,
            0.6030226891555273,
            0.5120763831912406,
            0.6127757103102611,
            0.5727128425310541,
            0.6296754942588885,
            0.5698028822981898,
            0.411113225896519,
            0.5519850541454905,
            0.4952605565436486,
            0.5166403906326748,
            0.22440969727312554,
            0.3887965929604765,
            0.2956561979945413,
            0.40425749778280995,
            0.0,
            0.5021692075819447,
            0.5326546068819439,
            0.5321520841901914,
            0.4990108793478454,
            0.539163866017192,
            0.5708263279047433,
            0.5188745216627708,
            0.6768676234949363,
            0.5686864296949146,
            0.6287677132370127,
            0.5627984376737055,
            0.33988743092966983,
            0.504444531850912,
            0.4443860839367483,
            0.3740557384578547,
            0.5010111233785013,
            0.4970029700024287,
            0.5303300858899106,
            0.5381220025006314,
            0.5021692075819447,
            0.0,
            0.5691604887655423,
            0.5096471914376255,
            0.3764734830828952,
            0.39483355495914096,
            0.48329767466414153,
            0.47091116165974684,
            0.5529784118452927,
            0.4124614907210137,
            0.5848140173971875,
            0.5481142075784536,
            0.4718344383640064,
            0.4638312648270658,
            0.37120786035663517,
            0.43598468393751993,
            0.5035757308949782,
            0.483977514182461,
            0.5289768556009496,
            0.5158434070537864,
            0.5326546068819439,
            0.5691604887655423,
            0.0,
            0.5703005509786939,
            0.5317771010920851,
            0.5143675641322946,
            0.5897678246195885,
            0.5969782062382213,
            0.6257071471241671,
            0.5543618612158774,
            0.5821616046178358,
            0.5717718748968657,
            0.46841144595368495,
            0.5570860145311556,
            0.49643277251842644,
            0.5720775535473553,
            0.5161158260037454,
            0.5215041008435626,
            0.6030226891555273,
            0.5785568541403717,
            0.5321520841901914,
            0.5096471914376255,
            0.5703005509786939,
            0.0,
            0.5821616046178358,
            0.5132002392796674,
            0.4740454631399772,
            0.5534494613840601,
            0.5942991581364575,
            0.5856408512147784,
            0.6673410893648434,
            0.4837794468468967,
            0.48579831205964474,
            0.468292905790847,
            0.5339535400938207,
            0.4777193398166488,
            0.4646601886422925,
            0.45149324894859044,
            0.4825188364001099,
            0.5330017908890261,
            0.4990108793478454,
            0.3764734830828952,
            0.5317771010920851,
            0.5821616046178358,
            0.0,
            0.39086797998528583,
            0.5512593997339664,
            0.4394690514817857,
            0.5587959953568722,
            0.409041776713915,
            0.5582062368861089,
            0.46475800154489005,
            0.41026434366535963,
            0.4736397373114467,
            0.11884567213538201,
            0.48686449556014766,
            0.4873888516577975,
            0.49902628924144427,
            0.5205692714828775,
            0.546060269733862,
            0.539163866017192,
            0.39483355495914096,
            0.5143675641322946,
            0.5132002392796674,
            0.39086797998528583,
            0.0,
            0.5294117647058824,
            0.42769946138415077,
            0.5573204290227128,
            0.4638312648270658,
            0.5992953608843178,
            0.4548588261473421,
            0.44223518145841495,
            0.5056076519835918,
            0.37038374090052295,
            0.4688072309384954,
            0.5270462766947299,
            0.5340273262532407,
            0.5752469825293227,
            0.6030226891555273,
            0.5708263279047433,
            0.48329767466414153,
            0.5897678246195885,
            0.4740454631399772,
            0.5512593997339664,
            0.5294117647058824,
            0.0,
            0.5569596768462265,
            0.6324555320336759,
            0.48126671093981094,
            0.6164414002968976,
            0.5574558028324342,
            0.5150787536377127,
            0.49330113278256593,
            0.45527214638359687,
            0.5436291438546226,
            0.49307125859762485,
            0.5129891760425771,
            0.48336824452283184,
            0.5120763831912406,
            0.5188745216627708,
            0.47091116165974684,
            0.5969782062382213,
            0.5534494613840601,
            0.4394690514817857,
            0.42769946138415077,
            0.5569596768462265,
            0.0,
            0.5268140465549273,
            0.5154614273559055,
            0.5715708417087364,
            0.4585633803868073,
            0.48655389616932576,
            0.4879500364742666,
            0.41560470729681676,
            0.4188539082916955,
            0.6733422833213986,
            0.6618281717527744,
            0.6583892426595269,
            0.6127757103102611,
            0.6768676234949363,
            0.5529784118452927,
            0.6257071471241671,
            0.5942991581364575,
            0.5587959953568722,
            0.5573204290227128,
            0.6324555320336759,
            0.5268140465549273,
            0.0,
            0.606976978666884,
            0.6109332505435584,
            0.5561672715094849,
            0.6282006171006763,
            0.6324555320336759,
            0.5864072968394589,
            0.5992273016755487,
            0.5345224838248488,
            0.5156287578025647,
            0.6045344054638728,
            0.5727128425310541,
            0.5686864296949146,
            0.4124614907210137,
            0.5543618612158774,
            0.5856408512147784,
            0.409041776713915,
            0.4638312648270658,
            0.48126671093981094,
            0.5154614273559055,
            0.606976978666884,
            0.0,
            0.43994134506405985,
            0.5237712126356704,
            0.456102178333202,
            0.4917349679334637,
            0.3576408488192953,
            0.5761944116355173,
            0.6554828713832316,
            0.6336085968597637,
            0.6714976477316141,
            0.6296754942588885,
            0.6287677132370127,
            0.5848140173971875,
            0.5821616046178358,
            0.6673410893648434,
            0.5582062368861089,
            0.5992953608843178,
            0.6164414002968976,
            0.5715708417087364,
            0.6109332505435584,
            0.43994134506405985,
            0.0,
            0.5948496901286524,
            0.6324555320336759,
            0.6588691274690164,
            0.5603155257282213,
            0.6577416768573946,
            0.5513299898511337,
            0.4967982594960432,
            0.5960395606792697,
            0.5698028822981898,
            0.5627984376737055,
            0.5481142075784536,
            0.5717718748968657,
            0.4837794468468967,
            0.46475800154489005,
            0.4548588261473421,
            0.5574558028324342,
            0.4585633803868073,
            0.5561672715094849,
            0.5237712126356704,
            0.5948496901286524,
            0.0,
            0.4949544622272991,
            0.5646036597263776,
            0.4780914437337575,
            0.5153253011206647,
            0.3183572699835067,
            0.37188421899890495,
            0.3418164536304661,
            0.411113225896519,
            0.33988743092966983,
            0.4718344383640064,
            0.46841144595368495,
            0.48579831205964474,
            0.41026434366535963,
            0.44223518145841495,
            0.5150787536377127,
            0.48655389616932576,
            0.6282006171006763,
            0.456102178333202,
            0.6324555320336759,
            0.4949544622272991,
            0.0,
            0.39735970711951313,
            0.3333333333333333,
            0.36351458999998487,
            0.4435327625727437,
            0.4941518456017623,
            0.50787450018337,
            0.5519850541454905,
            0.504444531850912,
            0.4638312648270658,
            0.5570860145311556,
            0.468292905790847,
            0.4736397373114467,
            0.5056076519835918,
            0.49330113278256593,
            0.4879500364742666,
            0.6324555320336759,
            0.4917349679334637,
            0.6588691274690164,
            0.5646036597263776,
            0.39735970711951313,
            0.0,
            0.4283930429534732,
            0.48617243480439776,
            0.4255961412791452,
            0.41602514716892186,
            0.457495710997814,
            0.4952605565436486,
            0.4443860839367483,
            0.37120786035663517,
            0.49643277251842644,
            0.5339535400938207,
            0.11884567213538201,
            0.37038374090052295,
            0.45527214638359687,
            0.41560470729681676,
            0.5864072968394589,
            0.3576408488192953,
            0.5603155257282213,
            0.4780914437337575,
            0.3333333333333333,
            0.4283930429534732,
            0.0,
            0.44887920124843483,
            0.36301920849513475,
            0.4648840889051981,
            0.4166352189390347,
            0.5166403906326748,
            0.3740557384578547,
            0.43598468393751993,
            0.5720775535473553,
            0.4777193398166488,
            0.48686449556014766,
            0.4688072309384954,
            0.5436291438546226,
            0.4188539082916955,
            0.5992273016755487,
            0.5761944116355173,
            0.6577416768573946,
            0.5153253011206647,
            0.36351458999998487,
            0.48617243480439776,
            0.44887920124843483,
            0.0,
        ],
        20,
        20,
    )
    @test isapprox(covg0t, portfolio.cov)
    @test isapprox(codepg0t, portfolio.codep)
    @test isapprox(distg0t, portfolio.dist)

    asset_statistics!(
        portfolio,
        codep_type = :Gerber0,
        cov_type = :Gerber0,
        posdef_fix = :Nearest,
    )
    covg1t = reshape(
        [
            0.00020997582228184753,
            0.00014277081927457553,
            0.00020235082125870927,
            0.000202966750665995,
            0.00023620866959703796,
            9.668198230702423e-5,
            0.00028932910216351897,
            8.642959388088756e-5,
            0.00013489851953542816,
            0.00011839709540948726,
            6.5816501822488e-5,
            0.00019748881354297133,
            5.9756925786868745e-5,
            7.409083712965554e-5,
            6.451966952502984e-5,
            0.00012784290584776103,
            0.00014708801339530572,
            9.69765149163348e-5,
            0.00012576233198384362,
            0.00013382678711711061,
            0.00014277081927457553,
            0.0002115234468410606,
            0.00015692057250045222,
            0.0001553667470045165,
            0.00018443031218854823,
            9.847268045735691e-5,
            0.00031378556724680255,
            8.481137066137765e-5,
            0.00014230925350924544,
            0.00011385009068771976,
            6.408296263238669e-5,
            0.00018309928098965596,
            7.952587010755852e-5,
            8.15539895977898e-5,
            9.038892432088795e-5,
            0.0001655858453086544,
            0.00013409018932752692,
            8.219467616892205e-5,
            0.00012861969561962054,
            0.00010373469078644072,
            0.00020235082125870927,
            0.00015692057250045222,
            0.0002572414426920628,
            0.00019883149841037057,
            0.00024064682709372254,
            9.386536763568232e-5,
            0.0002867267635456961,
            5.593637257598872e-5,
            0.0001417363416961658,
            0.00011458188296696397,
            5.565121446006241e-5,
            0.00022711771514188496,
            9.408220522741729e-5,
            5.170154079200747e-5,
            4.9634750797733825e-5,
            0.00010436523629290909,
            0.00015664882005632843,
            8.577385319720526e-5,
            0.00012598423118538295,
            0.00013155783233668146,
            0.000202966750665995,
            0.0001553667470045165,
            0.00019883149841037057,
            0.00040062774321407494,
            0.00024513284101995784,
            0.00011258607825601218,
            0.00038018541035742166,
            8.461858112431406e-5,
            0.00014330701843621156,
            0.0001260456631118835,
            5.60683498038782e-5,
            0.00025307070988441014,
            0.00021964114675941345,
            8.255853436372062e-5,
            0.00013048239690215878,
            0.0001576650361278502,
            0.00016885899233944193,
            8.636554848052116e-5,
            0.00013740014024213906,
            0.00011726262459508273,
            0.00023620866959703796,
            0.00018443031218854823,
            0.00024064682709372254,
            0.00024513284101995784,
            0.0003311044630153933,
            0.00012029086068926236,
            0.00031955940376200996,
            0.00010088581786326086,
            0.0001520899711258931,
            0.00011883729133742748,
            6.517481027050149e-5,
            0.00022327344609439505,
            6.68277798704534e-5,
            7.716843248517349e-5,
            0.00011961216963030983,
            0.000149526620073986,
            0.00017819829774237596,
            9.864392592658963e-5,
            0.00014756329182276856,
            0.00016463717285734546,
            9.668198230702423e-5,
            9.847268045735691e-5,
            9.386536763568232e-5,
            0.00011258607825601218,
            0.00012029086068926236,
            0.00017908772525119756,
            0.0001910682066288743,
            8.216575445119683e-5,
            0.0001578901794716244,
            0.00014353308571753056,
            7.302640244459089e-5,
            0.00019777181777909966,
            0.00022923396743222856,
            0.00010560169675445271,
            0.00013341754197943557,
            0.0001201752796276827,
            9.457984660373055e-5,
            8.418186349763707e-5,
            0.00013151158681256125,
            0.00010411857915070724,
            0.00028932910216351897,
            0.00031378556724680255,
            0.0002867267635456961,
            0.00038018541035742166,
            0.00031955940376200996,
            0.0001910682066288743,
            0.0016481856234771104,
            0.00018147702545872734,
            0.00029229060483119967,
            0.00029821236024613914,
            0.00012687364930545432,
            0.00031006775689313635,
            0.00038821110644298595,
            0.0001875477042405691,
            0.0004120557182560618,
            0.00031573033499488027,
            0.00029035534817280564,
            0.00017010417132397104,
            0.00027754816564160093,
            0.00017626494188653608,
            8.642959388088756e-5,
            8.481137066137765e-5,
            5.593637257598872e-5,
            8.461858112431406e-5,
            0.00010088581786326086,
            8.216575445119683e-5,
            0.00018147702545872734,
            0.00016353541427233863,
            6.827381927572757e-5,
            9.440999044432386e-5,
            7.226038933819484e-5,
            0.00013170691717530642,
            0.00016550815788544262,
            4.814028451770467e-5,
            4.401825978794269e-5,
            0.00015286770800493438,
            8.605448105147838e-5,
            7.930528912907809e-5,
            7.412419597393428e-5,
            8.7349830084179e-5,
            0.00013489851953542816,
            0.00014230925350924544,
            0.0001417363416961658,
            0.00014330701843621156,
            0.0001520899711258931,
            0.0001578901794716244,
            0.00029229060483119967,
            6.827381927572757e-5,
            0.00027619979891424485,
            0.0001794107050062773,
            6.700990843641535e-5,
            0.00027026573593836326,
            0.0002731531391932321,
            0.00013237594059360981,
            0.000195617057631073,
            0.00021050094260376657,
            0.00013982042091043617,
            0.00010074206505821757,
            0.00021460389014219352,
            0.00010953910216372864,
            0.00011839709540948726,
            0.00011385009068771976,
            0.00011458188296696397,
            0.0001260456631118835,
            0.00011883729133742748,
            0.00014353308571753056,
            0.00029821236024613914,
            9.440999044432386e-5,
            0.0001794107050062773,
            0.000243322112701978,
            7.037385006238753e-5,
            0.00026297924456753814,
            0.0002604253726584805,
            0.00010651592703442121,
            0.00013840776787031538,
            0.00020547110805614307,
            0.00012103854673991584,
            8.420992214741953e-5,
            0.00015266124094490894,
            0.00010986077258091829,
            6.5816501822488e-5,
            6.408296263238669e-5,
            5.565121446006241e-5,
            5.60683498038782e-5,
            6.517481027050149e-5,
            7.302640244459089e-5,
            0.00012687364930545432,
            7.226038933819484e-5,
            6.700990843641535e-5,
            7.037385006238753e-5,
            0.00010534978848760108,
            0.00010360630524493524,
            9.036375903437598e-5,
            6.607108929317469e-5,
            7.747831910802633e-5,
            8.718146201382905e-5,
            6.137994085193061e-5,
            5.8181496685995505e-5,
            8.072792042017522e-5,
            5.276084245172127e-5,
            0.00019748881354297133,
            0.00018309928098965596,
            0.00022711771514188496,
            0.00025307070988441014,
            0.00022327344609439505,
            0.00019777181777909966,
            0.00031006775689313635,
            0.00013170691717530642,
            0.00027026573593836326,
            0.00026297924456753814,
            0.00010360630524493524,
            0.0007066882567333455,
            0.0005213429406029546,
            0.0001493213466716343,
            0.00029027392294195096,
            0.00034612389710890023,
            0.00017838405703885106,
            0.00015381473268463586,
            0.00023464313459410594,
            0.0002168451742638821,
            5.9756925786868745e-5,
            7.952587010755852e-5,
            9.408220522741729e-5,
            0.00021964114675941345,
            6.68277798704534e-5,
            0.00022923396743222856,
            0.00038821110644298595,
            0.00016550815788544262,
            0.0002731531391932321,
            0.0002604253726584805,
            9.036375903437598e-5,
            0.0005213429406029546,
            0.0019439677607081577,
            0.00013886738147646604,
            0.0003524963777333228,
            0.00037810502375811743,
            0.0001184133412067091,
            9.740095129418716e-5,
            0.00018659714230717997,
            0.00015607353415746344,
            7.409083712965554e-5,
            8.15539895977898e-5,
            5.170154079200747e-5,
            8.255853436372062e-5,
            7.716843248517349e-5,
            0.00010560169675445271,
            0.0001875477042405691,
            4.814028451770467e-5,
            0.00013237594059360981,
            0.00010651592703442121,
            6.607108929317469e-5,
            0.0001493213466716343,
            0.00013886738147646604,
            0.0001436352172851801,
            0.0002312720636584882,
            0.00012140828756992213,
            8.916011586876432e-5,
            6.834284538944297e-5,
            0.00011993834660714427,
            5.062790360761554e-5,
            6.451966952502984e-5,
            9.038892432088795e-5,
            4.9634750797733825e-5,
            0.00013048239690215878,
            0.00011961216963030983,
            0.00013341754197943557,
            0.0004120557182560618,
            4.401825978794269e-5,
            0.000195617057631073,
            0.00013840776787031538,
            7.747831910802633e-5,
            0.00029027392294195096,
            0.0003524963777333228,
            0.0002312720636584882,
            0.0009937022125140937,
            0.0002073027983393123,
            8.034549439898057e-5,
            4.5878334038036676e-5,
            0.00015920842199265513,
            5.328896010173921e-5,
            0.00012784290584776103,
            0.0001655858453086544,
            0.00010436523629290909,
            0.0001576650361278502,
            0.000149526620073986,
            0.0001201752796276827,
            0.00031573033499488027,
            0.00015286770800493438,
            0.00021050094260376657,
            0.00020547110805614307,
            8.718146201382905e-5,
            0.00034612389710890023,
            0.00037810502375811743,
            0.00012140828756992213,
            0.0002073027983393123,
            0.0005054585590745467,
            0.00014612587206389065,
            8.99951095872147e-5,
            0.00016548453461158377,
            0.00013236609864846166,
            0.00014708801339530572,
            0.00013409018932752692,
            0.00015664882005632843,
            0.00016885899233944193,
            0.00017819829774237596,
            9.457984660373055e-5,
            0.00029035534817280564,
            8.605448105147838e-5,
            0.00013982042091043617,
            0.00012103854673991584,
            6.137994085193061e-5,
            0.00017838405703885106,
            0.0001184133412067091,
            8.916011586876432e-5,
            8.034549439898057e-5,
            0.00014612587206389065,
            0.0001624387273643113,
            9.632956094832612e-5,
            0.00013393221239306575,
            0.00011781444967816972,
            9.69765149163348e-5,
            8.219467616892205e-5,
            8.577385319720526e-5,
            8.636554848052116e-5,
            9.864392592658963e-5,
            8.418186349763707e-5,
            0.00017010417132397104,
            7.930528912907809e-5,
            0.00010074206505821757,
            8.420992214741953e-5,
            5.8181496685995505e-5,
            0.00015381473268463586,
            9.740095129418716e-5,
            6.834284538944297e-5,
            4.5878334038036676e-5,
            8.99951095872147e-5,
            9.632956094832612e-5,
            0.00012202561764009547,
            9.444623559981197e-5,
            7.318429521439031e-5,
            0.00012576233198384362,
            0.00012861969561962054,
            0.00012598423118538295,
            0.00013740014024213906,
            0.00014756329182276856,
            0.00013151158681256125,
            0.00027754816564160093,
            7.412419597393428e-5,
            0.00021460389014219352,
            0.00015266124094490894,
            8.072792042017522e-5,
            0.00023464313459410594,
            0.00018659714230717997,
            0.00011993834660714427,
            0.00015920842199265513,
            0.00016548453461158377,
            0.00013393221239306575,
            9.444623559981197e-5,
            0.0001849011455817157,
            0.00010110548623314738,
            0.00013382678711711061,
            0.00010373469078644072,
            0.00013155783233668146,
            0.00011726262459508273,
            0.00016463717285734546,
            0.00010411857915070724,
            0.00017626494188653608,
            8.7349830084179e-5,
            0.00010953910216372864,
            0.00010986077258091829,
            5.276084245172127e-5,
            0.0002168451742638821,
            0.00015607353415746344,
            5.062790360761554e-5,
            5.328896010173921e-5,
            0.00013236609864846166,
            0.00011781444967816972,
            7.318429521439031e-5,
            0.00010110548623314738,
            0.00015789185651061686,
        ],
        20,
        20,
    )
    codepg1t = reshape(
        [
            1.0,
            0.6774473510351535,
            0.8706625365148364,
            0.6997932408811991,
            0.8958363297396199,
            0.498572121944211,
            0.49181799298545226,
            0.4664143666755428,
            0.5601584079610273,
            0.5238001439823091,
            0.44252042037789024,
            0.5126770988872221,
            0.09353175266474109,
            0.4266280327853662,
            0.14124704164968685,
            0.3924182626562904,
            0.7964304348396858,
            0.6058378743404647,
            0.6382578067520439,
            0.7349851097391641,
            0.6774473510351535,
            1.0,
            0.6727135232814828,
            0.533713643622005,
            0.6969000996474253,
            0.5059453307106242,
            0.5314356026009001,
            0.45600427786594516,
            0.588765297270194,
            0.5018377578283163,
            0.4292857674206785,
            0.47358009922575234,
            0.12401797705763724,
            0.4678810826703897,
            0.19715501665067073,
            0.506408719113625,
            0.7233907604310044,
            0.5116098815020887,
            0.6503668836848876,
            0.5676294161043985,
            0.8706625365148364,
            0.6727135232814828,
            1.0,
            0.6193615014779399,
            0.8245692866352471,
            0.4373226862601123,
            0.44034665685254487,
            0.2727205872075016,
            0.5317396824080567,
            0.4579886309521129,
            0.33805498459804145,
            0.5326802622220808,
            0.13304314146366766,
            0.26896919913055994,
            0.09817191192075912,
            0.2894293804432255,
            0.76632301775477,
            0.48412659927695817,
            0.5776648215462469,
            0.6527793013417287,
            0.6997932408811991,
            0.533713643622005,
            0.6193615014779399,
            1.0,
            0.6730517703497955,
            0.4203211765543801,
            0.4678664197734785,
            0.33058970186066633,
            0.4308094995029792,
            0.4037073048011754,
            0.2729169001856991,
            0.475617072826054,
            0.24888496568831986,
            0.3441604780505161,
            0.2068013108042225,
            0.3503661225121573,
            0.6619251672467321,
            0.3906110436774657,
            0.5048319870121347,
            0.4662396826563236,
            0.8958363297396199,
            0.6969000996474253,
            0.8245692866352471,
            0.6730517703497955,
            1.0,
            0.49398891648752924,
            0.43257958932777046,
            0.4335524991632223,
            0.5029286552859465,
            0.41867732204356956,
            0.34896383756486254,
            0.46157323839113473,
            0.08329712019177163,
            0.35385610544828766,
            0.20852816536223642,
            0.36550491529263623,
            0.7683803403621902,
            0.490752277507074,
            0.596384045321053,
            0.720054745285247,
            0.498572121944211,
            0.5059453307106242,
            0.4373226862601123,
            0.4203211765543801,
            0.49398891648752924,
            1.0,
            0.35168387535048595,
            0.4801224676313684,
            0.7099218274157506,
            0.6875880530401846,
            0.531655317698095,
            0.5559267321739894,
            0.3885094006726535,
            0.6584268282958053,
            0.31626555640056175,
            0.39942887191412857,
            0.5545247134500141,
            0.5694559275780465,
            0.7227054119945594,
            0.6191779146871067,
            0.49181799298545226,
            0.5314356026009001,
            0.44034665685254487,
            0.4678664197734785,
            0.43257958932777046,
            0.35168387535048595,
            1.0,
            0.3495527182470552,
            0.4332116389025857,
            0.4709033607039493,
            0.304474928371003,
            0.2873026351547072,
            0.21688043027184226,
            0.38545902955938977,
            0.3219769307742017,
            0.34591585802730274,
            0.5611538926559277,
            0.37930310292331987,
            0.5027655359389877,
            0.3455278164816426,
            0.4664143666755428,
            0.45600427786594516,
            0.2727205872075016,
            0.33058970186066633,
            0.4335524991632223,
            0.4801224676313684,
            0.3495527182470552,
            1.0,
            0.3212451735423455,
            0.47328338297368144,
            0.5505256463587377,
            0.38742597928225864,
            0.293541134343393,
            0.31410313941009266,
            0.10919401451095116,
            0.5317005002182545,
            0.5279864693484162,
            0.5613978406057989,
            0.42626952685413244,
            0.5435960485730115,
            0.5601584079610273,
            0.588765297270194,
            0.5317396824080567,
            0.4308094995029792,
            0.5029286552859465,
            0.7099218274157506,
            0.4332116389025857,
            0.3212451735423455,
            1.0,
            0.6920634037996273,
            0.39283530461823324,
            0.6117378795790253,
            0.37277775442027333,
            0.6646100620424866,
            0.37339363863339403,
            0.5633776169004102,
            0.6601066941936192,
            0.5487489000051826,
            0.9496336825630337,
            0.5245388167805108,
            0.5238001439823091,
            0.5018377578283163,
            0.4579886309521129,
            0.4037073048011754,
            0.41867732204356956,
            0.6875880530401846,
            0.4709033607039493,
            0.47328338297368144,
            0.6920634037996273,
            1.0,
            0.4395453480408155,
            0.6341861407108106,
            0.37865873165544583,
            0.5697617553156334,
            0.28147611425766556,
            0.585891498332829,
            0.6088188944857474,
            0.4887052102808966,
            0.7197276675837565,
            0.5604953240763769,
            0.44252042037789024,
            0.4292857674206785,
            0.33805498459804145,
            0.2729169001856991,
            0.34896383756486254,
            0.531655317698095,
            0.304474928371003,
            0.5505256463587377,
            0.39283530461823324,
            0.4395453480408155,
            1.0,
            0.37971295544483274,
            0.1996792449056672,
            0.5371111463004277,
            0.23946124036127556,
            0.37780224673078155,
            0.46920738871144374,
            0.5131478903313842,
            0.5784117811015849,
            0.40908638129290115,
            0.5126770988872221,
            0.47358009922575234,
            0.5326802622220808,
            0.475617072826054,
            0.46157323839113473,
            0.5559267321739894,
            0.2873026351547072,
            0.38742597928225864,
            0.6117378795790253,
            0.6341861407108106,
            0.37971295544483274,
            1.0,
            0.4448002583759209,
            0.46868115646695147,
            0.34639048718334,
            0.5791284096460476,
            0.5264987089104048,
            0.5237915530860922,
            0.6491186894169682,
            0.6491662887062378,
            0.09353175266474109,
            0.12401797705763724,
            0.13304314146366766,
            0.24888496568831986,
            0.08329712019177163,
            0.3885094006726535,
            0.21688043027184226,
            0.293541134343393,
            0.37277775442027333,
            0.37865873165544583,
            0.1996792449056672,
            0.4448002583759209,
            1.0,
            0.2627999325645888,
            0.2536191256745816,
            0.38143904039228754,
            0.21072269757300133,
            0.1999830382792306,
            0.31123659708243434,
            0.2817116906632316,
            0.4266280327853662,
            0.4678810826703897,
            0.26896919913055994,
            0.3441604780505161,
            0.35385610544828766,
            0.6584268282958053,
            0.38545902955938977,
            0.31410313941009266,
            0.6646100620424866,
            0.5697617553156334,
            0.5371111463004277,
            0.46868115646695147,
            0.2627999325645888,
            1.0,
            0.612159479949546,
            0.4505832966895101,
            0.5837076258402125,
            0.5162226800010663,
            0.7359660635070872,
            0.3361859900849355,
            0.14124704164968685,
            0.19715501665067073,
            0.09817191192075912,
            0.2068013108042225,
            0.20852816536223642,
            0.31626555640056175,
            0.3219769307742017,
            0.10919401451095116,
            0.37339363863339403,
            0.28147611425766556,
            0.23946124036127556,
            0.34639048718334,
            0.2536191256745816,
            0.612159479949546,
            1.0,
            0.2925056496164534,
            0.1999809420732889,
            0.1317510252576553,
            0.37142241415459,
            0.13453313151257087,
            0.3924182626562904,
            0.506408719113625,
            0.2894293804432255,
            0.3503661225121573,
            0.36550491529263623,
            0.39942887191412857,
            0.34591585802730274,
            0.5317005002182545,
            0.5633776169004102,
            0.585891498332829,
            0.37780224673078155,
            0.5791284096460476,
            0.38143904039228754,
            0.4505832966895101,
            0.2925056496164534,
            1.0,
            0.509964035715652,
            0.3623686561325207,
            0.5413084847442964,
            0.4685480400595386,
            0.7964304348396858,
            0.7233907604310044,
            0.76632301775477,
            0.6619251672467321,
            0.7683803403621902,
            0.5545247134500141,
            0.5611538926559277,
            0.5279864693484162,
            0.6601066941936192,
            0.6088188944857474,
            0.46920738871144374,
            0.5264987089104048,
            0.21072269757300133,
            0.5837076258402125,
            0.1999809420732889,
            0.509964035715652,
            1.0,
            0.6842097906925947,
            0.7728059422352993,
            0.7356545140224172,
            0.6058378743404647,
            0.5116098815020887,
            0.48412659927695817,
            0.3906110436774657,
            0.490752277507074,
            0.5694559275780465,
            0.37930310292331987,
            0.5613978406057989,
            0.5487489000051826,
            0.4887052102808966,
            0.5131478903313842,
            0.5237915530860922,
            0.1999830382792306,
            0.5162226800010663,
            0.1317510252576553,
            0.3623686561325207,
            0.6842097906925947,
            1.0,
            0.628766426942907,
            0.5272450631378914,
            0.6382578067520439,
            0.6503668836848876,
            0.5776648215462469,
            0.5048319870121347,
            0.596384045321053,
            0.7227054119945594,
            0.5027655359389877,
            0.42626952685413244,
            0.9496336825630337,
            0.7197276675837565,
            0.5784117811015849,
            0.6491186894169682,
            0.31123659708243434,
            0.7359660635070872,
            0.37142241415459,
            0.5413084847442964,
            0.7728059422352993,
            0.628766426942907,
            1.0,
            0.5917319994854573,
            0.7349851097391641,
            0.5676294161043985,
            0.6527793013417287,
            0.4662396826563236,
            0.720054745285247,
            0.6191779146871067,
            0.3455278164816426,
            0.5435960485730115,
            0.5245388167805108,
            0.5604953240763769,
            0.40908638129290115,
            0.6491662887062378,
            0.2817116906632316,
            0.3361859900849355,
            0.13453313151257087,
            0.4685480400595386,
            0.7356545140224172,
            0.5272450631378914,
            0.5917319994854573,
            1.0,
        ],
        20,
        20,
    )
    distg1t = reshape(
        [
            0.0,
            0.4015922365813652,
            0.25430047530939026,
            0.3874317740704813,
            0.2282144498715847,
            0.5007134300454648,
            0.5040744027495087,
            0.5165199092602614,
            0.46895713665481875,
            0.48795484218198454,
            0.5279581326308506,
            0.49362075579982345,
            0.6732266510378428,
            0.5354306524726773,
            0.6552682497841297,
            0.5511722676911954,
            0.3190372745936705,
            0.4439381295065425,
            0.4252894268894749,
            0.36401572099350044,
            0.4015922365813652,
            0.0,
            0.4045284147736208,
            0.4828490221477077,
            0.38929416920407034,
            0.49701844497431674,
            0.4840270640155878,
            0.5215341418038012,
            0.45345049494393874,
            0.4990802751921196,
            0.5341882779410839,
            0.5130399111054849,
            0.6618088934663702,
            0.515809517811377,
            0.6335791124040191,
            0.4967853061868754,
            0.37189329085706535,
            0.49416096491826994,
            0.4181107008407656,
            0.4649573012092624,
            0.25430047530939026,
            0.4045284147736208,
            0.0,
            0.43625594467127904,
            0.29616778468019855,
            0.5304136658024036,
            0.5289864568906538,
            0.6030254608192337,
            0.4838699812924663,
            0.520582063198439,
            0.5753021012485348,
            0.4833837697823124,
            0.6583907876543885,
            0.6045786966431418,
            0.6715013358435115,
            0.5960581429511614,
            0.3418164582383578,
            0.5078746896248335,
            0.45952974792376233,
            0.4166657525272933,
            0.3874317740704813,
            0.4828490221477077,
            0.43625594467127904,
            0.0,
            0.4043193228440885,
            0.5383673575940595,
            0.5158166245026043,
            0.578537076659454,
            0.5334746950404587,
            0.5460277901347259,
            0.6029440686391653,
            0.5120463490612671,
            0.6128274774810935,
            0.5726427865386431,
            0.6297613393960356,
            0.5699271345917137,
            0.41114160136944783,
            0.5519913750786938,
            0.497578141093369,
            0.5166044508827216,
            0.2282144498715847,
            0.38929416920407034,
            0.29616778468019855,
            0.4043193228440885,
            0.0,
            0.5029965623701969,
            0.5326445393844893,
            0.5321877022427227,
            0.49853352179871185,
            0.5391301688629706,
            0.5705419188960341,
            0.5188577654853328,
            0.6770165728430244,
            0.568394183006702,
            0.6290754464441303,
            0.5632473189937809,
            0.3403084333643598,
            0.5046026766144458,
            0.4492304278869292,
            0.37412915865697566,
            0.5007134300454648,
            0.49701844497431674,
            0.5304136658024036,
            0.5383673575940595,
            0.5029965623701969,
            0.0,
            0.5693488055004217,
            0.5098419031271515,
            0.38083997465093483,
            0.3952290139652044,
            0.4839135678516903,
            0.47120763354704404,
            0.5529424017595985,
            0.4132633371738864,
            0.5846941267019184,
            0.5479831786131174,
            0.4719508907449937,
            0.4639741762328769,
            0.3723537216179265,
            0.4363611378851772,
            0.5040744027495087,
            0.4840270640155878,
            0.5289864568906538,
            0.5158166245026043,
            0.5326445393844893,
            0.5693488055004217,
            0.0,
            0.5702838248420451,
            0.5323478003605416,
            0.5143426092091005,
            0.5897139440563522,
            0.5969494806285088,
            0.6257473810285417,
            0.5543198401828182,
            0.5822469704626201,
            0.5718759227195604,
            0.4684261453762334,
            0.5570892644256754,
            0.4986153146770626,
            0.5720455329422464,
            0.5165199092602614,
            0.5215341418038012,
            0.6030254608192337,
            0.578537076659454,
            0.5321877022427227,
            0.5098419031271515,
            0.5702838248420451,
            0.0,
            0.5825610811140985,
            0.5131844780516644,
            0.4740645281189378,
            0.5534320286709749,
            0.5943310801466667,
            0.585617990071133,
            0.6673851906841539,
            0.4838902250416645,
            0.4858052751111209,
            0.46829593175373685,
            0.5355980177081817,
            0.4777049044268797,
            0.46895713665481875,
            0.45345049494393874,
            0.4838699812924663,
            0.5334746950404587,
            0.49853352179871185,
            0.38083997465093483,
            0.5323478003605416,
            0.5825610811140985,
            0.0,
            0.3923879433675127,
            0.5509830738696819,
            0.4406030642318405,
            0.5600099309743206,
            0.409505761838288,
            0.5597349200142001,
            0.46723783189056395,
            0.4122458646283676,
            0.47500057894428793,
            0.1586920247475693,
            0.48757624184300097,
            0.48795484218198454,
            0.4990802751921196,
            0.520582063198439,
            0.5460277901347259,
            0.5391301688629706,
            0.3952290139652044,
            0.5143426092091005,
            0.5131844780516644,
            0.3923879433675127,
            0.0,
            0.5293650214923462,
            0.4276761971919816,
            0.557378358184346,
            0.46380935991222005,
            0.599384636832783,
            0.4550321426378421,
            0.44225620714369435,
            0.5056158570095994,
            0.3743476542041124,
            0.4687774930196751,
            0.5279581326308506,
            0.5341882779410839,
            0.5753021012485348,
            0.6029440686391653,
            0.5705419188960341,
            0.4839135678516903,
            0.5897139440563522,
            0.4740645281189378,
            0.5509830738696819,
            0.5293650214923462,
            0.0,
            0.5569053081786738,
            0.6325823089109956,
            0.4810867144806497,
            0.6166598574736013,
            0.5577623836676414,
            0.5151662893127598,
            0.4933822603563163,
            0.4591231963745761,
            0.5435593889848187,
            0.49362075579982345,
            0.5130399111054849,
            0.4833837697823124,
            0.5120463490612671,
            0.5188577654853328,
            0.47120763354704404,
            0.5969494806285088,
            0.5534320286709749,
            0.4406030642318405,
            0.4276761971919816,
            0.5569053081786738,
            0.0,
            0.5268774722950674,
            0.5154215961390484,
            0.5716683972447052,
            0.45873281458489124,
            0.48657028839089383,
            0.48795924364331283,
            0.4188563659436441,
            0.41882795471038115,
            0.6732266510378428,
            0.6618088934663702,
            0.6583907876543885,
            0.6128274774810935,
            0.6770165728430244,
            0.5529424017595985,
            0.6257473810285417,
            0.5943310801466667,
            0.5600099309743206,
            0.557378358184346,
            0.6325823089109956,
            0.5268774722950674,
            0.0,
            0.6071243972347888,
            0.6108931470909698,
            0.556129912703728,
            0.6282027150637757,
            0.6324622367069711,
            0.5868404395223482,
            0.5992863711685626,
            0.5354306524726773,
            0.515809517811377,
            0.6045786966431418,
            0.5726427865386431,
            0.568394183006702,
            0.4132633371738864,
            0.5543198401828182,
            0.585617990071133,
            0.409505761838288,
            0.46380935991222005,
            0.4810867144806497,
            0.5154215961390484,
            0.6071243972347888,
            0.0,
            0.44036378146394717,
            0.5241262745324308,
            0.45623041007794923,
            0.491821776662509,
            0.36334139352192785,
            0.5761137083575882,
            0.6552682497841297,
            0.6335791124040191,
            0.6715013358435115,
            0.6297613393960356,
            0.6290754464441303,
            0.5846941267019184,
            0.5822469704626201,
            0.6673851906841539,
            0.5597349200142001,
            0.599384636832783,
            0.6166598574736013,
            0.5716683972447052,
            0.6108931470909698,
            0.44036378146394717,
            0.0,
            0.5947664879528547,
            0.632463065295797,
            0.6588812392010964,
            0.5606146563573815,
            0.6578247747263055,
            0.5511722676911954,
            0.4967853061868754,
            0.5960581429511614,
            0.5699271345917137,
            0.5632473189937809,
            0.5479831786131174,
            0.5718759227195604,
            0.4838902250416645,
            0.46723783189056395,
            0.4550321426378421,
            0.5577623836676414,
            0.45873281458489124,
            0.556129912703728,
            0.5241262745324308,
            0.5947664879528547,
            0.0,
            0.4949929112039626,
            0.5646376465785289,
            0.47890057175561174,
            0.515486158854174,
            0.3190372745936705,
            0.37189329085706535,
            0.3418164582383578,
            0.41114160136944783,
            0.3403084333643598,
            0.4719508907449937,
            0.4684261453762334,
            0.4858052751111209,
            0.4122458646283676,
            0.44225620714369435,
            0.5151662893127598,
            0.48657028839089383,
            0.6282027150637757,
            0.45623041007794923,
            0.632463065295797,
            0.4949929112039626,
            0.0,
            0.39736016993868756,
            0.33704158331332107,
            0.3635556944799399,
            0.4439381295065425,
            0.49416096491826994,
            0.5078746896248335,
            0.5519913750786938,
            0.5046026766144458,
            0.4639741762328769,
            0.5570892644256754,
            0.46829593175373685,
            0.47500057894428793,
            0.5056158570095994,
            0.4933822603563163,
            0.48795924364331283,
            0.6324622367069711,
            0.491821776662509,
            0.6588812392010964,
            0.5646376465785289,
            0.39736016993868756,
            0.0,
            0.43083266650585644,
            0.48618666007106187,
            0.4252894268894749,
            0.4181107008407656,
            0.45952974792376233,
            0.497578141093369,
            0.4492304278869292,
            0.3723537216179265,
            0.4986153146770626,
            0.5355980177081817,
            0.1586920247475693,
            0.3743476542041124,
            0.4591231963745761,
            0.4188563659436441,
            0.5868404395223482,
            0.36334139352192785,
            0.5606146563573815,
            0.47890057175561174,
            0.33704158331332107,
            0.43083266650585644,
            0.0,
            0.45181190805164856,
            0.36401572099350044,
            0.4649573012092624,
            0.4166657525272933,
            0.5166044508827216,
            0.37412915865697566,
            0.4363611378851772,
            0.5720455329422464,
            0.4777049044268797,
            0.48757624184300097,
            0.4687774930196751,
            0.5435593889848187,
            0.41882795471038115,
            0.5992863711685626,
            0.5761137083575882,
            0.6578247747263055,
            0.515486158854174,
            0.3635556944799399,
            0.48618666007106187,
            0.45181190805164856,
            0.0,
        ],
        20,
        20,
    )
    @test isapprox(covg1t, portfolio.cov)
    @test isapprox(codepg1t, portfolio.codep)
    @test isapprox(distg1t, portfolio.dist)

    asset_statistics!(portfolio, mu_type = :JS, mu_target = :GM)
    jsgm = copy(portfolio.mu)
    jsgmt = [
        0.0006341475601844101,
        0.0006789058959280285,
        0.0008178383518190523,
        0.0007639436970922277,
        0.0013856285900496848,
        -0.0002523200512863443,
        0.0014200748323063197,
        0.0003576843329880906,
        0.000716221244111695,
        0.0004491661692147687,
        0.0003248478475254554,
        -0.00015878941972113393,
        -0.0007869829861367987,
        0.00011240543858372297,
        -0.0007127483820581668,
        0.0009418444136399807,
        0.0008403726820401893,
        0.00040878369315988205,
        0.0007395087768546029,
        0.0005917202666292221,
    ]
    @test isapprox(jsgm, jsgmt)

    asset_statistics!(portfolio, mu_type = :BS, mu_target = :GM)
    bsgm = copy(portfolio.mu)
    bsgmt = [
        0.000596098181618497,
        0.0006308701348944901,
        0.0007388042835731622,
        0.0006969344869229568,
        0.0011799103994799723,
        -9.258270551964977e-5,
        0.0012066710711265273,
        0.00038131882803247186,
        0.0006598597637974114,
        0.000452389436043844,
        0.0003558087477472064,
        -1.992042492707195e-5,
        -0.000507952809884533,
        0.00019076602676948228,
        -0.000450281269117916,
        0.0008351423827437062,
        0.0007563108030747699,
        0.000421017010165618,
        0.0006779514329132588,
        0.0005631371734706867,
    ]
    @test isapprox(bsgm, bsgmt)

    asset_statistics!(portfolio, mu_type = :BOP, mu_target = :GM)
    bopgm = copy(portfolio.mu)
    bopgmt = [
        0.00016917378887231472,
        0.00018160113183457628,
        0.00022017632122135324,
        0.00020521224029664158,
        0.0003778257043783738,
        -7.695772718287296e-5,
        0.00038738985056862576,
        9.24125938068311e-5,
        0.00019196189753174021,
        0.00011781291610921848,
        8.32954034613955e-5,
        -5.0988548109821304e-5,
        -0.0002254091731583472,
        2.4309861845846202e-5,
        -0.00020479761847862714,
        0.0002546071335838931,
        0.00022643307419105795,
        0.00010660054926711702,
        0.00019842778039652644,
        0.00015739366972331245,
    ]
    @test isapprox(bsgm, bsgmt)

    asset_statistics!(portfolio, mu_type = :JS, mu_target = :VW)
    jsvw = copy(portfolio.mu)
    jsvwt = [
        0.0005962555831924726,
        0.0006415098938267387,
        0.0007819818843870736,
        0.0007274900136324292,
        0.001356063904844158,
        -0.00030003512981584556,
        0.001390891851892819,
        0.0003167288189678275,
        0.0006792387398634284,
        0.00040922438130752903,
        0.0002835284667077342,
        -0.0002054680690806927,
        -0.000840622757491449,
        6.873194654195269e-5,
        -0.0007655655468742032,
        0.0009073620789126582,
        0.0008047659214344713,
        0.00036839442002307234,
        0.000702784325800534,
        0.0005533581454299117,
    ]
    @test isapprox(jsvw, jsvwt)

    asset_statistics!(portfolio, mu_type = :BS, mu_target = :VW)
    bsvw = copy(portfolio.mu)
    bsvwt = [
        0.0005338285186301338,
        0.0005684298660735894,
        0.0006758344444072082,
        0.0006341700785954429,
        0.0011147763081207544,
        -0.00015147341032380464,
        0.0011414056806530696,
        0.0003201029629179168,
        0.0005972772596601718,
        0.00039082486862451814,
        0.00029471804581950544,
        -7.91676414513528e-5,
        -0.0005648055341960804,
        0.00013048509387008866,
        -0.0005074169542728796,
        0.0007716998683304457,
        0.000693255069558542,
        0.00035960636906711714,
        0.0006152801634355449,
        0.0005010292310561348,
    ]
    @test isapprox(bsvw, bsvwt)

    asset_statistics!(portfolio, mu_type = :BOP, mu_target = :VW)
    bopvw = copy(portfolio.mu)
    bopvwt = [
        0.00015313828431741356,
        0.00016556562727967512,
        0.00020414081666645203,
        0.0001891767357417404,
        0.00036179019982347235,
        -9.299323173777384e-5,
        0.00037135434601372436,
        7.637708925193004e-5,
        0.00017592639297683903,
        0.0001017774115543174,
        6.725989890649445e-5,
        -6.70240526647222e-5,
        -0.00024144467771324788,
        8.27435729094522e-6,
        -0.00022083312303352787,
        0.00023857162902899187,
        0.00021039756963615674,
        9.056504471221594e-5,
        0.00018239227584162526,
        0.00014135816516841132,
    ]
    @test isapprox(bsvw, bsvwt)

    asset_statistics!(portfolio, mu_type = :JS, mu_target = :SE)
    jsse = copy(portfolio.mu)
    jsset = [
        0.0005441589609781389,
        0.0005935020904084804,
        0.0007466660103623951,
        0.0006872506885098965,
        0.0013726175062978338,
        -0.0004331134367079999,
        0.0014105922290353827,
        0.0002393763863887135,
        0.0006346398142441448,
        0.0003402291104782567,
        0.00020317631493160286,
        -0.0003300020501394817,
        -0.0010225442535071647,
        -3.102750669731119e-5,
        -0.0009407054716041901,
        0.000883374559885473,
        0.0007715086313905049,
        0.00029571007933939126,
        0.0006603127916494866,
        0.0004973856526660391,
    ]
    @test isapprox(jsse, jsset)

    asset_statistics!(portfolio, mu_type = :BS, mu_target = :SE)
    bsse = copy(portfolio.mu)
    bsset = [
        0.00039511694346837297,
        0.0004306923523558474,
        0.00054112047359735,
        0.0004982832155335399,
        0.0009924189759160213,
        -0.0003094768985417447,
        0.00101979799107727,
        0.00017537480635680485,
        0.00046035182801232744,
        0.00024808760220746524,
        0.0001492752792552546,
        -0.00023513565224304845,
        -0.000734444722038041,
        -1.958098936102768e-5,
        -0.0006754405980057115,
        0.0006396846020554542,
        0.0005590315062196169,
        0.0002159902716505294,
        0.00047886153096587204,
        0.0003613943241810836,
    ]
    @test isapprox(bsse, bsset)

    asset_statistics!(portfolio, mu_type = :BOP, mu_target = :SE)
    bopse = copy(portfolio.mu)
    bopset = [
        0.00013646827659120816,
        0.00014889561955346972,
        0.00018747080894024668,
        0.00017250672801553501,
        0.00034512019209726716,
        -0.00010966323946397949,
        0.0003546843382875191,
        5.970708152572455e-5,
        0.00015925638525063365,
        8.510740382811192e-5,
        5.058989118028895e-5,
        -8.369406039092783e-5,
        -0.0002581146854394537,
        -8.395650435260338e-6,
        -0.00023750313075973365,
        0.00022190162130278655,
        0.00019372756190995139,
        7.389503698601047e-5,
        0.00016572226811541988,
        0.0001246881574422059,
    ]
    @test isapprox(bsse, bsset)

    portfolio.mu_type = :Default
    asset_statistics!(portfolio)
    mu1 = copy(portfolio.mu)
    asset_statistics!(
        portfolio,
        mu_weights = eweights(size(portfolio.returns, 1), eps(), scale = true),
    )
    mu2 = copy(portfolio.mu)
    @test isapprox(mu1, mu2)
    asset_statistics!(
        portfolio,
        mu_weights = eweights(size(portfolio.returns, 1), 1 - eps(), scale = true),
    )
    mu3 = copy(portfolio.mu)
    @test isapprox(mu3, portfolio.returns[end, 1:end])

    asset_statistics!(portfolio, cov_type = :Full)
    cov1 = copy(portfolio.cov)
    cov2 = cov(portfolio.returns)
    @test isapprox(cov1, cov2)

    asset_statistics!(portfolio, cov_type = :Semi)
    cov3 = copy(portfolio.cov)

    semiret = min.(portfolio.returns .- 0, 0)
    cov4 = cov(StatsBase.SimpleCovariance(; corrected = true), semiret, mean = 0)
    @test isapprox(cov3, cov4)

    cov5 = transpose(semiret) * semiret / (size(semiret, 1) - 1)
    @test isapprox(cov3, cov5)

    asset_statistics!(
        portfolio,
        cov_type = :Semi,
        cov_est = StatsBase.SimpleCovariance(; corrected = false),
    )
    cov6 = copy(portfolio.cov)
    cov7 = transpose(semiret) * semiret / (size(semiret, 1))
    @test isapprox(cov6, cov7)

    portfolio = Portfolio(returns = returns)

    asset_statistics!(portfolio, cov_type = :Gerber1, std_kwargs = (; corrected = false))
    covg1 = copy(portfolio.cov)
    asset_statistics!(portfolio, cov_type = :Gerber2, std_kwargs = (; corrected = false))
    covg2 = copy(portfolio.cov)

    covgt1 = reshape(
        [
            0.00020974121242454938,
            6.250133585184752e-5,
            0.00010308920030405359,
            8.336113386524584e-5,
            0.00011572025672346055,
            3.836287594271049e-5,
            9.653212653585173e-5,
            3.1883152115014425e-5,
            5.7365584297502435e-5,
            4.797874155062979e-5,
            2.5019111703636648e-5,
            7.07499647690489e-5,
            1.919340415249585e-5,
            2.7635142768275865e-5,
            2.4899996577966644e-5,
            4.5818889711417205e-5,
            7.148890225301703e-5,
            3.797093766066356e-5,
            5.4206126776390346e-5,
            5.430868038079555e-5,
            6.250133585184752e-5,
            0.00021128710779431086,
            6.896931621089687e-5,
            6.31356778021311e-5,
            7.774945281161811e-5,
            3.882158442508595e-5,
            0.00010925451077843667,
            3.1930988237114795e-5,
            5.6506739289969694e-5,
            4.376206209763014e-5,
            2.554935233529653e-5,
            6.568371505107873e-5,
            2.8093343086444576e-5,
            3.1902179088675707e-5,
            3.5839879298544966e-5,
            6.0635288777962045e-5,
            5.847041542925502e-5,
            3.3677708529122014e-5,
            5.2554705292333276e-5,
            4.311682087740567e-5,
            0.00010308920030405359,
            6.896931621089687e-5,
            0.000256954022085703,
            8.21464016388811e-5,
            0.00011861824072234456,
            3.8297316476982224e-5,
            9.80211544843378e-5,
            2.0360337189652927e-5,
            5.7171168770933466e-5,
            4.5506304922970216e-5,
            2.2893293275143936e-5,
            7.52738320561967e-5,
            3.178132158303975e-5,
            2.0006874569844294e-5,
            1.990610418838896e-5,
            3.691354862764159e-5,
            7.193345065702455e-5,
            3.421692126589264e-5,
            5.1298725984165446e-5,
            5.3008504387511776e-5,
            8.336113386524584e-5,
            6.31356778021311e-5,
            8.21464016388811e-5,
            0.00040018011445070714,
            0.00010006056914689232,
            4.528543402192555e-5,
            0.0001378096166007681,
            3.118006736324835e-5,
            5.6536213903168096e-5,
            5.1978594587131e-5,
            2.2370446526698464e-5,
            8.790417559576765e-5,
            8.060293394984372e-5,
            3.153793507418763e-5,
            5.350327040620056e-5,
            5.50822067069581e-5,
            7.258446776763506e-5,
            3.4135496213278316e-5,
            5.646446357340958e-5,
            4.608290500591353e-5,
            0.00011572025672346055,
            7.774945281161811e-5,
            0.00011861824072234456,
            0.00010006056914689232,
            0.0003307345138947058,
            4.4508885077778627e-5,
            0.00011250016908942395,
            3.7174698433196484e-5,
            6.079712484932821e-5,
            4.837353612463215e-5,
            2.68574184309218e-5,
            7.559463647185589e-5,
            2.2896731194239402e-5,
            2.8836199417850844e-5,
            4.604151609381458e-5,
            5.330073489964903e-5,
            7.997168181991059e-5,
            3.5112726024940944e-5,
            5.6762531126068076e-5,
            6.203182070762331e-5,
            3.836287594271049e-5,
            3.882158442508595e-5,
            3.8297316476982224e-5,
            4.528543402192555e-5,
            4.4508885077778627e-5,
            0.00017888762723415697,
            6.470846121620126e-5,
            3.0341843550686635e-5,
            6.249225264851627e-5,
            5.851363025893238e-5,
            3.053607713353194e-5,
            7.857664921604262e-5,
            8.306038548137086e-5,
            4.024004073885486e-5,
            5.282807111447673e-5,
            4.46476686450183e-5,
            4.065334993458338e-5,
            3.411287236071691e-5,
            5.325683752452865e-5,
            3.777397463136236e-5,
            9.653212653585173e-5,
            0.00010925451077843667,
            9.80211544843378e-5,
            0.0001378096166007681,
            0.00011250016908942395,
            6.470846121620126e-5,
            0.001646344075294454,
            6.0281863383345436e-5,
            0.00011357544396509415,
            0.00010109560209650115,
            4.335739142933189e-5,
            9.240270648661293e-5,
            0.00012294016376712317,
            5.961962445537456e-5,
            0.00014475297064541138,
            0.00010536703797465925,
            0.00010640975822559856,
            5.3980004767739685e-5,
            9.176142515359876e-5,
            5.944895152347324e-5,
            3.1883152115014425e-5,
            3.1930988237114795e-5,
            2.0360337189652927e-5,
            3.118006736324835e-5,
            3.7174698433196484e-5,
            3.0341843550686635e-5,
            6.0281863383345436e-5,
            0.00016335269313907342,
            2.531913850897123e-5,
            3.518064521742837e-5,
            2.9224613819028337e-5,
            4.795930367789056e-5,
            5.9195505169616165e-5,
            1.8254144202435076e-5,
            1.6292977451999615e-5,
            5.874257792193607e-5,
            3.315916914318532e-5,
            2.8443441523077334e-5,
            2.7726145996789834e-5,
            3.239414212027499e-5,
            5.7365584297502435e-5,
            5.6506739289969694e-5,
            5.7171168770933466e-5,
            5.6536213903168096e-5,
            6.079712484932821e-5,
            6.249225264851627e-5,
            0.00011357544396509415,
            2.531913850897123e-5,
            0.00027589119578696634,
            7.955472135571965e-5,
            2.7895636897735858e-5,
            9.799192063537893e-5,
            0.00010121329413385771,
            5.187498163984717e-5,
            7.752656073980324e-5,
            8.280895619323395e-5,
            6.655277228781742e-5,
            4.16772440706494e-5,
            0.0001389129064723086,
            4.4587790083641915e-5,
            4.797874155062979e-5,
            4.376206209763014e-5,
            4.5506304922970216e-5,
            5.1978594587131e-5,
            4.837353612463215e-5,
            5.851363025893238e-5,
            0.00010109560209650115,
            3.518064521742837e-5,
            7.955472135571965e-5,
            0.00024305024441962947,
            2.991273017596313e-5,
            0.0001012798687186678,
            0.00010058404532128184,
            4.0095676833583735e-5,
            5.6053840090225026e-5,
            8.42718184647058e-5,
            4.8328610883378295e-5,
            3.485291477532223e-5,
            6.623082399674407e-5,
            4.480131845962774e-5,
            2.5019111703636648e-5,
            2.554935233529653e-5,
            2.2893293275143936e-5,
            2.2370446526698464e-5,
            2.68574184309218e-5,
            3.053607713353194e-5,
            4.335739142933189e-5,
            2.9224613819028337e-5,
            2.7895636897735858e-5,
            2.991273017596313e-5,
            0.00010523207922672109,
            3.8346589452670114e-5,
            3.3153772652402006e-5,
            2.7120949554690233e-5,
            3.291338337848911e-5,
            3.27809275373234e-5,
            2.663584778392028e-5,
            2.292264662243813e-5,
            3.3651246862384525e-5,
            2.2611451951324402e-5,
            7.07499647690489e-5,
            6.568371505107873e-5,
            7.52738320561967e-5,
            8.790417559576765e-5,
            7.559463647185589e-5,
            7.857664921604262e-5,
            9.240270648661293e-5,
            4.795930367789056e-5,
            9.799192063537893e-5,
            0.0001012798687186678,
            3.8346589452670114e-5,
            0.0007058986609157664,
            0.00017970842171632237,
            4.680044428300821e-5,
            0.00010728338804722919,
            0.00012036203496431589,
            6.863703788105435e-5,
            5.073287772575147e-5,
            8.21914782720405e-5,
            7.641141558976833e-5,
            1.919340415249585e-5,
            2.8093343086444576e-5,
            3.178132158303975e-5,
            8.060293394984372e-5,
            2.2896731194239402e-5,
            8.306038548137086e-5,
            0.00012294016376712317,
            5.9195505169616165e-5,
            0.00010121329413385771,
            0.00010058404532128184,
            3.3153772652402006e-5,
            0.00017970842171632237,
            0.0019417957296906064,
            5.041904922331697e-5,
            0.0001423909951567325,
            0.00013461278518958278,
            4.480714465918543e-5,
            3.29588900215982e-5,
            7.08238354754046e-5,
            5.863305409330455e-5,
            2.7635142768275865e-5,
            3.1902179088675707e-5,
            2.0006874569844294e-5,
            3.153793507418763e-5,
            2.8836199417850844e-5,
            4.024004073885486e-5,
            5.961962445537456e-5,
            1.8254144202435076e-5,
            5.187498163984717e-5,
            4.0095676833583735e-5,
            2.7120949554690233e-5,
            4.680044428300821e-5,
            5.041904922331697e-5,
            0.00014347473100888376,
            9.490198692412218e-5,
            4.2408320469182906e-5,
            3.80851702989904e-5,
            2.607301255274926e-5,
            4.937558691036947e-5,
            1.8775056994051316e-5,
            2.4899996577966644e-5,
            3.5839879298544966e-5,
            1.990610418838896e-5,
            5.350327040620056e-5,
            4.604151609381458e-5,
            5.282807111447673e-5,
            0.00014475297064541138,
            1.6292977451999615e-5,
            7.752656073980324e-5,
            5.6053840090225026e-5,
            3.291338337848911e-5,
            0.00010728338804722919,
            0.0001423909951567325,
            9.490198692412218e-5,
            0.0009925919307124018,
            7.958886029744778e-5,
            3.416694732093082e-5,
            1.71643678873937e-5,
            5.863617440251285e-5,
            2.135666399668303e-5,
            4.5818889711417205e-5,
            6.0635288777962045e-5,
            3.691354862764159e-5,
            5.50822067069581e-5,
            5.330073489964903e-5,
            4.46476686450183e-5,
            0.00010536703797465925,
            5.874257792193607e-5,
            8.280895619323395e-5,
            8.42718184647058e-5,
            3.27809275373234e-5,
            0.00012036203496431589,
            0.00013461278518958278,
            4.2408320469182906e-5,
            7.958886029744778e-5,
            0.0005048938009079831,
            5.583734790614842e-5,
            3.2682879382105955e-5,
            6.487903321451377e-5,
            4.903860852666143e-5,
            7.148890225301703e-5,
            5.847041542925502e-5,
            7.193345065702455e-5,
            7.258446776763506e-5,
            7.997168181991059e-5,
            4.065334993458338e-5,
            0.00010640975822559856,
            3.315916914318532e-5,
            6.655277228781742e-5,
            4.8328610883378295e-5,
            2.663584778392028e-5,
            6.863703788105435e-5,
            4.480714465918543e-5,
            3.80851702989904e-5,
            3.416694732093082e-5,
            5.583734790614842e-5,
            0.00016225723157954668,
            3.968226502212513e-5,
            6.106654743182969e-5,
            4.9497511584460304e-5,
            3.797093766066356e-5,
            3.3677708529122014e-5,
            3.421692126589264e-5,
            3.4135496213278316e-5,
            3.5112726024940944e-5,
            3.411287236071691e-5,
            5.3980004767739685e-5,
            2.8443441523077334e-5,
            4.16772440706494e-5,
            3.485291477532223e-5,
            2.292264662243813e-5,
            5.073287772575147e-5,
            3.29588900215982e-5,
            2.607301255274926e-5,
            1.71643678873937e-5,
            3.2682879382105955e-5,
            3.968226502212513e-5,
            0.00012188927616787188,
            4.1230763833977815e-5,
            3.171017222109923e-5,
            5.4206126776390346e-5,
            5.2554705292333276e-5,
            5.1298725984165446e-5,
            5.646446357340958e-5,
            5.6762531126068076e-5,
            5.325683752452865e-5,
            9.176142515359876e-5,
            2.7726145996789834e-5,
            0.0001389129064723086,
            6.623082399674407e-5,
            3.3651246862384525e-5,
            8.21914782720405e-5,
            7.08238354754046e-5,
            4.937558691036947e-5,
            5.863617440251285e-5,
            6.487903321451377e-5,
            6.106654743182969e-5,
            4.1230763833977815e-5,
            0.00018469455212296524,
            4.1818740776637804e-5,
            5.430868038079555e-5,
            4.311682087740567e-5,
            5.3008504387511776e-5,
            4.608290500591353e-5,
            6.203182070762331e-5,
            3.777397463136236e-5,
            5.944895152347324e-5,
            3.239414212027499e-5,
            4.4587790083641915e-5,
            4.480131845962774e-5,
            2.2611451951324402e-5,
            7.641141558976833e-5,
            5.863305409330455e-5,
            1.8775056994051316e-5,
            2.135666399668303e-5,
            4.903860852666143e-5,
            4.9497511584460304e-5,
            3.171017222109923e-5,
            4.1818740776637804e-5,
            0.0001577154410284821,
        ],
        20,
        20,
    )

    covgt2 = reshape(
        [
            0.00020974121242454936,
            8.70065424759032e-5,
            0.00013662231814612843,
            0.0001183229955995031,
            0.000155490860814295,
            5.470393847285265e-5,
            0.00014484835373731222,
            4.66528587758943e-5,
            8.0701287312996e-5,
            6.816628249900913e-5,
            3.643033465333079e-5,
            0.00010446441111282032,
            2.830452275749481e-5,
            4.014494241623802e-5,
            3.602179536253007e-5,
            6.714489577947147e-5,
            9.634380592297494e-5,
            5.440874346418598e-5,
            7.550849319735956e-5,
            7.743947610504054e-5,
            8.70065424759032e-5,
            0.00021128710779431083,
            9.579166305475039e-5,
            8.977604140159876e-5,
            0.00010946906408577506,
            5.568221796905987e-5,
            0.0001622603419926778,
            4.646235640248941e-5,
            8.101472553307369e-5,
            6.322290581474791e-5,
            3.656762437904325e-5,
            9.677012573113802e-5,
            4.151462663988477e-5,
            4.58612104902158e-5,
            5.140571820872446e-5,
            8.878331036982379e-5,
            8.143216919644634e-5,
            4.7772650083271003e-5,
            7.471184893264415e-5,
            6.073456693430828e-5,
            0.00013662231814612843,
            9.579166305475039e-5,
            0.00025695402208570294,
            0.00011625231675956524,
            0.00015898359903319308,
            5.439415682228453e-5,
            0.00014622547271329835,
            2.9944008816319307e-5,
            8.158169064997873e-5,
            6.514594822408642e-5,
            3.247454896021071e-5,
            0.0001131472029456251,
            4.7518529968612995e-5,
            2.8844281828734148e-5,
            2.8471008882917638e-5,
            5.454434482943973e-5,
            9.860345228040192e-5,
            4.8908760235395564e-5,
            7.302191921587462e-5,
            7.557579819604379e-5,
            0.0001183229955995031,
            8.977604140159876e-5,
            0.00011625231675956524,
            0.0004001801144507071,
            0.00014229922894717735,
            6.463635339853627e-5,
            0.0002027189842201594,
            4.570209170875722e-5,
            8.111209884156549e-5,
            7.357754025709192e-5,
            3.1976988826564284e-5,
            0.00013088167641490484,
            0.00011791199161477501,
            4.573201135639379e-5,
            7.596389534870286e-5,
            8.173478702354349e-5,
            0.00010149887516408042,
            4.8948901064002e-5,
            8.024387174882533e-5,
            6.614156203006114e-5,
            0.000155490860814295,
            0.00010946906408577506,
            0.00015898359903319308,
            0.00014229922894717735,
            0.0003307345138947058,
            6.502823894711227e-5,
            0.00016637867628405356,
            5.4403654986591854e-5,
            8.692231844976575e-5,
            6.886409340988716e-5,
            3.814222669770251e-5,
            0.0001130768288552334,
            3.420722302422444e-5,
            4.1968740411643694e-5,
            6.687992350286982e-5,
            7.862374531990129e-5,
            0.00011061901224732318,
            5.179435437716664e-5,
            8.23355500962909e-5,
            9.030508849626846e-5,
            5.470393847285265e-5,
            5.568221796905987e-5,
            5.439415682228453e-5,
            6.463635339853627e-5,
            6.502823894711227e-5,
            0.00017888762723415697,
            9.673193707013383e-5,
            4.437157156581276e-5,
            8.980341947137229e-5,
            8.320349298869806e-5,
            4.3168787974994604e-5,
            0.00011261612762585564,
            0.00012200734510681284,
            5.8325937820590826e-5,
            7.589529243381545e-5,
            6.507970307648992e-5,
            5.6909879471024164e-5,
            4.8542225267319e-5,
            7.584668909730006e-5,
            5.548616626560539e-5,
            0.00014484835373731222,
            0.0001622603419926778,
            0.00014622547271329835,
            0.0002027189842201594,
            0.00016637867628405356,
            9.673193707013383e-5,
            0.0016463440752944537,
            9.07041636108483e-5,
            0.00016403817375841968,
            0.00015138047294022854,
            6.491313951500416e-5,
            0.0001423334990172544,
            0.00018725504603040656,
            9.032051677504037e-5,
            0.0002156275323104518,
            0.00015802022844391839,
            0.0001561756396807977,
            8.197698540076858e-5,
            0.00013833120393823137,
            8.933091031704791e-5,
            4.66528587758943e-5,
            4.646235640248941e-5,
            2.9944008816319307e-5,
            4.570209170875722e-5,
            5.4403654986591854e-5,
            4.437157156581276e-5,
            9.07041636108483e-5,
            0.0001633526931390734,
            3.7077618371382444e-5,
            5.1370845637867264e-5,
            4.1587766511183166e-5,
            7.043861136733189e-5,
            8.752898754425453e-5,
            2.6338967892948126e-5,
            2.408516833155571e-5,
            8.494325539139998e-5,
            4.797240157327402e-5,
            4.1859048788647364e-5,
            4.050556718736145e-5,
            4.739590741697392e-5,
            8.0701287312996e-5,
            8.101472553307369e-5,
            8.158169064997873e-5,
            8.111209884156549e-5,
            8.692231844976575e-5,
            8.980341947137229e-5,
            0.00016403817375841968,
            3.7077618371382444e-5,
            0.0002758911957869664,
            0.0001103121676939658,
            3.937951993657368e-5,
            0.00014419900642482117,
            0.0001479490455259325,
            7.435687139964868e-5,
            0.00011141911162049639,
            0.00011922886171465122,
            9.029642879293375e-5,
            5.905845551468503e-5,
            0.00017014049270036387,
            6.346874873329079e-5,
            6.816628249900913e-5,
            6.322290581474791e-5,
            6.514594822408642e-5,
            7.357754025709192e-5,
            6.886409340988716e-5,
            8.320349298869806e-5,
            0.00015138047294022854,
            5.1370845637867264e-5,
            0.0001103121676939658,
            0.00024305024441962945,
            4.19751887723022e-5,
            0.0001465521948763164,
            0.00014508752113268447,
            5.827063122995585e-5,
            7.98468591338854e-5,
            0.0001196812130624784,
            6.905576797643164e-5,
            4.9328616318109774e-5,
            9.261616612023958e-5,
            6.367751664975844e-5,
            3.643033465333079e-5,
            3.656762437904325e-5,
            3.247454896021071e-5,
            3.1976988826564284e-5,
            3.814222669770251e-5,
            4.3168787974994604e-5,
            6.491313951500416e-5,
            4.1587766511183166e-5,
            3.937951993657368e-5,
            4.19751887723022e-5,
            0.00010523207922672109,
            5.619590801029284e-5,
            4.852744431453035e-5,
            3.852876031486888e-5,
            4.622259911245658e-5,
            4.7798269379021414e-5,
            3.714917018621213e-5,
            3.294908550197259e-5,
            4.7716725535356175e-5,
            3.1649465077283306e-5,
            0.00010446441111282032,
            9.677012573113802e-5,
            0.0001131472029456251,
            0.00013088167641490484,
            0.0001130768288552334,
            0.00011261612762585564,
            0.0001423334990172544,
            7.043861136733189e-5,
            0.00014419900642482117,
            0.0001465521948763164,
            5.619590801029284e-5,
            0.0007058986609157663,
            0.0002679071114442697,
            7.077340619506927e-5,
            0.0001569275191097776,
            0.00017876289201031217,
            9.947001305320075e-5,
            7.630993326897423e-5,
            0.00012214946001818907,
            0.00011339384027598847,
            2.830452275749481e-5,
            4.151462663988477e-5,
            4.7518529968612995e-5,
            0.00011791199161477501,
            3.420722302422444e-5,
            0.00012200734510681284,
            0.00018725504603040656,
            8.752898754425453e-5,
            0.0001479490455259325,
            0.00014508752113268447,
            4.852744431453035e-5,
            0.0002679071114442697,
            0.0019417957296906068,
            7.363576423154904e-5,
            0.0002029062787455756,
            0.0001987797776016755,
            6.499408649491043e-5,
            4.928429542640213e-5,
            0.00010278103162016824,
            8.522821576009881e-5,
            4.014494241623802e-5,
            4.58612104902158e-5,
            2.8844281828734148e-5,
            4.573201135639379e-5,
            4.1968740411643694e-5,
            5.8325937820590826e-5,
            9.032051677504037e-5,
            2.6338967892948126e-5,
            7.435687139964868e-5,
            5.827063122995585e-5,
            3.852876031486888e-5,
            7.077340619506927e-5,
            7.363576423154904e-5,
            0.00014347473100888379,
            0.00013455366620922977,
            6.265196393368165e-5,
            5.3434365294935004e-5,
            3.761355291236558e-5,
            7.015695550795746e-5,
            2.7215871982211317e-5,
            3.602179536253007e-5,
            5.140571820872446e-5,
            2.8471008882917638e-5,
            7.596389534870286e-5,
            6.687992350286982e-5,
            7.589529243381545e-5,
            0.0002156275323104518,
            2.408516833155571e-5,
            0.00011141911162049639,
            7.98468591338854e-5,
            4.622259911245658e-5,
            0.0001569275191097776,
            0.0002029062787455756,
            0.00013455366620922977,
            0.0009925919307124016,
            0.00011547316588305963,
            4.7962405424236676e-5,
            2.505921297910968e-5,
            8.592012571786864e-5,
            3.0519816829842606e-5,
            6.714489577947147e-5,
            8.878331036982379e-5,
            5.454434482943973e-5,
            8.173478702354349e-5,
            7.862374531990129e-5,
            6.507970307648992e-5,
            0.00015802022844391839,
            8.494325539139998e-5,
            0.00011922886171465122,
            0.0001196812130624784,
            4.7798269379021414e-5,
            0.00017876289201031217,
            0.0001987797776016755,
            6.265196393368165e-5,
            0.00011547316588305963,
            0.000504893800907983,
            8.091319798773893e-5,
            4.7943893927250424e-5,
            9.329148647305474e-5,
            7.175792614465586e-5,
            9.634380592297494e-5,
            8.143216919644634e-5,
            9.860345228040192e-5,
            0.00010149887516408042,
            0.00011061901224732318,
            5.6909879471024164e-5,
            0.0001561756396807977,
            4.797240157327402e-5,
            9.029642879293375e-5,
            6.905576797643164e-5,
            3.714917018621213e-5,
            9.947001305320075e-5,
            6.499408649491043e-5,
            5.3434365294935004e-5,
            4.7962405424236676e-5,
            8.091319798773893e-5,
            0.0001622572315795467,
            5.6248126683981794e-5,
            8.406589751415287e-5,
            6.97134918583332e-5,
            5.440874346418598e-5,
            4.7772650083271003e-5,
            4.8908760235395564e-5,
            4.8948901064002e-5,
            5.179435437716664e-5,
            4.8542225267319e-5,
            8.197698540076858e-5,
            4.1859048788647364e-5,
            5.905845551468503e-5,
            4.9328616318109774e-5,
            3.294908550197259e-5,
            7.630993326897423e-5,
            4.928429542640213e-5,
            3.761355291236558e-5,
            2.505921297910968e-5,
            4.7943893927250424e-5,
            5.6248126683981794e-5,
            0.00012188927616787188,
            5.7504006732060984e-5,
            4.427454016404935e-5,
            7.550849319735956e-5,
            7.471184893264415e-5,
            7.302191921587462e-5,
            8.024387174882533e-5,
            8.23355500962909e-5,
            7.584668909730006e-5,
            0.00013833120393823137,
            4.050556718736145e-5,
            0.00017014049270036387,
            9.261616612023958e-5,
            4.7716725535356175e-5,
            0.00012214946001818907,
            0.00010278103162016824,
            7.015695550795746e-5,
            8.592012571786864e-5,
            9.329148647305474e-5,
            8.406589751415287e-5,
            5.7504006732060984e-5,
            0.00018469455212296524,
            5.932547174202987e-5,
            7.743947610504054e-5,
            6.073456693430828e-5,
            7.557579819604379e-5,
            6.614156203006114e-5,
            9.030508849626846e-5,
            5.548616626560539e-5,
            8.933091031704791e-5,
            4.739590741697392e-5,
            6.346874873329079e-5,
            6.367751664975844e-5,
            3.1649465077283306e-5,
            0.00011339384027598847,
            8.522821576009881e-5,
            2.7215871982211317e-5,
            3.0519816829842606e-5,
            7.175792614465586e-5,
            6.97134918583332e-5,
            4.427454016404935e-5,
            5.932547174202987e-5,
            0.00015771544102848213,
        ],
        20,
        20,
    )
    @test isapprox(covgt1, covg1)
    @test isapprox(covgt2, covg2)

    portfolio = HCPortfolio(returns = returns)

    asset_statistics!(portfolio, jlogo = true)

    covj = copy(portfolio.cov)
    covjt = reshape(
        [
            0.00020997582228184737,
            9.803674633175464e-5,
            0.00014077374362954793,
            0.00011822768246482305,
            0.00015839638863970605,
            4.134249512939413e-5,
            9.741361595383921e-5,
            3.088472057695859e-5,
            8.723400768938203e-5,
            4.695561415789377e-5,
            2.410793390349611e-5,
            7.697761692810674e-5,
            5.0213913154013506e-5,
            4.657297911600372e-5,
            6.041300540147265e-5,
            4.007622815237787e-5,
            9.852662188755091e-5,
            4.2581217516476454e-5,
            7.891750241335416e-5,
            8.308464134357728e-5,
            9.803674633175465e-5,
            0.00021152344684106046,
            8.070483057492823e-5,
            7.345023656198462e-5,
            8.622173019184438e-5,
            4.428661971580518e-5,
            0.0001302364476786511,
            3.0805102198474415e-5,
            9.441947447077707e-5,
            5.079396190194336e-5,
            2.5625742533149956e-5,
            6.843664330541139e-5,
            5.434336230275222e-5,
            4.824450286505276e-5,
            6.332376221790682e-5,
            4.338668439198836e-5,
            9.258430057865659e-5,
            4.32569168917907e-5,
            8.569427917973395e-5,
            5.800692429397668e-5,
            0.00014077374362954793,
            8.070483057492824e-5,
            0.0002572414426920628,
            9.907520278111458e-5,
            0.00015334295879523472,
            3.9753234112169053e-5,
            9.26118854903671e-5,
            3.091630885459725e-5,
            8.337939553449811e-5,
            4.4888780957011246e-5,
            2.328729997945842e-5,
            7.756460767061063e-5,
            4.799509093176798e-5,
            4.566092116229601e-5,
            5.8836037779678905e-5,
            3.829743915517536e-5,
            0.00010166996305493107,
            4.2204522581317837e-5,
            7.526496401459743e-5,
            8.802924838121843e-5,
            0.000118227682464823,
            7.345023656198461e-5,
            9.907520278111457e-5,
            0.0004006277432140748,
            0.00013259642444595363,
            3.656822111047857e-5,
            8.810273446710931e-5,
            2.9742503351053496e-5,
            7.622510549864202e-5,
            4.1020950028742595e-5,
            2.1533972054045348e-5,
            6.244898023158406e-5,
            4.386538350476626e-5,
            4.293671627681013e-5,
            5.492306428908416e-5,
            3.499344009076798e-5,
            0.00010093601577900456,
            4.0169975051465906e-5,
            6.85725638068425e-5,
            6.258847359456458e-5,
            0.00015839638863970608,
            8.622173019184438e-5,
            0.00015334295879523472,
            0.00013259642444595363,
            0.0003311044630153935,
            4.038058059540701e-5,
            9.583901646637e-5,
            3.161780823422457e-5,
            8.463726955701523e-5,
            4.555542067291643e-5,
            2.367290551940056e-5,
            7.328255734548557e-5,
            4.87135900731346e-5,
            4.653304028701638e-5,
            5.9897079161003374e-5,
            3.886927014428788e-5,
            0.00010448970386759234,
            4.309114571855092e-5,
            7.634401145955454e-5,
            7.776687178020369e-5,
            4.134249512939419e-5,
            4.4286619715805225e-5,
            3.9753234112169114e-5,
            3.656822111047864e-5,
            4.0380580595407055e-5,
            0.00017908772525119732,
            6.489402909991504e-5,
            2.5028507197328273e-5,
            9.962273724791334e-5,
            8.680193208085993e-5,
            5.277338640116081e-5,
            6.097685395858871e-5,
            7.124243170541165e-5,
            6.946631411775527e-5,
            0.00010068570060338062,
            5.388381392162784e-5,
            5.3206272630080165e-5,
            4.00742109894251e-5,
            9.128928696697807e-5,
            3.6671470230580326e-5,
            9.741361595383927e-5,
            0.00013023644767865114,
            9.261188549036715e-5,
            8.810273446710938e-5,
            9.583901646637e-5,
            6.4894029099915e-5,
            0.0016481856234771088,
            4.424596013731999e-5,
            0.00013873440279034985,
            7.462295424808122e-5,
            3.7471916631902144e-5,
            9.514621072757057e-5,
            7.984666848657677e-5,
            7.004888096269947e-5,
            9.22439789559985e-5,
            6.375373838021073e-5,
            0.00013058586088202266,
            6.246142917350003e-5,
            0.00012602293719272368,
            7.362065024292618e-5,
            3.08847205769586e-5,
            3.080510219847442e-5,
            3.091630885459727e-5,
            2.9742503351053513e-5,
            3.161780823422457e-5,
            2.5028507197328253e-5,
            4.4245960137319985e-5,
            0.0001635354142723386,
            5.178413394383976e-5,
            2.8116150979283105e-5,
            1.469733389523753e-5,
            3.4709767831462856e-5,
            2.991739160561292e-5,
            2.901108129345606e-5,
            3.718896301005846e-5,
            2.3872325284642976e-5,
            4.6014215745053086e-5,
            4.450058196330504e-5,
            4.723912468936465e-5,
            2.5631155975938334e-5,
            8.723400768938216e-5,
            9.441947447077717e-5,
            8.337939553449825e-5,
            7.622510549864213e-5,
            8.463726955701532e-5,
            9.962273724791336e-5,
            0.0001387344027903499,
            5.1784133943839795e-5,
            0.0002761997989142426,
            0.0001258404123778019,
            5.5197475609638086e-5,
            0.0001417373885547038,
            0.0001484507282492688,
            9.14050552075807e-5,
            0.0001353618737737425,
            0.00011844433793628722,
            0.00010985321115130256,
            7.870483515637123e-5,
            0.0002011793054113852,
            7.788398396676904e-5,
            4.6955614157893846e-5,
            5.079396190194342e-5,
            4.488878095701133e-5,
            4.102095002874267e-5,
            4.555542067291649e-5,
            8.680193208085995e-5,
            7.462295424808129e-5,
            2.8116150979283132e-5,
            0.00012584041237780196,
            0.00024332211270197752,
            3.679005664812949e-5,
            7.277466203867336e-5,
            0.0001457443295728806,
            5.72686623984398e-5,
            8.137270380669468e-5,
            0.00010005844523863923,
            5.910666680743218e-5,
            4.341172302514207e-5,
            0.00010817672206732099,
            4.1999000458699494e-5,
            2.4107933903496137e-5,
            2.5625742533149973e-5,
            2.3287299979458445e-5,
            2.1533972054045372e-5,
            2.3672905519400578e-5,
            5.277338640116079e-5,
            3.747191663190216e-5,
            1.4697333895237537e-5,
            5.5197475609638065e-5,
            3.6790056648129484e-5,
            0.00010534978848760097,
            3.447283147876063e-5,
            3.476298535587916e-5,
            4.853189091930909e-5,
            5.9253564059689923e-5,
            2.7163178806229894e-5,
            3.156891859240837e-5,
            2.412239965940403e-5,
            5.140975472359201e-5,
            2.1234135644375778e-5,
            7.697761692810682e-5,
            6.843664330541146e-5,
            7.75646076706107e-5,
            6.244898023158416e-5,
            7.328255734548563e-5,
            6.097685395858872e-5,
            9.514621072757063e-5,
            3.4709767831462876e-5,
            0.0001417373885547038,
            7.277466203867336e-5,
            3.447283147876066e-5,
            0.0007066882567333448,
            7.998599079162263e-5,
            6.019307841605814e-5,
            8.302509502935594e-5,
            6.388032472082338e-5,
            8.383990731316273e-5,
            5.15179129885043e-5,
            0.00012182889805680192,
            0.00010811590662763465,
            5.021391315401357e-5,
            5.43433623027523e-5,
            4.799509093176807e-5,
            4.386538350476632e-5,
            4.871359007313466e-5,
            7.124243170541166e-5,
            7.984666848657684e-5,
            2.991739160561294e-5,
            0.00014845072824926883,
            0.0001457443295728806,
            3.4762985355879176e-5,
            7.998599079162263e-5,
            0.0019439677607081564,
            5.6091190985797525e-5,
            8.143828238380116e-5,
            0.00023386599375945137,
            6.320360210863741e-5,
            4.576565505327067e-5,
            0.00011581541521370314,
            4.487264327698091e-5,
            4.657297911600371e-5,
            4.824450286505274e-5,
            4.5660921162296005e-5,
            4.293671627681013e-5,
            4.6533040287016354e-5,
            6.94663141177552e-5,
            7.00488809626994e-5,
            2.901108129345604e-5,
            9.140505520758058e-5,
            5.72686623984397e-5,
            4.853189091930907e-5,
            6.019307841605804e-5,
            5.609119098579743e-5,
            0.00014363521728517984,
            0.00015453720776819601,
            4.42507949454857e-5,
            6.444039069141756e-5,
            5.124788460850674e-5,
            8.774182747957663e-5,
            4.0057278945382356e-5,
            6.041300540147268e-5,
            6.332376221790682e-5,
            5.883603777967893e-5,
            5.49230642890842e-5,
            5.989707916100338e-5,
            0.00010068570060338056,
            9.224397895599845e-5,
            3.718896301005845e-5,
            0.00013536187377374235,
            8.137270380669458e-5,
            5.925356405968988e-5,
            8.302509502935583e-5,
            8.143828238380108e-5,
            0.00015453720776819607,
            0.0009937022125140933,
            6.413867647869578e-5,
            8.159223034002054e-5,
            6.341331115400401e-5,
            0.00012057821002300521,
            5.249442561506602e-5,
            4.007622815237791e-5,
            4.33866843919884e-5,
            3.8297439155175416e-5,
            3.4993440090768036e-5,
            3.8869270144287924e-5,
            5.388381392162783e-5,
            6.375373838021077e-5,
            2.3872325284642983e-5,
            0.00011844433793628725,
            0.00010005844523863921,
            2.7163178806229897e-5,
            6.388032472082338e-5,
            0.00023386599375945131,
            4.4250794945485765e-5,
            6.413867647869583e-5,
            0.0005054585590745461,
            5.040215722614181e-5,
            3.648074552416068e-5,
            9.256991406046881e-5,
            3.582548495164837e-5,
            9.85266218875509e-5,
            9.258430057865655e-5,
            0.00010166996305493103,
            0.00010093601577900456,
            0.00010448970386759227,
            5.320627263008006e-5,
            0.00013058586088202253,
            4.601421574505306e-5,
            0.00010985321115130236,
            5.910666680743206e-5,
            3.156891859240832e-5,
            8.383990731316258e-5,
            6.320360210863729e-5,
            6.444039069141754e-5,
            8.159223034002047e-5,
            5.0402157226141716e-5,
            0.00016243872736431124,
            6.127832941435988e-5,
            9.838072451447072e-5,
            7.735879911530241e-5,
            4.258121751647646e-5,
            4.325691689179071e-5,
            4.220452258131785e-5,
            4.016997505146593e-5,
            4.309114571855092e-5,
            4.007421098942506e-5,
            6.24614291735e-5,
            4.450058196330504e-5,
            7.870483515637113e-5,
            4.341172302514201e-5,
            2.412239965940402e-5,
            5.151791298850423e-5,
            4.576565505327062e-5,
            5.124788460850676e-5,
            6.341331115400401e-5,
            3.6480745524160645e-5,
            6.12783294143599e-5,
            0.00012202561764009533,
            7.235602099204436e-5,
            3.5948219586652974e-5,
            7.891750241335428e-5,
            8.569427917973406e-5,
            7.526496401459755e-5,
            6.857256380684262e-5,
            7.634401145955463e-5,
            9.128928696697808e-5,
            0.00012602293719272376,
            4.723912468936469e-5,
            0.0002011793054113852,
            0.00010817672206732099,
            5.140975472359204e-5,
            0.00012182889805680191,
            0.00011581541521370316,
            8.774182747957677e-5,
            0.00012057821002300536,
            9.256991406046881e-5,
            9.838072451447094e-5,
            7.235602099204444e-5,
            0.0001849011455817144,
            7.089867226693533e-5,
            8.308464134357728e-5,
            5.800692429397668e-5,
            8.802924838121843e-5,
            6.25884735945646e-5,
            7.776687178020369e-5,
            3.667147023058028e-5,
            7.362065024292616e-5,
            2.5631155975938327e-5,
            7.788398396676894e-5,
            4.199900045869944e-5,
            2.1234135644375764e-5,
            0.00010811590662763458,
            4.487264327698086e-5,
            4.005727894538237e-5,
            5.249442561506602e-5,
            3.582548495164833e-5,
            7.735879911530245e-5,
            3.5948219586652974e-5,
            7.089867226693525e-5,
            0.00015789185651061675,
        ],
        20,
        20,
    )

    @test isapprox(covjt, covj)

    cov_mtx = reshape(
        [
            3.21391539839344,
            1.3953377554695519,
            2.5674375637791624,
            2.4443650120801395,
            3.0704634820747216,
            3.01183668435095,
            2.1222593889914108,
            1.3953377554695519,
            1.263679632566557,
            1.1684199185619657,
            1.120156072466662,
            1.7052774841127447,
            1.826522921049684,
            1.3234876825731399,
            2.5674375637791624,
            1.1684199185619657,
            2.6558231344470693,
            1.9629659998544318,
            2.6646207386161693,
            2.856579711073332,
            2.0197212244118314,
            2.4443650120801395,
            1.120156072466662,
            1.9629659998544318,
            2.3400698580374577,
            2.523383764177392,
            2.7159940128544333,
            1.472526357274328,
            3.0704634820747216,
            1.7052774841127447,
            2.6646207386161693,
            2.523383764177392,
            3.6570152564979654,
            3.516092668105584,
            2.1411535025278345,
            3.01183668435095,
            1.826522921049684,
            2.856579711073332,
            2.7159940128544333,
            3.516092668105584,
            4.171970824886582,
            2.5127642696638537,
            2.1222593889914108,
            1.3234876825731399,
            2.0197212244118314,
            1.472526357274328,
            2.1411535025278345,
            2.5127642696638537,
            2.3049355787543084,
        ],
        7,
        7,
    )

    cov1 = denoise_cov(cov_mtx, 100, :Fixed; alpha = 0.0, detone = false, mkt_comp = 1)
    cov2 = denoise_cov(cov_mtx, 100, :Spectral; alpha = 0.0, detone = false, mkt_comp = 1)
    cov3 = denoise_cov(cov_mtx, 100, :Shrink; alpha = 0.0, detone = false, mkt_comp = 1)
    cov4 = denoise_cov(cov_mtx, 100, :Shrink; alpha = 0.5, detone = false, mkt_comp = 1)
    cov5 = denoise_cov(cov_mtx, 100, :Shrink; alpha = 1.0, detone = false, mkt_comp = 1)
    cov6 = denoise_cov(cov_mtx, 100, :Fixed; alpha = 0.0, detone = true, mkt_comp = 2)
    cov7 = denoise_cov(cov_mtx, 100, :Spectral; alpha = 0.0, detone = true, mkt_comp = 2)
    cov8 = denoise_cov(cov_mtx, 100, :Shrink; alpha = 0.0, detone = true, mkt_comp = 2)
    cov9 = denoise_cov(cov_mtx, 100, :Shrink; alpha = 0.5, detone = true, mkt_comp = 2)
    cov10 = denoise_cov(cov_mtx, 100, :Shrink; alpha = 1.0, detone = true, mkt_comp = 2)

    cov1t = reshape(
        [
            3.213915398393439,
            1.590896553184143,
            2.353418072088162,
            2.1987815157775055,
            2.780235842824061,
            2.970101676148083,
            2.167945274740482,
            1.590896553184143,
            1.2636796325665567,
            1.4402347651090257,
            1.3456009442011516,
            1.7014368860032298,
            1.81763016976476,
            1.3267299127879366,
            2.353418072088162,
            1.4402347651090257,
            2.6558231344470693,
            1.9905515374734348,
            2.516940720012943,
            2.688825795326197,
            1.9626355637553985,
            2.1987815157775055,
            1.3456009442011516,
            1.9905515374734348,
            2.3400698580374577,
            2.351559545287994,
            2.512150530340415,
            1.8336762392429158,
            2.780235842824061,
            1.70143688600323,
            2.5169407200129434,
            2.3515595452879943,
            3.6570152564979646,
            3.176473377143236,
            2.3185807084044336,
            2.9701016761480834,
            1.81763016976476,
            2.688825795326197,
            2.512150530340415,
            3.176473377143236,
            4.171970824886581,
            2.4769195268418835,
            2.1679452747404824,
            1.3267299127879366,
            1.9626355637553992,
            1.833676239242916,
            2.3185807084044336,
            2.476919526841884,
            2.304935578754309,
        ],
        7,
        7,
    )
    cov2t = reshape(
        [
            3.21391539839344,
            2.0152814765540374,
            2.9215733547540728,
            2.7424052490583763,
            3.428314111194968,
            3.6617429286818,
            2.7217398753119975,
            2.0152814765540374,
            1.2636796325665567,
            1.8319687777633749,
            1.719621649777895,
            2.1497199109701803,
            2.2960911478142743,
            1.70666345400897,
            2.9215733547540728,
            1.8319687777633749,
            2.6558231344470693,
            2.4929523993045173,
            3.116470073854902,
            3.3286658938637874,
            2.4741667755965513,
            2.742405249058376,
            1.719621649777895,
            2.4929523993045173,
            2.3400698580374573,
            2.925349752100423,
            3.1245324731755884,
            2.3224362795480693,
            3.428314111194968,
            2.149719910970181,
            3.1164700738549023,
            2.9253497521004235,
            3.6570152564979654,
            3.906015995394109,
            2.9033058014527975,
            3.6617429286818,
            2.2960911478142743,
            3.3286658938637874,
            3.1245324731755884,
            3.906015995394109,
            4.171970824886582,
            3.1009875826591187,
            2.7217398753119975,
            1.7066634540089702,
            2.4741667755965517,
            2.3224362795480697,
            2.9033058014527975,
            3.1009875826591187,
            2.3049355787543084,
        ],
        7,
        7,
    )
    cov3t = reshape(
        [
            3.2139153983934414,
            1.579713913957069,
            2.517604322789144,
            2.3089729560851726,
            3.059341699088417,
            3.270970191121526,
            2.2212342966578746,
            1.579713913957069,
            1.263679632566557,
            1.4058858773590457,
            1.2893815127262893,
            1.7084039973362646,
            1.826582022970779,
            1.2403863068193508,
            2.517604322789144,
            1.4058858773590457,
            2.6558231344470697,
            2.0548989544776086,
            2.722698870196139,
            2.9110402562961446,
            1.9768148526048401,
            2.308972956085172,
            1.2893815127262893,
            2.0548989544776086,
            2.340069858037458,
            2.4970715222961823,
            2.6698052450182383,
            1.8129981715297343,
            3.059341699088417,
            1.7084039973362648,
            2.7226988701961394,
            2.497071522296183,
            3.6570152564979654,
            3.537437063956662,
            2.4021853057716673,
            3.2709701911215263,
            1.826582022970779,
            2.9110402562961446,
            2.669805245018239,
            3.5374370639566615,
            4.171970824886581,
            2.5683553200580835,
            2.221234296657875,
            1.2403863068193508,
            1.9768148526048406,
            1.8129981715297345,
            2.4021853057716673,
            2.568355320058084,
            2.304935578754308,
        ],
        7,
        7,
    )
    cov4t = reshape(
        [
            3.2139153983934414,
            1.4875258347133102,
            2.542520943284153,
            2.376668984082656,
            3.0649025905815686,
            3.1414034377362374,
            2.1717468428246427,
            1.4875258347133102,
            1.263679632566557,
            1.2871528979605058,
            1.204768792596476,
            1.7068407407245045,
            1.8265524720102324,
            1.2819369946962451,
            2.542520943284153,
            1.2871528979605056,
            2.6558231344470697,
            2.00893247716602,
            2.693659804406154,
            2.8838099836847384,
            1.9982680385083358,
            2.3766689840826554,
            1.204768792596476,
            2.00893247716602,
            2.340069858037458,
            2.5102276432367874,
            2.692899628936336,
            1.6427622644020308,
            3.0649025905815686,
            1.7068407407245048,
            2.6936598044061544,
            2.510227643236788,
            3.6570152564979654,
            3.5267648660311233,
            2.2716694041497507,
            3.1414034377362374,
            1.8265524720102324,
            2.8838099836847384,
            2.6928996289363365,
            3.526764866031123,
            4.171970824886582,
            2.5405597948609686,
            2.171746842824643,
            1.2819369946962453,
            1.9982680385083362,
            1.642762264402031,
            2.2716694041497507,
            2.540559794860969,
            2.304935578754308,
        ],
        7,
        7,
    )
    cov5t = reshape(
        [
            3.2139153983934414,
            1.3953377554695514,
            2.5674375637791624,
            2.444365012080139,
            3.0704634820747208,
            3.0118366843509485,
            2.1222593889914103,
            1.3953377554695514,
            1.263679632566557,
            1.1684199185619657,
            1.1201560724666628,
            1.7052774841127447,
            1.826522921049686,
            1.3234876825731396,
            2.5674375637791624,
            1.1684199185619657,
            2.6558231344470697,
            1.9629659998544322,
            2.6646207386161693,
            2.8565797110733326,
            2.019721224411831,
            2.4443650120801386,
            1.1201560724666628,
            1.9629659998544322,
            2.340069858037458,
            2.5233837641773924,
            2.7159940128544333,
            1.4725263572743275,
            3.0704634820747208,
            1.705277484112745,
            2.6646207386161693,
            2.523383764177393,
            3.6570152564979654,
            3.516092668105585,
            2.141153502527834,
            3.011836684350949,
            1.826522921049686,
            2.8565797110733326,
            2.7159940128544333,
            3.5160926681055846,
            4.171970824886581,
            2.5127642696638537,
            2.1222593889914103,
            1.3234876825731396,
            2.0197212244118314,
            1.4725263572743275,
            2.141153502527834,
            2.512764269663854,
            2.304935578754308,
        ],
        7,
        7,
    )
    cov6t = reshape(
        [
            0.24337744933743052,
            0.23059488563424985,
            -0.29798568333686415,
            -0.256426340850148,
            -0.3010501028932296,
            -0.27266530859866656,
            0.06891649457924848,
            0.23059488563424985,
            0.022044144387589074,
            0.29668996105523854,
            0.22029192071690995,
            -0.01606819831751287,
            -0.07052972736191879,
            -0.0157860004633994,
            -0.29798568333686415,
            0.29668996105523854,
            0.1342128388463147,
            -0.027178557174559862,
            -0.10551027397968159,
            -0.145345871439995,
            -0.14344905967310834,
            -0.256426340850148,
            0.22029192071690995,
            -0.027178557174559862,
            0.10578610291760526,
            -0.30529365118579455,
            -0.18547261016686079,
            0.42421193105285665,
            -0.3010501028932296,
            -0.01606819831751287,
            -0.10551027397968159,
            -0.30529365118579455,
            0.25041456762777375,
            -0.3958852340840332,
            0.12674461782287774,
            -0.27266530859866656,
            -0.07052972736191879,
            -0.145345871439995,
            -0.18547261016686079,
            -0.3958852340840332,
            0.3679045923608059,
            -0.03629263728717181,
            0.06891649457924848,
            -0.01578600046339959,
            -0.14344905967310834,
            0.42421193105285665,
            0.12674461782287805,
            -0.03629263728717181,
            0.06821176144562012,
        ],
        7,
        7,
    )
    cov7t = reshape(
        [
            0.24337744933743125,
            0.6549798090041442,
            0.2701695993290464,
            0.28719739243072273,
            0.3470281654776778,
            0.4189759439350505,
            0.6227110951507638,
            0.6549798090041442,
            0.022044144387589074,
            0.6884239737095876,
            0.5943126262936533,
            0.43221482664943794,
            0.4079312506875954,
            0.3641475407576341,
            0.2701695993290464,
            0.6884239737095876,
            0.1342128388463147,
            0.4752223046565227,
            0.49401907986227717,
            0.49449422709759533,
            0.36808215216804463,
            0.28719739243072273,
            0.5943126262936533,
            0.4752223046565227,
            0.105786102917605,
            0.26849655562663466,
            0.42690933266831294,
            0.9129719713580103,
            0.3470281654776778,
            0.43221482664943794,
            0.49401907986227717,
            0.26849655562663466,
            0.2504145676277746,
            0.33365738416683965,
            0.7114697108712417,
            0.41897594393505005,
            0.4079312506875954,
            0.49449422709759533,
            0.4269093326683126,
            0.3336573841668401,
            0.3679045923608068,
            0.5877754185300631,
            0.6227110951507636,
            0.3641475407576341,
            0.36808215216804435,
            0.9129719713580103,
            0.711469710871242,
            0.5877754185300628,
            0.06821176144561986,
        ],
        7,
        7,
    )
    cov8t = reshape(
        [
            0.24337744933743266,
            0.21941224640717577,
            -0.13379943263588245,
            -0.14623490054248112,
            -0.021944246628873468,
            0.028203206374776385,
            0.1222055164966412,
            0.21941224640717577,
            0.022044144387589355,
            0.2623410733052584,
            0.16407248924204784,
            -0.009101086984478129,
            -0.06157787415589986,
            -0.10212960643198522,
            -0.13379943263588245,
            0.2623410733052584,
            0.1342128388463153,
            0.037168859829613814,
            0.10024787620351418,
            0.07686858952995254,
            -0.12926977082366672,
            -0.14623490054248112,
            0.16407248924204784,
            0.037168859829613814,
            0.10578610291760578,
            -0.159781674177606,
            -0.02781789548903686,
            0.4035338633396751,
            -0.021944246628873468,
            -0.009101086984478129,
            0.10024787620351418,
            -0.159781674177606,
            0.2504145676277746,
            -0.0349215472706074,
            0.21034921519011135,
            0.028203206374776385,
            -0.06157787415589986,
            0.07686858952995254,
            -0.02781789548903686,
            -0.0349215472706074,
            0.36790459236080636,
            0.055143155929028125,
            0.1222055164966412,
            -0.10212960643198522,
            -0.12926977082366672,
            0.4035338633396751,
            0.21034921519011168,
            0.055143155929028125,
            0.06821176144561934,
        ],
        7,
        7,
    )
    cov9t = reshape(
        [
            0.24337744933743266,
            0.12722416716341695,
            -0.10888281214087346,
            -0.07853887254499792,
            -0.016383355135721655,
            -0.10136354701051246,
            0.07271806266340908,
            0.12722416716341695,
            0.022044144387589355,
            0.14360809390671858,
            0.0794597691122345,
            -0.01066434359623815,
            -0.0616074251164464,
            -0.06057891855509088,
            -0.10888281214087346,
            0.1436080939067184,
            0.1342128388463153,
            -0.008797617481974239,
            0.07120881041352911,
            0.04963831691854632,
            -0.1078165849201711,
            -0.07853887254499792,
            0.0794597691122345,
            -0.008797617481974239,
            0.10578610291760578,
            -0.14662555323700122,
            -0.00472351157093941,
            0.23329795621197172,
            -0.016383355135721655,
            -0.01066434359623815,
            0.07120881041352911,
            -0.1466255532370009,
            0.2504145676277746,
            -0.04559374519614602,
            0.07983331356819466,
            -0.10136354701051246,
            -0.0616074251164464,
            0.04963831691854632,
            -0.00472351157093941,
            -0.04559374519614602,
            0.3679045923608068,
            0.02734763073191309,
            0.07271806266340908,
            -0.06057891855509088,
            -0.1078165849201711,
            0.23329795621197172,
            0.07983331356819498,
            0.02734763073191309,
            0.06821176144561909,
        ],
        7,
        7,
    )
    cov10t = reshape(
        [
            0.24337744933743266,
            0.03503608791965811,
            -0.08396619164586414,
            -0.010842844547514713,
            -0.01082246364256946,
            -0.2309303003958013,
            0.02323060883017664,
            0.03503608791965811,
            0.022044144387589355,
            0.024875114508178576,
            -0.005152951017578832,
            -0.012227600207997935,
            -0.061636976076992936,
            -0.01902823067819635,
            -0.08396619164586414,
            0.024875114508178576,
            0.1342128388463153,
            -0.0547640947935623,
            0.0421697446235444,
            0.022408044307140457,
            -0.08636339901667574,
            -0.010842844547514713,
            -0.005152951017578832,
            -0.0547640947935623,
            0.10578610291760578,
            -0.13346943229639613,
            0.01837087234715769,
            0.06306204908426837,
            -0.01082246364256946,
            -0.012227600207997935,
            0.0421697446235444,
            -0.13346943229639613,
            0.2504145676277746,
            -0.0562659431216842,
            -0.050682588053722034,
            -0.23093030039580092,
            -0.061636976076992936,
            0.022408044307140457,
            0.01837087234715769,
            -0.0562659431216842,
            0.36790459236080636,
            -0.0004478944652019425,
            0.02323060883017664,
            -0.01902823067819635,
            -0.08636339901667574,
            0.0630620490842681,
            -0.05068258805372171,
            -0.0004478944652019425,
            0.06821176144561934,
        ],
        7,
        7,
    )

    @test isapprox(cov1t, cov1)
    @test isapprox(cov2t, cov2)
    @test isapprox(cov3t, cov3)
    @test isapprox(cov4t, cov4)
    @test isapprox(cov5t, cov5)
    @test isapprox(cov6t, cov6)
    @test isapprox(cov7t, cov7)
    @test isapprox(cov8t, cov8)
    @test isapprox(cov9t, cov9)
    @test isapprox(cov10t, cov10)

    portfolio = Portfolio(returns = returns)
    asset_statistics!(portfolio, denoise = true, calc_kurt = false)
    dmtx = copy(portfolio.cov)
    asset_statistics!(portfolio)
    mtx = copy(portfolio.cov)
    dmtxt = denoise_cov(mtx, size(returns, 1) / size(returns, 2))
    @test isapprox(dmtx, dmtxt)

    asset_statistics!(portfolio, denoise = true, method = :Spectral, calc_kurt = false)
    dmtx = copy(portfolio.cov)
    asset_statistics!(portfolio)
    mtx = copy(portfolio.cov)
    dmtxt = denoise_cov(mtx, size(returns, 1) / size(returns, 2), :Spectral)
    @test isapprox(dmtx, dmtxt)

    asset_statistics!(
        portfolio,
        denoise = true,
        method = :Shrink,
        calc_kurt = false,
        alpha = 0.3,
        detone = true,
        mkt_comp = 4,
    )
    dmtx = copy(portfolio.cov)
    asset_statistics!(portfolio)
    mtx = copy(portfolio.cov)
    dmtxt = denoise_cov(
        mtx,
        size(returns, 1) / size(returns, 2),
        :Shrink,
        alpha = 0.3,
        detone = true,
        mkt_comp = 4,
    )
    @test isapprox(dmtx, dmtxt)

    portfolio = Portfolio(returns = returns)
    asset_statistics!(portfolio, calc_kurt = true)

    posdef_fix!(portfolio.kurt, :Nearest; msg = "Kurtosis ")
    @test isposdef(portfolio.kurt)

    asset_statistics!(portfolio, calc_kurt = true)
    posdef_fix!(portfolio.kurt, :Custom_Func; msg = "Kurtosis ")
    @test !isposdef(portfolio.kurt)

    portfolio = Portfolio(returns = returns)
    asset_statistics!(portfolio)
    mtx = copy(portfolio.cov)
    vc = copy(portfolio.mu)

    asset_statistics!(
        portfolio,
        calc_kurt = false,
        cov_type = :Custom_Func,
        mu_type = :Custom_Func,
        mean_kwargs = (; dims = 1),
    )
    @test isapprox(portfolio.cov, mtx)
    @test isapprox(portfolio.mu, vc)

    portfolio = Portfolio(returns = returns)
    asset_statistics!(portfolio)
    krt = portfolio.kurt
    skrt = portfolio.skurt
    asset_statistics!(portfolio, denoise = true)
    T, N = size(portfolio.returns)
    dkrt = denoise_cov(krt, T / N)
    dskrt = denoise_cov(skrt, T / N)
    @test isapprox(portfolio.kurt, dkrt)
    @test isapprox(portfolio.skurt, dskrt)
    @test isposdef(dkrt)
    @test isposdef(portfolio.kurt)
    @test isposdef(dskrt)
    @test isposdef(portfolio.skurt)
    @test_throws ErrorException asset_statistics!(portfolio, jlogo = true)
    asset_statistics!(portfolio, jlogo = true, denoise = true)
    @test !isposdef(portfolio.kurt)
    @test !isposdef(portfolio.skurt)

    asset_statistics!(portfolio, jlogo = true, denoise = true, posdef_fix = :Nearest)
    @test isposdef(portfolio.kurt)
    @test isposdef(portfolio.skurt)

    asset_statistics!(portfolio, posdef_fix = :Nearest)
    @test isposdef(portfolio.kurt)
    @test isposdef(portfolio.skurt)

    portfolio = HCPortfolio(returns = returns)
    asset_statistics!(portfolio, codep_type = :Cov_to_Cor)
    @test isapprox(cov2cor(portfolio.cov), portfolio.codep)
    function func(x)
        return sqrt.(clamp!((1 .- x) / 2, 0, 1))
    end
    asset_statistics!(portfolio, codep_type = :Custom_Func, dist_func = func)
    corr = cor(portfolio.returns)
    @test isapprox(portfolio.codep, corr)
    @test isapprox(portfolio.dist, func(corr))

    asset_statistics!(
        portfolio,
        codep_type = :Custom_Val,
        custom_cor = corkendall(portfolio.returns),
    )
    @test isapprox(portfolio.codep, corkendall(portfolio.returns))

    portfolio = HCPortfolio(returns = returns)
    asset_statistics!(
        portfolio,
        cov_type = :Custom_Val,
        custom_cov = covgerber1(portfolio.returns),
    )
    @test isapprox(portfolio.cov, covgerber1(portfolio.returns))

    portfolio = HCPortfolio(returns = returns)
    asset_statistics!(
        portfolio,
        mu_type = :Custom_Val,
        custom_mu = vec(mean(portfolio.returns, dims = 1)),
    )
    @test isapprox(portfolio.mu, vec(mean(portfolio.returns, dims = 1)))

    portfolio = HCPortfolio(returns = returns)
    asset_statistics!(portfolio, mu_type = :CAPM, rf = 1.02^(1 / 252) - 1)
    mu1t = [
        0.00040040334444405826,
        0.0004038223404295389,
        0.00043573757119759937,
        0.00048053128316640257,
        0.00044477704799634137,
        0.0003755978488611824,
        0.0008152649427990807,
        0.0002780600524203449,
        0.0005188105786435606,
        0.0004425636876927541,
        0.00026282174415698657,
        0.0006142834273403131,
        0.0008405692490530579,
        0.00034645235281702806,
        0.0006147361886335554,
        0.000482278303725291,
        0.0004056677912614036,
        0.000301139624596775,
        0.00045281490145370775,
        0.0003559206722359082,
    ]
    @test isapprox(mu1t, portfolio.mu)
    asset_statistics!(
        portfolio,
        mu_type = :CAPM,
        rf = 1.02^(1 / 252) - 1,
        mkt_ret = vec(mean(portfolio.returns, dims = 2)),
    )
    @test isapprox(mu1t, portfolio.mu)

    span = ceil(Int, 4 * size(portfolio.returns, 1) / log(size(portfolio.returns, 1) + 2))
    N = size(portfolio.returns, 1)
    wghts = eweights(N, 2 / (span + 1), scale = true)
    asset_statistics!(
        portfolio,
        mu_type = :CAPM,
        rf = 1.02^(1 / 252) - 1,
        cov_weights = wghts,
        mu_weights = wghts,
        cov_est = StatsBase.SimpleCovariance(; corrected = false),
    )
    mu2t = [
        0.0003517892086598427,
        0.00033163914158950656,
        0.00036637944877043646,
        0.00040784177144941367,
        0.0003507030860866231,
        0.00032057983604707964,
        0.0006169144442016192,
        0.00026170999252808223,
        0.00040878236562676596,
        0.0003713423873400815,
        0.0002369398063429353,
        0.0005470124258263283,
        0.0007622471414574865,
        0.00026912184696135905,
        0.0005212683718308435,
        0.0003814681417250051,
        0.0003231376352264016,
        0.0002583315517364582,
        0.0003579816177607234,
        0.00026075454245967395,
    ]
    @test isapprox(mu2t, portfolio.mu)
    asset_statistics!(
        portfolio,
        mu_type = :CAPM,
        rf = 1.02^(1 / 252) - 1,
        cov_weights = wghts,
        mu_weights = wghts,
        cov_est = StatsBase.SimpleCovariance(; corrected = false),
        mkt_ret = vec(mean(portfolio.returns, dims = 2)),
    )
    @test isapprox(mu2t, portfolio.mu)
end

@testset "Loadings matrix" begin
    X = reshape(
        [
            -0.18107460082022617,
            -0.1208762770046876,
            0.3889357571775856,
            0.7081839451894439,
            -0.4088673119897882,
            -0.6810523329704676,
            -1.2822346804170213,
            -2.7390145289333945,
            -0.3932202916019732,
            -0.4336887162549466,
            -0.05202249114597304,
            -0.30756969670439704,
            0.9726056135746323,
            -2.046665874775512,
            -0.28999058097089414,
            -1.832476744872195,
            0.3727984694269189,
            1.9106595879493884,
            1.191273489686887,
            0.7651321360282342,
            -0.13709744603839696,
            -0.6445624880525183,
            -1.054949648278057,
            -0.2137942338064083,
            -0.30385548078734326,
            -0.3946474727435288,
            -0.22057968677950815,
            -2.166319280102542,
            0.007943217470795723,
            0.2147427190503624,
            -0.11556542580621014,
            -0.8847993920995831,
            -0.3289262049732102,
            -0.5924372729373232,
            -0.6594872785309324,
            1.349962126213888,
            -1.9173439896876328,
            0.11240937212738208,
            -0.06687015036605677,
            -0.03988805624435066,
            -0.5318632685929556,
            0.29040788843312804,
            0.44211759874598666,
            0.906569347543084,
            -0.09535959120255355,
            2.079300646963241,
            0.8448408152209508,
            -0.14686876085812142,
            -0.6366761035048806,
            1.4831790662182474,
            -1.0170935940721593,
            0.6092124022693919,
            0.8980105304208922,
            0.43430257965957286,
            -0.19253333936935954,
            0.7859899709253838,
            -0.5894624024509073,
            0.6039754327708095,
            -0.685251499922258,
            1.2891830582933095,
            -0.4156662590752433,
            -0.5519454693619595,
            0.7486765095896483,
            -0.3152019050448294,
            2.0062203889918457,
            -0.3216189798155882,
            0.05903946305517068,
            -1.224535630136596,
            -1.1761466153096345,
            0.2791549546370551,
            -0.8316820974702406,
            -1.6049521780760585,
            0.11085425928349124,
            -0.5281811684192177,
            -1.7842739799447536,
            1.3085948598592192,
            0.1411594480743344,
            -0.059715785872419186,
            -0.7724204950615721,
            -0.5839081596670758,
            -0.6591568990011077,
            1.527873087689142,
            0.8893089472764961,
            0.565384683101524,
            0.8489304566008014,
            -0.8589770042554324,
            1.654643805623552,
            -1.4243332357073284,
            -1.2181928921869152,
            -1.571309255948826,
            0.05643879671140066,
            0.43684936081500775,
            -0.31179370147273855,
            -1.2478526180924387,
            -0.5806523767693821,
            -0.778930608852041,
            0.35026126985639316,
            0.27821484212058106,
            0.1227406504304385,
            -0.9931025618021555,
            0.9933438011559207,
            1.6675200165207837,
            -0.3063046702596336,
            1.173535047658122,
            1.0313628081566732,
            -0.3149267468747062,
            1.5938212866120065,
            0.1275343432544648,
            -0.8141635642998124,
            1.0621049693926508,
            -0.6217876953491288,
            0.17602779783670588,
            -0.22851214774558998,
            0.1082126834216715,
            -0.07985012823991416,
        ],
        23,
        5,
    )

    Y = reshape(
        [
            1.463628168669343,
            -1.8254209367981828,
            -0.8254223671383071,
            -0.47569074452376825,
            0.9727961504281024,
            -2.508449919079545,
            -0.6381798921355933,
            -0.6535257545329125,
            -0.23307567628155607,
            -0.8345738835663709,
            -0.2783490744449156,
            0.1407255656913822,
            -1.5497209396828153,
            -0.5263021576284463,
            0.4770699267877759,
            1.2613690492576763,
            -1.880666371095876,
            -0.21314264721493875,
            -0.31686952612203634,
            -1.8242992542080332,
            -0.14357175464660635,
            1.4878067091893357,
            0.32014188000979993,
            -0.828635714336905,
            -1.8625488561355936,
            0.7871018967785383,
            0.550170950305336,
            0.15467908924374293,
            1.0367813478197487,
            -1.0268037307979552,
            0.641346716012388,
            -0.626504688442109,
            0.5411512372018732,
            0.17907036305427154,
            0.5798814706922586,
            -1.220907221720978,
            -0.07338083114390563,
            -0.28968724269303303,
            1.3416051103851903,
            1.2795706539815812,
            -0.3825717103969237,
            -1.1312825845836776,
            0.5508695549547493,
            0.18608544185194342,
            -0.5955802340926958,
            0.8901676629856492,
            0.06746870109010898,
            -1.3913542141583433,
            0.4857264549384593,
            0.15502358198100982,
            0.2985962863554775,
            -0.5150657337659673,
            -0.39518578230985185,
            -0.7842028057709174,
            -0.0986606025776193,
            0.34428685678704374,
            1.426859476679973,
            -1.2253113626517567,
            -0.6377604706331754,
            1.571333719831755,
            -1.0653566195170932,
            0.33287169950158363,
            1.6836565697722998,
            2.619746203836188,
            -0.5762985016409022,
            -0.6619056078057821,
            -0.6649879021449192,
            0.08262987638070116,
            1.2036755787063682,
            -0.01973692341320449,
            -0.053379543462884226,
            -0.5257835944336525,
            -0.28281670757787997,
            -0.8163705371414567,
            -0.30816983280077365,
            -2.1463848282218208,
            -0.5777371373582589,
            -1.8976961724497576,
            -0.8474613937056205,
            -1.1577371628964714,
            -0.24948031360102388,
            -0.22003524501162394,
            -0.035182691732522337,
            0.8361708390259863,
            -1.090023759565733,
            -0.7314739559932726,
            -1.361512576206954,
            1.8302947943298886,
            -1.3798600576978406,
            -1.493620430317295,
            0.4274669882480778,
            -0.8512752548730005,
            -1.0674287991445515,
            -0.8504503726923187,
            -2.319656054000923,
            -0.043556405325090426,
            0.6006443066807114,
            -1.8520033156707503,
            1.1668229581507963,
            -1.7649169618590579,
            -0.7850943554239531,
            0.4444609774029458,
            -0.5343146141300068,
            0.008528755641237465,
            0.7437979075502406,
            -1.7450772998351232,
            -0.42462067350583355,
            -0.512590731531532,
            1.4235953769954495,
            -0.061267731892414926,
            -1.1763781949431877,
            -0.6730315662142169,
            -0.604126270465532,
            0.12429802227462923,
            -0.7180978926448485,
            -0.7682386924042874,
            1.2874553122593668,
            -0.9932265764495786,
            -0.6663708659793628,
            -1.0426521600688143,
            -0.11281535020247357,
            0.9544245305334134,
            -0.30476558950473104,
            1.42636919456547,
            1.1912084032495027,
            0.9891210768347578,
            1.491044588139456,
            -0.22090683563350486,
            0.17098553640603695,
            0.7018827862808896,
            -0.9098575723476091,
            1.5613497100888687,
            -0.049815344110789646,
            -0.40031807991480206,
            1.2254736539577367,
            -1.1317065364122338,
            -0.44445847942059263,
            -1.2095142925756885,
            -0.04563960563176,
            1.0705408047302987,
            -0.7045226330032609,
            0.04802741945112501,
            -0.2395805282398228,
            0.2784243302457368,
            -1.7075420240564894,
            1.5130676703345487,
            -0.745870055018855,
            1.8542962139732366,
            1.1231573826857462,
            -0.23284102903746287,
            -0.16924704455586284,
            -0.647588687344851,
            1.1382531947119294,
            -0.4017276505551836,
            1.1422033901537636,
            -0.3556780761546071,
            0.9249049782618467,
            -0.16497771225259766,
            -0.5805386496934014,
            -1.4852455264523652,
            1.7681419428296745,
            1.2634267210448664,
            2.208871933214425,
            1.8575416990683293,
            -0.9396550240069037,
            0.7197068987701254,
            2.285452723558415,
            -0.18315280648099977,
            -0.8922204195445872,
            0.49344791500553,
            -0.31584198068354863,
            0.6818040438979212,
            0.7139635561137635,
            -0.41642360308058957,
            1.0894988260758454,
            0.42525412213538094,
            0.012623660148854203,
            1.3872743778867451,
            -0.6168581271286961,
            -0.7780192385178966,
            0.6671408165386411,
            0.6680970765227718,
            0.5133079142887137,
            0.1666950042058407,
            0.4081376543045581,
            -1.5802666157542866,
            0.30015649581820386,
            0.3973706646421308,
            0.6288405772443425,
            -0.40801609395010136,
            0.6775595722596202,
            -0.4744973793917291,
            0.08872556289285934,
            -0.038231379677643194,
            -0.8951091716224353,
            0.1861887931822463,
            -0.9807341270871496,
            -1.232058981175455,
            -1.7585501359403033,
            1.6426602747341794,
            -1.8597259204856968,
            0.09020895092935374,
            -1.3870580068126435,
            -0.24216481928092892,
            -0.4845509777820393,
            1.4220047089767451,
            -1.3857287089275352,
            1.333928491417406,
            -0.8861916675262194,
            -0.9982051009449144,
            -0.572632426589912,
            -2.103357954748012,
            1.4758254033857583,
            1.2407921831301434,
            0.29074343926791046,
            0.17482070592308083,
            0.7918187207353217,
            -0.9479125780631958,
            -0.6212505903500749,
            0.5099704572736059,
            0.4493172476990034,
            -0.5678270216962378,
            -0.7535124825671137,
            -0.08008050959684225,
            0.05529708846911832,
            -0.821429969544968,
            0.7425599152480041,
            -0.7383187213646814,
            0.23092765809416282,
            1.0500341275858571,
            0.48653219734140024,
            1.8516829076841348,
            -1.5196439513149405,
            0.3461908035647603,
            0.17494187626186622,
            0.6518431058683939,
            0.314001880373348,
            -0.6356943206784916,
            0.13943214125824316,
            0.4001873505194011,
            0.6664544314304832,
            -0.2224364631807193,
            1.2087319479840222,
            -0.3626962848580681,
            0.6995459457557346,
            0.9669614884158098,
            -0.4258566421708642,
            -0.5887784731349918,
            1.220838358204081,
            -0.3800870605174774,
            0.015326735903415682,
            -0.318059746187989,
            -0.5530971642449837,
        ],
        23,
        11,
    )

    X = DataFrame(X, ["x$i" for i in 1:5])
    Y = DataFrame(Y, ["y$i" for i in 1:11])

    incl1 = forward_regression(X, Y[!, 1], :pval, 0.05)
    incl2 = forward_regression(X, Y[!, 1], :pval, 0.35)
    incl3 = forward_regression(X, Y[!, 1], aic)
    incl7 = forward_regression(X, Y[!, 1], aicc)
    incl4 = forward_regression(X, Y[!, 1], bic)
    incl5 = forward_regression(X, Y[!, 1], r2)
    incl6 = forward_regression(X, Y[!, 1], adjr2)

    incl1t = ["x4"]
    incl2t = ["x4", "x3", "x2"]
    incl3t = ["x4"]
    incl4t = ["x4"]
    incl5t = ["x4", "x3", "x2", "x1", "x5"]
    incl6t = ["x4", "x3", "x2"]

    @test incl1 == incl1t
    @test incl2 == incl2t
    @test incl3 == incl3t
    @test incl4 == incl4t
    @test incl5 == incl5t
    @test incl6 == incl6t

    incl1 = backward_regression(X, Y[!, 1], :pval, 0.05)
    incl2 = backward_regression(X, Y[!, 1], :pval, 0.35)
    incl3 = backward_regression(X, Y[!, 1], aic)
    incl7 = backward_regression(X, Y[!, 1], aicc)
    incl4 = backward_regression(X, Y[!, 1], bic)
    incl5 = backward_regression(X, Y[!, 1], r2)
    incl6 = backward_regression(X, Y[!, 1], adjr2)

    incl1t = ["x4"]
    incl2t = ["x2", "x3", "x4"]
    incl3t = ["x4"]
    incl4t = Any[]
    incl5t = ["x1", "x2", "x3", "x4", "x5"]
    incl6t = ["x2", "x3", "x4"]

    @test incl1 == incl1t
    @test incl2 == incl2t
    @test incl3 == incl3t
    @test incl4 == incl4t
    @test incl5 == incl5t
    @test incl6 == incl6t

    lmtx1 = loadings_matrix(X, Y, :FReg; criterion = :pval, threshold = 0.05)
    lmtx1t = reshape(
        [
            -0.30994820979398263,
            -0.012770302754892965,
            0.15087582050756498,
            -0.5931508872820731,
            -0.4059835747542855,
            0.08760005704879117,
            0.1835394986007996,
            0.39886969838561415,
            -0.33633869353258494,
            0.022777873090124495,
            0.1639296264105174,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.268962280250076,
            0.0,
            -0.27201843701583395,
            0.405517759678623,
            0.0,
            0.0,
            0.0,
            0.0,
            0.27741672673054,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.14698557899413645,
            0.3616839130531306,
            -0.2389203113241418,
            0.2977893877734337,
            0.0,
            0.31458285260812835,
            0.0,
            0.0,
            -0.4507046022214036,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3032517398214801,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ],
        11,
        6,
    )

    lmtx2 = loadings_matrix(X, Y, :BReg; criterion = :pval, threshold = 0.05)
    lmtx2t = reshape(
        [
            -0.30994820979398263,
            -0.012770302754892965,
            0.15087582050756498,
            -0.5931508872820731,
            -0.4059835747542855,
            0.08760005704879117,
            0.1835394986007996,
            0.39886969838561415,
            -0.33633869353258494,
            0.022777873090124495,
            0.1639296264105174,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.268962280250076,
            0.0,
            -0.27201843701583395,
            0.405517759678623,
            0.0,
            0.0,
            0.0,
            0.0,
            0.27741672673054,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.14698557899413645,
            0.3616839130531306,
            -0.2389203113241418,
            0.2977893877734337,
            0.0,
            0.31458285260812835,
            0.0,
            0.0,
            -0.4507046022214036,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
            0.3032517398214801,
            0.0,
            0.0,
            0.0,
            0.0,
            0.0,
        ],
        11,
        6,
    )

    @test isapprox(Matrix(lmtx1[!, 2:end]), lmtx1t)
    @test isapprox(Matrix(lmtx2[!, 2:end]), lmtx2t)

    beta = pcr(X, Y[!, 1], pca_kwargs = (maxoutdim = 4,))
    betat = [
        -0.41718611743313244,
        -0.2340698064566073,
        -0.1718979672692257,
        -0.24470967024791743,
        0.21256138161600105,
        0.189547563378083,
    ]
    @test isapprox(beta, betat)

    lmtx3 = loadings_matrix(X, Y, :PCR; pca_kwargs = (; maxoutdim = 4))
    lmtx3t = reshape(
        [
            -0.41718611743313244,
            -0.0035810867143380026,
            0.08032889460412476,
            -0.5579929283058411,
            -0.4008518223542619,
            0.08489446585650395,
            0.18470243204228798,
            0.40421258910972435,
            -0.35834891680635966,
            0.040564623056674694,
            0.20475981143406488,
            -0.2340698064566073,
            -0.11799890297144452,
            -0.005680486557199951,
            0.11241861425613958,
            0.17610438452639593,
            0.14676042450236984,
            0.03490584478879821,
            -0.056769473262301855,
            -0.13321026308458211,
            -0.05790568283748528,
            0.07454778998848516,
            -0.1718979672692257,
            -0.06540408676948556,
            -0.12199543283424372,
            0.025739740914832478,
            0.08549343174382851,
            -0.25257088906290254,
            0.2085751125767404,
            -0.2593160717184674,
            -0.26504723760158433,
            0.35739289237702454,
            0.08342595169100822,
            -0.24470967024791743,
            -0.1943611772212289,
            0.0228239486604013,
            0.24811617508563344,
            0.055689362367063296,
            0.17377634323229627,
            0.03282503442557853,
            -0.33806443552170745,
            -0.18956913154597452,
            0.24362879035560142,
            0.16891766911346104,
            0.21256138161600105,
            -0.15432072540037728,
            0.11140250542015451,
            -0.06346788039260617,
            0.23785527220454517,
            0.002217680114479435,
            -0.09401329932579523,
            -0.4455378833148836,
            0.05954793331217856,
            0.3532182420335984,
            0.07517196769505011,
            0.189547563378083,
            -0.13709978718486224,
            0.16132925460187839,
            -0.08568146639771959,
            0.3351321056147943,
            0.20872404609822112,
            -0.19153889776751845,
            -0.17815499497370035,
            0.16792788835821548,
            -0.03754263532591707,
            0.017934028466320823,
        ],
        11,
        6,
    )

    lmtx4 = loadings_matrix(X, Y, :PCR; pca_kwargs = (; maxoutdim = 2))
    lmtx4t = reshape(
        [
            -0.4077068203609503,
            0.009132957495164858,
            0.08894656471450857,
            -0.5646107987275492,
            -0.4058408248107884,
            0.11287892087754997,
            0.1655426881295863,
            0.4569256547300026,
            -0.33093549885032536,
            -0.02355318800358636,
            0.1902540530878734,
            -0.21045850761276524,
            -0.03663825271992003,
            -0.06877199978027898,
            0.06136461418013626,
            0.0726157028018775,
            -0.015810154075879216,
            0.10436285547577591,
            0.011620031491855688,
            -0.15600299491499345,
            -0.016429888792169927,
            0.036932378953233674,
            -0.13739836559903598,
            -0.047794614177963275,
            -0.041858646209945914,
            0.021594516948756786,
            0.11986147341509513,
            -0.01674397742566698,
            0.07125296544646789,
            -0.03118165992068618,
            -0.11274416746731607,
            0.007994391914308981,
            0.031488723610837925,
            -0.13611825920715104,
            0.054722072376848015,
            -0.05446238585255378,
            0.1003456724969593,
            -0.1910110641863042,
            0.01086854082501989,
            0.05725300820488616,
            0.13484902396214707,
            -0.0651059737590933,
            -0.07211474750479377,
            -0.00034419051286826356,
            0.2778835861817347,
            -0.02520870316415145,
            0.1001720211964925,
            -0.13794209692172094,
            0.12742796491269656,
            0.0010814634591406658,
            -0.12818361734758638,
            -0.1348274043182669,
            0.17239618550288044,
            0.0793917845858901,
            -0.026027150520860087,
            0.2039142743233263,
            -0.06178203831610737,
            0.07901743556532254,
            -0.13470345869049147,
            0.22486076713755165,
            -0.010849404487538326,
            -0.08840745380543842,
            -0.16922042249747782,
            0.10675071836857115,
            0.09219750088053251,
            -0.005724622329620918,
        ],
        11,
        6,
    )
    @test isapprox(Matrix(lmtx3[!, 2:end]), lmtx3t)
    @test isapprox(Matrix(lmtx4[!, 2:end]), lmtx4t)

    mu1, sigma1, returns1 = risk_factors(X, Y; reg_type = :BReg, error = true)
    mu2, sigma2, returns2 = risk_factors(X, Y; reg_type = :BReg, error = false)

    mu1t = [
        -0.3740749325681081,
        0.029590377431456233,
        0.0980776262123757,
        -0.5631219781242214,
        -0.4617592580253621,
        0.11933340944743609,
        0.1469573089296255,
        0.47877982995795415,
        -0.2993408288219003,
        -0.03237754716360007,
        0.1798400462728943,
    ]
    mu2t = [
        -0.3740749325681081,
        0.029590377431456233,
        0.0980776262123757,
        -0.5631219781242214,
        -0.4617592580253621,
        0.11933340944743609,
        0.1469573089296255,
        0.47877982995795415,
        -0.2993408288219003,
        -0.03237754716360007,
        0.1798400462728943,
    ]
    @test isapprox(mu1, mu1t)
    @test isapprox(mu2, mu2t)

    sigma1t = reshape(
        [
            1.1786107704560354,
            -0.09042955086258173,
            0.11271105599498585,
            -0.013168640001057955,
            0.11906725683036683,
            0.026839075613226637,
            0.0034237769890773256,
            -0.17058832095394885,
            -0.003462680582547332,
            0.005162070952696223,
            -0.00697722952012527,
            -0.09042955086258171,
            0.7547482925881452,
            -0.07445440512041515,
            0.008698909338293228,
            -0.078653169366269,
            -0.017729293644924492,
            -0.002261670576469967,
            0.11268683311494965,
            0.0022873694210357094,
            -0.003409948727562893,
            0.004609001918433246,
            0.11271105599498583,
            -0.07445440512041517,
            1.0571735018205128,
            -0.010842288258332741,
            0.09803301788036278,
            0.022097725684840152,
            0.002818937798044491,
            -0.14045244984592978,
            -0.0028509687423677404,
            0.004250147416483578,
            -0.005744642855729159,
            -0.013168640001057953,
            0.008698909338293226,
            -0.010842288258332741,
            0.7822041350931259,
            -0.011453725717388416,
            -0.01442194596058839,
            -0.009372449280792575,
            0.01640981652562973,
            0.009478946274551644,
            -0.01413095781131359,
            0.03173557349712748,
            0.11906725683036683,
            -0.07865316936626901,
            0.0980330178803628,
            -0.011453725717388416,
            0.9323970624631774,
            0.023343899640164013,
            0.0029779083145447935,
            -0.14837309233446896,
            -0.00301174560442366,
            0.004489829232261677,
            -0.006068604896508686,
            0.02683907561322664,
            -0.017729293644924492,
            0.022097725684840152,
            -0.01442194596058839,
            0.023343899640164017,
            0.9341622357564326,
            -0.0011607247823556784,
            -0.03344493482205978,
            0.0011739138321119526,
            -0.0017500391240983279,
            -0.007641277086000118,
            0.003423776989077325,
            -0.002261670576469967,
            0.002818937798044491,
            -0.009372449280792575,
            0.002977908314544793,
            -0.0011607247823556784,
            0.9858471042242972,
            -0.004266465801397727,
            -0.05846641788571767,
            0.08716016111830802,
            -0.0049658681376793,
            -0.17058832095394885,
            0.11268683311494965,
            -0.14045244984592978,
            0.01640981652562973,
            -0.14837309233446894,
            -0.03344493482205978,
            -0.004266465801397728,
            0.8663491764390326,
            0.004314944674765001,
            -0.006432603307495861,
            0.008694523980704527,
            -0.0034626805825473317,
            0.0022873694210357094,
            -0.0028509687423677404,
            0.009478946274551644,
            -0.00301174560442366,
            0.0011739138321119526,
            -0.05846641788571767,
            0.004314944674765001,
            0.9472426747228775,
            -0.08815054205893136,
            0.005022294159546454,
            0.005162070952696222,
            -0.003409948727562893,
            0.004250147416483578,
            -0.014130957811313589,
            0.004489829232261677,
            -0.001750039124098328,
            0.08716016111830802,
            -0.006432603307495861,
            -0.08815054205893134,
            0.8328183866698657,
            -0.007487100868489148,
            -0.00697722952012527,
            0.004609001918433245,
            -0.005744642855729159,
            0.03173557349712748,
            -0.006068604896508686,
            -0.007641277086000119,
            -0.004965868137679301,
            0.008694523980704525,
            0.005022294159546455,
            -0.0074871008684891495,
            0.5713351124166021,
        ],
        11,
        11,
    )
    sigma2t = reshape(
        [
            0.13689465592250286,
            -0.09042955086258173,
            0.11271105599498585,
            -0.013168640001057955,
            0.11906725683036683,
            0.026839075613226637,
            0.0034237769890773256,
            -0.17058832095394885,
            -0.003462680582547332,
            0.005162070952696223,
            -0.00697722952012527,
            -0.09042955086258171,
            0.05973574069858215,
            -0.07445440512041515,
            0.008698909338293228,
            -0.078653169366269,
            -0.017729293644924492,
            -0.002261670576469967,
            0.11268683311494965,
            0.0022873694210357094,
            -0.003409948727562893,
            0.004609001918433246,
            0.11271105599498583,
            -0.07445440512041517,
            0.09279969373454976,
            -0.010842288258332741,
            0.09803301788036278,
            0.022097725684840152,
            0.002818937798044491,
            -0.14045244984592978,
            -0.0028509687423677404,
            0.004250147416483578,
            -0.005744642855729159,
            -0.013168640001057953,
            0.008698909338293226,
            -0.010842288258332741,
            0.05989688907400087,
            -0.011453725717388416,
            -0.01442194596058839,
            -0.009372449280792575,
            0.01640981652562973,
            0.009478946274551644,
            -0.01413095781131359,
            0.03173557349712748,
            0.11906725683036683,
            -0.07865316936626901,
            0.0980330178803628,
            -0.011453725717388416,
            0.10356146887964898,
            0.023343899640164013,
            0.0029779083145447935,
            -0.14837309233446896,
            -0.00301174560442366,
            0.004489829232261677,
            -0.006068604896508686,
            0.02683907561322664,
            -0.017729293644924492,
            0.022097725684840152,
            -0.01442194596058839,
            0.023343899640164017,
            0.06179991958541152,
            -0.0011607247823556784,
            -0.03344493482205978,
            0.0011739138321119526,
            -0.0017500391240983279,
            -0.007641277086000118,
            0.003423776989077325,
            -0.002261670576469967,
            0.002818937798044491,
            -0.009372449280792575,
            0.002977908314544793,
            -0.0011607247823556784,
            0.05780954131311732,
            -0.004266465801397727,
            -0.05846641788571767,
            0.08716016111830802,
            -0.0049658681376793,
            -0.17058832095394885,
            0.11268683311494965,
            -0.14045244984592978,
            0.01640981652562973,
            -0.14837309233446894,
            -0.03344493482205978,
            -0.004266465801397728,
            0.2125749544405986,
            0.004314944674765001,
            -0.006432603307495861,
            0.008694523980704527,
            -0.0034626805825473317,
            0.0022873694210357094,
            -0.0028509687423677404,
            0.009478946274551644,
            -0.00301174560442366,
            0.0011739138321119526,
            -0.05846641788571767,
            0.004314944674765001,
            0.059130758396308714,
            -0.08815054205893136,
            0.005022294159546454,
            0.005162070952696222,
            -0.003409948727562893,
            0.004250147416483578,
            -0.014130957811313589,
            0.004489829232261677,
            -0.001750039124098328,
            0.08716016111830802,
            -0.006432603307495861,
            -0.08815054205893134,
            0.13141245395845466,
            -0.007487100868489148,
            -0.00697722952012527,
            0.004609001918433245,
            -0.005744642855729159,
            0.03173557349712748,
            -0.006068604896508686,
            -0.007641277086000119,
            -0.004965868137679301,
            0.008694523980704525,
            0.005022294159546455,
            -0.0074871008684891495,
            0.0168146733622055,
        ],
        11,
        11,
    )
    @test isapprox(sigma1, sigma1t)
    @test isapprox(sigma2, sigma2t)

    returns1t = reshape(
        [
            -0.2089823534526834,
            -0.6107542452232544,
            -0.8904335938236764,
            -0.2698540075177232,
            -0.5009828415888199,
            -0.9552914048192841,
            0.1633494997211128,
            -0.2588931082500372,
            -0.3315464488993621,
            -0.5893202769702883,
            -0.5211383978460228,
            -0.5483546563406705,
            0.24265890720999514,
            0.011700530170140677,
            -0.10545766522951924,
            -0.002903720340623953,
            -0.620626373915743,
            0.2885098365330672,
            -0.8251066279762361,
            -0.7505489818936565,
            -0.8782654901021572,
            -0.28953520495139307,
            -0.1519468235596517,
            -0.07946609142445485,
            0.18593544289541217,
            0.3706853712913984,
            -0.03925563689451183,
            0.1134229064393755,
            0.41352899202107307,
            -0.3254201940696293,
            -0.04649616203515697,
            0.0014970113967112152,
            0.17177664239836557,
            0.12673721653747147,
            0.14471566876590758,
            -0.3778102165293606,
            -0.2252442733015382,
            -0.14785218725941032,
            -0.21559703173850225,
            0.19245675052209363,
            -0.40809831592503476,
            0.32753183734962416,
            0.2782807222992615,
            0.3626473938629061,
            -0.02625467763594076,
            -0.11714248804256697,
            0.23400520354285428,
            -0.09679028212022318,
            -0.3270619060073435,
            0.18388704251167332,
            -0.0064109262694507394,
            -0.38046203560025116,
            0.5405614826685041,
            0.19291160612805683,
            0.1330930931922078,
            -0.07914280582047314,
            -0.023005832875605894,
            -0.04541410889260998,
            0.6058602118860204,
            0.4157025874584696,
            0.3192413791448447,
            0.4036783014409392,
            -0.10491841570111841,
            0.643611186367307,
            -0.2732755017390742,
            -0.21188909504672504,
            -0.3170434008241656,
            0.16768269522692228,
            0.280964924213882,
            -0.35877791371511597,
            -0.6338947381783036,
            -0.7697754879039516,
            -0.18169220557654805,
            -0.8753096629281721,
            -0.4241451767608494,
            -0.34402774536315317,
            -0.4726680872222848,
            -0.646562856076421,
            -0.3751041223049208,
            -0.756677617500724,
            -0.4255979996971338,
            -0.7832511153776988,
            -0.2355099430938762,
            -0.7084636602870558,
            -0.7462697927262195,
            -0.3854555006116671,
            -0.6805931680388402,
            -0.03659179386788453,
            -0.6823733719169292,
            -0.576772352693379,
            -0.9328575535594867,
            -0.9194336314564755,
            -0.318166212804868,
            -0.6676165014395852,
            -0.9108740092330807,
            -0.3711107256451237,
            -0.5721403134094972,
            -0.9672855731997645,
            0.005677929168561644,
            -0.3615772329064724,
            -0.42476913701976726,
            -0.6489738175037375,
            -0.5896710692835166,
            -0.613343032358382,
            0.07465909959415383,
            -0.12622222927011373,
            -0.2281232483232654,
            -0.1389246100508845,
            -0.6762030110777438,
            0.11453899366914094,
            -0.8540543871076625,
            -0.7892061698053914,
            -0.9002905228202228,
            -0.38822889708704283,
            -0.2685582566690628,
            -0.006951925388195981,
            -0.29081342042852987,
            -0.08848378643800153,
            -0.14861200528579507,
            0.19381739652482335,
            0.1719691919660158,
            0.12482137283864175,
            -0.21356002263888146,
            0.3888332929902065,
            0.5932784032458621,
            -0.005287367122887494,
            0.4434766019926003,
            0.4003626230094698,
            -0.007902026857282352,
            0.570929135178392,
            0.1262750685276975,
            -0.15929646032438444,
            0.4096852368901524,
            -0.10095814336542058,
            0.140980792999716,
            0.018303350674597898,
            0.1204157415671641,
            0.06338536673506891,
            0.12603691397191014,
            0.1018138356217526,
            0.07739421443677037,
            0.12421188306773555,
            -0.3991186747252833,
            0.18567592448426706,
            0.24129718998368652,
            0.15245675815789034,
            -0.05443816346218537,
            0.09507075647720109,
            0.02419621876644051,
            0.006162296371203031,
            0.5466283903185278,
            -0.33215371288936435,
            0.21377337964965962,
            0.1655539504776795,
            0.17281111603857577,
            0.040488341098779614,
            0.2616482664763834,
            0.3024524560982083,
            0.42737245752081116,
            0.1578913655072457,
            0.7427929419334912,
            0.27305327559778625,
            0.7737126473006015,
            1.1222290313897594,
            0.3489071735506999,
            0.6369233817988339,
            1.203050192770615,
            -0.19092002739620867,
            0.3352484854914784,
            0.42578387790358135,
            0.7470031703599996,
            0.6620397932221954,
            0.6959547463514023,
            -0.28974973384610836,
            -0.0019459369485742481,
            0.1440482196862674,
            0.016252834629715416,
            0.7860145874058918,
            -0.34688587984605834,
            1.0408232428158104,
            0.947914841287659,
            1.1070660115548394,
            0.37343247296394766,
            0.20197968098881164,
            -0.27818272020956797,
            -0.25368440057011704,
            -0.2289873048246413,
            -0.27633695189738094,
            0.25294009111817517,
            -0.3384993951338677,
            -0.39475267232919486,
            -0.3049027670317103,
            -0.09565694582109632,
            -0.2468647013622225,
            -0.17518483251825126,
            -0.15694599479477478,
            -0.7035532811358587,
            0.18521422176394817,
            -0.36691611524460666,
            -0.3181487797469964,
            -0.325488406817397,
            -0.19166207850379646,
            -0.4153349934412331,
            -0.45660283172066185,
            -0.5829422704977191,
            -0.31039912657919744,
            -0.9019468056055381,
            -0.06391948563525793,
            -0.10044092074482983,
            -0.13725868591966175,
            -0.06667110732331404,
            -0.8557030681256659,
            0.025998988843521673,
            0.10985985942672342,
            -0.024085959479115966,
            -0.336023994159106,
            -0.11060754465020325,
            -0.21746596258153172,
            -0.24465593063629126,
            0.5702114901633708,
            -0.7547391661412772,
            0.06836186984210113,
            -0.0043391604756915,
            0.0066025578839805045,
            -0.19290212804504062,
            0.14054342940052608,
            0.2020644112480894,
            0.39040784389910693,
            -0.01589213469820435,
            0.8659712131449695,
            0.2881090427936471,
            0.14234203655963504,
            0.07034742070512177,
            0.3819355602105891,
            0.014431535594593878,
            0.25347506408849274,
            0.2959242241672638,
            0.22776584254042678,
            0.1356300020476375,
            0.2794588173705694,
            0.07728715389099611,
            0.25270530509456895,
            0.06320753793784385,
            0.353420944663191,
            0.10283268065201603,
            0.08280160202315937,
            0.27397427665186097,
            0.11759949189744832,
            0.45881509187632546,
            0.11665627444681968,
            0.17260757607118457,
            -0.01605945218405988,
            -0.008946964822763097,
        ],
        23,
        11,
    )
    returns2t = reshape(
        [
            -0.2089823534526834,
            -0.6107542452232544,
            -0.8904335938236764,
            -0.2698540075177232,
            -0.5009828415888199,
            -0.9552914048192841,
            0.1633494997211128,
            -0.2588931082500372,
            -0.3315464488993621,
            -0.5893202769702883,
            -0.5211383978460228,
            -0.5483546563406705,
            0.24265890720999514,
            0.011700530170140677,
            -0.10545766522951924,
            -0.002903720340623953,
            -0.620626373915743,
            0.2885098365330672,
            -0.8251066279762361,
            -0.7505489818936565,
            -0.8782654901021572,
            -0.28953520495139307,
            -0.1519468235596517,
            -0.07946609142445485,
            0.18593544289541217,
            0.3706853712913984,
            -0.03925563689451183,
            0.1134229064393755,
            0.41352899202107307,
            -0.3254201940696293,
            -0.04649616203515697,
            0.0014970113967112152,
            0.17177664239836557,
            0.12673721653747147,
            0.14471566876590758,
            -0.3778102165293606,
            -0.2252442733015382,
            -0.14785218725941032,
            -0.21559703173850225,
            0.19245675052209363,
            -0.40809831592503476,
            0.32753183734962416,
            0.2782807222992615,
            0.3626473938629061,
            -0.02625467763594076,
            -0.11714248804256697,
            0.23400520354285428,
            -0.09679028212022318,
            -0.3270619060073435,
            0.18388704251167332,
            -0.0064109262694507394,
            -0.38046203560025116,
            0.5405614826685041,
            0.19291160612805683,
            0.1330930931922078,
            -0.07914280582047314,
            -0.023005832875605894,
            -0.04541410889260998,
            0.6058602118860204,
            0.4157025874584696,
            0.3192413791448447,
            0.4036783014409392,
            -0.10491841570111841,
            0.643611186367307,
            -0.2732755017390742,
            -0.21188909504672504,
            -0.3170434008241656,
            0.16768269522692228,
            0.280964924213882,
            -0.35877791371511597,
            -0.6338947381783036,
            -0.7697754879039516,
            -0.18169220557654805,
            -0.8753096629281721,
            -0.4241451767608494,
            -0.34402774536315317,
            -0.4726680872222848,
            -0.646562856076421,
            -0.3751041223049208,
            -0.756677617500724,
            -0.4255979996971338,
            -0.7832511153776988,
            -0.2355099430938762,
            -0.7084636602870558,
            -0.7462697927262195,
            -0.3854555006116671,
            -0.6805931680388402,
            -0.03659179386788453,
            -0.6823733719169292,
            -0.576772352693379,
            -0.9328575535594867,
            -0.9194336314564755,
            -0.318166212804868,
            -0.6676165014395852,
            -0.9108740092330807,
            -0.3711107256451237,
            -0.5721403134094972,
            -0.9672855731997645,
            0.005677929168561644,
            -0.3615772329064724,
            -0.42476913701976726,
            -0.6489738175037375,
            -0.5896710692835166,
            -0.613343032358382,
            0.07465909959415383,
            -0.12622222927011373,
            -0.2281232483232654,
            -0.1389246100508845,
            -0.6762030110777438,
            0.11453899366914094,
            -0.8540543871076625,
            -0.7892061698053914,
            -0.9002905228202228,
            -0.38822889708704283,
            -0.2685582566690628,
            -0.006951925388195981,
            -0.29081342042852987,
            -0.08848378643800153,
            -0.14861200528579507,
            0.19381739652482335,
            0.1719691919660158,
            0.12482137283864175,
            -0.21356002263888146,
            0.3888332929902065,
            0.5932784032458621,
            -0.005287367122887494,
            0.4434766019926003,
            0.4003626230094698,
            -0.007902026857282352,
            0.570929135178392,
            0.1262750685276975,
            -0.15929646032438444,
            0.4096852368901524,
            -0.10095814336542058,
            0.140980792999716,
            0.018303350674597898,
            0.1204157415671641,
            0.06338536673506891,
            0.12603691397191014,
            0.1018138356217526,
            0.07739421443677037,
            0.12421188306773555,
            -0.3991186747252833,
            0.18567592448426706,
            0.24129718998368652,
            0.15245675815789034,
            -0.05443816346218537,
            0.09507075647720109,
            0.02419621876644051,
            0.006162296371203031,
            0.5466283903185278,
            -0.33215371288936435,
            0.21377337964965962,
            0.1655539504776795,
            0.17281111603857577,
            0.040488341098779614,
            0.2616482664763834,
            0.3024524560982083,
            0.42737245752081116,
            0.1578913655072457,
            0.7427929419334912,
            0.27305327559778625,
            0.7737126473006015,
            1.1222290313897594,
            0.3489071735506999,
            0.6369233817988339,
            1.203050192770615,
            -0.19092002739620867,
            0.3352484854914784,
            0.42578387790358135,
            0.7470031703599996,
            0.6620397932221954,
            0.6959547463514023,
            -0.28974973384610836,
            -0.0019459369485742481,
            0.1440482196862674,
            0.016252834629715416,
            0.7860145874058918,
            -0.34688587984605834,
            1.0408232428158104,
            0.947914841287659,
            1.1070660115548394,
            0.37343247296394766,
            0.20197968098881164,
            -0.27818272020956797,
            -0.25368440057011704,
            -0.2289873048246413,
            -0.27633695189738094,
            0.25294009111817517,
            -0.3384993951338677,
            -0.39475267232919486,
            -0.3049027670317103,
            -0.09565694582109632,
            -0.2468647013622225,
            -0.17518483251825126,
            -0.15694599479477478,
            -0.7035532811358587,
            0.18521422176394817,
            -0.36691611524460666,
            -0.3181487797469964,
            -0.325488406817397,
            -0.19166207850379646,
            -0.4153349934412331,
            -0.45660283172066185,
            -0.5829422704977191,
            -0.31039912657919744,
            -0.9019468056055381,
            -0.06391948563525793,
            -0.10044092074482983,
            -0.13725868591966175,
            -0.06667110732331404,
            -0.8557030681256659,
            0.025998988843521673,
            0.10985985942672342,
            -0.024085959479115966,
            -0.336023994159106,
            -0.11060754465020325,
            -0.21746596258153172,
            -0.24465593063629126,
            0.5702114901633708,
            -0.7547391661412772,
            0.06836186984210113,
            -0.0043391604756915,
            0.0066025578839805045,
            -0.19290212804504062,
            0.14054342940052608,
            0.2020644112480894,
            0.39040784389910693,
            -0.01589213469820435,
            0.8659712131449695,
            0.2881090427936471,
            0.14234203655963504,
            0.07034742070512177,
            0.3819355602105891,
            0.014431535594593878,
            0.25347506408849274,
            0.2959242241672638,
            0.22776584254042678,
            0.1356300020476375,
            0.2794588173705694,
            0.07728715389099611,
            0.25270530509456895,
            0.06320753793784385,
            0.353420944663191,
            0.10283268065201603,
            0.08280160202315937,
            0.27397427665186097,
            0.11759949189744832,
            0.45881509187632546,
            0.11665627444681968,
            0.17260757607118457,
            -0.01605945218405988,
            -0.008946964822763097,
        ],
        23,
        11,
    )
    @test isapprox(returns1, returns1t)
    @test isapprox(returns2, returns2t)
end

@testset "Black litterman" begin
    asset_classes = Dict(
        "Assets" => names(returns)[2:end],
        "Industry" => [
            "Consumer Discretionary",
            "Consumer Discretionary",
            "Consumer Staples",
            "Consumer Staples",
            "Energy",
            "Financials",
            "Financials",
            "Financials",
            "Health Care",
            "Health Care",
            "Industrials",
            "Industrials",
            "Health care",
            "Industrials",
            "Information Technology",
            "Information Technology",
            "Materials",
            "Telecommunications Services",
            "Utilities",
            "Financials",
        ],
    )

    asset_classes = DataFrame(asset_classes)
    asset_classes = sort!(asset_classes, :Assets)

    views = Dict(
        "Enabled" => [true, true, true],
        "Type" => ["Classes", "Classes", "Classes"],
        "Set" => ["Industry", "Industry", "Industry"],
        "Position" => ["Energy", "Consumer Staples", "Materials"],
        "Sign" => [">=", ">=", ">="],
        "Return" => [0.08, 0.1, 0.09], # Annual terms 
        "Type Relative" => ["Classes", "Classes", "Classes"],
        "Relative Set" => ["Industry", "Industry", "Industry"],
        "Relative" => ["Financials", "Utilities", "Industrials"],
    )

    views = DataFrame(views)

    P, Q = asset_views(views, asset_classes)

    X = Matrix(returns[!, 2:end])
    w = fill(1 / 20, 20)
    mu, cov_mtx, wb = black_litterman(X, w, P, Q)
    wbt = [
        0.04994419642839887,
        -36.43505342391563,
        145.9899346778055,
        38.19762923314582,
        0.04994419642867243,
        0.04994419642855785,
        38.197629233145825,
        -36.43505342391561,
        0.04994419642874348,
        0.04994419642857295,
        -76.24542587700597,
        69.88661355431003,
        0.04994419642857295,
        0.049944196428551635,
        -36.4350534239156,
        0.049944196428576504,
        -23.228945589532003,
        -23.22894558953189,
        -36.435053423915775,
        -23.228945589531968,
    ]
    cov_mtxt = reshape(
        [
            0.00021019372803673762,
            9.814073696822803e-5,
            0.00014089460579763032,
            0.0001183384864749401,
            0.00015855508698984152,
            6.209596553886905e-5,
            8.22975685311066e-5,
            4.183022574848328e-5,
            9.067141771050849e-5,
            7.173426083922174e-5,
            4.035654677616946e-5,
            0.00010239654183710268,
            3.58895347738626e-5,
            5.338345680784469e-5,
            2.4554319628138348e-5,
            5.014139348676143e-5,
            9.862887967338167e-5,
            5.899907732521574e-5,
            7.900678634747935e-5,
            8.317071782107266e-5,
            9.814073696822803e-5,
            0.00021175486167171988,
            0.00010926287107231252,
            9.468695325627838e-5,
            0.00010738963680672156,
            5.824815415910256e-5,
            0.0001303281405925459,
            4.55503795780771e-5,
            9.442418939594358e-5,
            7.595943936350152e-5,
            4.1840531207773575e-5,
            9.143103991948571e-5,
            7.152326073683382e-5,
            5.8990702062783135e-5,
            5.4196528349915624e-5,
            7.441014007127945e-5,
            9.268283422780716e-5,
            5.101719691518799e-5,
            8.578645730092226e-5,
            7.170559134560567e-5,
            0.00014089460579763032,
            0.00010926287107231252,
            0.0002574464719462557,
            0.00011943713428833755,
            0.0001534757246847234,
            6.712382518273905e-5,
            0.0001171647101931088,
            3.869996028185736e-5,
            9.457451171224822e-5,
            7.620626380944493e-5,
            3.904868634759729e-5,
            0.0001380361667111408,
            5.843400843950329e-5,
            5.25446963255022e-5,
            4.352899431627756e-5,
            5.6524130190162446e-5,
            0.0001017691211442463,
            5.430475677066226e-5,
            8.143381874305633e-5,
            8.811290555373818e-5,
            0.0001183384864749401,
            9.468695325627838e-5,
            0.00011943713428833755,
            0.0004010053847728717,
            0.0001327158452540512,
            6.518088662452111e-5,
            0.0002006877860966814,
            3.4692524062064834e-5,
            9.796039730265241e-5,
            8.16394591837143e-5,
            2.8632944028368108e-5,
            0.0001110166930016184,
            0.0001005546477458589,
            5.6383706572802686e-5,
            9.648891401981502e-5,
            7.798069948053724e-5,
            0.00010102936638412913,
            5.228279286729776e-5,
            8.456006602214185e-5,
            6.922325042733573e-5,
            0.00015855508698984152,
            0.00010738963680672156,
            0.0001534757246847234,
            0.0001327158452540512,
            0.00033145361964108004,
            5.1702278730316985e-5,
            0.00012084014635246575,
            3.685462693695783e-5,
            8.824241294836913e-5,
            6.603052146528479e-5,
            3.7336633685666965e-5,
            0.000119287048586928,
            1.9469575171790783e-5,
            5.127173943603295e-5,
            7.761647751672517e-5,
            5.7170644642460245e-5,
            0.00010459687632576076,
            4.6500445739785534e-5,
            7.532179344546002e-5,
            9.997544696541581e-5,
            6.209596553886905e-5,
            5.824815415910256e-5,
            6.712382518273905e-5,
            6.518088662452111e-5,
            5.1702278730316985e-5,
            0.00017928520818153665,
            9.465022633794337e-5,
            3.832908345199822e-5,
            9.972948243252036e-5,
            8.68948697277735e-5,
            5.283319336828808e-5,
            0.00010681830912336068,
            0.00011529019623067329,
            6.954195527091396e-5,
            0.00010078891821697432,
            4.77570913061552e-5,
            6.47822958428556e-5,
            5.623134884245821e-5,
            9.138793988145932e-5,
            6.148438504369382e-5,
            8.22975685311066e-5,
            0.0001303281405925459,
            0.0001171647101931088,
            0.0002006877860966814,
            0.00012084014635246575,
            9.465022633794337e-5,
            0.001649363491651328,
            4.5223413328825034e-5,
            0.00016784137181758126,
            0.0001386850909657868,
            6.458939755923189e-5,
            0.00010589340734636572,
            0.00014011446207689595,
            8.976333622649406e-5,
            0.00024098758150871094,
            0.00012009725810408961,
            0.00013067736145363487,
            7.421418478073369e-5,
            0.0001261200253519647,
            5.35968653435065e-5,
            4.183022574848328e-5,
            4.55503795780771e-5,
            3.869996028185736e-5,
            3.4692524062064834e-5,
            3.685462693695783e-5,
            3.832908345199822e-5,
            4.5223413328825034e-5,
            0.00016371583720534307,
            4.145051227987881e-5,
            4.987929270759291e-5,
            4.2438319829851895e-5,
            6.412885304835658e-5,
            0.0001118207982683004,
            3.454468025870223e-5,
            2.086534217872943e-5,
            5.781803066827005e-5,
            4.606752104626116e-5,
            4.4550654075148215e-5,
            4.728950626423971e-5,
            4.882332406662685e-5,
            9.067141771050849e-5,
            9.442418939594358e-5,
            9.457451171224822e-5,
            9.796039730265241e-5,
            8.824241294836913e-5,
            9.972948243252036e-5,
            0.00016784137181758126,
            4.145051227987881e-5,
            0.00027649791945834486,
            0.0001259729089585305,
            4.680226229882406e-5,
            0.00014186361033472427,
            0.00014860049111880655,
            9.150244120620364e-5,
            0.00013548711170023822,
            0.00011856721969541951,
            0.0001099720594647006,
            7.765450504400617e-5,
            0.00020139646917204595,
            7.7970058613762e-5,
            7.173426083922174e-5,
            7.595943936350152e-5,
            7.620626380944493e-5,
            8.16394591837143e-5,
            6.603052146528479e-5,
            8.68948697277735e-5,
            0.0001386850909657868,
            4.987929270759291e-5,
            0.0001259729089585305,
            0.00024358720166818307,
            4.770909506399242e-5,
            0.00012828950523977845,
            0.00014589380973957058,
            6.572302569854488e-5,
            0.00010419064086039876,
            0.0001001626277238875,
            7.69968436098602e-5,
            6.028339725989123e-5,
            0.00010829182738571201,
            6.998325134810433e-5,
            4.035654677616946e-5,
            4.1840531207773575e-5,
            3.904868634759729e-5,
            2.8632944028368108e-5,
            3.7336633685666965e-5,
            5.283319336828808e-5,
            6.458939755923189e-5,
            4.2438319829851895e-5,
            4.680226229882406e-5,
            4.770909506399242e-5,
            0.00010546409712361284,
            4.8929129369513514e-5,
            5.896108666334838e-5,
            4.858651300669176e-5,
            6.262720448187368e-5,
            4.035544686685855e-5,
            4.2701719087240345e-5,
            3.7316927906384094e-5,
            5.146903681941111e-5,
            3.612480526163764e-5,
            0.00010239654183710268,
            9.143103991948571e-5,
            0.0001380361667111408,
            0.0001110166930016184,
            0.000119287048586928,
            0.00010681830912336068,
            0.00010589340734636572,
            6.412885304835658e-5,
            0.00014186361033472427,
            0.00012828950523977845,
            4.8929129369513514e-5,
            0.0007071294270311353,
            0.00023036570341228548,
            7.577351396199615e-5,
            0.00013063845835111998,
            0.00013765335885783806,
            9.310648708686168e-5,
            6.83762483768431e-5,
            0.00012194120070538858,
            0.00010822552101984676,
            3.58895347738626e-5,
            7.152326073683382e-5,
            5.843400843950329e-5,
            0.0001005546477458589,
            1.9469575171790783e-5,
            0.00011529019623067329,
            0.00014011446207689595,
            0.0001118207982683004,
            0.00014860049111880655,
            0.00014589380973957058,
            5.896108666334838e-5,
            0.00023036570341228548,
            0.0019461027850529162,
            7.840009478093784e-5,
            0.0002218451937626271,
            0.0002341094546003583,
            5.970942481284993e-5,
            5.5928282713946245e-5,
            0.00010036337308436913,
            9.48018264310036e-5,
            5.338345680784469e-5,
            5.8990702062783135e-5,
            5.25446963255022e-5,
            5.6383706572802686e-5,
            5.127173943603295e-5,
            6.954195527091396e-5,
            8.976333622649406e-5,
            3.454468025870223e-5,
            9.150244120620364e-5,
            6.572302569854488e-5,
            4.858651300669176e-5,
            7.577351396199615e-5,
            7.840009478093784e-5,
            0.000143792480348064,
            0.00015468838723823786,
            4.7345308377058936e-5,
            6.451263640232723e-5,
            5.130492003035679e-5,
            8.783587312013415e-5,
            4.020673361771947e-5,
            2.4554319628138348e-5,
            5.4196528349915624e-5,
            4.352899431627756e-5,
            9.648891401981502e-5,
            7.761647751672517e-5,
            0.00010078891821697432,
            0.00024098758150871094,
            2.086534217872943e-5,
            0.00013548711170023822,
            0.00010419064086039876,
            6.262720448187368e-5,
            0.00013063845835111998,
            0.0002218451937626271,
            0.00015468838723823786,
            0.0009946578234570117,
            0.00011460104418440797,
            6.711857333430317e-5,
            3.7676959871462685e-5,
            0.00011646949598061786,
            3.519383745244493e-5,
            5.014139348676143e-5,
            7.441014007127945e-5,
            5.6524130190162446e-5,
            7.798069948053724e-5,
            5.7170644642460245e-5,
            4.77570913061552e-5,
            0.00012009725810408961,
            5.781803066827005e-5,
            0.00011856721969541951,
            0.0001001626277238875,
            4.035544686685855e-5,
            0.00013765335885783806,
            0.0002341094546003583,
            4.7345308377058936e-5,
            0.00011460104418440797,
            0.0005060138824207279,
            7.487467040330356e-5,
            4.936187188815178e-5,
            9.266612075095574e-5,
            7.645805395118208e-5,
            9.862887967338167e-5,
            9.268283422780716e-5,
            0.0001017691211442463,
            0.00010102936638412913,
            0.00010459687632576076,
            6.47822958428556e-5,
            0.00013067736145363487,
            4.606752104626116e-5,
            0.0001099720594647006,
            7.69968436098602e-5,
            4.2701719087240345e-5,
            9.310648708686168e-5,
            5.970942481284993e-5,
            6.451263640232723e-5,
            6.711857333430317e-5,
            7.487467040330356e-5,
            0.00016261411241525983,
            6.134491065110071e-5,
            9.84889216824726e-5,
            7.744209739132543e-5,
            5.899907732521574e-5,
            5.101719691518799e-5,
            5.430475677066226e-5,
            5.228279286729776e-5,
            4.6500445739785534e-5,
            5.623134884245821e-5,
            7.421418478073369e-5,
            4.4550654075148215e-5,
            7.765450504400617e-5,
            6.028339725989123e-5,
            3.7316927906384094e-5,
            6.83762483768431e-5,
            5.5928282713946245e-5,
            5.130492003035679e-5,
            3.7676959871462685e-5,
            4.936187188815178e-5,
            6.134491065110071e-5,
            0.00012216128652920127,
            7.24360662559272e-5,
            4.462918750011317e-5,
            7.900678634747935e-5,
            8.578645730092226e-5,
            8.143381874305633e-5,
            8.456006602214185e-5,
            7.532179344546002e-5,
            9.138793988145932e-5,
            0.0001261200253519647,
            4.728950626423972e-5,
            0.00020139646917204595,
            0.00010829182738571201,
            5.146903681941111e-5,
            0.00012194120070538858,
            0.00010036337308436913,
            8.783587312013415e-5,
            0.00011646949598061786,
            9.266612075095574e-5,
            9.84889216824726e-5,
            7.24360662559272e-5,
            0.00018510192027154697,
            7.09780097642729e-5,
            8.317071782107266e-5,
            7.170559134560567e-5,
            8.811290555373818e-5,
            6.922325042733573e-5,
            9.997544696541581e-5,
            6.148438504369382e-5,
            5.35968653435065e-5,
            4.882332406662685e-5,
            7.7970058613762e-5,
            6.998325134810433e-5,
            3.612480526163764e-5,
            0.00010822552101984676,
            9.48018264310036e-5,
            4.020673361771947e-5,
            3.519383745244493e-5,
            7.645805395118208e-5,
            7.744209739132543e-5,
            4.462918750011317e-5,
            7.09780097642729e-5,
            0.00015806550547591282,
        ],
        20,
        20,
    )
    mut = [
        0.01788215049780121,
        0.008299034563518402,
        0.03771050756916562,
        0.02955207837251922,
        0.02096210070715395,
        0.00461702040536412,
        0.06451975912860629,
        -0.003377902366384085,
        0.006963261507811539,
        0.007773327769429087,
        -0.005267147027680203,
        0.05304204065453175,
        0.006155642613698241,
        -0.000994094039101126,
        -0.022823596819754384,
        0.005387815348900928,
        0.008901143775398971,
        0.001922621478357743,
        0.0031199916007543745,
        0.0076272307297972726,
    ]
    @test isapprox(wb, wbt)
    @test isapprox(cov_mtx, cov_mtxt)
    @test isapprox(mu, mut)

    w = [
        0.08454031142379292,
        0.03742613569034952,
        0.00811626543723675,
        0.04557497081761481,
        0.09529326368486243,
        0.06082192264285191,
        0.06768140680640844,
        0.0034378800052307194,
        0.001945490978309011,
        0.09146698265346637,
        0.003124977384141323,
        0.04521409857507437,
        0.029836207702826512,
        0.015564711797928397,
        0.07424201222126192,
        0.03952015210626435,
        0.07672455015176545,
        0.07637525289339532,
        0.0689582593402907,
        0.07413514768692882,
    ]
    mu, cov_mtx, wb = black_litterman(X, w, P, Q)

    wbt = [
        0.08444595839748814,
        -36.448751083381346,
        145.95264900242904,
        38.184587394621076,
        0.09518690959604825,
        0.06075404103271964,
        38.2066691582483,
        -36.48270140574533,
        0.0019433196715752388,
        0.09136489896748401,
        -76.27500508776644,
        69.88682447509879,
        0.029802908363878444,
        0.015547340467723103,
        -36.41197629599826,
        0.03947604479364486,
        -23.203914692822245,
        -23.20426360023991,
        -36.4172541518338,
        -23.206501205329104,
    ]
    cov_mtxt = reshape(
        [
            0.00021019372803673762,
            9.814073696822803e-5,
            0.00014089460579763032,
            0.0001183384864749401,
            0.00015855508698984152,
            6.209596553886905e-5,
            8.22975685311066e-5,
            4.183022574848328e-5,
            9.067141771050849e-5,
            7.173426083922174e-5,
            4.035654677616946e-5,
            0.00010239654183710268,
            3.58895347738626e-5,
            5.338345680784469e-5,
            2.4554319628138348e-5,
            5.014139348676143e-5,
            9.862887967338167e-5,
            5.899907732521574e-5,
            7.900678634747935e-5,
            8.317071782107266e-5,
            9.814073696822803e-5,
            0.00021175486167171988,
            0.00010926287107231252,
            9.468695325627838e-5,
            0.00010738963680672156,
            5.824815415910256e-5,
            0.0001303281405925459,
            4.55503795780771e-5,
            9.442418939594358e-5,
            7.595943936350152e-5,
            4.1840531207773575e-5,
            9.143103991948571e-5,
            7.152326073683382e-5,
            5.8990702062783135e-5,
            5.4196528349915624e-5,
            7.441014007127945e-5,
            9.268283422780716e-5,
            5.101719691518799e-5,
            8.578645730092226e-5,
            7.170559134560567e-5,
            0.00014089460579763032,
            0.00010926287107231252,
            0.0002574464719462557,
            0.00011943713428833755,
            0.0001534757246847234,
            6.712382518273905e-5,
            0.0001171647101931088,
            3.869996028185736e-5,
            9.457451171224822e-5,
            7.620626380944493e-5,
            3.904868634759729e-5,
            0.0001380361667111408,
            5.843400843950329e-5,
            5.25446963255022e-5,
            4.352899431627756e-5,
            5.6524130190162446e-5,
            0.0001017691211442463,
            5.430475677066226e-5,
            8.143381874305633e-5,
            8.811290555373818e-5,
            0.0001183384864749401,
            9.468695325627838e-5,
            0.00011943713428833755,
            0.0004010053847728717,
            0.0001327158452540512,
            6.518088662452111e-5,
            0.0002006877860966814,
            3.4692524062064834e-5,
            9.796039730265241e-5,
            8.16394591837143e-5,
            2.8632944028368108e-5,
            0.0001110166930016184,
            0.0001005546477458589,
            5.6383706572802686e-5,
            9.648891401981502e-5,
            7.798069948053724e-5,
            0.00010102936638412913,
            5.228279286729776e-5,
            8.456006602214185e-5,
            6.922325042733573e-5,
            0.00015855508698984152,
            0.00010738963680672156,
            0.0001534757246847234,
            0.0001327158452540512,
            0.00033145361964108004,
            5.1702278730316985e-5,
            0.00012084014635246575,
            3.685462693695783e-5,
            8.824241294836913e-5,
            6.603052146528479e-5,
            3.7336633685666965e-5,
            0.000119287048586928,
            1.9469575171790783e-5,
            5.127173943603295e-5,
            7.761647751672517e-5,
            5.7170644642460245e-5,
            0.00010459687632576076,
            4.6500445739785534e-5,
            7.532179344546002e-5,
            9.997544696541581e-5,
            6.209596553886905e-5,
            5.824815415910256e-5,
            6.712382518273905e-5,
            6.518088662452111e-5,
            5.1702278730316985e-5,
            0.00017928520818153665,
            9.465022633794337e-5,
            3.832908345199822e-5,
            9.972948243252036e-5,
            8.68948697277735e-5,
            5.283319336828808e-5,
            0.00010681830912336068,
            0.00011529019623067329,
            6.954195527091396e-5,
            0.00010078891821697432,
            4.77570913061552e-5,
            6.47822958428556e-5,
            5.623134884245821e-5,
            9.138793988145932e-5,
            6.148438504369382e-5,
            8.22975685311066e-5,
            0.0001303281405925459,
            0.0001171647101931088,
            0.0002006877860966814,
            0.00012084014635246575,
            9.465022633794337e-5,
            0.001649363491651328,
            4.5223413328825034e-5,
            0.00016784137181758126,
            0.0001386850909657868,
            6.458939755923189e-5,
            0.00010589340734636572,
            0.00014011446207689595,
            8.976333622649406e-5,
            0.00024098758150871094,
            0.00012009725810408961,
            0.00013067736145363487,
            7.421418478073369e-5,
            0.0001261200253519647,
            5.35968653435065e-5,
            4.183022574848328e-5,
            4.55503795780771e-5,
            3.869996028185736e-5,
            3.4692524062064834e-5,
            3.685462693695783e-5,
            3.832908345199822e-5,
            4.5223413328825034e-5,
            0.00016371583720534307,
            4.145051227987881e-5,
            4.987929270759291e-5,
            4.2438319829851895e-5,
            6.412885304835658e-5,
            0.0001118207982683004,
            3.454468025870223e-5,
            2.086534217872943e-5,
            5.781803066827005e-5,
            4.606752104626116e-5,
            4.4550654075148215e-5,
            4.728950626423971e-5,
            4.882332406662685e-5,
            9.067141771050849e-5,
            9.442418939594358e-5,
            9.457451171224822e-5,
            9.796039730265241e-5,
            8.824241294836913e-5,
            9.972948243252036e-5,
            0.00016784137181758126,
            4.145051227987881e-5,
            0.00027649791945834486,
            0.0001259729089585305,
            4.680226229882406e-5,
            0.00014186361033472427,
            0.00014860049111880655,
            9.150244120620364e-5,
            0.00013548711170023822,
            0.00011856721969541951,
            0.0001099720594647006,
            7.765450504400617e-5,
            0.00020139646917204595,
            7.7970058613762e-5,
            7.173426083922174e-5,
            7.595943936350152e-5,
            7.620626380944493e-5,
            8.16394591837143e-5,
            6.603052146528479e-5,
            8.68948697277735e-5,
            0.0001386850909657868,
            4.987929270759291e-5,
            0.0001259729089585305,
            0.00024358720166818307,
            4.770909506399242e-5,
            0.00012828950523977845,
            0.00014589380973957058,
            6.572302569854488e-5,
            0.00010419064086039876,
            0.0001001626277238875,
            7.69968436098602e-5,
            6.028339725989123e-5,
            0.00010829182738571201,
            6.998325134810433e-5,
            4.035654677616946e-5,
            4.1840531207773575e-5,
            3.904868634759729e-5,
            2.8632944028368108e-5,
            3.7336633685666965e-5,
            5.283319336828808e-5,
            6.458939755923189e-5,
            4.2438319829851895e-5,
            4.680226229882406e-5,
            4.770909506399242e-5,
            0.00010546409712361284,
            4.8929129369513514e-5,
            5.896108666334838e-5,
            4.858651300669176e-5,
            6.262720448187368e-5,
            4.035544686685855e-5,
            4.2701719087240345e-5,
            3.7316927906384094e-5,
            5.146903681941111e-5,
            3.612480526163764e-5,
            0.00010239654183710268,
            9.143103991948571e-5,
            0.0001380361667111408,
            0.0001110166930016184,
            0.000119287048586928,
            0.00010681830912336068,
            0.00010589340734636572,
            6.412885304835658e-5,
            0.00014186361033472427,
            0.00012828950523977845,
            4.8929129369513514e-5,
            0.0007071294270311353,
            0.00023036570341228548,
            7.577351396199615e-5,
            0.00013063845835111998,
            0.00013765335885783806,
            9.310648708686168e-5,
            6.83762483768431e-5,
            0.00012194120070538858,
            0.00010822552101984676,
            3.58895347738626e-5,
            7.152326073683382e-5,
            5.843400843950329e-5,
            0.0001005546477458589,
            1.9469575171790783e-5,
            0.00011529019623067329,
            0.00014011446207689595,
            0.0001118207982683004,
            0.00014860049111880655,
            0.00014589380973957058,
            5.896108666334838e-5,
            0.00023036570341228548,
            0.0019461027850529162,
            7.840009478093784e-5,
            0.0002218451937626271,
            0.0002341094546003583,
            5.970942481284993e-5,
            5.5928282713946245e-5,
            0.00010036337308436913,
            9.48018264310036e-5,
            5.338345680784469e-5,
            5.8990702062783135e-5,
            5.25446963255022e-5,
            5.6383706572802686e-5,
            5.127173943603295e-5,
            6.954195527091396e-5,
            8.976333622649406e-5,
            3.454468025870223e-5,
            9.150244120620364e-5,
            6.572302569854488e-5,
            4.858651300669176e-5,
            7.577351396199615e-5,
            7.840009478093784e-5,
            0.000143792480348064,
            0.00015468838723823786,
            4.7345308377058936e-5,
            6.451263640232723e-5,
            5.130492003035679e-5,
            8.783587312013415e-5,
            4.020673361771947e-5,
            2.4554319628138348e-5,
            5.4196528349915624e-5,
            4.352899431627756e-5,
            9.648891401981502e-5,
            7.761647751672517e-5,
            0.00010078891821697432,
            0.00024098758150871094,
            2.086534217872943e-5,
            0.00013548711170023822,
            0.00010419064086039876,
            6.262720448187368e-5,
            0.00013063845835111998,
            0.0002218451937626271,
            0.00015468838723823786,
            0.0009946578234570117,
            0.00011460104418440797,
            6.711857333430317e-5,
            3.7676959871462685e-5,
            0.00011646949598061786,
            3.519383745244493e-5,
            5.014139348676143e-5,
            7.441014007127945e-5,
            5.6524130190162446e-5,
            7.798069948053724e-5,
            5.7170644642460245e-5,
            4.77570913061552e-5,
            0.00012009725810408961,
            5.781803066827005e-5,
            0.00011856721969541951,
            0.0001001626277238875,
            4.035544686685855e-5,
            0.00013765335885783806,
            0.0002341094546003583,
            4.7345308377058936e-5,
            0.00011460104418440797,
            0.0005060138824207279,
            7.487467040330356e-5,
            4.936187188815178e-5,
            9.266612075095574e-5,
            7.645805395118208e-5,
            9.862887967338167e-5,
            9.268283422780716e-5,
            0.0001017691211442463,
            0.00010102936638412913,
            0.00010459687632576076,
            6.47822958428556e-5,
            0.00013067736145363487,
            4.606752104626116e-5,
            0.0001099720594647006,
            7.69968436098602e-5,
            4.2701719087240345e-5,
            9.310648708686168e-5,
            5.970942481284993e-5,
            6.451263640232723e-5,
            6.711857333430317e-5,
            7.487467040330356e-5,
            0.00016261411241525983,
            6.134491065110071e-5,
            9.84889216824726e-5,
            7.744209739132543e-5,
            5.899907732521574e-5,
            5.101719691518799e-5,
            5.430475677066226e-5,
            5.228279286729776e-5,
            4.6500445739785534e-5,
            5.623134884245821e-5,
            7.421418478073369e-5,
            4.4550654075148215e-5,
            7.765450504400617e-5,
            6.028339725989123e-5,
            3.7316927906384094e-5,
            6.83762483768431e-5,
            5.5928282713946245e-5,
            5.130492003035679e-5,
            3.7676959871462685e-5,
            4.936187188815178e-5,
            6.134491065110071e-5,
            0.00012216128652920127,
            7.24360662559272e-5,
            4.462918750011317e-5,
            7.900678634747935e-5,
            8.578645730092226e-5,
            8.143381874305633e-5,
            8.456006602214185e-5,
            7.532179344546002e-5,
            9.138793988145932e-5,
            0.0001261200253519647,
            4.728950626423972e-5,
            0.00020139646917204595,
            0.00010829182738571201,
            5.146903681941111e-5,
            0.00012194120070538858,
            0.00010036337308436913,
            8.783587312013415e-5,
            0.00011646949598061786,
            9.266612075095574e-5,
            9.84889216824726e-5,
            7.24360662559272e-5,
            0.00018510192027154697,
            7.09780097642729e-5,
            8.317071782107266e-5,
            7.170559134560567e-5,
            8.811290555373818e-5,
            6.922325042733573e-5,
            9.997544696541581e-5,
            6.148438504369382e-5,
            5.35968653435065e-5,
            4.882332406662685e-5,
            7.7970058613762e-5,
            6.998325134810433e-5,
            3.612480526163764e-5,
            0.00010822552101984676,
            9.48018264310036e-5,
            4.020673361771947e-5,
            3.519383745244493e-5,
            7.645805395118208e-5,
            7.744209739132543e-5,
            4.462918750011317e-5,
            7.09780097642729e-5,
            0.00015806550547591282,
        ],
        20,
        20,
    )
    mut = [
        0.01788998459183981,
        0.008299820326268045,
        0.03771183401154889,
        0.02955423090677379,
        0.020977345429949813,
        0.004618718511626486,
        0.06453581774835698,
        -0.0033848280023150825,
        0.006961245640874746,
        0.007779388719665253,
        -0.005268833811381122,
        0.05304233110704597,
        0.006115255635197766,
        -0.000994712949840736,
        -0.02280716266830342,
        0.005381589715613995,
        0.00890566996442942,
        0.001924494732875434,
        0.0031198232898175006,
        0.007630956707819302,
    ]
    @test isapprox(wb, wbt)
    @test isapprox(cov_mtx, cov_mtxt)
    @test isapprox(mu, mut)

    w = fill(1 / 20, 20)
    mu1, cov_mtx1, wb1 = black_litterman(X, w, P, Q)
    mu2, cov_mtx2, wb2 = augmented_black_litterman(X, w, P = P, Q = Q)
    @test isapprox(mu1, mu2)
    @test isapprox(cov_mtx1, cov_mtx2)
    @test isapprox(wb1, wb2)

    # Augmented black litterman
    kr = TimeArray(CSV.File("./assets/KeyRates.csv"), timestamp = :Date) ./ 100
    assets = TimeArray(CSV.File("./assets/Assets.csv"), timestamp = :Date)
    a = merge(assets, kr, method = :inner)

    kr_returns = dropmissing!(DataFrame(diff(a[colnames(kr)])))
    sort!(kr_returns, :timestamp, rev = true)
    assets_returns = dropmissing!(DataFrame(percentchange(a[colnames(assets)])))
    sort!(assets_returns, :timestamp, rev = true)

    equity = ["APA", "CMCSA", "CNP", "HPQ", "PSA", "SEE", "ZION"]
    bonds = [
        "PEP11900D031",
        "PEP13000D012",
        "PEP13000M088",
        "PEP23900M103",
        "PEP70101M530",
        "PEP70101M571",
        "PEP70310M156",
    ]
    factors = ["MTUM", "QUAL", "SIZE", "USMV", "VLUE"]

    factor_returns = assets_returns[!, ["timestamp"; factors]]
    assets_returns = assets_returns[!, ["timestamp"; equity; bonds]]

    convexity = CSV.read("./assets/convexity.csv", DataFrame)
    durations = CSV.read("./assets/durations.csv", DataFrame)

    loadings = innerjoin(durations, convexity, on = "ticker")
    loadings[!, names(durations)[2:end]] .= -1 * Matrix(durations[!, 2:end])
    loadings[!, names(convexity)[2:end]] .= 0.5 * Matrix(convexity[!, 2:end])

    kr_returns_2 = copy(kr_returns)
    kr_returns_2[!, 2:end] .= Matrix(kr_returns_2[!, 2:end]) .^ 2
    X = DataFrames.rename!(
        hcat(kr_returns, kr_returns_2[!, 2:end], makeunique = true),
        ["timestamp"; names(loadings)[2:end]],
    )
    Y = assets_returns[!, ["timestamp"; bonds]]

    views = DataFrame(
        Dict(
            "Enabled" => [true, true, true],
            "Factor" => ["R 10800", "R 1800", "R 3600"],
            "Sign" => [">=", "<=", "<="],
            "Value" => [0.001, -0.001, -0.003],
            "Relative Factor" => ["R 7200", "", ""],
        ),
    )

    P_f, Q_f = factor_views(views, loadings)

    port = Portfolio(returns = Y, f_returns = X)

    muab1, cov_mtxab1, wab1 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        F = port.f_returns,
        B = Matrix(loadings[!, 2:end]),
        P_f = P_f,
        Q_f = Q_f / 252,
        constant = false,
    )

    muabt1 = [
        1.3647878981697301e-5,
        3.8631303737554514e-5,
        3.184515304560784e-5,
        1.7852294696819652e-5,
        5.528581214542672e-5,
        5.388880823022076e-5,
        1.7266267583101907e-5,
    ]
    cov_mtxabt1 = reshape(
        [
            2.1533865165434455e-6,
            3.28910821006002e-6,
            3.2359698761898692e-6,
            2.7071092725875364e-6,
            4.322774613456235e-6,
            4.287435815187083e-6,
            2.650639864415661e-6,
            3.289108210060019e-6,
            7.82088560810633e-6,
            6.69307769169049e-6,
            4.23171596821771e-6,
            1.1611407645337776e-5,
            1.2055557166459422e-5,
            4.111799472080012e-6,
            3.2359698761898692e-6,
            6.693077691690491e-6,
            5.963833546575896e-6,
            4.13461898435994e-6,
            9.579184937136725e-6,
            9.784202271748621e-6,
            4.027804949738506e-6,
            2.707109272587537e-6,
            4.2317159682177095e-6,
            4.134618984359942e-6,
            3.4145086428229834e-6,
            5.577239865561125e-6,
            5.51620095655457e-6,
            3.3412100554856735e-6,
            4.322774613456236e-6,
            1.1611407645337773e-5,
            9.579184937136722e-6,
            5.577239865561126e-6,
            1.847777247472792e-5,
            2.013519806354297e-5,
            5.408790621570868e-6,
            4.2874358151870814e-6,
            1.2055557166459427e-5,
            9.78420227174862e-6,
            5.516200956554569e-6,
            2.0135198063542976e-5,
            2.273176298828888e-5,
            5.3483311191646005e-6,
            2.6506398644156605e-6,
            4.1117994720800115e-6,
            4.027804949738505e-6,
            3.341210055485674e-6,
            5.408790621570868e-6,
            5.348331119164602e-6,
            3.2699648768137866e-6,
        ],
        7,
        7,
    )
    wabt1 = [
        -2.210151123453599,
        91.23381308739383,
        -255.9087623851521,
        19.982187615160356,
        109.09145034867265,
        -62.593125053898895,
        109.08107269112764,
    ]

    @test isapprox(muab1, muabt1)
    @test isapprox(cov_mtxab1, cov_mtxabt1)
    @test isapprox(wab1, wabt1)

    asset_classes = Dict(
        "Assets" => bonds,
        "Class 1" => [
            "Equity",
            "Equity",
            "Fixed Income",
            "Equity",
            "Equity",
            "Fixed Income",
            "Fixed Income",
        ],
        "Class 2" => [
            "Technology",
            "Technology",
            "Essentials",
            "Financial",
            "Financial",
            "Treasury",
            "Treasury",
        ],
    )

    asset_classes = DataFrame(asset_classes)
    sort!(asset_classes, "Assets")

    views = Dict(
        "Enabled" => [true, true, true, true, true],
        "Type" => ["Assets", "Classes", "Classes", "Assets", "Classes"],
        "Set" => ["", "Class 2", "Class 1", "", "Class 1"],
        "Position" => [bonds[3], "Financial", "Equity", bonds[5], "Fixed Income"],
        "Sign" => ["<=", ">=", ">=", ">=", "<="],
        "Return" => [0.3, 0.1, 0.05, 0.03, 0.017],
        "Type Relative" => ["Assets", "Classes", "Assets", "", ""],
        "Relative Set" => ["", "Class 1", "", "", ""],
        "Relative" => [bonds[2], "Fixed Income", bonds[3], "", ""],
    )

    views = DataFrame(views)
    P, Q = asset_views(views, asset_classes)

    muab2, cov_mtxab2, wab2 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        F = port.f_returns,
        B = Matrix(loadings[!, 2:end]),
        P = P,
        Q = Q / 252,
        P_f = P_f,
        Q_f = Q_f / 252,
        constant = false,
    )

    muabt2 = [
        -7.596863028243962e-7,
        -0.0001459514528743672,
        0.00012175676935906917,
        0.0001437654183200914,
        0.00018542698814630866,
        9.899518781536428e-6,
        -6.853573051225962e-6,
    ]
    cov_mtxabt2 = reshape(
        [
            1.974978406015164e-5,
            7.845288629212163e-6,
            8.368508701428944e-6,
            7.458436208923389e-6,
            1.1593331442434624e-5,
            1.794995975365903e-5,
            7.734167717602765e-6,
            7.845288629212165e-6,
            2.8720758920728506e-5,
            1.242803375674979e-5,
            1.030770120817009e-5,
            1.9576462216886023e-5,
            1.8432690357430814e-5,
            1.087307688166259e-5,
            8.368508701428944e-6,
            1.242803375674979e-5,
            6.056804099547507e-5,
            1.092489253754303e-5,
            1.884602747977965e-5,
            1.7393637753491328e-5,
            1.1497974633284017e-5,
            7.458436208923389e-6,
            1.030770120817009e-5,
            1.092489253754303e-5,
            1.6943109520623145e-5,
            1.544855101402545e-5,
            1.4184676368400762e-5,
            1.0114271216141725e-5,
            1.1593331442434624e-5,
            1.9576462216886023e-5,
            1.8846027479779654e-5,
            1.5448551014025452e-5,
            3.967036657239096e-5,
            3.0314823553669076e-5,
            1.6109329460313524e-5,
            1.794995975365903e-5,
            1.8432690357430817e-5,
            1.739363775349133e-5,
            1.4184676368400767e-5,
            3.0314823553669076e-5,
            4.0459660527347004e-5,
            1.4747644712425486e-5,
            7.734167717602765e-6,
            1.0873076881662589e-5,
            1.1497974633284015e-5,
            1.0114271216141722e-5,
            1.6109329460313524e-5,
            1.4747644712425485e-5,
            1.721039832241595e-5,
        ],
        7,
        7,
    )
    wabt2 = [
        1.4905649566042773,
        -12.824035859642859,
        1.3067234255598335,
        13.694984925393952,
        12.024675514888314,
        -7.616458850425878,
        -7.616458850426216,
    ]
    @test isapprox(muab2, muabt2)
    @test isapprox(cov_mtxab2, cov_mtxabt2)
    @test isapprox(wab2, wabt2)

    mub1, sigma_b1, wb1 = bayesian_black_litterman(
        port.returns,
        port.f_returns,
        Matrix(loadings[!, 2:end]),
        P_f,
        Q_f / 252,
        constant = false,
        diagonal = true,
    )

    mubt1 = [
        1.5211845368269412e-5,
        7.12393961486707e-5,
        5.0237060501731094e-5,
        1.9319648191519328e-5,
        0.00011864810032815108,
        0.00013716286860696042,
        1.8561504553428525e-5,
    ]
    covbt1 = reshape(
        [
            1.8492511130154584e-5,
            3.3086872642120553e-6,
            3.2507289601969717e-6,
            2.7204667415664046e-6,
            4.380855735642888e-6,
            4.3855666960386775e-6,
            2.6653495454216413e-6,
            3.3086872642120523e-6,
            2.914616140480822e-5,
            6.709463957850312e-6,
            4.243498527858832e-6,
            1.1709771875054674e-5,
            1.2222281431192287e-5,
            4.124985184450166e-6,
            3.2507289601969704e-6,
            6.7094639578503104e-6,
            5.843090096107253e-5,
            4.143978094287707e-6,
            9.626600007558158e-6,
            9.862472398389762e-6,
            4.0381466092664456e-6,
            2.7204667415664033e-6,
            4.243498527858833e-6,
            4.143978094287707e-6,
            1.5329163184191893e-5,
            5.611939023087249e-6,
            5.575162443589605e-6,
            3.3511800688307266e-6,
            4.38085573564288e-6,
            1.1709771875054669e-5,
            9.626600007558158e-6,
            5.611939023087245e-6,
            3.7521056653733796e-5,
            2.138835268751145e-5,
            5.448044191668484e-6,
            4.385566696038663e-6,
            1.2222281431192277e-5,
            9.862472398389755e-6,
            5.575162443589595e-6,
            2.1388352687511448e-5,
            4.323430765621752e-5,
            5.415019635201494e-6,
            2.6653495454216413e-6,
            4.124985184450167e-6,
            4.038146609266446e-6,
            3.3511800688307275e-6,
            5.4480441916684895e-6,
            5.415019635201505e-6,
            1.5216693981192306e-5,
        ],
        7,
        7,
    )
    wbt1 = [
        -0.18879712265363802,
        0.9391284425473025,
        0.1665640589235099,
        -0.34266801621174814,
        1.7461003795507033,
        2.1120756631921536,
        -0.34719809188344003,
    ]

    @test isapprox(mub1, mubt1)
    @test isapprox(sigma_b1, covbt1)
    @test isapprox(wb1, wbt1)

    mub2, sigma_b2, wb2 = bayesian_black_litterman(
        port.returns,
        port.f_returns,
        Matrix(loadings[!, 2:end]),
        P_f,
        Q_f / 252,
        constant = false,
        diagonal = false,
    )

    mubt2 = [
        1.5211845370658701e-5,
        7.123939615975321e-5,
        5.023706050841155e-5,
        1.9319648198414038e-5,
        0.00011864810033343962,
        0.00013716286860711776,
        1.8561504559366494e-5,
    ]
    covbt2 = reshape(
        [
            2.174018477350132e-6,
            3.3086872638377794e-6,
            3.250728959713388e-6,
            2.7204667410029697e-6,
            4.380855735287792e-6,
            4.3855666957320906e-6,
            2.66534954486634e-6,
            3.308687263518598e-6,
            7.846388947581434e-6,
            6.7094639571598795e-6,
            4.243498527006333e-6,
            1.1709771874622221e-5,
            1.2222281430830062e-5,
            4.124985183609081e-6,
            3.2507289595141217e-6,
            6.709463957334167e-6,
            5.975632280012276e-6,
            4.143978093447178e-6,
            9.626600007095194e-6,
            9.862472397997325e-6,
            4.038146608437487e-6,
            2.720466740993234e-6,
            4.2434985273919725e-6,
            4.143978093682622e-6,
            3.423666554697309e-6,
            5.611939022646215e-6,
            5.575162443209455e-6,
            3.35118006813389e-6,
            4.380855734723869e-6,
            1.1709771874415406e-5,
            9.626600006658176e-6,
            5.6119390219586e-6,
            1.9184045664263333e-5,
            2.138835268706203e-5,
            5.448044190554631e-6,
            4.38556669511822e-6,
            1.2222281430555371e-5,
            9.862472397490683e-6,
            5.57516244245947e-6,
            2.138835268697447e-5,
            2.496246409911077e-5,
            5.4150196340861175e-6,
            2.6653495448602685e-6,
            4.1249851839920675e-6,
            4.038146608673273e-6,
            3.3511800681382357e-6,
            5.448044191235192e-6,
            5.415019634827862e-6,
            3.2808457291338653e-6,
        ],
        7,
        7,
    )
    wbt2 = [
        -7821.1008977394085,
        30344.898064793248,
        -45066.23062839449,
        31905.905605824664,
        -1645.5040439071172,
        -74.5115684811035,
        -6058.759093070403,
    ]

    @test isapprox(mub2, mubt2)
    @test isapprox(sigma_b2, covbt2)
    @test isapprox(wb2, wbt2)

    port = Portfolio(returns = Y, f_returns = X)
    asset_statistics!(port)
    black_litterman_statistics!(port, P, Q / 252, fill(1 / 7, 7); delta = 1)
    @test isapprox(port.bl_bench_weights, fill(1 / 7, 7))

    port = Portfolio(returns = Y, f_returns = X)
    asset_statistics!(port)
    black_litterman_statistics!(port, P, Q / 252, ; delta = 1)
    mu1, cov1, w1 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        P = P,
        Q = Q / 252,
    )
    @test isapprox(mu1, port.mu_bl)
    @test isapprox(cov1, port.cov_bl)

    rf = 1.0329^(1 / 252) - 1
    bw = fill(1 / length(port.assets), length(port.assets))
    delta = (dot(port.mu, bw) - rf) / dot(bw, port.cov, bw)
    black_litterman_statistics!(port, P, Q / 252; rf = rf)
    mu2, cov2, w2 = augmented_black_litterman(
        port.returns,
        bw;
        P = P,
        Q = Q / 252,
        rf = rf,
        delta = delta,
    )
    @test isapprox(mu2, port.mu_bl)
    @test isapprox(cov2, port.cov_bl)

    mu3, cov3, w3 = black_litterman(port.returns, bw, P, Q / 252; rf = rf, delta = delta)
    @test isapprox(mu3, port.mu_bl)
    @test isapprox(cov3, port.cov_bl)

    factor_statistics!(port; reg_type = :BReg)
    mu_ft = [
        9.14199087663652e-5,
        0.00011888557150746489,
        0.0002507952281107193,
        0.0001526701517709168,
        0.00019984628913082334,
        0.00019588947077146059,
        0.0001330502135829032,
    ]
    cov_ft = reshape(
        [
            1.9733861670583968e-5,
            7.842849068861552e-6,
            8.366261183033376e-6,
            7.4548415456416025e-6,
            1.15898988376771e-5,
            1.7940550288745064e-5,
            7.731423845318617e-6,
            7.842849068861552e-6,
            2.8702673540267946e-5,
            1.2420388430250576e-5,
            1.030344062358102e-5,
            1.9570871791419014e-5,
            1.8427926279124283e-5,
            1.086919714112664e-5,
            8.366261183033376e-6,
            1.2420388430250576e-5,
            6.054810637470125e-5,
            1.091979644930212e-5,
            1.8840340921297204e-5,
            1.739093596942493e-5,
            1.1495467004809538e-5,
            7.4548415456416025e-6,
            1.030344062358102e-5,
            1.091979644930212e-5,
            1.6931893494002995e-5,
            1.5444455331490255e-5,
            1.4179605661234799e-5,
            1.010933816396797e-5,
            1.15898988376771e-5,
            1.9570871791419014e-5,
            1.8840340921297204e-5,
            1.5444455331490255e-5,
            3.96561514210648e-5,
            3.0305945008858823e-5,
            1.6104151341073822e-5,
            1.7940550288745064e-5,
            1.8427926279124283e-5,
            1.739093596942493e-5,
            1.4179605661234799e-5,
            3.0305945008858823e-5,
            4.044062094298001e-5,
            1.4743759389780284e-5,
            7.731423845318617e-6,
            1.086919714112664e-5,
            1.1495467004809538e-5,
            1.010933816396797e-5,
            1.6104151341073822e-5,
            1.4743759389780284e-5,
            1.7199286016812874e-5,
        ],
        7,
        7,
    )
    mu_fmt = [
        9.141990876636845e-5,
        0.00011888557150747776,
        0.0002507952281107191,
        0.00015267015177092099,
        0.00019984628913084654,
        0.0001958894707715255,
        0.00013305021358293328,
    ]
    cov_fmt = reshape(
        [
            1.9733861670583968e-5,
            4.848496323269074e-6,
            5.41952737165016e-6,
            5.075813057871703e-6,
            7.585660856677651e-6,
            7.37489475153783e-6,
            5.177129718706979e-6,
            4.848496323269073e-6,
            2.870267354026793e-5,
            8.043223030730563e-6,
            6.3757878210052454e-6,
            1.2817707784638854e-5,
            1.2508057810583204e-5,
            6.274830289086978e-6,
            5.4195273716501594e-6,
            8.043223030730563e-6,
            6.054810637470123e-5,
            7.062815077274499e-6,
            1.2718590310218615e-5,
            1.2109659683943118e-5,
            7.033801718371211e-6,
            5.075813057871702e-6,
            6.3757878210052454e-6,
            7.062815077274499e-6,
            1.6931893494002985e-5,
            1.0004070938408941e-5,
            9.671257708327071e-6,
            6.474254723417463e-6,
            7.585660856677651e-6,
            1.2817707784638856e-5,
            1.2718590310218615e-5,
            1.000407093840894e-5,
            3.965615142106479e-5,
            2.187173659845087e-5,
            9.746180733797309e-6,
            7.37489475153783e-6,
            1.2508057810583206e-5,
            1.210965968394312e-5,
            9.671257708327073e-6,
            2.187173659845087e-5,
            4.0440620942979996e-5,
            9.475924702249967e-6,
            5.17712971870698e-6,
            6.27483028908698e-6,
            7.033801718371214e-6,
            6.474254723417465e-6,
            9.746180733797309e-6,
            9.475924702249967e-6,
            1.719928601681286e-5,
        ],
        7,
        7,
    )
    @test isapprox(port.mu_f, mu_ft)
    @test isapprox(port.cov_f, cov_ft)
    @test isapprox(port.mu_fm, mu_fmt)
    @test isapprox(port.cov_fm, cov_fmt)

    factor_statistics!(port; reg_type = :PCR)
    mu_ft = [
        9.14199087663652e-5,
        0.00011888557150746489,
        0.0002507952281107193,
        0.0001526701517709168,
        0.00019984628913082334,
        0.00019588947077146059,
        0.0001330502135829032,
    ]
    cov_ft = reshape(
        [
            1.9733861670583968e-5,
            7.842849068861552e-6,
            8.366261183033376e-6,
            7.4548415456416025e-6,
            1.15898988376771e-5,
            1.7940550288745064e-5,
            7.731423845318617e-6,
            7.842849068861552e-6,
            2.8702673540267946e-5,
            1.2420388430250576e-5,
            1.030344062358102e-5,
            1.9570871791419014e-5,
            1.8427926279124283e-5,
            1.086919714112664e-5,
            8.366261183033376e-6,
            1.2420388430250576e-5,
            6.054810637470125e-5,
            1.091979644930212e-5,
            1.8840340921297204e-5,
            1.739093596942493e-5,
            1.1495467004809538e-5,
            7.4548415456416025e-6,
            1.030344062358102e-5,
            1.091979644930212e-5,
            1.6931893494002995e-5,
            1.5444455331490255e-5,
            1.4179605661234799e-5,
            1.010933816396797e-5,
            1.15898988376771e-5,
            1.9570871791419014e-5,
            1.8840340921297204e-5,
            1.5444455331490255e-5,
            3.96561514210648e-5,
            3.0305945008858823e-5,
            1.6104151341073822e-5,
            1.7940550288745064e-5,
            1.8427926279124283e-5,
            1.739093596942493e-5,
            1.4179605661234799e-5,
            3.0305945008858823e-5,
            4.044062094298001e-5,
            1.4743759389780284e-5,
            7.731423845318617e-6,
            1.086919714112664e-5,
            1.1495467004809538e-5,
            1.010933816396797e-5,
            1.6104151341073822e-5,
            1.4743759389780284e-5,
            1.7199286016812874e-5,
        ],
        7,
        7,
    )
    mu_fmt = [
        9.141990876636525e-5,
        0.00011888557150746489,
        0.0002507952281107193,
        0.0001526701517709168,
        0.00019984628913082334,
        0.0001958894707714606,
        0.00013305021358290322,
    ]
    cov_fmt = reshape(
        [
            1.9729635884430235e-5,
            4.9256685676516726e-6,
            5.475167197152441e-6,
            4.9842764866188545e-6,
            7.569703750155468e-6,
            7.479526028846325e-6,
            5.083272001768722e-6,
            4.925668567651674e-6,
            2.8694763391774985e-5,
            7.702345457156184e-6,
            6.474466225704216e-6,
            1.2709184630705394e-5,
            1.266308472567879e-5,
            6.451729338171833e-6,
            5.475167197152441e-6,
            7.702345457156184e-6,
            6.053949172152161e-5,
            7.147646166798667e-6,
            1.2271131973186004e-5,
            1.1936556710055939e-5,
            7.211882796391111e-6,
            4.984276486618854e-6,
            6.474466225704213e-6,
            7.147646166798666e-6,
            1.6925376235116648e-5,
            1.0074586291727095e-5,
            9.801112001375271e-6,
            6.411575335778097e-6,
            7.5697037501554695e-6,
            1.2709184630705393e-5,
            1.2271131973186002e-5,
            1.0074586291727102e-5,
            3.963385061121752e-5,
            2.187699921533186e-5,
            9.935758571166564e-6,
            7.479526028846328e-6,
            1.2663084725678786e-5,
            1.1936556710055942e-5,
            9.801112001375273e-6,
            2.1876999215331867e-5,
            4.041755162560434e-5,
            9.627382005850791e-6,
            5.083272001768722e-6,
            6.451729338171832e-6,
            7.211882796391111e-6,
            6.411575335778097e-6,
            9.93575857116656e-6,
            9.62738200585079e-6,
            1.7192561662549678e-5,
        ],
        7,
        7,
    )
    @test isapprox(port.mu_f, mu_ft)
    @test isapprox(port.cov_f, cov_ft)
    @test isapprox(port.mu_fm, mu_fmt)
    @test isapprox(port.cov_fm, cov_fmt, rtol = 7.25e-3)

    factor_statistics!(port; reg_type = :FReg)
    mu_ft = [
        9.14199087663652e-5,
        0.00011888557150746489,
        0.0002507952281107193,
        0.0001526701517709168,
        0.00019984628913082334,
        0.00019588947077146059,
        0.0001330502135829032,
    ]
    cov_ft = reshape(
        [
            1.9733861670583968e-5,
            7.842849068861552e-6,
            8.366261183033376e-6,
            7.4548415456416025e-6,
            1.15898988376771e-5,
            1.7940550288745064e-5,
            7.731423845318617e-6,
            7.842849068861552e-6,
            2.8702673540267946e-5,
            1.2420388430250576e-5,
            1.030344062358102e-5,
            1.9570871791419014e-5,
            1.8427926279124283e-5,
            1.086919714112664e-5,
            8.366261183033376e-6,
            1.2420388430250576e-5,
            6.054810637470125e-5,
            1.091979644930212e-5,
            1.8840340921297204e-5,
            1.739093596942493e-5,
            1.1495467004809538e-5,
            7.4548415456416025e-6,
            1.030344062358102e-5,
            1.091979644930212e-5,
            1.6931893494002995e-5,
            1.5444455331490255e-5,
            1.4179605661234799e-5,
            1.010933816396797e-5,
            1.15898988376771e-5,
            1.9570871791419014e-5,
            1.8840340921297204e-5,
            1.5444455331490255e-5,
            3.96561514210648e-5,
            3.0305945008858823e-5,
            1.6104151341073822e-5,
            1.7940550288745064e-5,
            1.8427926279124283e-5,
            1.739093596942493e-5,
            1.4179605661234799e-5,
            3.0305945008858823e-5,
            4.044062094298001e-5,
            1.4743759389780284e-5,
            7.731423845318617e-6,
            1.086919714112664e-5,
            1.1495467004809538e-5,
            1.010933816396797e-5,
            1.6104151341073822e-5,
            1.4743759389780284e-5,
            1.7199286016812874e-5,
        ],
        7,
        7,
    )
    mu_fmt = [
        9.141990876636845e-5,
        0.00011888557150747776,
        0.0002507952281107191,
        0.000152670151770921,
        0.0001998462891308503,
        0.0001958894707714722,
        0.0001330502135829073,
    ]
    cov_fmt = reshape(
        [
            1.9733861670583968e-5,
            4.848496323269074e-6,
            5.41952737165016e-6,
            5.075813057871706e-6,
            7.706722009436583e-6,
            7.466949481823141e-6,
            5.177129718706981e-6,
            4.848496323269073e-6,
            2.870267354026793e-5,
            8.043223030730563e-6,
            6.37578782100525e-6,
            1.2817707784638842e-5,
            1.2537204152117622e-5,
            6.320683130163937e-6,
            5.4195273716501594e-6,
            8.043223030730563e-6,
            6.054810637470123e-5,
            7.062815077274504e-6,
            1.2718590310218602e-5,
            1.2154452899331862e-5,
            7.033801718371215e-6,
            5.075813057871706e-6,
            6.37578782100525e-6,
            7.062815077274504e-6,
            1.693189349400299e-5,
            1.012015951708397e-5,
            9.769145969870943e-6,
            6.47425472341747e-6,
            7.706722009436583e-6,
            1.2817707784638844e-5,
            1.2718590310218603e-5,
            1.0120159517083971e-5,
            3.965615142106477e-5,
            2.1969945134233947e-5,
            1.003981474824968e-5,
            7.466949481823141e-6,
            1.2537204152117622e-5,
            1.2154452899331862e-5,
            9.769145969870945e-6,
            2.1969945134233947e-5,
            4.044062094297997e-5,
            9.7097406572249e-6,
            5.177129718706981e-6,
            6.320683130163937e-6,
            7.033801718371214e-6,
            6.47425472341747e-6,
            1.003981474824968e-5,
            9.7097406572249e-6,
            1.7199286016812867e-5,
        ],
        7,
        7,
    )
    @test isapprox(port.mu_f, mu_ft)
    @test isapprox(port.cov_f, cov_ft)
    @test isapprox(port.mu_fm, mu_fmt)
    @test isapprox(port.cov_fm, cov_fmt)

    port = Portfolio(returns = Y, f_returns = X)
    black_litterman_factor_satistics!(
        port,
        fill(1 / 20, 20);
        # Black Litterman
        P = P,
        P_f = P_f,
        Q = Q / 252,
        Q_f = Q_f / 252,
        bl_type = :B,
        # delta = 1.0,
        # eq = true,
        # rf = 0.0,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    @test isapprox(port.bl_bench_weights, fill(1 / 20, 20))

    port = Portfolio(returns = Y, f_returns = X)
    black_litterman_factor_satistics!(
        port;
        # w;
        # Black Litterman
        B = loadings,
        P = P,
        P_f = P_f,
        Q = Q / 252,
        Q_f = Q_f / 252,
        bl_type = :B,
        # delta = 1.0,
        # eq = true,
        # rf = 0.0,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    mub1, covb1, wb1 = bayesian_black_litterman(
        port.returns,
        port.f_returns,
        Matrix(loadings[!, 2:end]),
        P_f,
        Q_f / 252,
        constant = false,
    )
    @test isapprox(port.mu_bl_fm, mub1)
    @test isapprox(port.cov_bl_fm, covb1)

    f_views = DataFrame(
        Dict(
            "Enabled" => [true, true, true],
            "Factor" => ["R 10800", "R 1800", "R 3600"],
            "Sign" => [">=", "<=", "<="],
            "Value" => [0.001, -0.001, -0.003],
            "Relative Factor" => ["R 7200", "", ""],
        ),
    )
    f_views = DataFrame(f_views)
    B = loadings_matrix(
        DataFrame(port.f_returns, port.f_assets),
        DataFrame(port.returns, port.assets),
    )
    P_f1, Q_f1 = factor_views(f_views, B)
    black_litterman_factor_satistics!(
        port;
        # w;
        # Black Litterman
        B = B,
        P = P,
        P_f = P_f1,
        Q = Q / 252,
        Q_f = Q_f1 / 252,
        bl_type = :B,
        # delta = 1.0,
        eq = false,
        rf = 0.0002,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    mub2, covb2, wb2 = bayesian_black_litterman(
        port.returns,
        port.f_returns,
        Matrix(B[!, 2:end]),
        P_f1,
        Q_f1 / 252,
        constant = true,
        rf = 0.0002,
    )
    @test isapprox(port.mu_bl_fm, mub2)
    @test isapprox(port.cov_bl_fm, covb2)

    try
        black_litterman_factor_satistics!(
            port;
            # w;
            # Black Litterman
            B = B,
            P = P,
            P_f = P_f1,
            Q = Q / 252,
            Q_f = Q_f1 / 252,
            bl_type = :B,
            # delta = 1.0,
            # eq = true,
            # rf = 0.0,
            # # Loadings matrix
            # criterion = :pval,
            diagonal = false,
        )
        mub3, covb3, wb3 = bayesian_black_litterman(
            port.returns,
            port.f_returns,
            Matrix(B[!, 2:end]),
            P_f1,
            Q_f1 / 252,
            constant = true,
            diagonal = false,
        )
        @test isapprox(port.mu_bl_fm, mub3)
        @test isapprox(port.cov_bl_fm, covb3)
    catch
    end

    black_litterman_factor_satistics!(
        port;
        # w;
        # Black Litterman
        B = loadings,
        P = P,
        P_f = P_f,
        Q = Q / 252,
        Q_f = Q_f / 252,
        bl_type = :A,
        # delta = 1.0,
        # eq = true,
        # rf = 0.0,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    mub4, covb4, w4 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        F = port.f_returns,
        B = Matrix(loadings[!, 2:end]),
        P = P,
        Q = Q / 252,
        P_f = P_f,
        Q_f = Q_f / 252,
        constant = false,
    )
    @test isapprox(port.mu_bl_fm, mub4)
    @test isapprox(port.cov_bl_fm, covb4)

    black_litterman_factor_satistics!(
        port;
        # w;
        # Black Litterman
        B = B,
        P = P,
        P_f = P_f1,
        Q = Q / 252,
        Q_f = Q_f1 / 252,
        bl_type = :A,
        # delta = 1.0,
        # eq = true,
        # rf = 0.0,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    mub5, covb5, wb5 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        F = port.f_returns,
        B = Matrix(B[!, 2:end]),
        P = P,
        Q = Q / 252,
        P_f = P_f1,
        Q_f = Q_f1 / 252,
        constant = true,
    )
    @test isapprox(port.mu_bl_fm, mub5)
    @test isapprox(port.cov_bl_fm, covb5)

    black_litterman_factor_satistics!(
        port;
        # w;
        # Black Litterman
        B = loadings,
        P = P,
        P_f = P_f,
        Q = Q / 252,
        Q_f = Q_f / 252,
        bl_type = :A,
        # delta = 1.0,
        eq = false,
        rf = 0.001,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    mub6, covb6, w6 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        F = port.f_returns,
        B = Matrix(loadings[!, 2:end]),
        P = P,
        Q = Q / 252,
        P_f = P_f,
        Q_f = Q_f / 252,
        constant = false,
        eq = false,
        rf = 0.001,
    )
    @test isapprox(port.mu_bl_fm, mub6)
    @test isapprox(port.cov_bl_fm, covb6)

    black_litterman_factor_satistics!(
        port;
        # w;
        # Black Litterman
        B = loadings,
        P = P,
        P_f = P_f,
        Q = Q / 252,
        Q_f = Q_f / 252,
        bl_type = :A,
        delta = 3.0,
        eq = false,
        rf = 0.001,
        # # Loadings matrix
        # criterion = :pval,
        # diagonal = true,
    )
    mub7, covb7, w7 = augmented_black_litterman(
        port.returns,
        fill(1 / length(port.assets), length(port.assets));
        F = port.f_returns,
        B = Matrix(loadings[!, 2:end]),
        P = P,
        Q = Q / 252,
        P_f = P_f,
        Q_f = Q_f / 252,
        constant = false,
        eq = false,
        rf = 0.001,
        delta = 3.0,
    )
    @test isapprox(port.mu_bl_fm, mub7)
    @test isapprox(port.cov_bl_fm, covb7)
end

@testset "BL class optimisations" begin
    A = TimeArray(CSV.File("./assets/stock_prices.csv"), timestamp = :date)
    Y = percentchange(A)
    returns = dropmissing!(DataFrame(Y))

    portfolio = Portfolio(
        returns = returns,
        solvers = Dict(
            :Clarabel => Dict(
                :solver => (Clarabel.Optimizer),
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
        ),
    )
    asset_statistics!(portfolio, calc_kurt = false)

    w1 = opt_port!(portfolio, hist = 5)
    w2 = opt_port!(portfolio, class = :FM, hist = 1)
    @test isempty(w2)
    portfolio.mu_fm = portfolio.mu
    w3 = opt_port!(portfolio, class = :FM, hist = 2)
    @test isapprox(w1.weights, w3.weights)
    @test_throws AssertionError opt_port!(portfolio, class = :FM, hist = 3)

    portfolio.returns_fm = portfolio.returns
    portfolio.cov_fm = portfolio.cov
    w4 = opt_port!(portfolio, class = :FM, hist = 1)
    @test isapprox(w1.weights, w4.weights)
    w5 = opt_port!(portfolio, class = :FM, hist = 2)
    @test isapprox(w1.weights, w5.weights)

    portfolio = Portfolio(
        returns = returns,
        solvers = Dict(
            :Clarabel => Dict(
                :solver => (Clarabel.Optimizer),
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
        ),
    )
    asset_statistics!(portfolio, calc_kurt = false)

    w1 = opt_port!(portfolio, hist = 5)
    @test_throws DimensionMismatch opt_port!(portfolio, class = :BL, hist = 1)
    portfolio.mu_bl = portfolio.mu
    w3 = opt_port!(portfolio, class = :BL, hist = 2)
    @test isapprox(w1.weights, w3.weights)
    @test_throws AssertionError opt_port!(portfolio, class = :BL, hist = 3)

    portfolio.cov_bl = portfolio.cov
    w4 = opt_port!(portfolio, class = :BL, hist = 1)
    @test isapprox(w1.weights, w4.weights)
    w5 = opt_port!(portfolio, class = :BL, hist = 2)
    @test isapprox(w1.weights, w5.weights)

    portfolio = Portfolio(
        returns = returns,
        solvers = Dict(
            :Clarabel => Dict(
                :solver => (Clarabel.Optimizer),
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
        ),
    )
    asset_statistics!(portfolio, calc_kurt = false)

    w1 = opt_port!(portfolio, hist = 5)
    w2 = opt_port!(portfolio, class = :BL_FM, hist = 1)
    @test isempty(w2)
    portfolio.mu_bl_fm = portfolio.mu
    w3 = opt_port!(portfolio, class = :BL_FM, hist = 2)
    @test isapprox(w1.weights, w3.weights)
    @test_throws DimensionMismatch opt_port!(portfolio, class = :BL_FM, hist = 3)

    portfolio.cov_bl_fm = portfolio.cov
    portfolio.returns_fm = portfolio.returns
    w4 = opt_port!(portfolio, class = :BL_FM, hist = 1)
    @test isapprox(w1.weights, w4.weights)
    w5 = opt_port!(portfolio, class = :BL_FM, hist = 2)
    @test isapprox(w1.weights, w5.weights)
    @test_throws DimensionMismatch opt_port!(portfolio, class = :BL_FM, hist = 3)
    portfolio.cov_fm = portfolio.cov
    w6 = opt_port!(portfolio, class = :BL_FM, hist = 3)
    @test isapprox(w1.weights, w6.weights)
end
