using Test
using PortfolioOptimiser, DataFrames, CSV, Statistics

@testset "Black Litterman" begin
    df = CSV.read("./assets/stock_prices.csv", DataFrame)
    dropmissing!(df)
    returns = returns_from_prices(df[!, 2:end])

    mu = vec(ret_model(MRet(), Matrix(returns)))
    S = risk_matrix(Cov(), Matrix(returns))

    spy_prices = CSV.read("./assets/spy_prices.csv", DataFrame)
    delta = market_implied_risk_aversion(spy_prices[!, 2])
    deltatest = 2.685491066228311
    @test delta ≈ deltatest

    mcapsdf = DataFrame(
        ticker = names(df)[2:end],
        mcap = [
            927e9,
            1.19e12,
            574e9,
            533e9,
            867e9,
            96e9,
            43e9,
            339e9,
            301e9,
            51e9,
            61e9,
            78e9,
            0,
            295e9,
            1e9,
            22e9,
            288e9,
            212e9,
            422e9,
            102e9,
        ],
    )

    prior = market_implied_prior_returns(mcapsdf[!, 2], S, delta)
    priortest = [
        0.100018238563725
        0.095817277146265
        0.101974120071953
        0.103623740430225
        0.113305470289775
        0.064596564538619
        0.106300826264041
        0.052573811340803
        0.092296370665787
        0.073364357412511
        0.048205218070282
        0.095916237673261
        0.068649071964450
        0.062299939432165
        0.067232761782777
        0.067106130903036
        0.084316356398802
        0.058800474037087
        0.083208859167023
        0.071788977328806
    ]
    @test prior ≈ priortest

    # 1. SBUX drop by 20%
    # 2. GOOG outperforms FB by 10%
    # 3. BAC and JPM will outperform T and GE by 15%
    views = [-0.20, 0.10, 0.15]
    picking = hcat(
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, -0.5, 0, 0, 0.5, 0, -0.5, 0, 0, 0, 0, 0, 0, 0, 0.5, 0],
    )

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:equal`, or `:market`
        Q = views,
        P = picking,
    )
    testpost_ret = [
        0.058404059186963
        0.045896711623189
        0.007453320742957
        0.060355089645467
        0.041326156056687
        -0.000031349301321
        0.077691247532764
        0.011640256362282
        0.091419219703375
        0.030831889341423
        0.003819579599605
        0.012885885501672
        -0.005959314336322
        0.039596385262949
        0.049524436696886
        0.023233278987958
        0.035771855459317
        0.032196366540610
        0.070539152651673
        -0.059373291000260
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = [
        0.05334874453292 0.024902672047444 0.035820877126815 0.03003762293178 0.040239757633216 0.015753746209349 0.020901320606043 0.010599290285722 0.022969634599781 0.018184452941796 0.010240781936638 0.025973258402243 0.009064297749123 0.013538208101076 0.006210715239239 0.012688234416409 0.025017676973642 0.01496297568946 0.020016194441763 0.021040600912291
        0.024902672047444 0.05378655346829 0.027715737668323 0.024028034151111 0.027240121725497 0.014780532959058 0.033098711831861 0.011552819915695 0.023921951319338 0.019261317981843 0.010624375436169 0.023173090065358 0.018121979504474 0.014968035434157 0.013747654871833 0.018860638211729 0.023508873867951 0.012939357937947 0.02174053531735 0.018137037509882
        0.035820877126815 0.027715737668323 0.065315687317338 0.030317625879565 0.038957855421918 0.017024676408514 0.029722501289929 0.00980478073907 0.023954242508466 0.019314377339082 0.009908592917906 0.03499366030552 0.014762971727342 0.013323558842692 0.010996319122858 0.014300277970999 0.025812084646399 0.013774651234565 0.020627276954368 0.022289714337395
        0.03003762293178 0.024028034151111 0.030317625879565 0.101918357017587 0.033684859429564 0.016546732063455 0.051026767291063 0.008792539122271 0.024821010516939 0.02070838698998 0.007265433614312 0.028160522674305 0.025507344746638 0.014305718590147 0.024501686107163 0.019770838251757 0.025634708805639 0.013261994393431 0.021428453897999 0.0175104551891
        0.040239757633216 0.027240121725497 0.038957855421918 0.033684859429564 0.084186441326594 0.013102039631964 0.030683114990461 0.009329532359921 0.022338707473804 0.016723425860667 0.009469164201705 0.030239737474177 0.004868424300702 0.012996415834839 0.019688863589902 0.014462589996749 0.026523493457822 0.011781491403383 0.019067922153415 0.025290726153949
        0.015753746209349 0.014780532959058 0.017024676408514 0.016546732063455 0.013102039631964 0.045546322618926 0.024053819130086 0.009721114482515 0.025348180325503 0.022066907386658 0.013407954548335 0.027118500000968 0.029271861523519 0.017666148809851 0.025616703559727 0.01211576330532 0.016440745985032 0.014279107809269 0.023222340135006 0.015556744457971
        0.020901320606043 0.033098711831861 0.029722501289929 0.051026767291063 0.030683114990461 0.024053819130086 0.419435740109041 0.011477565295854 0.042579570395332 0.035219728639183 0.016410203945159 0.026858724945831 0.035576381829818 0.02279674386249 0.061254442712256 0.030485215262191 0.033182344528116 0.018843469973971 0.031989975975234 0.013556548739957
        0.010599290285722 0.011552819915695 0.00980478073907 0.008792539122271 0.009329532359921 0.009721114482515 0.011477565295854 0.041603952007734 0.010508522499114 0.012654353044667 0.010775500238374 0.016264694466671 0.02839435328056 0.008767439301597 0.005296035825415 0.014670575655231 0.011681472878172 0.011308790475922 0.011995716652398 0.012350793595876
        0.022969634599781 0.023921951319338 0.023954242508466 0.024821010516939 0.022338707473804 0.025348180325503 0.042579570395332 0.010508522499114 0.070059650164303 0.031932681675489 0.011914877668708 0.035953252498342 0.037689078480604 0.023206827652217 0.03438071083178 0.030032807360198 0.027858949081679 0.01968588510039 0.051021491390749 0.019709534765143
        0.018184452941796 0.019261317981843 0.019314377339082 0.02070838698998 0.016723425860667 0.022066907386658 0.035219728639183 0.012654353044667 0.031932681675489 0.061876666057302 0.012119544562166 0.032548730414819 0.037031741557304 0.016678576740828 0.026459306692323 0.025405843850092 0.01951833438857 0.015293548042868 0.027455167376016 0.017700258458998
        0.010240781936638 0.010624375436169 0.009908592917906 0.007265433614312 0.009469164201705 0.013407954548335 0.016410203945159 0.010775500238374 0.011914877668708 0.012119544562166 0.026795081644734 0.012420626767153 0.014970292581857 0.012347504980603 0.015922535723888 0.010251092702776 0.010843846272749 0.009480106941065 0.01309306276484 0.00914149735524
        0.025973258402243 0.023173090065358 0.03499366030552 0.028160522674305 0.030239737474177 0.027118500000968 0.026858724945831 0.016264694466671 0.035953252498342 0.032548730414819 0.012420626767153 0.179749910435694 0.058493054783132 0.019223964528325 0.033173828688863 0.034920875598853 0.023589018847215 0.017337377334031 0.030907137690852 0.027376522902746
        0.009064297749123 0.018121979504474 0.014762971727342 0.025507344746638 0.004868424300702 0.029271861523519 0.035576381829818 0.02839435328056 0.037689078480604 0.037031741557304 0.014970292581857 0.058493054783132 0.494697541906723 0.019898343296291 0.056376935787249 0.059452838044951 0.015111514351748 0.014180557030523 0.025439788469831 0.023979222437031
        0.013538208101076 0.014968035434157 0.013323558842692 0.014305718590147 0.012996415834839 0.017666148809851 0.02279674386249 0.008767439301597 0.023206827652217 0.016678576740828 0.012347504980603 0.019223964528325 0.019898343296291 0.036539546031524 0.039313250146948 0.012002339660102 0.016367538036895 0.013024216890089 0.022285558956566 0.010168475613478
        0.006210715239239 0.013747654871833 0.010996319122858 0.024501686107163 0.019688863589902 0.025616703559727 0.061254442712256 0.005296035825415 0.03438071083178 0.026459306692323 0.015922535723888 0.033173828688863 0.056376935787249 0.039313250146948 0.252892111331342 0.029103381607604 0.01702654624531 0.00955948287177 0.0295607068289 0.008895620469753
        0.012688234416409 0.018860638211729 0.014300277970999 0.019770838251757 0.014462589996749 0.01211576330532 0.030485215262191 0.014670575655231 0.030032807360198 0.025405843850092 0.010251092702776 0.034920875598853 0.059452838044951 0.012002339660102 0.029103381607604 0.128579631489709 0.018970727664979 0.012512528618383 0.02346950763889 0.019336816446419
        0.025017676973642 0.023508873867951 0.025812084646399 0.025634708805639 0.026523493457822 0.016440745985032 0.033182344528116 0.011681472878172 0.027858949081679 0.01951833438857 0.010843846272749 0.023589018847215 0.015111514351748 0.016367538036895 0.01702654624531 0.018970727664979 0.041281485121884 0.015560942620389 0.024957639540371 0.019587608239884
        0.01496297568946 0.012939357937947 0.013774651234565 0.013261994393431 0.011781491403383 0.014279107809269 0.018843469973971 0.011308790475922 0.01968588510039 0.015293548042868 0.009480106941065 0.017337377334031 0.014180557030523 0.013024216890089 0.00955948287177 0.012512528618383 0.015560942620389 0.031037346425707 0.018369433119826 0.011288056098657
        0.020016194441763 0.02174053531735 0.020627276954368 0.021428453897999 0.019067922153415 0.023222340135006 0.031989975975234 0.011995716652398 0.051021491390749 0.027455167376016 0.01309306276484 0.030907137690852 0.025439788469831 0.022285558956566 0.0295607068289 0.02346950763889 0.024957639540371 0.018369433119826 0.046919986197744 0.01794461920481
        0.021040600912291 0.018137037509882 0.022289714337395 0.0175104551891 0.025290726153949 0.015556744457971 0.013556548739957 0.012350793595876 0.019709534765143 0.017700258458998 0.00914149735524 0.027376522902746 0.023979222437031 0.010168475613478 0.008895620469753 0.019336816446419 0.019587608239884 0.011288056098657 0.01794461920481 0.039986416856178
    ]
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        2.802634574339719,
        1.0696569899116537,
        -1.5225894339745898,
        0.5221972605398294,
        0.7399073537664403,
        -1.3989450429613053,
        0.00932451280100568,
        0.6505588964261255,
        1.8362707796803164,
        0.09084468616612303,
        -0.8183433897385306,
        0.0075712114558542905,
        -0.024199601308436784,
        0.6270484617832653,
        0.002865041743474888,
        0.08532234626520806,
        0.27339562941444895,
        0.7122779313389186,
        1.7936495956277718,
        -6.459447803277293,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest = 1.0093606663118133, 1.405512109425161, 0.7039147223828978
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(mcapsdf[!, 1], S; rf = 0, tau = 0.01, Q = views, P = picking)
    testpost_ret = [
        -0.020830526939649,
        -0.031015053178948,
        -0.072163030613922,
        -0.024603378927613,
        -0.047074290570558,
        -0.052593753584965,
        -0.011573284998936,
        -0.029853302581122,
        0.028940053197696,
        -0.023279044028087,
        -0.038689702120485,
        -0.054944226494396,
        -0.050783791594354,
        -0.011499423908914,
        -0.006534148187139,
        -0.022294481371801,
        -0.027596053560504,
        -0.014608054178002,
        0.012267692276885,
        -0.094287655854972,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.05334874453292,
            0.024902672047444,
            0.035820877126815,
            0.03003762293178,
            0.040239757633216,
            0.015753746209349,
            0.020901320606043,
            0.010599290285722,
            0.022969634599781,
            0.018184452941796,
            0.010240781936638,
            0.025973258402243,
            0.009064297749123,
            0.013538208101076,
            0.006210715239239,
            0.012688234416409,
            0.025017676973642,
            0.01496297568946,
            0.020016194441763,
            0.021040600912291,
            0.024902672047444,
            0.05378655346829,
            0.027715737668323,
            0.024028034151111,
            0.027240121725497,
            0.014780532959058,
            0.033098711831861,
            0.011552819915695,
            0.023921951319338,
            0.019261317981843,
            0.010624375436169,
            0.023173090065358,
            0.018121979504474,
            0.014968035434157,
            0.013747654871833,
            0.018860638211729,
            0.023508873867951,
            0.012939357937947,
            0.02174053531735,
            0.018137037509882,
            0.035820877126815,
            0.027715737668323,
            0.065315687317338,
            0.030317625879565,
            0.038957855421918,
            0.017024676408514,
            0.029722501289929,
            0.00980478073907,
            0.023954242508466,
            0.019314377339082,
            0.009908592917906,
            0.03499366030552,
            0.014762971727342,
            0.013323558842692,
            0.010996319122858,
            0.014300277970999,
            0.025812084646399,
            0.013774651234565,
            0.020627276954368,
            0.022289714337395,
            0.03003762293178,
            0.024028034151111,
            0.030317625879565,
            0.101918357017587,
            0.033684859429564,
            0.016546732063455,
            0.051026767291063,
            0.008792539122271,
            0.024821010516939,
            0.02070838698998,
            0.007265433614312,
            0.028160522674305,
            0.025507344746638,
            0.014305718590147,
            0.024501686107163,
            0.019770838251757,
            0.025634708805639,
            0.013261994393431,
            0.021428453897999,
            0.0175104551891,
            0.040239757633216,
            0.027240121725497,
            0.038957855421918,
            0.033684859429564,
            0.084186441326594,
            0.013102039631964,
            0.030683114990461,
            0.009329532359921,
            0.022338707473804,
            0.016723425860667,
            0.009469164201705,
            0.030239737474177,
            0.004868424300702,
            0.012996415834839,
            0.019688863589902,
            0.014462589996749,
            0.026523493457822,
            0.011781491403383,
            0.019067922153415,
            0.025290726153949,
            0.015753746209349,
            0.014780532959058,
            0.017024676408514,
            0.016546732063455,
            0.013102039631964,
            0.045546322618926,
            0.024053819130086,
            0.009721114482515,
            0.025348180325503,
            0.022066907386658,
            0.013407954548335,
            0.027118500000968,
            0.029271861523519,
            0.017666148809851,
            0.025616703559727,
            0.01211576330532,
            0.016440745985032,
            0.014279107809269,
            0.023222340135006,
            0.015556744457971,
            0.020901320606043,
            0.033098711831861,
            0.029722501289929,
            0.051026767291063,
            0.030683114990461,
            0.024053819130086,
            0.419435740109041,
            0.011477565295854,
            0.042579570395332,
            0.035219728639183,
            0.016410203945159,
            0.026858724945831,
            0.035576381829818,
            0.02279674386249,
            0.061254442712256,
            0.030485215262191,
            0.033182344528116,
            0.018843469973971,
            0.031989975975234,
            0.013556548739957,
            0.010599290285722,
            0.011552819915695,
            0.00980478073907,
            0.008792539122271,
            0.009329532359921,
            0.009721114482515,
            0.011477565295854,
            0.041603952007734,
            0.010508522499114,
            0.012654353044667,
            0.010775500238374,
            0.016264694466671,
            0.02839435328056,
            0.008767439301597,
            0.005296035825415,
            0.014670575655231,
            0.011681472878172,
            0.011308790475922,
            0.011995716652398,
            0.012350793595876,
            0.022969634599781,
            0.023921951319338,
            0.023954242508466,
            0.024821010516939,
            0.022338707473804,
            0.025348180325503,
            0.042579570395332,
            0.010508522499114,
            0.070059650164303,
            0.031932681675489,
            0.011914877668708,
            0.035953252498342,
            0.037689078480604,
            0.023206827652217,
            0.03438071083178,
            0.030032807360198,
            0.027858949081679,
            0.01968588510039,
            0.051021491390749,
            0.019709534765143,
            0.018184452941796,
            0.019261317981843,
            0.019314377339082,
            0.02070838698998,
            0.016723425860667,
            0.022066907386658,
            0.035219728639183,
            0.012654353044667,
            0.031932681675489,
            0.061876666057302,
            0.012119544562166,
            0.032548730414819,
            0.037031741557304,
            0.016678576740828,
            0.026459306692323,
            0.025405843850092,
            0.01951833438857,
            0.015293548042868,
            0.027455167376016,
            0.017700258458998,
            0.010240781936638,
            0.010624375436169,
            0.009908592917906,
            0.007265433614312,
            0.009469164201705,
            0.013407954548335,
            0.016410203945159,
            0.010775500238374,
            0.011914877668708,
            0.012119544562166,
            0.026795081644734,
            0.012420626767153,
            0.014970292581857,
            0.012347504980603,
            0.015922535723888,
            0.010251092702776,
            0.010843846272749,
            0.009480106941065,
            0.01309306276484,
            0.00914149735524,
            0.025973258402243,
            0.023173090065358,
            0.03499366030552,
            0.028160522674305,
            0.030239737474177,
            0.027118500000968,
            0.026858724945831,
            0.016264694466671,
            0.035953252498342,
            0.032548730414819,
            0.012420626767153,
            0.179749910435694,
            0.058493054783132,
            0.019223964528325,
            0.033173828688863,
            0.034920875598853,
            0.023589018847215,
            0.017337377334031,
            0.030907137690852,
            0.027376522902746,
            0.009064297749123,
            0.018121979504474,
            0.014762971727342,
            0.025507344746638,
            0.004868424300702,
            0.029271861523519,
            0.035576381829818,
            0.02839435328056,
            0.037689078480604,
            0.037031741557304,
            0.014970292581857,
            0.058493054783132,
            0.494697541906723,
            0.019898343296291,
            0.056376935787249,
            0.059452838044951,
            0.015111514351748,
            0.014180557030523,
            0.025439788469831,
            0.023979222437031,
            0.013538208101076,
            0.014968035434157,
            0.013323558842692,
            0.014305718590147,
            0.012996415834839,
            0.017666148809851,
            0.02279674386249,
            0.008767439301597,
            0.023206827652217,
            0.016678576740828,
            0.012347504980603,
            0.019223964528325,
            0.019898343296291,
            0.036539546031524,
            0.039313250146948,
            0.012002339660102,
            0.016367538036895,
            0.013024216890089,
            0.022285558956566,
            0.010168475613478,
            0.006210715239239,
            0.013747654871833,
            0.010996319122858,
            0.024501686107163,
            0.019688863589902,
            0.025616703559727,
            0.061254442712256,
            0.005296035825415,
            0.03438071083178,
            0.026459306692323,
            0.015922535723888,
            0.033173828688863,
            0.056376935787249,
            0.039313250146948,
            0.252892111331342,
            0.029103381607604,
            0.01702654624531,
            0.00955948287177,
            0.0295607068289,
            0.008895620469753,
            0.012688234416409,
            0.018860638211729,
            0.014300277970999,
            0.019770838251757,
            0.014462589996749,
            0.01211576330532,
            0.030485215262191,
            0.014670575655231,
            0.030032807360198,
            0.025405843850092,
            0.010251092702776,
            0.034920875598853,
            0.059452838044951,
            0.012002339660102,
            0.029103381607604,
            0.128579631489709,
            0.018970727664979,
            0.012512528618383,
            0.02346950763889,
            0.019336816446419,
            0.025017676973642,
            0.023508873867951,
            0.025812084646399,
            0.025634708805639,
            0.026523493457822,
            0.016440745985032,
            0.033182344528116,
            0.011681472878172,
            0.027858949081679,
            0.01951833438857,
            0.010843846272749,
            0.023589018847215,
            0.015111514351748,
            0.016367538036895,
            0.01702654624531,
            0.018970727664979,
            0.041281485121884,
            0.015560942620389,
            0.024957639540371,
            0.019587608239884,
            0.01496297568946,
            0.012939357937947,
            0.013774651234565,
            0.013261994393431,
            0.011781491403383,
            0.014279107809269,
            0.018843469973971,
            0.011308790475922,
            0.01968588510039,
            0.015293548042868,
            0.009480106941065,
            0.017337377334031,
            0.014180557030523,
            0.013024216890089,
            0.00955948287177,
            0.012512528618383,
            0.015560942620389,
            0.031037346425707,
            0.018369433119826,
            0.011288056098657,
            0.020016194441763,
            0.02174053531735,
            0.020627276954368,
            0.021428453897999,
            0.019067922153415,
            0.023222340135006,
            0.031989975975234,
            0.011995716652398,
            0.051021491390749,
            0.027455167376016,
            0.01309306276484,
            0.030907137690852,
            0.025439788469831,
            0.022285558956566,
            0.0295607068289,
            0.02346950763889,
            0.024957639540371,
            0.018369433119826,
            0.046919986197744,
            0.01794461920481,
            0.021040600912291,
            0.018137037509882,
            0.022289714337395,
            0.0175104551891,
            0.025290726153949,
            0.015556744457971,
            0.013556548739957,
            0.012350793595876,
            0.019709534765143,
            0.017700258458998,
            0.00914149735524,
            0.027376522902746,
            0.023979222437031,
            0.010168475613478,
            0.008895620469753,
            0.019336816446419,
            0.019587608239884,
            0.011288056098657,
            0.01794461920481,
            0.039986416856178,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.39150004402872096,
        4.6895436760156055e-17,
        0.39150004402872096,
        5.5357767191555675e-18,
        -1.6804894098435003e-17,
        0.3704847078591793,
        -3.291491816172276e-18,
        -4.3716925134921596e-17,
        -0.37048470785917914,
        -3.535974243476658e-17,
        0.3704847078591794,
        2.5582596145939483e-17,
        -1.1945455638290133e-17,
        -2.5604273389586943e-17,
        -7.033736113034615e-18,
        2.7239824302241563e-17,
        1.9771585259870072e-17,
        7.167596687923214e-17,
        -0.3704847078591795,
        1.0,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest = -0.1634702972666502, 0.24870800299247436, -0.737693580661342
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = :market, # either a vector, `nothing`, `:equal`, or `:market`
        market_caps = mcapsdf[!, 2],
        Q = views,
        P = picking,
    )
    testpost_ret = [
        0.003159709618849,
        -0.008198179020157,
        -0.047973127241007,
        0.001146509165171,
        -0.019298956843574,
        -0.038975395634745,
        0.015357849340789,
        -0.020698432886203,
        0.046307334847981,
        -0.009008922543199,
        -0.029397051577061,
        -0.034675794405371,
        -0.039366481896771,
        0.000978169150907,
        0.007641576415112,
        -0.011088705297456,
        -0.009702793037667,
        -0.003618163606929,
        0.027981726053541,
        -0.085034119105279,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.05334874453292,
            0.024902672047444,
            0.035820877126815,
            0.03003762293178,
            0.040239757633216,
            0.015753746209349,
            0.020901320606043,
            0.010599290285722,
            0.022969634599781,
            0.018184452941796,
            0.010240781936638,
            0.025973258402243,
            0.009064297749123,
            0.013538208101076,
            0.006210715239239,
            0.012688234416409,
            0.025017676973642,
            0.01496297568946,
            0.020016194441763,
            0.021040600912291,
            0.024902672047444,
            0.05378655346829,
            0.027715737668323,
            0.024028034151111,
            0.027240121725497,
            0.014780532959058,
            0.033098711831861,
            0.011552819915695,
            0.023921951319338,
            0.019261317981843,
            0.010624375436169,
            0.023173090065358,
            0.018121979504474,
            0.014968035434157,
            0.013747654871833,
            0.018860638211729,
            0.023508873867951,
            0.012939357937947,
            0.02174053531735,
            0.018137037509882,
            0.035820877126815,
            0.027715737668323,
            0.065315687317338,
            0.030317625879565,
            0.038957855421918,
            0.017024676408514,
            0.029722501289929,
            0.00980478073907,
            0.023954242508466,
            0.019314377339082,
            0.009908592917906,
            0.03499366030552,
            0.014762971727342,
            0.013323558842692,
            0.010996319122858,
            0.014300277970999,
            0.025812084646399,
            0.013774651234565,
            0.020627276954368,
            0.022289714337395,
            0.03003762293178,
            0.024028034151111,
            0.030317625879565,
            0.101918357017587,
            0.033684859429564,
            0.016546732063455,
            0.051026767291063,
            0.008792539122271,
            0.024821010516939,
            0.02070838698998,
            0.007265433614312,
            0.028160522674305,
            0.025507344746638,
            0.014305718590147,
            0.024501686107163,
            0.019770838251757,
            0.025634708805639,
            0.013261994393431,
            0.021428453897999,
            0.0175104551891,
            0.040239757633216,
            0.027240121725497,
            0.038957855421918,
            0.033684859429564,
            0.084186441326594,
            0.013102039631964,
            0.030683114990461,
            0.009329532359921,
            0.022338707473804,
            0.016723425860667,
            0.009469164201705,
            0.030239737474177,
            0.004868424300702,
            0.012996415834839,
            0.019688863589902,
            0.014462589996749,
            0.026523493457822,
            0.011781491403383,
            0.019067922153415,
            0.025290726153949,
            0.015753746209349,
            0.014780532959058,
            0.017024676408514,
            0.016546732063455,
            0.013102039631964,
            0.045546322618926,
            0.024053819130086,
            0.009721114482515,
            0.025348180325503,
            0.022066907386658,
            0.013407954548335,
            0.027118500000968,
            0.029271861523519,
            0.017666148809851,
            0.025616703559727,
            0.01211576330532,
            0.016440745985032,
            0.014279107809269,
            0.023222340135006,
            0.015556744457971,
            0.020901320606043,
            0.033098711831861,
            0.029722501289929,
            0.051026767291063,
            0.030683114990461,
            0.024053819130086,
            0.419435740109041,
            0.011477565295854,
            0.042579570395332,
            0.035219728639183,
            0.016410203945159,
            0.026858724945831,
            0.035576381829818,
            0.02279674386249,
            0.061254442712256,
            0.030485215262191,
            0.033182344528116,
            0.018843469973971,
            0.031989975975234,
            0.013556548739957,
            0.010599290285722,
            0.011552819915695,
            0.00980478073907,
            0.008792539122271,
            0.009329532359921,
            0.009721114482515,
            0.011477565295854,
            0.041603952007734,
            0.010508522499114,
            0.012654353044667,
            0.010775500238374,
            0.016264694466671,
            0.02839435328056,
            0.008767439301597,
            0.005296035825415,
            0.014670575655231,
            0.011681472878172,
            0.011308790475922,
            0.011995716652398,
            0.012350793595876,
            0.022969634599781,
            0.023921951319338,
            0.023954242508466,
            0.024821010516939,
            0.022338707473804,
            0.025348180325503,
            0.042579570395332,
            0.010508522499114,
            0.070059650164303,
            0.031932681675489,
            0.011914877668708,
            0.035953252498342,
            0.037689078480604,
            0.023206827652217,
            0.03438071083178,
            0.030032807360198,
            0.027858949081679,
            0.01968588510039,
            0.051021491390749,
            0.019709534765143,
            0.018184452941796,
            0.019261317981843,
            0.019314377339082,
            0.02070838698998,
            0.016723425860667,
            0.022066907386658,
            0.035219728639183,
            0.012654353044667,
            0.031932681675489,
            0.061876666057302,
            0.012119544562166,
            0.032548730414819,
            0.037031741557304,
            0.016678576740828,
            0.026459306692323,
            0.025405843850092,
            0.01951833438857,
            0.015293548042868,
            0.027455167376016,
            0.017700258458998,
            0.010240781936638,
            0.010624375436169,
            0.009908592917906,
            0.007265433614312,
            0.009469164201705,
            0.013407954548335,
            0.016410203945159,
            0.010775500238374,
            0.011914877668708,
            0.012119544562166,
            0.026795081644734,
            0.012420626767153,
            0.014970292581857,
            0.012347504980603,
            0.015922535723888,
            0.010251092702776,
            0.010843846272749,
            0.009480106941065,
            0.01309306276484,
            0.00914149735524,
            0.025973258402243,
            0.023173090065358,
            0.03499366030552,
            0.028160522674305,
            0.030239737474177,
            0.027118500000968,
            0.026858724945831,
            0.016264694466671,
            0.035953252498342,
            0.032548730414819,
            0.012420626767153,
            0.179749910435694,
            0.058493054783132,
            0.019223964528325,
            0.033173828688863,
            0.034920875598853,
            0.023589018847215,
            0.017337377334031,
            0.030907137690852,
            0.027376522902746,
            0.009064297749123,
            0.018121979504474,
            0.014762971727342,
            0.025507344746638,
            0.004868424300702,
            0.029271861523519,
            0.035576381829818,
            0.02839435328056,
            0.037689078480604,
            0.037031741557304,
            0.014970292581857,
            0.058493054783132,
            0.494697541906723,
            0.019898343296291,
            0.056376935787249,
            0.059452838044951,
            0.015111514351748,
            0.014180557030523,
            0.025439788469831,
            0.023979222437031,
            0.013538208101076,
            0.014968035434157,
            0.013323558842692,
            0.014305718590147,
            0.012996415834839,
            0.017666148809851,
            0.02279674386249,
            0.008767439301597,
            0.023206827652217,
            0.016678576740828,
            0.012347504980603,
            0.019223964528325,
            0.019898343296291,
            0.036539546031524,
            0.039313250146948,
            0.012002339660102,
            0.016367538036895,
            0.013024216890089,
            0.022285558956566,
            0.010168475613478,
            0.006210715239239,
            0.013747654871833,
            0.010996319122858,
            0.024501686107163,
            0.019688863589902,
            0.025616703559727,
            0.061254442712256,
            0.005296035825415,
            0.03438071083178,
            0.026459306692323,
            0.015922535723888,
            0.033173828688863,
            0.056376935787249,
            0.039313250146948,
            0.252892111331342,
            0.029103381607604,
            0.01702654624531,
            0.00955948287177,
            0.0295607068289,
            0.008895620469753,
            0.012688234416409,
            0.018860638211729,
            0.014300277970999,
            0.019770838251757,
            0.014462589996749,
            0.01211576330532,
            0.030485215262191,
            0.014670575655231,
            0.030032807360198,
            0.025405843850092,
            0.010251092702776,
            0.034920875598853,
            0.059452838044951,
            0.012002339660102,
            0.029103381607604,
            0.128579631489709,
            0.018970727664979,
            0.012512528618383,
            0.02346950763889,
            0.019336816446419,
            0.025017676973642,
            0.023508873867951,
            0.025812084646399,
            0.025634708805639,
            0.026523493457822,
            0.016440745985032,
            0.033182344528116,
            0.011681472878172,
            0.027858949081679,
            0.01951833438857,
            0.010843846272749,
            0.023589018847215,
            0.015111514351748,
            0.016367538036895,
            0.01702654624531,
            0.018970727664979,
            0.041281485121884,
            0.015560942620389,
            0.024957639540371,
            0.019587608239884,
            0.01496297568946,
            0.012939357937947,
            0.013774651234565,
            0.013261994393431,
            0.011781491403383,
            0.014279107809269,
            0.018843469973971,
            0.011308790475922,
            0.01968588510039,
            0.015293548042868,
            0.009480106941065,
            0.017337377334031,
            0.014180557030523,
            0.013024216890089,
            0.00955948287177,
            0.012512528618383,
            0.015560942620389,
            0.031037346425707,
            0.018369433119826,
            0.011288056098657,
            0.020016194441763,
            0.02174053531735,
            0.020627276954368,
            0.021428453897999,
            0.019067922153415,
            0.023222340135006,
            0.031989975975234,
            0.011995716652398,
            0.051021491390749,
            0.027455167376016,
            0.01309306276484,
            0.030907137690852,
            0.025439788469831,
            0.022285558956566,
            0.0295607068289,
            0.02346950763889,
            0.024957639540371,
            0.018369433119826,
            0.046919986197744,
            0.01794461920481,
            0.021040600912291,
            0.018137037509882,
            0.022289714337395,
            0.0175104551891,
            0.025290726153949,
            0.015556744457971,
            0.013556548739957,
            0.012350793595876,
            0.019709534765143,
            0.017700258458998,
            0.00914149735524,
            0.027376522902746,
            0.023979222437031,
            0.010168475613478,
            0.008895620469753,
            0.019336816446419,
            0.019587608239884,
            0.011288056098657,
            0.01794461920481,
            0.039986416856178,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.6294139094485687,
        -0.09837977027829774,
        0.5053231235765305,
        -0.044064216435573664,
        -0.07167668977418844,
        0.48139995581445977,
        -0.003554899262156977,
        -0.028025833717935343,
        -0.5142207699325133,
        -0.004216275869069968,
        0.4842934784697037,
        -0.006448421917401054,
        -1.2305559159888653e-17,
        -0.024388262379914153,
        -8.267207586413058e-05,
        -0.001818785669010557,
        -0.023809557848865275,
        -0.01752648008319239,
        -0.5242240911120722,
        1.5208340779439298,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest =
        -0.22381742715934094, 0.3451253556188572, -0.7064604880222224
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = :equal, # either a vector, `nothing`, `:equal`, or `:market`
        Q = views,
        P = picking,
    )
    testpost_ret = [
        0.016192023490508,
        0.008078079544674,
        -0.035526575723945,
        0.014915056431211,
        -0.012549200465761,
        -0.012617689405891,
        0.030779744648498,
        0.012417292831914,
        0.068538770170616,
        0.016192579991541,
        0.005195177139875,
        -0.021445679758055,
        -0.015375306432324,
        0.032468937295293,
        0.038440359581279,
        0.016292390683074,
        0.01069324078961,
        0.028619865249918,
        0.052446599909811,
        -0.069127469398986,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.05334874453292,
            0.024902672047444,
            0.035820877126815,
            0.03003762293178,
            0.040239757633216,
            0.015753746209349,
            0.020901320606043,
            0.010599290285722,
            0.022969634599781,
            0.018184452941796,
            0.010240781936638,
            0.025973258402243,
            0.009064297749123,
            0.013538208101076,
            0.006210715239239,
            0.012688234416409,
            0.025017676973642,
            0.01496297568946,
            0.020016194441763,
            0.021040600912291,
            0.024902672047444,
            0.05378655346829,
            0.027715737668323,
            0.024028034151111,
            0.027240121725497,
            0.014780532959058,
            0.033098711831861,
            0.011552819915695,
            0.023921951319338,
            0.019261317981843,
            0.010624375436169,
            0.023173090065358,
            0.018121979504474,
            0.014968035434157,
            0.013747654871833,
            0.018860638211729,
            0.023508873867951,
            0.012939357937947,
            0.02174053531735,
            0.018137037509882,
            0.035820877126815,
            0.027715737668323,
            0.065315687317338,
            0.030317625879565,
            0.038957855421918,
            0.017024676408514,
            0.029722501289929,
            0.00980478073907,
            0.023954242508466,
            0.019314377339082,
            0.009908592917906,
            0.03499366030552,
            0.014762971727342,
            0.013323558842692,
            0.010996319122858,
            0.014300277970999,
            0.025812084646399,
            0.013774651234565,
            0.020627276954368,
            0.022289714337395,
            0.03003762293178,
            0.024028034151111,
            0.030317625879565,
            0.101918357017587,
            0.033684859429564,
            0.016546732063455,
            0.051026767291063,
            0.008792539122271,
            0.024821010516939,
            0.02070838698998,
            0.007265433614312,
            0.028160522674305,
            0.025507344746638,
            0.014305718590147,
            0.024501686107163,
            0.019770838251757,
            0.025634708805639,
            0.013261994393431,
            0.021428453897999,
            0.0175104551891,
            0.040239757633216,
            0.027240121725497,
            0.038957855421918,
            0.033684859429564,
            0.084186441326594,
            0.013102039631964,
            0.030683114990461,
            0.009329532359921,
            0.022338707473804,
            0.016723425860667,
            0.009469164201705,
            0.030239737474177,
            0.004868424300702,
            0.012996415834839,
            0.019688863589902,
            0.014462589996749,
            0.026523493457822,
            0.011781491403383,
            0.019067922153415,
            0.025290726153949,
            0.015753746209349,
            0.014780532959058,
            0.017024676408514,
            0.016546732063455,
            0.013102039631964,
            0.045546322618926,
            0.024053819130086,
            0.009721114482515,
            0.025348180325503,
            0.022066907386658,
            0.013407954548335,
            0.027118500000968,
            0.029271861523519,
            0.017666148809851,
            0.025616703559727,
            0.01211576330532,
            0.016440745985032,
            0.014279107809269,
            0.023222340135006,
            0.015556744457971,
            0.020901320606043,
            0.033098711831861,
            0.029722501289929,
            0.051026767291063,
            0.030683114990461,
            0.024053819130086,
            0.419435740109041,
            0.011477565295854,
            0.042579570395332,
            0.035219728639183,
            0.016410203945159,
            0.026858724945831,
            0.035576381829818,
            0.02279674386249,
            0.061254442712256,
            0.030485215262191,
            0.033182344528116,
            0.018843469973971,
            0.031989975975234,
            0.013556548739957,
            0.010599290285722,
            0.011552819915695,
            0.00980478073907,
            0.008792539122271,
            0.009329532359921,
            0.009721114482515,
            0.011477565295854,
            0.041603952007734,
            0.010508522499114,
            0.012654353044667,
            0.010775500238374,
            0.016264694466671,
            0.02839435328056,
            0.008767439301597,
            0.005296035825415,
            0.014670575655231,
            0.011681472878172,
            0.011308790475922,
            0.011995716652398,
            0.012350793595876,
            0.022969634599781,
            0.023921951319338,
            0.023954242508466,
            0.024821010516939,
            0.022338707473804,
            0.025348180325503,
            0.042579570395332,
            0.010508522499114,
            0.070059650164303,
            0.031932681675489,
            0.011914877668708,
            0.035953252498342,
            0.037689078480604,
            0.023206827652217,
            0.03438071083178,
            0.030032807360198,
            0.027858949081679,
            0.01968588510039,
            0.051021491390749,
            0.019709534765143,
            0.018184452941796,
            0.019261317981843,
            0.019314377339082,
            0.02070838698998,
            0.016723425860667,
            0.022066907386658,
            0.035219728639183,
            0.012654353044667,
            0.031932681675489,
            0.061876666057302,
            0.012119544562166,
            0.032548730414819,
            0.037031741557304,
            0.016678576740828,
            0.026459306692323,
            0.025405843850092,
            0.01951833438857,
            0.015293548042868,
            0.027455167376016,
            0.017700258458998,
            0.010240781936638,
            0.010624375436169,
            0.009908592917906,
            0.007265433614312,
            0.009469164201705,
            0.013407954548335,
            0.016410203945159,
            0.010775500238374,
            0.011914877668708,
            0.012119544562166,
            0.026795081644734,
            0.012420626767153,
            0.014970292581857,
            0.012347504980603,
            0.015922535723888,
            0.010251092702776,
            0.010843846272749,
            0.009480106941065,
            0.01309306276484,
            0.00914149735524,
            0.025973258402243,
            0.023173090065358,
            0.03499366030552,
            0.028160522674305,
            0.030239737474177,
            0.027118500000968,
            0.026858724945831,
            0.016264694466671,
            0.035953252498342,
            0.032548730414819,
            0.012420626767153,
            0.179749910435694,
            0.058493054783132,
            0.019223964528325,
            0.033173828688863,
            0.034920875598853,
            0.023589018847215,
            0.017337377334031,
            0.030907137690852,
            0.027376522902746,
            0.009064297749123,
            0.018121979504474,
            0.014762971727342,
            0.025507344746638,
            0.004868424300702,
            0.029271861523519,
            0.035576381829818,
            0.02839435328056,
            0.037689078480604,
            0.037031741557304,
            0.014970292581857,
            0.058493054783132,
            0.494697541906723,
            0.019898343296291,
            0.056376935787249,
            0.059452838044951,
            0.015111514351748,
            0.014180557030523,
            0.025439788469831,
            0.023979222437031,
            0.013538208101076,
            0.014968035434157,
            0.013323558842692,
            0.014305718590147,
            0.012996415834839,
            0.017666148809851,
            0.02279674386249,
            0.008767439301597,
            0.023206827652217,
            0.016678576740828,
            0.012347504980603,
            0.019223964528325,
            0.019898343296291,
            0.036539546031524,
            0.039313250146948,
            0.012002339660102,
            0.016367538036895,
            0.013024216890089,
            0.022285558956566,
            0.010168475613478,
            0.006210715239239,
            0.013747654871833,
            0.010996319122858,
            0.024501686107163,
            0.019688863589902,
            0.025616703559727,
            0.061254442712256,
            0.005296035825415,
            0.03438071083178,
            0.026459306692323,
            0.015922535723888,
            0.033173828688863,
            0.056376935787249,
            0.039313250146948,
            0.252892111331342,
            0.029103381607604,
            0.01702654624531,
            0.00955948287177,
            0.0295607068289,
            0.008895620469753,
            0.012688234416409,
            0.018860638211729,
            0.014300277970999,
            0.019770838251757,
            0.014462589996749,
            0.01211576330532,
            0.030485215262191,
            0.014670575655231,
            0.030032807360198,
            0.025405843850092,
            0.010251092702776,
            0.034920875598853,
            0.059452838044951,
            0.012002339660102,
            0.029103381607604,
            0.128579631489709,
            0.018970727664979,
            0.012512528618383,
            0.02346950763889,
            0.019336816446419,
            0.025017676973642,
            0.023508873867951,
            0.025812084646399,
            0.025634708805639,
            0.026523493457822,
            0.016440745985032,
            0.033182344528116,
            0.011681472878172,
            0.027858949081679,
            0.01951833438857,
            0.010843846272749,
            0.023589018847215,
            0.015111514351748,
            0.016367538036895,
            0.01702654624531,
            0.018970727664979,
            0.041281485121884,
            0.015560942620389,
            0.024957639540371,
            0.019587608239884,
            0.01496297568946,
            0.012939357937947,
            0.013774651234565,
            0.013261994393431,
            0.011781491403383,
            0.014279107809269,
            0.018843469973971,
            0.011308790475922,
            0.01968588510039,
            0.015293548042868,
            0.009480106941065,
            0.017337377334031,
            0.014180557030523,
            0.013024216890089,
            0.00955948287177,
            0.012512528618383,
            0.015560942620389,
            0.031037346425707,
            0.018369433119826,
            0.011288056098657,
            0.020016194441763,
            0.02174053531735,
            0.020627276954368,
            0.021428453897999,
            0.019067922153415,
            0.023222340135006,
            0.031989975975234,
            0.011995716652398,
            0.051021491390749,
            0.027455167376016,
            0.01309306276484,
            0.030907137690852,
            0.025439788469831,
            0.022285558956566,
            0.0295607068289,
            0.02346950763889,
            0.024957639540371,
            0.018369433119826,
            0.046919986197744,
            0.01794461920481,
            0.021040600912291,
            0.018137037509882,
            0.022289714337395,
            0.0175104551891,
            0.025290726153949,
            0.015556744457971,
            0.013556548739957,
            0.012350793595876,
            0.019709534765143,
            0.017700258458998,
            0.00914149735524,
            0.027376522902746,
            0.023979222437031,
            0.010168475613478,
            0.008895620469753,
            0.019336816446419,
            0.019587608239884,
            0.011288056098657,
            0.01794461920481,
            0.039986416856178,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        8.754664998496072,
        1.0732578926250225,
        -8.146850880828588,
        0.9455529695359096,
        0.35684387807620915,
        -6.916912407717437,
        -0.2775240638458601,
        4.035813523265117,
        8.142914952354905,
        0.5313680726647304,
        -0.3470878250829728,
        -0.6041848156310756,
        -0.2610045880233343,
        4.169128323738159,
        0.02210801019603272,
        0.7268002248416386,
        0.4163589038618726,
        5.818178434078446,
        6.619286979429875,
        -24.058712582034723,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest = 3.489507035125494, 5.426654465092965, 0.639345485776393
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:equal`, or `:market`
        Q = views,
        P = picking,
        omega = :idzorek,
        view_confidence = ones(length(views)),
    )
    testpost_ret = [
        0.013244409305835,
        -0.003862569869929,
        -0.086755590694165,
        0.017883535855483,
        -0.033667602107403,
        -0.072841404411129,
        0.055401879433333,
        -0.032909672787738,
        0.108841692163082,
        -0.010074729322361,
        -0.04816087126435,
        -0.070450930614597,
        -0.082521192117745,
        0.018048332665877,
        0.035883001205855,
        -0.017763252145557,
        -0.011710954813223,
        0.005937523530032,
        0.070156032161439,
        -0.2,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.053256543534734,
            0.02485717955359,
            0.035817619714355,
            0.029988307958865,
            0.040168108898735,
            0.015718391524181,
            0.020876469348865,
            0.010565499901285,
            0.022902978091904,
            0.018135729311071,
            0.010219823816128,
            0.025914655077702,
            0.00900971729413,
            0.013508308774706,
            0.00619243513112,
            0.012634980171098,
            0.024963364434361,
            0.014928533869611,
            0.019958071938655,
            0.020937329618582,
            0.02485717955359,
            0.05374167993442,
            0.027657768273465,
            0.023984202855246,
            0.027181921371324,
            0.014752012532679,
            0.033057137474918,
            0.011526953764051,
            0.023851942232172,
            0.019215953190019,
            0.010611027043246,
            0.023105515165171,
            0.018065012681861,
            0.014941801097853,
            0.013720572956834,
            0.018809737491406,
            0.023459592167097,
            0.012911443094151,
            0.021682003893448,
            0.018050243391523,
            0.035817619714355,
            0.027657768273465,
            0.065167479878108,
            0.030268405584729,
            0.038894644577928,
            0.016984117668096,
            0.029655017559715,
            0.009775901621619,
            0.023884750870884,
            0.019261551919389,
            0.0098898856717,
            0.034892444631564,
            0.01468199260245,
            0.013295608051251,
            0.010955054109048,
            0.01424068742045,
            0.025755486408541,
            0.013747080867653,
            0.020567895494028,
            0.022183370592067,
            0.029988307958865,
            0.023984202855246,
            0.030268405584729,
            0.101874666444492,
            0.033627442692993,
            0.016520905849791,
            0.050986320124768,
            0.008767555815056,
            0.024746899622433,
            0.020663198448029,
            0.007254070800019,
            0.028096036381827,
            0.025452880281545,
            0.014279280118194,
            0.024475075669774,
            0.019719957310083,
            0.025585679565071,
            0.01323381926109,
            0.02136722512479,
            0.017427045522604,
            0.040168108898735,
            0.027181921371324,
            0.038894644577928,
            0.033627442692993,
            0.084105839020058,
            0.013057482625446,
            0.030637508261343,
            0.009291592752752,
            0.022262308241168,
            0.016665094831991,
            0.009444553325608,
            0.030153806152355,
            0.004793607459318,
            0.012962474714869,
            0.019658669189534,
            0.014398229617691,
            0.026459303726848,
            0.01174415277131,
            0.019001285453577,
            0.025167580696414,
            0.015718391524181,
            0.014752012532679,
            0.016984117668096,
            0.016520905849791,
            0.013057482625446,
            0.045506878679339,
            0.024042375783768,
            0.009695466589876,
            0.025350821099752,
            0.022042116626904,
            0.013379911681984,
            0.027073395681668,
            0.029229753229419,
            0.017652502053035,
            0.025609267652104,
            0.012090611453685,
            0.016412061810848,
            0.01426245093153,
            0.023216799227331,
            0.015476976487021,
            0.020876469348865,
            0.033057137474918,
            0.029655017559715,
            0.050986320124768,
            0.030637508261343,
            0.024042375783768,
            0.4193830002235,
            0.011461456268777,
            0.042484455503263,
            0.035176002954457,
            0.016412020302663,
            0.026794578956909,
            0.035526316803062,
            0.02277153148325,
            0.06122068140341,
            0.030434104912454,
            0.033136321916934,
            0.018818716990605,
            0.031915915280527,
            0.013495696064937,
            0.010565499901285,
            0.011526953764051,
            0.009775901621619,
            0.008767555815056,
            0.009291592752752,
            0.009695466589876,
            0.011461456268777,
            0.04158454584264,
            0.010487452615155,
            0.012629520896697,
            0.010759192929477,
            0.016225956041488,
            0.028359504276614,
            0.00875316748315,
            0.005285322802455,
            0.014643930169031,
            0.011653647061782,
            0.011292466926478,
            0.011974748241831,
            0.012289284929863,
            0.022902978091904,
            0.023851942232172,
            0.023884750870884,
            0.024746899622433,
            0.022262308241168,
            0.025350821099752,
            0.042484455503263,
            0.010487452615155,
            0.06984396533883,
            0.031852079511833,
            0.011936960498535,
            0.0358549656547,
            0.037614366268123,
            0.023158256442708,
            0.03431823986322,
            0.029936615391661,
            0.027775071949442,
            0.019638479938432,
            0.05085828933697,
            0.019626763959626,
            0.018135729311071,
            0.019215953190019,
            0.019261551919389,
            0.020663198448029,
            0.016665094831991,
            0.022042116626904,
            0.035176002954457,
            0.012629520896697,
            0.031852079511833,
            0.061829683957123,
            0.012109622752937,
            0.032481770120198,
            0.036975714071886,
            0.016651103344083,
            0.026430631981669,
            0.025352677987965,
            0.019467551736462,
            0.01526454219229,
            0.02738924405632,
            0.017616476279587,
            0.010219823816128,
            0.010611027043246,
            0.0098898856717,
            0.007254070800019,
            0.009444553325608,
            0.013379911681984,
            0.016412020302663,
            0.010759192929477,
            0.011936960498535,
            0.012109622752937,
            0.026773113016096,
            0.012398910279535,
            0.014948102089414,
            0.012342333691718,
            0.015923663751803,
            0.010242425513935,
            0.010831430166694,
            0.009472576538247,
            0.013104413743994,
            0.009092834755815,
            0.025914655077702,
            0.023105515165171,
            0.034892444631564,
            0.028096036381827,
            0.030153806152355,
            0.027073395681668,
            0.026794578956909,
            0.016225956041488,
            0.0358549656547,
            0.032481770120198,
            0.012398910279535,
            0.179645407437457,
            0.058405486814376,
            0.019185773101533,
            0.033132546846781,
            0.034845867497757,
            0.023516303627135,
            0.017296997441985,
            0.03082419361403,
            0.027245208470164,
            0.00900971729413,
            0.018065012681861,
            0.01468199260245,
            0.025452880281545,
            0.004793607459318,
            0.029229753229419,
            0.035526316803062,
            0.028359504276614,
            0.037614366268123,
            0.036975714071886,
            0.014948102089414,
            0.058405486814376,
            0.494623032427318,
            0.019866350492007,
            0.056344563544883,
            0.059390642511711,
            0.015050259713064,
            0.014146146019123,
            0.025375185644141,
            0.023863106816131,
            0.013508308774706,
            0.014941801097853,
            0.013295608051251,
            0.014279280118194,
            0.012962474714869,
            0.017652502053035,
            0.02277153148325,
            0.00875316748315,
            0.023158256442708,
            0.016651103344083,
            0.012342333691718,
            0.019185773101533,
            0.019866350492007,
            0.036523375772781,
            0.039296623530467,
            0.011971193645525,
            0.016337859983078,
            0.013007124718704,
            0.022246046069868,
            0.010120477342456,
            0.00619243513112,
            0.013720572956834,
            0.010955054109048,
            0.024475075669774,
            0.019658669189534,
            0.025609267652104,
            0.06122068140341,
            0.005285322802455,
            0.03431823986322,
            0.026430631981669,
            0.015923663751803,
            0.033132546846781,
            0.056344563544883,
            0.039296623530467,
            0.252870406117809,
            0.029069899802156,
            0.016996319777651,
            0.009543050167162,
            0.029512038916943,
            0.008855628861118,
            0.012634980171098,
            0.018809737491406,
            0.01424068742045,
            0.019719957310083,
            0.014398229617691,
            0.012090611453685,
            0.030434104912454,
            0.014643930169031,
            0.029936615391661,
            0.025352677987965,
            0.010242425513935,
            0.034845867497757,
            0.059390642511711,
            0.011971193645525,
            0.029069899802156,
            0.12851913088368,
            0.018913489429945,
            0.012479936990966,
            0.023391698251987,
            0.019245993632443,
            0.024963364434361,
            0.023459592167097,
            0.025755486408541,
            0.025585679565071,
            0.026459303726848,
            0.016412061810848,
            0.033136321916934,
            0.011653647061782,
            0.027775071949442,
            0.019467551736462,
            0.010831430166694,
            0.023516303627135,
            0.015050259713064,
            0.016337859983078,
            0.016996319777651,
            0.018913489429945,
            0.04122643526786,
            0.015529396610032,
            0.024888466413595,
            0.019494417377056,
            0.014928533869611,
            0.012911443094151,
            0.013747080867653,
            0.01323381926109,
            0.01174415277131,
            0.01426245093153,
            0.018818716990605,
            0.011292466926478,
            0.019638479938432,
            0.01526454219229,
            0.009472576538247,
            0.017296997441985,
            0.014146146019123,
            0.013007124718704,
            0.009543050167162,
            0.012479936990966,
            0.015529396610032,
            0.031018977571267,
            0.018330186492931,
            0.01123416557741,
            0.019958071938655,
            0.021682003893448,
            0.020567895494028,
            0.02136722512479,
            0.019001285453577,
            0.023216799227331,
            0.031915915280527,
            0.011974748241831,
            0.05085828933697,
            0.02738924405632,
            0.013104413743994,
            0.03082419361403,
            0.025375185644141,
            0.022246046069868,
            0.029512038916943,
            0.023391698251987,
            0.024888466413595,
            0.018330186492931,
            0.046795038778593,
            0.017866465411268,
            0.020937329618582,
            0.018050243391523,
            0.022183370592067,
            0.017427045522604,
            0.025167580696414,
            0.015476976487021,
            0.013495696064937,
            0.012289284929863,
            0.019626763959626,
            0.017616476279587,
            0.009092834755815,
            0.027245208470164,
            0.023863106816131,
            0.010120477342456,
            0.008855628861118,
            0.019245993632443,
            0.019494417377056,
            0.01123416557741,
            0.017866465411268,
            0.039788747840675,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.7158337577632388,
        -0.16394497820881257,
        0.5196428529940469,
        -0.0800365157310615,
        -0.11340466722869529,
        0.5513553465965026,
        -0.0014291563205649168,
        -0.0997103418236338,
        -0.6183837108784705,
        -0.013923650510731987,
        0.4623672632358077,
        -0.0011604300339745556,
        0.0037090423814285746,
        -0.09610692714812996,
        -0.0004391213357471932,
        -0.013077248436743842,
        -0.04190300342022579,
        -0.10916994048869978,
        -0.6118512157359796,
        2.143300159856924,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest = -0.6514205594222443, 0.4406932807032015, -1.5235552453871726
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest
end