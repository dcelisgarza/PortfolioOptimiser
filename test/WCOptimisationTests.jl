using CSV, TimeSeries, DataFrames, StatsBase, Statistics, LinearAlgebra, Test, Clarabel,
      PortfolioOptimiser

prices = TimeArray(CSV.File("./assets/stock_prices.csv"); timestamp = :date)
rf = 1.0329^(1 / 252) - 1
l = 2.0

@testset "WC" begin
    portfolio = Portfolio2(; prices = prices,
                           solvers = Dict(:Clarabel => Dict(:solver => Clarabel.Optimizer,
                                                            :params => Dict("verbose" => false,
                                                                            "max_step_fraction" => 0.75))))
    asset_statistics2!(portfolio)
    wc_statistics2!(portfolio,
                    WCType(; box = WorstCaseNormal(; seed = 123456789),
                           ellipse = WorstCaseNormal(; seed = 123456789)))

    obj = MinRisk()
    w1 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = NoWC()), obj = obj)
    wt = [0.007911813464316563, 0.030685102137465003, 0.010505366137937627,
          0.02748375285330022, 0.012276170276064991, 0.033407270362069155,
          3.9681916897466676e-7, 0.13984690156809362, 6.626902694299562e-7,
          1.4125052278009859e-5, 0.287819278544025, 4.2200065479380485e-7,
          3.2968647670955543e-7, 0.1252756033367362, 1.836077877893019e-6,
          0.015083599354026141, 2.2788913848604495e-5, 0.19311714086149775,
          8.33379655093792e-7, 0.11654660648423812]
    @test isapprox(w1.weights, wt)

    w2 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCBox()), obj = obj)
    wt = [0.010505262318529992, 0.02765001122550846, 0.005155696156007754,
          0.014740124727828497, 0.0010683067257489488, 0.025331092034852395,
          3.754513874058572e-7, 0.13424546801820622, 1.4866284653090363e-6,
          1.8892933709798838e-5, 0.3078517408243262, 5.63377136447301e-7,
          3.110414525764398e-7, 0.12812721007458797, 1.2279377389265111e-6,
          8.308260892405014e-5, 0.008584743293094763, 0.2075899643656187,
          2.629689746559314e-6, 0.129041810567129]
    @test isapprox(w2.weights, wt)

    w3 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCEllipse()), obj = obj)
    wt = [0.007912037870629744, 0.030687527018252187, 0.010506202400593748,
          0.027485168637134863, 0.012276285584638688, 0.033409132424065756,
          3.0555517864196244e-8, 0.13984914464917864, 5.272370480321505e-8,
          1.2133616244260131e-6, 0.28782650603675497, 3.254697640057812e-8,
          2.5377425073073737e-8, 0.12528224646265831, 1.5082548413727057e-7,
          0.015084240268755747, 1.9674029424070814e-6, 0.19312513937224335,
          6.756803830577166e-8, 0.11655282891338065]
    @test isapprox(w3.weights, wt)

    w4 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = NoWC()), obj = obj)
    wt = [0.00792065742760887, 0.030668637277270414, 0.010500432216142526,
          0.027472910520011096, 0.012271335324961146, 0.033393094532735,
          1.728880761891034e-6, 0.13984196459803458, 2.902646782469052e-6,
          6.137370884061714e-5, 0.2878082866151491, 1.8463236147379452e-6,
          1.438334441195597e-6, 0.12524860212396854, 7.997518373077627e-6,
          0.015077475176265715, 9.879305759185557e-5, 0.19309419174112602,
          3.645964676816195e-6, 0.11652268601164413]
    @test isapprox(w4.weights, wt)

    w5 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCBox()), obj = obj)
    wt = [0.010485323947274642, 0.02763472687903287, 0.0051582579275902185,
          0.01473022995223824, 0.0011034822444609253, 0.025325763023434943,
          4.384456477155093e-7, 0.13424317043556885, 1.7339563285631196e-6,
          2.198250602715775e-5, 0.30785468395078497, 6.580793426480371e-7,
          3.640388686990717e-7, 0.12812714403276232, 1.4335156329910958e-6,
          9.63475507546304e-5, 0.008584326247404458, 0.20759531561665803,
          3.0643263594866353e-6, 0.12903155332382776]
    @test isapprox(w5.weights, wt)

    w6 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCEllipse()), obj = obj)
    wt = [0.007912276006249002, 0.030687391278917574, 0.010506192464148875,
          0.02748502848039196, 0.012276222490584219, 0.03340909086136257,
          3.2497621577550586e-8, 0.13984925331600684, 5.6032410844440464e-8,
          1.2910274779790488e-6, 0.28782697883394714, 3.4634758123111317e-8,
          2.7009870956582878e-8, 0.12528197756410062, 1.6021549334908612e-7,
          0.015084194509364511, 2.0950941665139236e-6, 0.19312511746053143,
          7.170637993957165e-8, 0.11655250851621585]
    @test isapprox(w6.weights, wt)

    w7 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = NoWC()), obj = obj)
    wt = [0.007909537856206164, 0.030689718255011864, 0.010506789943790507,
          0.02748676433387746, 0.012277520150601164, 0.033411335407212084,
          2.617989299314997e-8, 0.13984829600681303, 4.4241613330232595e-8,
          9.427135178002876e-7, 0.28782215568808145, 2.820788810518629e-8,
          2.1722025381310856e-8, 0.12528313510020228, 1.219425413700327e-7,
          0.015085349355071985, 1.522506427308343e-6, 0.19312342649980008,
          5.5696001840248274e-8, 0.1165532081934238]
    @test isapprox(w7.weights, wt)

    w8 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCBox()), obj = obj)
    wt = [0.010679320316551711, 0.0277269877911594, 0.005180570068271846,
          0.014799058589056642, 0.0007846490313187991, 0.025359575888464433,
          3.220311381073476e-9, 0.13425402283015495, 1.2804994087409802e-8,
          1.6387162692945203e-7, 0.30782743677775776, 4.839546730175031e-9,
          2.662865535949132e-9, 0.12811924110183784, 1.0537599013647173e-8,
          7.606037606538199e-7, 0.008636130253989903, 0.2075345596830514,
          2.262322168737283e-8, 0.12909746650445925]
    @test isapprox(w8.weights, wt)

    w9 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCEllipse()), obj = obj)
    wt = [0.007911679026783547, 0.030687880244735878, 0.010506311672977857,
          0.027485403531063882, 0.0122764770166707, 0.033409490447046074,
          2.668249114838825e-8, 0.1398490106836625, 4.5548246332211236e-8,
          1.0415335735683515e-6, 0.2878258103745408, 2.8270150126946782e-8,
          2.2117497900244012e-8, 0.1252825146692545, 1.3072957065408793e-7,
          0.015084405374256732, 1.6847781632894585e-6, 0.19312497924850405,
          5.8066067335590394e-8, 0.11655299998474332]
    @test isapprox(w9.weights, wt)

    obj = Util(; l = l)
    w10 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = NoWC()), obj = obj)
    wt = [1.8806821243138587e-9, 3.862037665252809e-9, 5.3001998134864415e-9,
          4.0360019978329865e-9, 0.7741908142503099, 3.844601498472023e-10,
          0.10998661007165182, 1.8527007377941382e-9, 5.530541762351095e-9,
          1.7145166998745589e-9, 1.565743319144623e-9, 4.404618249917125e-10,
          8.279003191700973e-10, 3.393484482000698e-10, 7.565367120223997e-10,
          0.11582251334241189, 1.837873208584227e-8, 2.095242389749337e-9,
          1.0434851269789176e-8, 2.9356689604674046e-9]
    @test isapprox(w10.weights, wt)

    w11 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCBox()), obj = obj)
    wt = [2.805716190890176e-8, 6.088365624069214e-8, 1.0568078151538469e-7,
          6.412319437460625e-8, 0.7874637096101381, 8.77422866291805e-9,
          0.09194225139664124, 2.6192987809704286e-8, 9.665810149369637e-8,
          2.5024890510346207e-8, 2.3372371281176592e-8, 8.255036285355643e-9,
          6.25704011973132e-9, 1.3190093800452873e-8, 6.1985343812035715e-9,
          0.12059116015349544, 1.957546960890278e-6, 2.9194381725999492e-8,
          3.7710143676481466e-7, 4.2328867346495816e-8]
    @test isapprox(w11.weights, wt)

    w12 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCEllipse()), obj = obj)
    wt = [1.0817131674324131e-8, 2.889834405555976e-8, 4.024221161322655e-8,
          2.4723019415101256e-8, 0.5625967619010117, 3.1853029013843226e-9,
          0.07157115390725362, 1.9261981775340735e-8, 3.007667860789801e-8,
          1.1629547908783714e-8, 1.604168248789888e-8, 2.639035849100641e-9,
          1.915014613885714e-9, 5.690758925535531e-9, 1.8686617382003593e-9,
          0.14787356584614542, 0.17030634430559083, 1.9681883224143102e-8,
          0.04765193490126016, 2.2467483664152168e-8]
    @test isapprox(w12.weights, wt, rtol = 1e-5)

    w13 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = NoWC()), obj = obj)
    wt = [5.252194452079515e-9, 1.031535486427643e-8, 9.455445002828933e-9,
          4.0132093122963755e-9, 0.5819241901850066, 6.270895459420635e-10,
          2.0561436069527382e-9, 6.707564451760214e-9, 7.865563976161287e-9,
          4.174500901517634e-9, 1.0991695319655359e-8, 2.1907872384482647e-10,
          1.1231728021597677e-10, 2.5405249292978275e-9, 1.811392469557399e-10,
          1.0750087766165246e-8, 0.4180755819595816, 1.2097725638064922e-8,
          1.273857094095548e-7, 1.3110067439258625e-8]
    @test isapprox(w13.weights, wt)

    w14 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCBox()), obj = obj)
    wt = [7.450617561203435e-8, 1.6917707192315162e-7, 1.567471389219165e-7,
          5.3660427700111614e-8, 0.5520776394586291, 1.841614636887493e-8,
          2.9069631640138387e-8, 9.268404816032403e-8, 1.0485330098663648e-7,
          5.4460570484930626e-8, 1.8959018987776546e-7, 1.1836606199162978e-8,
          6.9505032772479036e-9, 3.673765106194884e-8, 8.326868451375697e-9,
          1.46635215938837e-7, 0.4479156448057863, 2.156962161572903e-7,
          5.092622257136216e-6, 2.5376556477626486e-7]
    @test isapprox(w14.weights, wt)

    w15 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCEllipse()), obj = obj)
    wt = [8.944699665874712e-9, 2.4866016687209537e-8, 1.8056975027233465e-8,
          6.701055880721176e-9, 0.3997543530600884, 2.28279574922472e-9,
          3.235792020528003e-9, 2.9551515433410007e-8, 9.862417196022293e-9,
          7.666562367860835e-9, 0.032978164250364414, 1.2731123003899245e-9,
          7.278461891769551e-10, 5.29152538961053e-9, 8.767298048625151e-10,
          3.906026526832658e-8, 0.4425967756222856, 2.594790000012218e-7,
          0.12467021234820054, 7.684275213276779e-8]
    @test isapprox(w15.weights, wt, rtol = 5.0e-5)

    w16 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = NoWC()), obj = obj)
    wt = [0.004693559535706938, 0.03169836414352631, 0.012129963693487978,
          0.02810771359920274, 0.01892932696746519, 0.023655483430201466,
          1.4163700577931323e-8, 0.13876997110144496, 2.32347448400989e-8,
          9.068461506432257e-7, 0.2889430629754584, 1.2659952049090117e-8,
          9.679831510232964e-9, 0.12088003598788585, 3.857204453276775e-8,
          0.01705983030744189, 0.003165472335153956, 0.1950028925981883,
          3.0519011679565134e-8, 0.11696328764940013]
    @test isapprox(w16.weights, wt)

    w17 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCBox()), obj = obj)
    wt = [0.004707791908335483, 0.03168011994608607, 0.012095944726982897,
          0.02803363059967011, 0.018858414233725893, 0.02360951845095837,
          4.062695091533421e-10, 0.13873732502020755, 7.218091124516795e-10,
          4.018727224148649e-8, 0.2890603349686695, 4.1736222559824104e-10,
          2.9349382715563125e-10, 0.12089400398467261, 1.1087628592860438e-9,
          0.016965121620385774, 0.0032370161940927407, 0.19508381163882427,
          9.295988249096634e-10, 0.1170369226428201]
    @test isapprox(w17.weights, wt)

    w18 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCEllipse()),
                     obj = obj)
    wt = [0.00470793943460317, 0.03169648179413269, 0.012124808282586247,
          0.028106341262349902, 0.018903442332804023, 0.02369550390238433,
          8.921232449396263e-10, 0.13877483349713424, 1.4822841679084963e-9,
          6.006577482922801e-8, 0.2889391999126842, 7.991192476634082e-10,
          6.07022442605008e-10, 0.12090015499880688, 2.432451838638286e-9,
          0.01705249593429949, 0.0031368731795578695, 0.19499783747523122,
          1.948624861428987e-9, 0.11696401976602508]
    @test isapprox(w18.weights, wt)

    obj = SR(; rf = rf)
    w19 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = NoWC()), obj = obj)
    wt = [7.553492851361374e-8, 2.1285579856165624e-7, 2.845661364428514e-7,
          1.7013437460195322e-7, 0.5180573515455889, 2.363670300697333e-8,
          0.06365091396779785, 1.7695161329410745e-7, 1.633441255483874e-7,
          8.353312871467369e-8, 1.4040146163299775e-7, 1.9253794707313353e-8,
          1.4063308424953963e-8, 4.233163476317312e-8, 1.3763723070491807e-8,
          0.14326808269312313, 0.1964975514314666, 1.6605635787037674e-7,
          0.0785243406233306, 1.7331160397531429e-7]
    @test isapprox(w19.weights, wt)

    w20 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCBox()), obj = obj)
    wt = [1.489640997960677e-7, 0.0004625556277101684, 6.7609178905389495e-6,
          1.4950528283290103e-6, 0.2666049557990059, 1.6019767874087718e-8,
          0.011435342219864373, 0.06655662635749292, 2.598611710282023e-7,
          2.5908488314878567e-7, 0.16139778876749925, 1.0155011746814096e-8,
          7.158321578252474e-9, 5.8234629212534585e-8, 7.495338701268424e-9,
          0.07263440734513225, 0.2016703153864126, 0.1013721092886068, 0.08768110255896876,
          0.03017577370536502]
    @test isapprox(w20.weights, wt, rtol = 1.0e-6)

    w21 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCEllipse()), obj = obj)
    wt = [1.2044815694693301e-8, 0.007778164610818489, 0.0038637110626756565,
          0.0027532020484506573, 0.2509904698171083, 3.0624039140214415e-9,
          0.0231603617913757, 0.08562651351987942, 1.537252297870439e-8,
          1.7130607590947504e-8, 0.16235416382611415, 1.9604660345645446e-9,
          1.4372377685968588e-9, 8.183697008509526e-9, 1.53881065195444e-9,
          0.08334202366046319, 0.1653489211089905, 0.10482703093847662, 0.07553034289474611,
          0.03442503399033974]
    @test isapprox(w21.weights, wt, rtol = 5.0e-6)

    w22 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = NoWC()), obj = obj)
    wt = [5.0260866671471015e-8, 7.11967445297655e-8, 7.979707474987201e-8,
          3.9221151098284e-8, 0.999998607704837, 1.3137249521153987e-8,
          2.4140354794258172e-8, 4.0434584082135856e-8, 6.183081785542689e-8,
          3.478750956563012e-8, 5.035877409453666e-8, 8.837405908253427e-9,
          4.805004970331584e-9, 2.4259888221439417e-8, 5.843880004225067e-9,
          6.054685369215372e-8, 5.41985632452297e-7, 5.794577768162093e-8,
          1.490358667309571e-7, 7.386972637164583e-8]
    @test isapprox(w22.weights, wt)

    w23 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCBox()), obj = obj)
    wt = [4.103485632181873e-9, 6.654627090271345e-9, 6.916439063663765e-9,
          3.1704701261354826e-9, 0.7008358236264317, 1.0627461986134946e-9,
          1.877709941493643e-9, 3.857500147115765e-9, 5.426591456403466e-9,
          2.9808806594248508e-9, 5.377863624140663e-9, 6.944692438024383e-10,
          3.796655667143752e-10, 2.0468411004934156e-9, 4.6100994000162007e-10,
          5.918088963580169e-9, 0.2991640792411969, 6.190821969631627e-9,
          3.2451665787212517e-8, 7.561494888375288e-9]
    @test isapprox(w23.weights, wt, rtol = 5.0e-5)

    w24 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCEllipse()), obj = obj)
    wt = [1.4980773982464543e-9, 2.4096518851689155e-9, 2.436781423851796e-9,
          1.1837462171172515e-9, 0.6864097284419763, 4.131394247537901e-10,
          7.153492082001606e-10, 1.4946216860413926e-9, 1.9973114005002028e-9,
          1.1382183432389244e-9, 2.0610973562806614e-9, 2.6864779186557474e-10,
          1.4870705765414701e-10, 7.915733356260394e-10, 1.7978453104869838e-10,
          2.2666572964595546e-9, 0.3135902373007148, 2.325169642218911e-9,
          1.0209533981696565e-8, 2.719240890348517e-9]
    @test isapprox(w24.weights, wt, rtol = 1.0e-6)

    w25 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = NoWC()), obj = obj)
    wt = [0.03668699478582806, 0.04199403436794092, 0.03158083933533834,
          0.030223424091804413, 0.030963950682207125, 0.05092107388691887,
          0.00539237446272562, 0.12741042422900892, 0.01520026272558982,
          0.03191251305819219, 0.199628293321302, 0.007864727315155796,
          0.004658985994392003, 0.08046868727603212, 0.01464008883272933,
          0.030923246980974105, 0.03998219832902477, 0.1239050047200327,
          0.024618179504698936, 0.07102469610010399]
    @test isapprox(w25.weights, wt)

    w26 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCBox()), obj = obj)
    wt = [0.04435081556206913, 0.046531779724922014, 0.03983282471344198,
          0.03688976682490868, 0.03929355810970192, 0.052232750323772, 0.018170784735912004,
          0.10231971135551078, 0.02904435913658891, 0.03963600574858972, 0.1406194039337424,
          0.022554828135680514, 0.017335902942306466, 0.06829040604620087,
          0.02553551635285248, 0.037430047548205496, 0.04570665183466338,
          0.09487419873685467, 0.03610360633847377, 0.06324708189560278]
    @test isapprox(w26.weights, wt, rtol = 1.0e-6)

    w27 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCEllipse()),
                     obj = obj)
    wt = [0.033899981174270725, 0.041522699517496243, 0.029713306845669925,
          0.030088582391661716, 0.029218641360507024, 0.05051625097823812,
          0.0009132432077065283, 0.1283973710563001, 0.009746770311749283,
          0.030107578018352087, 0.21416508196173528, 0.001772290252427619,
          0.0003861400923800053, 0.08742390229570096, 0.011297279192536725,
          0.030547843147737917, 0.03829092435932253, 0.1349402895583896,
          0.019913279929698966, 0.07713854434811851]
    @test isapprox(w27.weights, wt, rtol = 1.0e-6)

    obj = MaxRet()
    w28 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = NoWC()), obj = obj)
    wt = [2.2425872064182503e-8, 2.3869345714744183e-8, 3.0249972071127925e-8,
          2.7441036408966832e-8, 2.674016472879105e-6, 1.1117945427350462e-8,
          0.9999969549278999, 1.6603745200809882e-8, 2.5223224538501096e-8,
          1.8088400365786554e-8, 1.61723807198772e-8, 1.1616638624454757e-8,
          8.681387036441865e-9, 1.377196283532058e-8, 8.992921448080973e-9,
          4.0392434474846235e-8, 3.1600448886835504e-8, 1.7426103712222823e-8,
          2.6166436896960802e-8, 2.1215370935214236e-8]
    @test isapprox(w28.weights, wt)

    w29 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCBox()), obj = obj)
    wt = [6.989037894153361e-8, 7.480538210565656e-8, 9.691293469005913e-8,
          8.678037209210843e-8, 8.83780308684425e-6, 3.405815640181256e-8, 0.99998999333959,
          5.0910247622783476e-8, 7.956894827168171e-8, 5.5670422511961646e-8,
          4.943917760140057e-8, 3.572433741167029e-8, 2.7230914952084987e-8,
          4.200273371512125e-8, 2.7981881704772375e-8, 1.3369440448455757e-7,
          1.0195753500768141e-7, 5.343621687414818e-8, 8.291247353947803e-8,
          6.58808052003012e-8]
    @test isapprox(w29.weights, wt)

    w30 = optimise2!(portfolio; type = WC2(; mu = NoWC(), cov = WCEllipse()), obj = obj)
    wt = [7.557373043328773e-10, 8.076782220927106e-10, 1.0443145369507127e-9,
          9.359408251112705e-10, 1.0872408625408755e-7, 3.781875331915266e-10,
          0.999999878579857, 5.560321337955898e-10, 8.594596265633233e-10,
          6.066737928742431e-10, 5.405772841878036e-10, 3.9671164925883545e-10,
          3.045445880537671e-10, 4.627780252852682e-10, 3.125443989397034e-10,
          1.4463379951285884e-9, 1.0983103441793478e-9, 5.825488309417498e-10,
          8.944332827304902e-10, 7.132463682764463e-10]
    @test isapprox(w30.weights, wt)

    w31 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = NoWC()), obj = obj)
    wt = [4.204205203542449e-8, 4.52151914455539e-8, 5.659006380294785e-8,
          3.514878006645271e-8, 0.9999993010578087, 1.5765086265663477e-8,
          2.7221730459829723e-8, 2.8333312807231666e-8, 4.0442400780506775e-8,
          2.8205642322983483e-8, 3.015402047164297e-8, 1.3622177335174017e-8,
          8.610125010959476e-9, 2.1881581304089744e-8, 1.0054344901923858e-8,
          3.857715271568933e-8, 1.201866393126026e-7, 3.337383016337279e-8,
          5.928283995021941e-8, 4.42352202098176e-8]
    @test isapprox(w31.weights, wt)

    w32 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCBox()), obj = obj)
    wt = [9.349443309060658e-8, 1.0239636651034713e-7, 1.233364801221487e-7,
          7.86882321995889e-8, 0.999998459470907, 3.374223076392958e-8,
          6.050116124704548e-8, 6.512359766654129e-8, 9.24582416822205e-8,
          6.423360525428934e-8, 7.082470644140513e-8, 2.8405642612874244e-8,
          1.7518365512769257e-8, 4.905313270804857e-8, 2.0460696086146867e-8,
          8.883201342617105e-8, 2.388667481911421e-7, 7.830567654701249e-8,
          1.332659590868544e-7, 1.010218038502237e-7]
    @test isapprox(w32.weights, wt)

    w33 = optimise2!(portfolio; type = WC2(; mu = WCBox(), cov = WCEllipse()), obj = obj)
    wt = [6.951776791650045e-10, 7.623338151759487e-10, 9.242434324077375e-10,
          5.888794418446168e-10, 0.9999999883860969, 2.546616267443753e-10,
          4.611257640454363e-10, 4.83346835194399e-10, 6.893058462042585e-10,
          4.79488007836693e-10, 5.218722830698115e-10, 2.1865601988791256e-10,
          1.3678932465370838e-10, 3.652334940493917e-10, 1.5880646578070034e-10,
          6.65386630333166e-10, 1.878633599620097e-9, 5.782505869920645e-10,
          1.0015839924968695e-9, 7.501281605435445e-10]
    @test isapprox(w33.weights, wt)

    w34 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = NoWC()), obj = obj)
    wt = [0.004673507042573548, 0.03170121824101275, 0.01213716074983467,
          0.028109772046531013, 0.01896480998262944, 0.023601128417283394,
          1.3751619568813637e-8, 0.1387634338016991, 2.3003240383071667e-8,
          9.093159089332627e-7, 0.2889485204734536, 1.2276165285978352e-8,
          9.266122498606984e-9, 0.12085297997683866, 3.8187058574230424e-8,
          0.01706996047179656, 0.003203549288618823, 0.19501021778744967,
          3.033277729523375e-8, 0.11696270558738632]
    @test isapprox(w34.weights, wt)

    w35 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCBox()), obj = obj)
    wt = [0.004673537976966748, 0.031701195445288786, 0.012137146091925163,
          0.02810975710228726, 0.018964798825330857, 0.02360110244926761,
          1.5311407407456336e-8, 0.13876342534330915, 2.545705564449862e-8,
          1.0145275795541222e-6, 0.2889485043788008, 1.3594041442615469e-8,
          1.0339386850279656e-8, 0.12085294737119615, 4.2344602564562274e-8,
          0.0170699489104224, 0.003203622706898777, 0.1950101843139078,
          3.3499259525636553e-8, 0.11696267401106561]
    @test isapprox(w35.weights, wt)

    w36 = optimise2!(portfolio; type = WC2(; mu = WCEllipse(), cov = WCEllipse()),
                     obj = obj)
    wt = [0.004673244817190372, 0.03170139396261079, 0.012137270934126525,
          0.028109884440479575, 0.018964905446944652, 0.023601322132116985,
          2.3690055506863073e-9, 0.1387634986487497, 3.872188777363404e-9,
          1.5339587504398632e-7, 0.288948634807124, 2.080972367542935e-9,
          1.5953934172609717e-9, 0.12085322415240292, 6.4846917818404995e-9,
          0.01707004331543968, 0.0032029825571973755, 0.1950104752320347,
          5.056451116475305e-9, 0.11696294469900465]
    @test isapprox(w36.weights, wt)
end
