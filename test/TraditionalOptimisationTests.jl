using Test,
    PortfolioOptimiser,
    DataFrames,
    TimeSeries,
    CSV,
    Dates,
    ECOS,
    SCS,
    Clarabel,
    COSMO,
    OrderedCollections,
    LinearAlgebra,
    StatsBase

A = TimeArray(CSV.File("./assets/stock_prices.csv"), timestamp = :date)
Y = percentchange(A)
RET = dropmissing!(DataFrame(Y))
rf = 1.0329^(1 / 252) - 1
l = 2.0
type = :trad

println("Traditional optimisation tests...")

@testset "mv" begin
    println("Testing rm = :mv, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)

    rm = :mv

    w11 = [
        0.00790101350930099,
        0.0306909139358808,
        0.010506322670541511,
        0.027487810990731512,
        0.012278574123481116,
        0.033410647094723245,
        5.992768702616961e-10,
        0.1398486652999066,
        1.0318412667826644e-9,
        1.1506529577820253e-8,
        0.2878239722245232,
        6.544625217911222e-10,
        4.93689273689815e-10,
        0.1252846767367913,
        2.4717046303259267e-9,
        0.015084330918903146,
        1.814161154983086e-8,
        0.19312632144038927,
        1.2981261894646573e-9,
        0.11655671485758536,
    ]
    w12 = [
        7.501098494991323e-9,
        1.0064670665034103e-8,
        1.1722347049257423e-8,
        1.0361728384158447e-8,
        0.7742138078975956,
        3.1023452209126238e-9,
        0.10997534056425429,
        7.085470209215128e-9,
        1.1532235426098252e-8,
        6.972409318059648e-9,
        6.650081562400164e-9,
        2.953876334873929e-9,
        2.162908256197495e-9,
        4.5301912036774246e-9,
        2.128892154621845e-9,
        0.11581072064765068,
        1.4678173585918143e-8,
        7.408376181540708e-9,
        1.3081152141411003e-8,
        8.954543362088613e-9,
    ]
    w13 = [
        2.374679736183779e-9,
        4.939301272870657e-9,
        6.179061867835019e-9,
        4.034411541161419e-9,
        0.5180871979643897,
        8.070325177367361e-10,
        0.06365369306001793,
        4.3349884009920866e-9,
        5.452105198932873e-9,
        2.5299877405583313e-9,
        4.118309846310807e-9,
        6.403157613827995e-10,
        4.338684204098137e-10,
        1.4266510957251872e-9,
        4.641523581003893e-10,
        0.14327007654199483,
        0.19648906566805555,
        4.3761672024213315e-9,
        0.07849992010817639,
        4.5463326801949395e-9,
    ]
    w14 = [
        1.5192065610514992e-11,
        1.7722471226445733e-11,
        2.9669315137971204e-11,
        2.4155024681950277e-11,
        7.59468703964738e-9,
        4.471042028698165e-12,
        0.9999999921281696,
        7.096032846356474e-12,
        2.025110689901504e-11,
        8.759180650670239e-12,
        6.652117745262745e-12,
        4.483930062795914e-12,
        4.799732666967364e-12,
        5.010418115419259e-12,
        4.745332577894867e-12,
        4.8538726608548216e-11,
        3.238920124696666e-11,
        7.938033081344488e-12,
        2.2053788083893776e-11,
        1.3216026591344278e-11,
    ]
    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-3
    @test rmsd(w12, w22) < 1e-5
    @test rmsd(w13, w23) < 1e-5
    @test rmsd(w14, w24) < 1e-7

    w11 = [
        0.00790101350930099,
        0.0306909139358808,
        0.010506322670541511,
        0.027487810990731512,
        0.012278574123481116,
        0.033410647094723245,
        5.992768702616961e-10,
        0.1398486652999066,
        1.0318412667826644e-9,
        1.1506529577820253e-8,
        0.2878239722245232,
        6.544625217911222e-10,
        4.93689273689815e-10,
        0.1252846767367913,
        2.4717046303259267e-9,
        0.015084330918903146,
        1.814161154983086e-8,
        0.19312632144038927,
        1.2981261894646573e-9,
        0.11655671485758536,
    ]
    w12 = [
        1.0865353755842134e-7,
        2.0686588717409895e-7,
        2.7187228304113667e-7,
        2.0072734321853616e-7,
        0.7186482205643473,
        3.586615839912499e-8,
        0.0986154275914106,
        1.241580400451212e-7,
        3.0436884512675934e-7,
        1.088247045474315e-7,
        1.112603543141629e-7,
        3.1508000068382684e-8,
        2.222968616538749e-8,
        5.931283202136737e-8,
        2.173470660006859e-8,
        0.155173188146538,
        0.02755989731852978,
        1.3508443743246354e-7,
        1.3614308668529052e-6,
        1.6248149155617866e-7,
    ]
    w13 = [
        6.855095326572051e-6,
        0.00017172239690563856,
        0.0038555391801365674,
        2.143004752616271e-5,
        0.44500402816108947,
        1.8152494753280122e-6,
        0.0530854298623821,
        0.01112265539105882,
        1.1115099133313281e-5,
        7.943733622637706e-6,
        0.0002625353133695802,
        1.3338274727547277e-6,
        9.698302908052664e-7,
        3.7126808251988777e-6,
        9.44699303794041e-7,
        0.13922569809430452,
        0.21448393215354267,
        0.0002952249055260894,
        0.13232670442156164,
        0.0001104098571462203,
    ]
    w14 = [
        2.85898052025261e-10,
        3.228570520084843e-10,
        3.96885303999293e-10,
        3.6151119117976806e-10,
        0.8503207438320458,
        1.3091890174421828e-10,
        0.14967925108373412,
        2.2266817711863868e-10,
        3.578136311569646e-10,
        2.430092800863492e-10,
        2.1336134958599728e-10,
        1.3701726564971077e-10,
        1.0011479238014472e-10,
        1.7239200605803413e-10,
        9.960662977431538e-11,
        6.90047353140167e-10,
        4.4818671820098014e-10,
        2.33945765127216e-10,
        3.813924242288859e-10,
        2.865940556541881e-10,
    ]
    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights
    @test rmsd(w11, w21) < 1e-3
    @test rmsd(w12, w22) < 1e-4
    @test rmsd(w13, w23) < 6e-3
    @test rmsd(w14, w24) < 1e-4

    w11 = [
        0.00790101350930099,
        0.0306909139358808,
        0.010506322670541511,
        0.027487810990731512,
        0.012278574123481116,
        0.033410647094723245,
        5.992768702616961e-10,
        0.1398486652999066,
        1.0318412667826644e-9,
        1.1506529577820253e-8,
        0.2878239722245232,
        6.544625217911222e-10,
        4.93689273689815e-10,
        0.1252846767367913,
        2.4717046303259267e-9,
        0.015084330918903146,
        1.814161154983086e-8,
        0.19312632144038927,
        1.2981261894646573e-9,
        0.11655671485758536,
    ]
    w12 = [
        1.315015450408368e-9,
        2.5569969088173495e-9,
        3.2848585681829983e-9,
        2.415839535140197e-9,
        0.7207185008699422,
        4.214879579614106e-10,
        0.09835548176963889,
        1.5542515887798901e-9,
        3.729782644427829e-9,
        1.3295817491560547e-9,
        1.388763754161527e-9,
        3.705725275704055e-10,
        2.521544891441231e-10,
        7.154212396901733e-10,
        2.4979939717861087e-10,
        0.1550534383573205,
        0.025872538818152355,
        1.6894699154777678e-9,
        1.6889096272823596e-8,
        2.0218541540301808e-9,
    ]
    w13 = [
        3.5379549415042476e-9,
        1.0875979548667672e-8,
        1.4071917588238513e-8,
        8.228849778539734e-9,
        0.48941829873075493,
        1.0581922819515598e-9,
        0.058337193245876315,
        1.1157269577897694e-8,
        6.978121275865596e-9,
        4.032629340398236e-9,
        8.367592140519154e-9,
        8.203007150891988e-10,
        5.956884940425251e-10,
        2.00603917076689e-9,
        5.766499624947155e-10,
        0.14032716520895433,
        0.21337786390770655,
        9.556458677811914e-9,
        0.09853938790242223,
        9.140642129470356e-9,
    ]
    w14 = [
        5.572234280636143e-12,
        6.2577610721475044e-12,
        7.80856647073791e-12,
        7.0310636849368874e-12,
        0.8533951447515135,
        2.372412685580246e-12,
        0.14660485515191704,
        4.210456213977918e-12,
        6.789275907086024e-12,
        4.566909792245081e-12,
        4.040076957903744e-12,
        2.4655779176383524e-12,
        1.7223062268928809e-12,
        3.197669196657552e-12,
        1.7515788729082566e-12,
        1.2784956162245935e-11,
        8.759115642694511e-12,
        4.44077647544962e-12,
        7.27702202443673e-12,
        5.5217229111629075e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights
    @test rmsd(w11, w21) < 1e-4
    @test rmsd(w12, w22) < 1e-6
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-7
end

@testset "mad" begin
    println("Testing rm = :mad, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 1)),
        ),
    )
    asset_statistics!(port)
    rm = :mad

    w11 = [
        0.014061880230098326,
        0.042374911253546026,
        0.016863338191130086,
        0.002020812393188773,
        0.01768388730031514,
        0.05422406737508933,
        9.113561695090867e-14,
        0.15821655500572893,
        8.46594672298905e-14,
        2.0403599807029582e-13,
        0.23689727682445483,
        1.874295992935553e-14,
        1.6648543494044883e-14,
        0.12783200177689702,
        0.0003509455035553752,
        0.0009122889020762202,
        0.04394937954196347,
        0.1827242784279457,
        1.1531703482203527e-13,
        0.10188837727348043,
    ]
    w12 = [
        0.009459604882737808,
        0.05572444620116,
        0.009430414009520324,
        0.010307935591294204,
        0.07101573331118137,
        7.839058521990585e-12,
        0.0001581465738274952,
        0.1419952435186637,
        1.030148707398242e-11,
        0.01166920447831044,
        0.20323468319872826,
        9.403326025584615e-13,
        1.078177294820107e-12,
        0.07795484495517012,
        2.9356518300200813e-12,
        0.018196904111046245,
        0.08494632444810453,
        0.1710124635707962,
        0.0348180544878595,
        0.10007599663850512,
    ]
    w13 = [
        3.2775465892126126e-14,
        1.3324468779911932e-13,
        1.3508376405283924e-13,
        5.825260884346701e-14,
        0.6622657752292105,
        1.2893443650953926e-14,
        0.04259470718268862,
        6.402051883460471e-14,
        1.4053330248177402e-13,
        5.0973946679400004e-14,
        1.2310891296174548e-13,
        1.8485767870164157e-14,
        2.2469205389774708e-14,
        3.2784628518521933e-15,
        2.1453760820002276e-14,
        0.13436659616544247,
        0.08736654877101017,
        1.0887119028450206e-13,
        0.07340637265061209,
        1.1047477580014884e-13,
    ]
    w14 = [
        5.1608094762415435e-11,
        5.207032566247801e-11,
        3.782701076683847e-11,
        5.7306423152006965e-11,
        4.454447352632455e-9,
        4.512526606836864e-11,
        0.9999999946698693,
        5.479796043404423e-11,
        5.86551194224155e-11,
        5.742197185891196e-11,
        5.541951271588821e-11,
        4.3846453202089875e-11,
        3.234749500702867e-11,
        5.2403775872871985e-11,
        3.4954868529747976e-11,
        5.234152591865969e-11,
        3.1546432022118925e-11,
        5.5618418746024516e-11,
        5.0220204576520237e-11,
        5.217247326479619e-11,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-10
    @test rmsd(w12, w22) < 1e-3
    @test rmsd(w13, w23) < 1e-11
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        0.014061880230098326,
        0.042374911253546026,
        0.016863338191130086,
        0.002020812393188773,
        0.01768388730031514,
        0.05422406737508933,
        9.113561695090867e-14,
        0.15821655500572893,
        8.46594672298905e-14,
        2.0403599807029582e-13,
        0.23689727682445483,
        1.874295992935553e-14,
        1.6648543494044883e-14,
        0.12783200177689702,
        0.0003509455035553752,
        0.0009122889020762202,
        0.04394937954196347,
        0.1827242784279457,
        1.1531703482203527e-13,
        0.10188837727348043,
    ]
    w12 = [
        0.009565267432672603,
        0.05620284535416836,
        0.008993474211176244,
        0.010206322935447884,
        0.0710167281388428,
        2.298858951190326e-11,
        0.00017536205588263538,
        0.1418013594524342,
        2.8660788530265935e-11,
        0.011593356383033267,
        0.20333070438882536,
        2.6847869096026175e-12,
        3.06758039909358e-12,
        0.07780288116378963,
        8.418334431600834e-12,
        0.018214560919887397,
        0.08518138137390815,
        0.17144261641315284,
        0.0345995473220713,
        0.09987359238888735,
    ]
    w13 = [
        9.504881872318081e-11,
        2.9123136038561247e-10,
        4.0097177827889205e-10,
        1.212786084526373e-10,
        0.5088097565792566,
        2.677323781992036e-11,
        0.03160672364497261,
        4.97480365723299e-10,
        1.706107548502445e-10,
        1.0552531049364852e-10,
        0.002868526653981817,
        1.7183631715074215e-11,
        1.275187573074244e-11,
        5.240853030999799e-11,
        1.3953791270255274e-11,
        0.13826739485875297,
        0.1856567959322612,
        7.583330580870742e-10,
        0.13279079938109614,
        3.861275708474309e-10,
    ]
    w14 = [
        6.451870016207551e-11,
        7.204189513443317e-11,
        8.906070782869375e-11,
        8.043422201618524e-11,
        0.8503236439328641,
        2.8926968274147874e-11,
        0.14967635495285603,
        4.963144068207656e-11,
        7.736352584584053e-11,
        5.335368390612564e-11,
        4.775366195384848e-11,
        2.981109178487484e-11,
        2.1309243400208645e-11,
        3.823750623124682e-11,
        2.1778192018626845e-11,
        1.4148999322396185e-10,
        9.9490223515674e-11,
        5.216117002128669e-11,
        8.28894231464527e-11,
        6.402829476449138e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-10
    @test rmsd(w12, w22) < 1e-4
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        0.014061880230098326,
        0.042374911253546026,
        0.016863338191130086,
        0.002020812393188773,
        0.01768388730031514,
        0.05422406737508933,
        9.113561695090867e-14,
        0.15821655500572893,
        8.46594672298905e-14,
        2.0403599807029582e-13,
        0.23689727682445483,
        1.874295992935553e-14,
        1.6648543494044883e-14,
        0.12783200177689702,
        0.0003509455035553752,
        0.0009122889020762202,
        0.04394937954196347,
        0.1827242784279457,
        1.1531703482203527e-13,
        0.10188837727348043,
    ]
    w12 = [
        0.009655333104202836,
        0.05668988463932766,
        0.008732431589792788,
        0.010029023064255843,
        0.07087921569422946,
        6.053991567851434e-10,
        0.00027672453242039656,
        0.14173992880953148,
        7.853345255824746e-10,
        0.011690881540715927,
        0.2034942612496262,
        6.57223748541311e-11,
        7.396199492284394e-11,
        0.07793795323823294,
        2.170816203984454e-10,
        0.018196999328664754,
        0.08532599960948957,
        0.1714774352067705,
        0.03408825592081158,
        0.09978567072442833,
    ]
    w13 = [
        5.307195679149273e-9,
        1.4194129525935186e-8,
        1.7354954130135684e-8,
        7.69709015502935e-9,
        0.5791948770331061,
        1.6231439384973383e-9,
        0.03882080552455042,
        1.1852355445669338e-8,
        1.197142154465931e-8,
        6.274221797039603e-9,
        2.0423609005150175e-8,
        1.111272705926853e-9,
        8.190299006052292e-10,
        3.06150066521855e-9,
        8.86433926811959e-10,
        0.13597962032185792,
        0.1396816496855953,
        1.5682996078576144e-8,
        0.10632291549847374,
        1.3677061998106875e-8,
    ]
    w14 = [
        2.372567339579673e-12,
        2.769343808491492e-12,
        3.450523690582476e-12,
        3.037652170506673e-12,
        0.853395144817874,
        1.0233579127715154e-12,
        0.14660485514075286,
        1.8423792083391256e-12,
        3.021317261414211e-12,
        1.9710723229578766e-12,
        1.8321553750679943e-12,
        1.0360765732858033e-12,
        7.238504663351113e-13,
        1.3785475292246846e-12,
        7.393585991081788e-13,
        4.191347610684789e-12,
        4.092086797226064e-12,
        1.9824825850098335e-12,
        3.525593957914199e-12,
        2.3833513620954525e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-6
    @test rmsd(w12, w22) < 1e-5
    @test rmsd(w13, w23) < 1e-5
    @test rmsd(w14, w24) < 1e-8
end

@testset "msv" begin
    println("Testing rm = :msv, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)

    rm = :msv

    w11 = [
        2.55758354864312e-11,
        0.049737933019557645,
        1.3014700073272225e-11,
        0.0029777224539362067,
        0.0025509059694021636,
        0.0201330430354537,
        8.397918006915536e-13,
        0.1280946321089455,
        2.270551221852937e-12,
        3.059427039464877e-12,
        0.29957704078280734,
        3.2275482148862498e-12,
        1.4589123785012587e-12,
        0.12069607876051516,
        0.012266320099222476,
        0.009663147476582737,
        1.610951395799657e-11,
        0.2292760516042169,
        2.8487748300041965e-12,
        0.12502712462095514,
    ]
    w12 = [
        1.9156653261040654e-10,
        0.05530892517886745,
        1.8207787819858364e-10,
        0.0042753961376044885,
        0.03390811748805293,
        1.7514163524383542e-10,
        2.1440183312559418e-11,
        0.12521696144034022,
        5.723675318626706e-11,
        6.48366010575146e-11,
        0.29837124853503444,
        3.3294773632339516e-11,
        1.931116699761228e-11,
        0.1072434224473909,
        0.0027603560012123274,
        0.021120535368443192,
        0.005355512144905968,
        0.22898955441834898,
        8.401612007629805e-11,
        0.11744997001087748,
    ]
    w13 = [
        9.607244670198283e-13,
        2.391137555008359e-12,
        1.8922378269442666e-12,
        1.1313327665810094e-12,
        0.6665999471445081,
        2.3334981438405056e-13,
        0.03791833955846937,
        1.9095293384972558e-12,
        2.353045340592011e-12,
        9.34156262240138e-13,
        2.472837754753188e-12,
        1.6272296653923608e-13,
        7.367793241732568e-14,
        5.990452133427442e-13,
        8.504687243647897e-14,
        0.17184265886747102,
        0.10259234079986289,
        2.5939306665781046e-12,
        0.02104671360990669,
        1.9890215642933244e-12,
    ]
    w14 = [
        5.1608094762415435e-11,
        5.207032566247801e-11,
        3.782701076683847e-11,
        5.7306423152006965e-11,
        4.454447352632455e-9,
        4.512526606836864e-11,
        0.9999999946698693,
        5.479796043404423e-11,
        5.86551194224155e-11,
        5.742197185891196e-11,
        5.541951271588821e-11,
        4.3846453202089875e-11,
        3.234749500702867e-11,
        5.2403775872871985e-11,
        3.4954868529747976e-11,
        5.234152591865969e-11,
        3.1546432022118925e-11,
        5.5618418746024516e-11,
        5.0220204576520237e-11,
        5.217247326479619e-11,
    ]
    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-6
    @test rmsd(w12, w22) < 1e-6
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        2.55758354864312e-11,
        0.049737933019557645,
        1.3014700073272225e-11,
        0.0029777224539362067,
        0.0025509059694021636,
        0.0201330430354537,
        8.397918006915536e-13,
        0.1280946321089455,
        2.270551221852937e-12,
        3.059427039464877e-12,
        0.29957704078280734,
        3.2275482148862498e-12,
        1.4589123785012587e-12,
        0.12069607876051516,
        0.012266320099222476,
        0.009663147476582737,
        1.610951395799657e-11,
        0.2292760516042169,
        2.8487748300041965e-12,
        0.12502712462095514,
    ]
    w12 = [
        1.2704782106128035e-10,
        0.05530881628945258,
        1.2075938661785783e-10,
        0.004275454549045597,
        0.033908000135876144,
        1.1615985361241391e-10,
        1.4219483963950566e-11,
        0.1252169293774202,
        3.79606854965062e-11,
        4.300146829448829e-11,
        0.2983713212474063,
        2.2081584317588234e-11,
        1.2807309112850566e-11,
        0.10724336239856848,
        0.0027604095390312148,
        0.021120538338028398,
        0.005355646795958502,
        0.228989580117213,
        5.5722225044495545e-11,
        0.11744994066223978,
    ]
    w13 = [
        7.363661351586077e-8,
        2.5705950610421285e-7,
        1.5197234482781846e-7,
        8.679910869526458e-8,
        0.6097126504003868,
        2.4051954018376768e-8,
        0.034203863970850804,
        3.339626976419743e-7,
        1.5196279932077877e-7,
        7.632901292676212e-8,
        9.369605182195306e-7,
        1.821082337461327e-8,
        1.3211663682035826e-8,
        5.252775532485843e-8,
        1.3774904974813092e-8,
        0.16942833134359192,
        0.11618307189855633,
        6.234070334872332e-7,
        0.07046906010764163,
        2.0841223639248495e-7,
    ]
    w14 = [
        6.447654712857413e-11,
        7.199507451731768e-11,
        8.900328403278313e-11,
        8.038228123266515e-11,
        0.8503236439995903,
        2.8907569848280577e-11,
        0.149676354886852,
        4.959868578848664e-11,
        7.731383671877374e-11,
        5.331876976568252e-11,
        4.7722068298258526e-11,
        2.9791247533839734e-11,
        2.1294956968522065e-11,
        3.8212094371935885e-11,
        2.1763484425926076e-11,
        1.4140214364103512e-10,
        9.942634321375959e-11,
        5.212681397049816e-11,
        8.283615974871166e-11,
        6.398646761762893e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1e-4
    @test rmsd(w13, w23) < 1.5e-2
    @test rmsd(w14, w24) < 1e-5

    w11 = [
        2.55758354864312e-11,
        0.049737933019557645,
        1.3014700073272225e-11,
        0.0029777224539362067,
        0.0025509059694021636,
        0.0201330430354537,
        8.397918006915536e-13,
        0.1280946321089455,
        2.270551221852937e-12,
        3.059427039464877e-12,
        0.29957704078280734,
        3.2275482148862498e-12,
        1.4589123785012587e-12,
        0.12069607876051516,
        0.012266320099222476,
        0.009663147476582737,
        1.610951395799657e-11,
        0.2292760516042169,
        2.8487748300041965e-12,
        0.12502712462095514,
    ]
    w12 = [
        1.0869636665019237e-9,
        0.055189038801229384,
        1.036666634724481e-9,
        0.004437455383514737,
        0.03376639170501625,
        1.002048945961556e-9,
        1.2093682073975915e-10,
        0.12529118361655533,
        3.216828095668146e-10,
        3.6718397781408777e-10,
        0.2984002607982874,
        1.8732526662903816e-10,
        1.0884847693179967e-10,
        0.10741595040130675,
        0.002730634116446955,
        0.02106510835154312,
        0.0053525640221985605,
        0.22884015349994202,
        4.71643878713438e-10,
        0.11751125460065905,
    ]
    w13 = [
        2.427772859467267e-9,
        6.374404209825435e-9,
        4.730657999754549e-9,
        2.9305572867804203e-9,
        0.6079706108644816,
        8.070511714421598e-10,
        0.03578597555791761,
        5.987700937219431e-9,
        4.804544054084032e-9,
        2.420934715094821e-9,
        8.26404914320616e-9,
        6.367643511127184e-10,
        4.5854724188179494e-10,
        1.6347734766722213e-9,
        4.771538041253759e-10,
        0.16672161304707145,
        0.13732281060305965,
        7.964582581007634e-9,
        0.052198934636586085,
        5.371389733037639e-9,
    ]
    w14 = [
        2.372567339579673e-12,
        2.769343808491492e-12,
        3.450523690582476e-12,
        3.037652170506673e-12,
        0.853395144817874,
        1.0233579127715154e-12,
        0.14660485514075286,
        1.8423792083391256e-12,
        3.021317261414211e-12,
        1.9710723229578766e-12,
        1.8321553750679943e-12,
        1.0360765732858033e-12,
        7.238504663351113e-13,
        1.3785475292246846e-12,
        7.393585991081788e-13,
        4.191347610684789e-12,
        4.092086797226064e-12,
        1.9824825850098335e-12,
        3.525593957914199e-12,
        2.3833513620954525e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1e-7
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-8
end

@testset "flpm" begin
    println("Testing rm = :flpm, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 1)),
        ),
    )
    asset_statistics!(port)
    rm = :flpm

    w11 = [
        0.004266104170212475,
        0.04362179170407835,
        0.019960459298168455,
        0.007822769475608627,
        0.06052525617915513,
        1.4669228261368196e-12,
        0.00039596201057354153,
        0.13089268135668963,
        3.9610625266004783e-13,
        0.011878930759598547,
        0.20660964182727393,
        2.3577313221584285e-14,
        2.316805525860719e-14,
        0.0832948051848743,
        7.763336649709251e-14,
        0.013888096835933667,
        0.08734726460706164,
        0.1921003416581416,
        0.037213209126096373,
        0.1001826858045464,
    ]
    w12 = [
        3.97703723716329e-11,
        0.04213913352837321,
        0.012527562902683436,
        0.007205814358280906,
        0.09868075643555277,
        3.3465297249225032e-12,
        0.002773008726661481,
        0.10921155672499787,
        1.0110450839450292e-11,
        3.1329247819452524e-11,
        0.20154701424960908,
        9.672037716402015e-13,
        1.0503656341541338e-12,
        0.02654257492720819,
        1.726495529519959e-12,
        0.04173133597987413,
        0.11080124113039533,
        0.17232503202458582,
        0.0680011026628178,
        0.10651386626065946,
    ]
    w13 = [
        1.876923604420911e-15,
        9.44002949390975e-15,
        9.555029218396679e-15,
        4.530289570532286e-15,
        0.6999125313283426,
        1.184517271080013e-15,
        0.02929583116603214,
        6.387837166227903e-15,
        1.277182187796183e-14,
        4.1233562555874204e-15,
        9.707954733795156e-15,
        1.741986055403713e-15,
        2.083095182300139e-15,
        2.7698865307518983e-16,
        1.9698445297849096e-15,
        0.1518116450016806,
        0.04226454249441166,
        8.852368865865114e-15,
        0.07671545000944742,
        1.1102518515252822e-14,
    ]
    w14 = [
        5.3529747667019664e-11,
        5.398065147651168e-11,
        3.9028457439044154e-11,
        5.938482214023437e-11,
        2.985084905390435e-9,
        4.6954283924602456e-11,
        0.9999999961065184,
        5.692625044494419e-11,
        6.08405012326576e-11,
        5.96478985101771e-11,
        5.758412273517798e-11,
        4.560417554870693e-11,
        3.3631448559961506e-11,
        5.4484530383739083e-11,
        3.6359927660111094e-11,
        5.4059907555460024e-11,
        3.246534109619667e-11,
        5.778004677413067e-11,
        5.202256867147806e-11,
        5.4112166262118535e-11,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-10
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1e-9
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        0.004266104170212475,
        0.04362179170407835,
        0.019960459298168455,
        0.007822769475608627,
        0.06052525617915513,
        1.4669228261368196e-12,
        0.00039596201057354153,
        0.13089268135668963,
        3.9610625266004783e-13,
        0.011878930759598547,
        0.20660964182727393,
        2.3577313221584285e-14,
        2.316805525860719e-14,
        0.0832948051848743,
        7.763336649709251e-14,
        0.013888096835933667,
        0.08734726460706164,
        0.1921003416581416,
        0.037213209126096373,
        0.1001826858045464,
    ]
    w12 = [
        5.583524145162717e-11,
        0.042139131566751614,
        0.012527565127180097,
        0.007205814264460682,
        0.09868076274396621,
        5.079770317558342e-12,
        0.0027730065736920745,
        0.10921155768918284,
        1.4432537415666022e-11,
        4.53025962972074e-11,
        0.20154701506863107,
        1.4433519561270054e-12,
        1.5579686462387685e-12,
        0.026542585747955857,
        2.5733482555695855e-12,
        0.04173133433050141,
        0.11080122934388514,
        0.17232504372822366,
        0.06800109290200503,
        0.10651386078733938,
    ]
    w13 = [
        2.1920178421710392e-11,
        5.871292779778813e-11,
        6.784485956061595e-11,
        2.9339662203650365e-11,
        0.5637246782282297,
        7.174156177673923e-12,
        0.02602976749408832,
        7.411248211706471e-11,
        4.816744519592941e-11,
        2.7354806203999625e-11,
        4.414702337752316e-10,
        4.584962845266257e-12,
        3.5555053488206943e-12,
        1.3597531119516564e-11,
        3.956978044277948e-12,
        0.14917727787214147,
        0.12978985558886494,
        1.4933861215413567e-10,
        0.13127841977613147,
        8.941372634471405e-11,
    ]
    w14 = [
        6.51401905922968e-11,
        7.274141214004412e-11,
        8.993569677451936e-11,
        8.1222859747114e-11,
        0.8503236618406598,
        2.9195437580839036e-11,
        0.14967633703417974,
        5.0102312572015986e-11,
        7.812833399015634e-11,
        5.386655366310768e-11,
        4.820499079289575e-11,
        3.009097205219429e-11,
        2.1507807110106056e-11,
        3.859674681800695e-11,
        2.1978678073308094e-11,
        1.4296384229108385e-10,
        1.0047390918688235e-10,
        5.2657548652916866e-11,
        8.370808928591076e-11,
        6.464514743714907e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 4e-3
    @test rmsd(w13, w23) < 1e-10
    @test rmsd(w14, w24) < 1e-10

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-6
    @test rmsd(w12, w22) < 4e-3
    @test rmsd(w13, w23) < 1.3e-2
    @test rmsd(w14, w24) < 1e-3
end

@testset "slpm" begin
    println("Testing rm = :slpm, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 1)),
        ),
    )
    asset_statistics!(port)
    rm = :slpm

    w11 = [
        9.734843743565922e-12,
        0.055245392174630495,
        9.265028500708643e-12,
        0.004319524740807712,
        0.03359645164504849,
        9.099457127650289e-12,
        1.0768073011057016e-12,
        0.12478083345794555,
        3.049353991287137e-12,
        3.4056535380734585e-12,
        0.3005646161459586,
        1.7918175719497817e-12,
        1.0076213333193919e-12,
        0.1066186362177196,
        0.003124151746210445,
        0.021391627262487112,
        0.0035938741203482647,
        0.2296514023036259,
        4.481963078085049e-12,
        0.11711349014230511,
    ]
    w12 = [
        5.905676944843912e-11,
        0.055105218383047244,
        7.218883740512182e-11,
        0.00042392114085447376,
        0.06590323402369498,
        3.14960977480048e-11,
        1.6375168320853316e-11,
        0.11928808515085303,
        4.211302584089351e-11,
        4.0145000636314516e-11,
        0.29373864011411,
        1.3600594278497308e-11,
        8.276682729550648e-12,
        0.07604809144606464,
        4.424145671310857e-11,
        0.03452496050911095,
        0.028236087800952582,
        0.2232046896140672,
        8.642217888728471e-11,
        0.10352707140332928,
    ]
    w13 = [
        1.0710633714502649e-12,
        2.651921538531967e-12,
        2.0543597788242345e-12,
        1.2310099909488965e-12,
        0.6654370457201403,
        2.605874910950091e-13,
        0.038071850442216205,
        2.158192329691087e-12,
        2.5720301013859423e-12,
        1.0201554894185877e-12,
        2.7640725345768247e-12,
        1.861704830545739e-13,
        8.469611916760072e-14,
        6.752933893403868e-13,
        9.640673819222276e-14,
        0.17459159243171005,
        0.10411304234874887,
        2.9044283963889756e-12,
        0.01778646903526312,
        2.1909333503726834e-12,
    ]
    w14 = [
        5.3529747667019664e-11,
        5.398065147651168e-11,
        3.9028457439044154e-11,
        5.938482214023437e-11,
        2.985084905390435e-9,
        4.6954283924602456e-11,
        0.9999999961065184,
        5.692625044494419e-11,
        6.08405012326576e-11,
        5.96478985101771e-11,
        5.758412273517798e-11,
        4.560417554870693e-11,
        3.3631448559961506e-11,
        5.4484530383739083e-11,
        3.6359927660111094e-11,
        5.4059907555460024e-11,
        3.246534109619667e-11,
        5.778004677413067e-11,
        5.202256867147806e-11,
        5.4112166262118535e-11,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1e-7
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1e-8

    w11 = [
        9.734843743565922e-12,
        0.055245392174630495,
        9.265028500708643e-12,
        0.004319524740807712,
        0.03359645164504849,
        9.099457127650289e-12,
        1.0768073011057016e-12,
        0.12478083345794555,
        3.049353991287137e-12,
        3.4056535380734585e-12,
        0.3005646161459586,
        1.7918175719497817e-12,
        1.0076213333193919e-12,
        0.1066186362177196,
        0.003124151746210445,
        0.021391627262487112,
        0.0035938741203482647,
        0.2296514023036259,
        4.481963078085049e-12,
        0.11711349014230511,
    ]
    w12 = [
        1.1241040489662525e-10,
        0.055105171737783495,
        1.3740898813638443e-10,
        0.0004239387860984131,
        0.0659032660971727,
        5.995002680896056e-11,
        3.116853243441848e-11,
        0.11928810428288263,
        8.015803048054586e-11,
        7.64130505287999e-11,
        0.2937386038028337,
        2.588739157768177e-11,
        1.5753853550298096e-11,
        0.07604804636797598,
        8.420999595356769e-11,
        0.03452498400561177,
        0.028236118490406917,
        0.22320471419933216,
        1.6449779683791834e-10,
        0.10352705144204402,
    ]
    w13 = [
        1.5382627441031582e-10,
        4.744951793870768e-10,
        2.9083004636740804e-10,
        1.7914988332240976e-10,
        0.5737564396681322,
        5.04872533532364e-11,
        0.02956614173266077,
        6.165744335121019e-10,
        2.632484889520154e-10,
        1.5354888576012826e-10,
        1.3684758947668124e-9,
        3.907906778003871e-11,
        2.8346176535886915e-11,
        1.0876657779774813e-10,
        2.940619749942788e-11,
        0.16718960426117846,
        0.15962973783229092,
        8.854133625684913e-10,
        0.0698580714648303,
        3.9925951529603846e-10,
    ]
    w14 = [
        7.218059688369303e-11,
        8.056321810868184e-11,
        9.953296527918561e-11,
        8.990269945575493e-11,
        0.8503236604178088,
        3.243077267816855e-11,
        0.1496763383363862,
        5.557003210699212e-11,
        8.643332320168008e-11,
        5.969683381679134e-11,
        5.3478278738193595e-11,
        3.3401669738623014e-11,
        2.3890260936160026e-11,
        4.283705837053415e-11,
        2.443067918443955e-11,
        1.5766969562016922e-10,
        1.1115221346582016e-10,
        5.839312211726877e-11,
        9.261053062837624e-11,
        7.163097741826096e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1.5e-4
    @test rmsd(w13, w23) < 1e-10
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        0.004266104170212475,
        0.04362179170407835,
        0.019960459298168455,
        0.007822769475608627,
        0.06052525617915513,
        1.4669228261368196e-12,
        0.00039596201057354153,
        0.13089268135668963,
        3.9610625266004783e-13,
        0.011878930759598547,
        0.20660964182727393,
        2.3577313221584285e-14,
        2.316805525860719e-14,
        0.0832948051848743,
        7.763336649709251e-14,
        0.013888096835933667,
        0.08734726460706164,
        0.1921003416581416,
        0.037213209126096373,
        0.1001826858045464,
    ]
    w12 = [
        5.366943379001608e-9,
        0.037685257234435575,
        0.015475261449440647,
        0.008116632652606873,
        0.09893828295115893,
        3.6741917420142557e-10,
        0.002533108099369867,
        0.10486352409926158,
        1.0817154460311678e-9,
        3.502277841381867e-9,
        0.20310196149743928,
        1.0079014838622261e-10,
        1.0701726983355811e-10,
        0.035552354824832065,
        1.7874131295885733e-10,
        0.03730691016280064,
        0.10541166388792744,
        0.1786179249226791,
        0.0624840388163108,
        0.1099130686968325,
    ]
    w13 = [
        2.039188294486064e-9,
        5.048458542242682e-9,
        5.421379567488297e-9,
        2.941564579072603e-9,
        0.6065808866779807,
        6.869768753641578e-10,
        0.028287238295437254,
        4.467607312036331e-9,
        5.382327186082125e-9,
        2.411810008366047e-9,
        7.11392756683615e-9,
        4.690206350403667e-10,
        3.554206535948382e-10,
        1.242614201364564e-9,
        3.853001141584733e-10,
        0.14977655653657573,
        0.1082455171784687,
        6.430554936785963e-9,
        0.10710975085009784,
        6.065289355076913e-9,
    ]
    w14 = [
        8.464106423945461e-13,
        9.53841045161041e-13,
        1.1872996296829948e-12,
        1.0663212593506019e-12,
        0.8533951448523589,
        3.6129321116430966e-13,
        0.14660485513294397,
        6.433174401880225e-13,
        1.0350079073877415e-12,
        6.958897637913575e-13,
        6.178225638101201e-13,
        3.743294644932179e-13,
        2.6115447196553085e-13,
        4.875692540542846e-13,
        2.6591775306822504e-13,
        1.9123353345067804e-12,
        1.3487854956949795e-12,
        6.787915725876882e-13,
        1.1184001779704939e-12,
        8.426196746306771e-13,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 4e-2
    @test rmsd(w12, w22) < 4e-2
    @test rmsd(w13, w23) < 1.6e-2
    @test rmsd(w14, w24) < 1e-8
end

@testset "wr" begin
    println("Testing rm = :wr, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 1)),
        ),
    )
    asset_statistics!(port)
    rm = :wr

    w11 = [
        1.5872117599818181e-12,
        0.22119704093179035,
        2.7460744440299463e-12,
        8.760783938755109e-12,
        2.42796997026455e-11,
        4.153621663627526e-12,
        0.02918541160594417,
        4.6506478406695e-12,
        2.5706293424936534e-12,
        5.068814556141634e-12,
        0.545516556476523,
        6.062817157637105e-13,
        2.9662912155824217e-12,
        1.031358077466878e-12,
        1.0810184999857832e-9,
        3.4809641727814008e-12,
        1.1123583810364371e-11,
        2.28985847538167e-12,
        3.3954259268973147e-12,
        0.20410098982601288,
    ]
    w12 = [
        3.560271431548733e-12,
        0.2211970386593474,
        3.059641331261165e-12,
        1.8513954627393046e-12,
        4.855396500761436e-12,
        2.249088265017882e-12,
        0.02918541185511367,
        3.1662278504445505e-12,
        2.193191628560586e-12,
        2.1134156752419318e-12,
        0.5455165570204782,
        1.0808200666307882e-12,
        1.1402263376615155e-12,
        1.6268062260262784e-12,
        1.3432415726654499e-11,
        5.712610404244119e-12,
        4.996863571198007e-12,
        2.50876282906927e-12,
        2.2061293672236323e-12,
        0.20410099240930754,
    ]
    w13 = [
        2.5249282417299593e-12,
        6.989609320130095e-12,
        2.273164837384381e-12,
        4.030282074065242e-12,
        0.3797661697236015,
        3.693030786466783e-13,
        0.17660513859783303,
        3.2050070941789235e-12,
        3.4383509435362943e-12,
        0.040750909622561456,
        0.05638227444983319,
        3.946602613760457e-13,
        1.9709649688509545e-14,
        2.5981044526983304e-12,
        2.8723207504665393e-13,
        0.1585473448927049,
        0.18794816267268055,
        3.6155144948511706e-12,
        9.321661877136584e-12,
        1.717866934662681e-12,
    ]
    w14 = [
        1.7959854306408767e-12,
        1.7156481414042887e-12,
        1.2771013362498924e-12,
        1.4834517685526053e-12,
        2.4173240009633934e-10,
        1.4999073050992992e-12,
        0.9999999997299931,
        1.8841529140028033e-12,
        1.6272444266391985e-12,
        1.9083773025285005e-12,
        1.8700985786185693e-12,
        1.5553736088431574e-12,
        1.2484132458499945e-12,
        1.7382976188005103e-12,
        1.2781860831397474e-12,
        9.01786461024123e-13,
        1.183246640619779e-12,
        1.9014146908574295e-12,
        1.5581671397691983e-12,
        1.847450196180598e-12,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-9
    @test rmsd(w12, w22) < 1e-10
    @test rmsd(w13, w23) < 1e-10
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        1.5872117599818181e-12,
        0.22119704093179035,
        2.7460744440299463e-12,
        8.760783938755109e-12,
        2.42796997026455e-11,
        4.153621663627526e-12,
        0.02918541160594417,
        4.6506478406695e-12,
        2.5706293424936534e-12,
        5.068814556141634e-12,
        0.545516556476523,
        6.062817157637105e-13,
        2.9662912155824217e-12,
        1.031358077466878e-12,
        1.0810184999857832e-9,
        3.4809641727814008e-12,
        1.1123583810364371e-11,
        2.28985847538167e-12,
        3.3954259268973147e-12,
        0.20410098982601288,
    ]
    w12 = [
        5.580118825542006e-12,
        0.22119703872625918,
        5.833275701497547e-12,
        3.9356989124554925e-11,
        1.6652924492694228e-11,
        1.4531635293386055e-11,
        0.029185411802843234,
        1.5084072253204066e-11,
        5.253374561521923e-12,
        8.812347870425367e-12,
        0.5455165569799576,
        3.5800226333485165e-12,
        9.296190283320398e-12,
        4.963437479493972e-12,
        6.630418990866132e-11,
        1.0929402734492203e-11,
        3.283613803392497e-11,
        6.620394448355113e-12,
        6.303108776951111e-12,
        0.20410099223900247,
    ]
    w13 = [
        3.999083476616732e-9,
        2.8780832136796113e-8,
        3.201044912321686e-9,
        7.364193078023599e-9,
        0.37976614060599495,
        1.0996123653630493e-9,
        0.17660512637564443,
        7.332034223940026e-9,
        5.17433543394314e-9,
        0.04075088649799189,
        0.056382248000272014,
        1.3378845498290765e-9,
        7.017547192890002e-10,
        8.443080003112706e-9,
        1.2178573036750075e-9,
        0.15854733762603024,
        0.18794816432764888,
        7.050239510025053e-9,
        1.7124171816281148e-8,
        3.740293885250038e-9,
    ]
    w14 = [
        5.432491017337578e-10,
        6.088877217065151e-10,
        7.568888313805797e-10,
        6.829362461973679e-10,
        0.8503254122959001,
        2.3943626149029237e-10,
        0.14967457826143366,
        4.1500086957672766e-10,
        6.593731940823428e-10,
        4.4880242354909025e-10,
        3.9860209517794684e-10,
        2.479958142645432e-10,
        1.7655956953068637e-10,
        3.182809897936625e-10,
        1.795357817956996e-10,
        1.2368513808641989e-9,
        8.481233016212245e-10,
        4.367623435601381e-10,
        7.062017525713229e-10,
        5.391785591969758e-10,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1.5e-4
    @test rmsd(w13, w23) < 1e-7
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        1.5872117599818181e-12,
        0.22119704093179035,
        2.7460744440299463e-12,
        8.760783938755109e-12,
        2.42796997026455e-11,
        4.153621663627526e-12,
        0.02918541160594417,
        4.6506478406695e-12,
        2.5706293424936534e-12,
        5.068814556141634e-12,
        0.545516556476523,
        6.062817157637105e-13,
        2.9662912155824217e-12,
        1.031358077466878e-12,
        1.0810184999857832e-9,
        3.4809641727814008e-12,
        1.1123583810364371e-11,
        2.28985847538167e-12,
        3.3954259268973147e-12,
        0.20410098982601288,
    ]
    w12 = [
        7.45989992711553e-12,
        0.22119703935082163,
        1.2129605506189624e-11,
        3.030619355618286e-11,
        5.130838714873081e-11,
        1.5193888909346986e-11,
        0.029185411828414175,
        1.5638488715182897e-11,
        1.2468753956520241e-11,
        1.4635748676102266e-11,
        0.545516556818022,
        5.0611334298293105e-12,
        9.691820170210439e-12,
        7.496507459625859e-12,
        1.4996790132973115e-10,
        1.3336869774187548e-11,
        3.6802565605001553e-11,
        9.645249385748878e-12,
        1.3380874125869641e-11,
        0.20410099159821812,
    ]
    w13 = [
        1.9829182115492817e-10,
        6.620856343474973e-10,
        1.5786279568215212e-10,
        3.1883061547143337e-10,
        0.37976617050877287,
        5.563110615358895e-11,
        0.17660513696675353,
        3.1906755895221523e-10,
        2.8586380930272815e-10,
        0.040750907805173445,
        0.056382272517820534,
        5.867118305299877e-11,
        3.5930256458744575e-11,
        2.642012788113992e-10,
        5.80493968369723e-11,
        0.15854734516583013,
        0.1879481629272116,
        3.586456944045736e-10,
        1.199359003210698e-9,
        1.3594766555055647e-10,
    ]
    w14 = [
        2.2214447250728438e-12,
        2.5454915608984357e-12,
        3.2228182522120352e-12,
        2.9236350294530333e-12,
        0.853395144873137,
        8.398455809331968e-13,
        0.1466048550886921,
        1.5747499898192399e-12,
        2.7952455160063363e-12,
        1.7346016644847664e-12,
        1.4968040241016079e-12,
        8.72177328997753e-13,
        6.36222713719807e-13,
        1.1407125376912396e-12,
        6.374402567087384e-13,
        5.02661761490207e-12,
        3.618879541395566e-12,
        1.6774741223781233e-12,
        3.0129758027187774e-12,
        2.1939477909300844e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-9
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1e-8
end

@testset "cvar" begin
    println("Testing rm = :cvar, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS =>
                Dict(:solver => ECOS.Optimizer, :params => Dict("verbose" => false)),
            :COSMO => Dict(:solver => COSMO.Optimizer),
            :Clarabel => Dict(:solver => Clarabel.Optimizer),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 1)),
        ),
    )
    asset_statistics!(port)
    rm = :cvar

    w11 = [
        2.303134652727294e-13,
        0.04242033344689568,
        2.2560723197168515e-13,
        5.879677806934238e-13,
        0.00757402780230305,
        2.3254133834035285e-13,
        2.137006070885132e-14,
        0.09464947869391295,
        9.5745671879576e-14,
        1.2881104140338158e-13,
        0.3040110655982685,
        1.2263136596657544e-13,
        5.45900791459912e-14,
        0.06564167131742486,
        2.0400196887884809e-13,
        0.029371611103182725,
        2.426150553645928e-13,
        0.3663101128910502,
        1.2705737244784516e-13,
        0.0900216991446889,
    ]
    w12 = [
        2.7548924145067353e-12,
        0.036359165797018506,
        2.4593262619968404e-12,
        8.082040204696044e-12,
        0.01717734834554079,
        2.552923489640131e-12,
        4.5149908101297456e-13,
        0.09164255516352998,
        1.2849261042143455e-12,
        1.4615907979630983e-12,
        0.32258428845565756,
        1.2430706489478934e-12,
        7.266810569848359e-13,
        0.03955071305075278,
        2.1699297437998916e-12,
        0.03091937834243328,
        3.2957346960749036e-12,
        0.37332984206148495,
        1.587025068411895e-12,
        0.08843670875551242,
    ]
    w13 = [
        2.27808798340481e-14,
        3.9771469177560906e-14,
        5.1934421313554014e-14,
        1.514276585711131e-14,
        0.5628454293454889,
        1.6738404571264975e-14,
        0.04434184295741817,
        1.0098965813453761e-13,
        4.276588411855481e-14,
        5.074743635238302e-15,
        7.67170461851457e-14,
        1.8117849009016032e-14,
        2.388234773936646e-14,
        2.6096030468732262e-15,
        2.4399823832566055e-14,
        0.20959173458768757,
        0.1832209931085117,
        1.1316968761107113e-13,
        2.683466231053402e-13,
        7.123753568969862e-14,
    ]
    w14 = [
        5.152273955249736e-11,
        5.197813415202082e-11,
        3.769639077745766e-11,
        5.720033360276275e-11,
        4.1856645151623315e-9,
        4.509891998252037e-11,
        0.9999999949400076,
        5.4745257607000495e-11,
        5.855899562059385e-11,
        5.736300095386456e-11,
        5.536978956261922e-11,
        4.381613412623681e-11,
        3.2327676722967096e-11,
        5.2366249771619416e-11,
        3.493451254347115e-11,
        5.217368209578132e-11,
        3.140615455370963e-11,
        5.556211964812391e-11,
        5.011464681628099e-11,
        5.20932177761396e-11,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-11
    @test rmsd(w12, w22) < 1e-9
    @test rmsd(w13, w23) < 1e-11
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        2.303134652727294e-13,
        0.04242033344689568,
        2.2560723197168515e-13,
        5.879677806934238e-13,
        0.00757402780230305,
        2.3254133834035285e-13,
        2.137006070885132e-14,
        0.09464947869391295,
        9.5745671879576e-14,
        1.2881104140338158e-13,
        0.3040110655982685,
        1.2263136596657544e-13,
        5.45900791459912e-14,
        0.06564167131742486,
        2.0400196887884809e-13,
        0.029371611103182725,
        2.426150553645928e-13,
        0.3663101128910502,
        1.2705737244784516e-13,
        0.0900216991446889,
    ]
    w12 = [
        3.901389196720429e-11,
        0.036359167344902056,
        3.871435968505127e-11,
        1.2956334498057992e-10,
        0.01717734945422618,
        3.640854067607285e-11,
        6.540525080510947e-12,
        0.09164255746184724,
        2.0849167049660003e-11,
        2.3240324850316875e-11,
        0.3225842755340019,
        1.991626464471255e-11,
        1.1263417343482922e-11,
        0.03955071896162385,
        3.7028392830986467e-11,
        0.030919377880693818,
        4.812427503923967e-11,
        0.37332984167627487,
        2.5967158513110906e-11,
        0.08843671124980043,
    ]
    w13 = [
        9.248469965923031e-9,
        1.3906018526509056e-8,
        1.2668796300024209e-8,
        8.702857504711827e-9,
        0.5593115737357834,
        2.917223597832455e-9,
        0.029474953334083825,
        1.8590253529694341e-7,
        1.0584028972234713e-8,
        6.341342591015511e-9,
        4.0564908724766405e-8,
        2.54958359092519e-9,
        1.712875005001451e-9,
        5.616527190888435e-9,
        1.7681063630272971e-9,
        0.20296964510473753,
        0.2082432909638256,
        1.1771121720685817e-7,
        8.661971978368329e-8,
        3.0047359022582616e-8,
    ]
    w14 = [
        6.407064851238897e-11,
        7.154417226653421e-11,
        8.845011061977296e-11,
        7.988197742640806e-11,
        0.8503236439412061,
        2.8720964009681457e-11,
        0.1496763549521902,
        4.9283402050981806e-11,
        7.683519547180937e-11,
        5.298263419371677e-11,
        4.741798203501393e-11,
        2.960032072307228e-11,
        2.1157547772592066e-11,
        3.796755892069836e-11,
        2.162204483249587e-11,
        1.405552206249925e-10,
        9.881091300043403e-11,
        5.179609682439249e-11,
        8.232307798705996e-11,
        6.358371799699763e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-11
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        2.303134652727294e-13,
        0.04242033344689568,
        2.2560723197168515e-13,
        5.879677806934238e-13,
        0.00757402780230305,
        2.3254133834035285e-13,
        2.137006070885132e-14,
        0.09464947869391295,
        9.5745671879576e-14,
        1.2881104140338158e-13,
        0.3040110655982685,
        1.2263136596657544e-13,
        5.45900791459912e-14,
        0.06564167131742486,
        2.0400196887884809e-13,
        0.029371611103182725,
        2.426150553645928e-13,
        0.3663101128910502,
        1.2705737244784516e-13,
        0.0900216991446889,
    ]
    w12 = [
        4.619652900809258e-11,
        0.036359181702277345,
        4.567868530205557e-11,
        1.535693864641901e-10,
        0.01717734054145095,
        4.317662540103457e-11,
        7.732997861072141e-12,
        0.09164255790625052,
        2.4542973162652893e-11,
        2.750093897975244e-11,
        0.32258422434562267,
        2.341204509979607e-11,
        1.3296342203092745e-11,
        0.03955073570081477,
        4.459084506586277e-11,
        0.030919378085716848,
        5.698511415879638e-11,
        0.3733298473737275,
        3.060116587468088e-11,
        0.08843673382685575,
    ]
    w13 = [
        3.8545685729666835e-10,
        5.592942794436413e-10,
        6.167673692826263e-10,
        3.389405573886444e-10,
        0.562270214633016,
        1.229763320980819e-10,
        0.041921692832627776,
        1.1705453923513893e-9,
        5.008459377062156e-10,
        2.68632339497541e-10,
        1.1673754279984465e-9,
        1.130667604574582e-10,
        7.449945196456532e-11,
        2.285445606805847e-10,
        7.673264675361186e-11,
        0.20851374053679536,
        0.1872943421590053,
        1.2552113375430242e-9,
        2.156007168445332e-9,
        8.036591855912093e-10,
    ]
    w14 = [
        3.5417734327410802e-12,
        4.012191134390014e-12,
        5.004219622080099e-12,
        4.480615548386929e-12,
        0.8533951448549584,
        1.5154165972083055e-12,
        0.14660485508355525,
        2.6967059397037035e-12,
        4.357606295122794e-12,
        2.9147323855324295e-12,
        2.6103783523309775e-12,
        1.5655944256000861e-12,
        1.0921489055281942e-12,
        2.042525560663503e-12,
        1.1121951106451e-12,
        7.703092052941846e-12,
        5.689252206869037e-12,
        2.8573540674297534e-12,
        4.769579735749646e-12,
        3.5209346491164276e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-7
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1e-8
end

@testset "evar" begin
    println("Testing rm = :evar, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 200),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :evar

    w11 = [
        2.3010332937056324e-5,
        0.15904585435949511,
        1.9466595990956338e-5,
        0.01633520792118815,
        2.5449936092232598e-5,
        0.00011588683539808774,
        0.015339264469876133,
        0.1549916981169939,
        1.843005652452624e-5,
        2.0025819790224893e-5,
        0.4526592005243169,
        1.634814762506855e-5,
        2.475704699222494e-5,
        3.763276839876931e-5,
        0.004169221826305033,
        0.0002584312109083365,
        0.015516948227763287,
        0.00016834457761860904,
        2.3068531181638514e-5,
        0.1811917526946038,
    ]
    w12 = [
        7.764316037289316e-9,
        0.1513987651581381,
        6.6931398915977e-9,
        0.020421294226148183,
        9.73743511402055e-9,
        2.3826337632147742e-8,
        0.01722231388670238,
        0.15323487083507017,
        6.341129824521381e-9,
        6.945031403755022e-9,
        0.4464508152608372,
        5.248720283090065e-9,
        6.916440813172021e-9,
        1.2524728037154376e-8,
        1.0490108231508911e-7,
        3.8175293262760857e-7,
        0.02761804576300884,
        6.271388103407004e-8,
        8.081265106185231e-9,
        0.18365325142365505,
    ]
    w13 = [
        3.076508751529447e-8,
        9.277077352505919e-9,
        3.3148660421548246e-8,
        2.4208446607157443e-8,
        0.5367723899818512,
        1.356870169870626e-7,
        0.13762177716967672,
        2.1540712490549928e-8,
        3.448560220321819e-8,
        4.170353478994931e-8,
        1.6444447189432472e-8,
        1.37303315455866e-7,
        2.0076520038710387e-7,
        5.436589531217834e-8,
        1.8278300815340426e-7,
        0.18389339314791642,
        0.1417114521759636,
        1.806081806104358e-8,
        1.0611895955842585e-8,
        3.637387306368509e-8,
    ]
    w14 = [
        4.732587949531317e-11,
        4.9806119822412933e-11,
        5.95821742305601e-11,
        5.535634453627276e-11,
        3.458816523090677e-9,
        2.4028811539018406e-11,
        0.9999999957781234,
        3.626071166523671e-11,
        5.210197729169735e-11,
        3.929339808672974e-11,
        3.528663694328443e-11,
        2.5333408613328912e-11,
        1.858696725887365e-11,
        3.007989177316934e-11,
        1.9188881417893284e-11,
        7.25553669978091e-11,
        6.155452199676112e-11,
        3.789054139559595e-11,
        5.363293798393116e-11,
        4.5195415964148415e-11,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-3
    @test rmsd(w12, w22) < 1e-6
    @test rmsd(w13, w23) < 1e-3
    @test rmsd(w14, w24) < 1e-7

    w11 = [
        2.3010332937056324e-5,
        0.15904585435949511,
        1.9466595990956338e-5,
        0.01633520792118815,
        2.5449936092232598e-5,
        0.00011588683539808774,
        0.015339264469876133,
        0.1549916981169939,
        1.843005652452624e-5,
        2.0025819790224893e-5,
        0.4526592005243169,
        1.634814762506855e-5,
        2.475704699222494e-5,
        3.763276839876931e-5,
        0.004169221826305033,
        0.0002584312109083365,
        0.015516948227763287,
        0.00016834457761860904,
        2.3068531181638514e-5,
        0.1811917526946038,
    ]
    w12 = [
        4.076362009442859e-8,
        0.15140502026410385,
        3.514701860253866e-8,
        0.02042091252708798,
        5.114683996032453e-8,
        1.2503221108629294e-7,
        0.017220719804414565,
        0.15322901011669066,
        3.3293806651945786e-8,
        3.646735897908761e-8,
        0.44645252415219394,
        2.7554486250213578e-8,
        3.632961532000158e-8,
        6.567476329734442e-8,
        5.469793714134177e-7,
        1.9611395486144403e-6,
        0.027608911247304718,
        3.2719931468864686e-7,
        4.24284540573486e-8,
        0.18365957273179523,
    ]
    w13 = [
        1.472729878979434e-7,
        1.0650700636223798e-6,
        1.339498448799022e-7,
        1.8549785111314984e-7,
        0.4916872630935656,
        3.252815170762038e-8,
        0.11118631530182936,
        5.426841283706828e-7,
        1.295474973227387e-7,
        1.1277334635718631e-7,
        9.970470090008889e-7,
        3.049912018398635e-8,
        2.039131263463318e-8,
        8.934038321740165e-8,
        2.2763786662346187e-8,
        0.18070116534217698,
        0.21642042243281093,
        4.734027143294267e-7,
        7.045013864675675e-7,
        1.465600332575276e-7,
    ]
    w14 = [
        6.83323119872969e-10,
        7.616689703304776e-10,
        9.105479364408012e-10,
        8.591436569668001e-10,
        0.8503244622653177,
        3.4620187410684163e-10,
        0.14967552562127506,
        5.549786987897421e-10,
        8.527038490066765e-10,
        6.012853786565789e-10,
        5.360463330580118e-10,
        3.567847079416162e-10,
        2.626379556300326e-10,
        4.4413215058670634e-10,
        2.6589856189575143e-10,
        1.517040468187833e-9,
        1.0082324234767702e-9,
        5.791402036610941e-10,
        8.900853861429578e-10,
        6.835558188589269e-10,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-3
    @test rmsd(w12, w22) < 1e-4
    @test rmsd(w13, w23) < 3.5e-3
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        2.3010332937056324e-5,
        0.15904585435949511,
        1.9466595990956338e-5,
        0.01633520792118815,
        2.5449936092232598e-5,
        0.00011588683539808774,
        0.015339264469876133,
        0.1549916981169939,
        1.843005652452624e-5,
        2.0025819790224893e-5,
        0.4526592005243169,
        1.634814762506855e-5,
        2.475704699222494e-5,
        3.763276839876931e-5,
        0.004169221826305033,
        0.0002584312109083365,
        0.015516948227763287,
        0.00016834457761860904,
        2.3068531181638514e-5,
        0.1811917526946038,
    ]
    w12 = [
        8.969445225396906e-11,
        0.12186895586627287,
        8.566656340934268e-11,
        0.023760506482624195,
        2.433068136596418e-10,
        1.3019165108393218e-10,
        0.0057136122764143964,
        0.1428088466436254,
        2.3971612221034656e-11,
        6.826252836396581e-11,
        0.42760458278251456,
        7.331710534327378e-11,
        3.690612785463839e-10,
        1.6887535081972322e-10,
        1.0123697800504516e-10,
        0.010614840764071817,
        0.04023390368296647,
        0.047891583808809195,
        4.316472317023914e-11,
        0.179503166295952,
    ]
    w13 = [
        5.991052752377225e-11,
        2.433071572090745e-10,
        6.137987612028502e-11,
        7.764227729932904e-11,
        0.5137576728307748,
        1.3933353478876682e-11,
        0.11861563828805713,
        1.1627729300826322e-10,
        5.840486231537919e-11,
        4.476212471392546e-11,
        1.5078033138891433e-10,
        1.3140683132002661e-11,
        8.958777288465453e-12,
        3.433655115631202e-11,
        9.66514874044241e-12,
        0.18153051016263663,
        0.18609617738724765,
        1.2749530550618746e-10,
        2.5163966524024895e-10,
        5.965006890936763e-11,
    ]
    w14 = [
        3.696510396916757e-12,
        4.169069932785755e-12,
        5.338268052922153e-12,
        4.734699188248743e-12,
        0.8533951447375869,
        1.5661530290111893e-12,
        0.14660485519752636,
        2.7744299162161516e-12,
        4.537600221937271e-12,
        3.0079350246873727e-12,
        2.662904487083837e-12,
        1.6290373955008443e-12,
        1.130376759336915e-12,
        2.1132873193150444e-12,
        1.148221081766175e-12,
        8.877450023425809e-12,
        6.028454624607497e-12,
        2.9253853085148482e-12,
        4.89375861052771e-12,
        3.65321267862404e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-3
    @test rmsd(w12, w22) < 1.5e-2
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1e-8
end

@testset "rvar" begin
    println("Testing rm = :rvar, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 200),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :rvar

    w11 = [
        1.9783062132048476e-7,
        0.12552716578011983,
        2.0786033868461824e-7,
        1.586179011783083e-7,
        1.3418986766135798e-7,
        1.554325253791357e-7,
        0.007646479601956259,
        0.213937896045473,
        1.5865119315748915e-7,
        1.800119946077241e-7,
        0.46520085503621345,
        2.4757097452420833e-7,
        1.6224989383347287e-7,
        1.9318708464560664e-7,
        7.831961814701979e-8,
        2.0812773657624318e-7,
        1.4911298452968159e-7,
        2.4156521233977854e-7,
        1.8856108319133288e-7,
        0.1876849422472079,
    ]
    w12 = [
        9.014301678525505e-9,
        0.19730124931412601,
        2.2149736568549733e-9,
        0.009958634808862141,
        7.461828199871207e-9,
        2.591178591018891e-8,
        0.029570057763818373,
        0.13927990418526945,
        4.258022055513588e-9,
        8.836842257229241e-9,
        0.42701761771346186,
        6.048384563202982e-9,
        1.5913279247827727e-9,
        2.846836598303463e-8,
        3.120543527898343e-8,
        1.9402185985933533e-8,
        1.8671029763241776e-8,
        3.9429180160636886e-8,
        1.1349954715369166e-8,
        0.19687232235084418,
    ]
    w13 = [
        4.3136559965343246e-8,
        4.058649205395248e-8,
        1.4440897587583353e-8,
        5.26403717915682e-8,
        0.47749083286356364,
        1.5076435414257574e-7,
        0.1838182351957419,
        7.659699338396456e-8,
        6.510534147892671e-8,
        1.1236961195377985e-7,
        8.911441819250446e-8,
        1.525950826382792e-7,
        2.3094566216738583e-7,
        1.2493246562437532e-7,
        2.8054529148271886e-7,
        0.15176147281036922,
        0.18692789962300255,
        6.682835912514554e-8,
        5.122451147371528e-8,
        7.680909701243837e-9,
    ]
    w14 = [
        4.332828618431265e-8,
        4.412541232011959e-8,
        4.3284571321645355e-8,
        4.3795015247105985e-8,
        1.7817758297642007e-6,
        4.6402267552826896e-8,
        0.999997401765868,
        4.543262704299355e-8,
        4.501601846359973e-8,
        4.5428127406551514e-8,
        4.52958390353112e-8,
        4.647397041305956e-8,
        5.0743050890492344e-8,
        4.5749636488478024e-8,
        4.766826784052939e-8,
        4.5286761124520554e-8,
        4.3953947229187936e-8,
        4.5207917895257286e-8,
        4.495100975199424e-8,
        4.431557583218842e-8,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 5e-2
    @test rmsd(w12, w22) < 3e-2
    @test rmsd(w13, w23) < 1.5e-2
    @test rmsd(w14, w24) < 1e-6

    w11 = [
        1.9783062132048476e-7,
        0.12552716578011983,
        2.0786033868461824e-7,
        1.586179011783083e-7,
        1.3418986766135798e-7,
        1.554325253791357e-7,
        0.007646479601956259,
        0.213937896045473,
        1.5865119315748915e-7,
        1.800119946077241e-7,
        0.46520085503621345,
        2.4757097452420833e-7,
        1.6224989383347287e-7,
        1.9318708464560664e-7,
        7.831961814701979e-8,
        2.0812773657624318e-7,
        1.4911298452968159e-7,
        2.4156521233977854e-7,
        1.8856108319133288e-7,
        0.1876849422472079,
    ]
    w12 = [
        9.014301678525505e-9,
        0.19730124931412601,
        2.2149736568549733e-9,
        0.009958634808862141,
        7.461828199871207e-9,
        2.591178591018891e-8,
        0.029570057763818373,
        0.13927990418526945,
        4.258022055513588e-9,
        8.836842257229241e-9,
        0.42701761771346186,
        6.048384563202982e-9,
        1.5913279247827727e-9,
        2.846836598303463e-8,
        3.120543527898343e-8,
        1.9402185985933533e-8,
        1.8671029763241776e-8,
        3.9429180160636886e-8,
        1.1349954715369166e-8,
        0.19687232235084418,
    ]
    w13 = [
        4.3136559965343246e-8,
        4.058649205395248e-8,
        1.4440897587583353e-8,
        5.26403717915682e-8,
        0.47749083286356364,
        1.5076435414257574e-7,
        0.1838182351957419,
        7.659699338396456e-8,
        6.510534147892671e-8,
        1.1236961195377985e-7,
        8.911441819250446e-8,
        1.525950826382792e-7,
        2.3094566216738583e-7,
        1.2493246562437532e-7,
        2.8054529148271886e-7,
        0.15176147281036922,
        0.18692789962300255,
        6.682835912514554e-8,
        5.122451147371528e-8,
        7.680909701243837e-9,
    ]
    w14 = [
        1.8627122645236273e-11,
        2.408694808141871e-11,
        3.6424621073439797e-11,
        3.0174191690909147e-11,
        0.8503271551723861,
        6.9268523006275565e-12,
        0.1496728444480554,
        7.85567861957879e-12,
        2.8160503255372478e-11,
        1.0658665145342347e-11,
        6.471150254909595e-12,
        6.2160861933501414e-12,
        1.2202245892621786e-11,
        2.988215511968398e-13,
        1.1957133510750498e-11,
        7.544005357222848e-11,
        4.398875603911654e-11,
        9.676675293326075e-12,
        3.2107546650158034e-11,
        1.8285626807746916e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 5e-2
    @test rmsd(w12, w22) < 3e-2
    @test rmsd(w13, w23) < 1.7e-2
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        1.9783062132048476e-7,
        0.12552716578011983,
        2.0786033868461824e-7,
        1.586179011783083e-7,
        1.3418986766135798e-7,
        1.554325253791357e-7,
        0.007646479601956259,
        0.213937896045473,
        1.5865119315748915e-7,
        1.800119946077241e-7,
        0.46520085503621345,
        2.4757097452420833e-7,
        1.6224989383347287e-7,
        1.9318708464560664e-7,
        7.831961814701979e-8,
        2.0812773657624318e-7,
        1.4911298452968159e-7,
        2.4156521233977854e-7,
        1.8856108319133288e-7,
        0.1876849422472079,
    ]
    w12 = [
        1.6339908824773239e-9,
        0.18785361734704872,
        5.6235750325061365e-9,
        0.010229273270024116,
        2.145881817979745e-9,
        2.6431786498852397e-8,
        0.034944108414147544,
        0.14769773602096598,
        3.318779302147341e-10,
        5.330873797911393e-9,
        0.4212644101745082,
        2.248051230140141e-9,
        1.8668271517284917e-9,
        2.796039828863696e-8,
        3.390260190245624e-8,
        1.687152400153133e-8,
        1.7477590155778092e-8,
        4.192912732730621e-8,
        9.336097931190306e-9,
        0.1980106616831015,
    ]
    w13 = [
        0.00020951098404609422,
        0.00026109773624657945,
        0.0003151223550578498,
        0.00027246322955495834,
        0.8060082183534146,
        8.925802345168651e-5,
        0.18941720354558209,
        0.00016691580392084898,
        0.0002840396261436436,
        0.0001728267369028469,
        0.0001617855626528449,
        8.87502485210866e-5,
        6.456853217838862e-5,
        0.0001220414806425407,
        6.599182538793858e-5,
        0.0011634618625357355,
        0.0004182999348165407,
        0.0001798399793284494,
        0.00032822084598869245,
        0.0002103833336264928,
    ]
    w14 = [
        7.76951241341802e-8,
        6.029864365730938e-7,
        7.374101569613261e-9,
        4.00563253322122e-7,
        0.8547023744913609,
        8.723761710817995e-7,
        0.14527653856538852,
        1.0389592522629672e-6,
        1.248425438190976e-6,
        1.2381426913148612e-6,
        9.523945158891405e-7,
        1.038965894041075e-6,
        2.8608425972503444e-6,
        8.852263146014757e-7,
        1.265902231714221e-6,
        5.1082833538909e-6,
        7.626403993103026e-7,
        9.197843680845396e-7,
        1.113399107849039e-6,
        6.929819995906802e-7,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 4.1e-2
    @test rmsd(w12, w22) < 2.7e-2
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 5e-4
end

@testset "mdd" begin
    println("Testing rm = :mdd, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.9),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :mdd

    w11 = [
        0.03773810157989838,
        8.218519125778296e-14,
        1.8909216453358465e-13,
        2.372179564900224e-13,
        0.06767028644965215,
        5.259644103336042e-13,
        4.737887712069405e-13,
        8.761479553870644e-11,
        2.929747505048438e-14,
        1.363805841188755e-12,
        0.49113432442939414,
        4.953508611797011e-13,
        0.028699870249064247,
        2.988125142775998e-13,
        3.2840057300798275e-13,
        0.14543878662957055,
        0.09520044588421932,
        0.102993342036098,
        6.306042456928766e-13,
        0.031124842649833936,
    ]
    w12 = [
        0.037738101641035415,
        1.6777856597250242e-13,
        2.676638607900095e-13,
        1.2408296300296452e-13,
        0.06767028650404505,
        5.068795730675681e-13,
        3.2142310425037224e-13,
        5.0758796938232184e-12,
        2.2591829242893184e-13,
        7.543183321177868e-13,
        0.4911343243422307,
        4.696749760872032e-13,
        0.028699870259353322,
        1.0457714469408207e-13,
        1.0256953717941221e-13,
        0.14543878670594462,
        0.09520044587568066,
        0.10299334216650265,
        4.739292201039674e-13,
        0.031124842496612893,
    ]
    w13 = [
        6.57454320675663e-14,
        1.0296890990307163e-12,
        2.330057794991116e-11,
        1.9035268729059683e-12,
        0.285395461042499,
        2.2223343528372137e-12,
        2.1831954492847816e-12,
        0.07964283619459461,
        2.0982852452748326e-12,
        2.0081979510485232e-12,
        0.3337054782271337,
        2.29516120325559e-12,
        2.388976373176604e-12,
        1.8573775710151153e-12,
        2.2925802529659753e-12,
        0.3012562244884411,
        7.577165637672333e-13,
        1.2236793228261315e-12,
        1.655409047909528e-12,
        4.8995886546650235e-14,
    ]
    w14 = [
        8.931449702368536e-13,
        9.484221316418283e-13,
        1.1410232540611591e-12,
        1.0926850959470071e-12,
        1.8065710361581948e-9,
        4.2090471598459996e-13,
        0.9999999981789072,
        6.789168763467449e-13,
        1.0276340381175471e-12,
        7.334005889094863e-13,
        6.513773987819921e-13,
        4.435361713334977e-13,
        3.168437382480083e-13,
        5.479795996320007e-13,
        3.3793880357004073e-13,
        1.5107675254536785e-12,
        1.195181363986857e-12,
        6.990411526707713e-13,
        1.055407115995939e-12,
        8.276457162462601e-13,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-10
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1e-9
    @test rmsd(w14, w24) < 1e-7

    w11 = [
        0.03773810157989838,
        8.218519125778296e-14,
        1.8909216453358465e-13,
        2.372179564900224e-13,
        0.06767028644965215,
        5.259644103336042e-13,
        4.737887712069405e-13,
        8.761479553870644e-11,
        2.929747505048438e-14,
        1.363805841188755e-12,
        0.49113432442939414,
        4.953508611797011e-13,
        0.028699870249064247,
        2.988125142775998e-13,
        3.2840057300798275e-13,
        0.14543878662957055,
        0.09520044588421932,
        0.102993342036098,
        6.306042456928766e-13,
        0.031124842649833936,
    ]
    w12 = [
        0.03773810176281003,
        9.050753688497763e-13,
        1.2873468080774035e-12,
        6.707989287326192e-13,
        0.06767028647410092,
        2.781562677732707e-12,
        1.675190739326753e-12,
        2.950809289989109e-11,
        1.228458398588984e-12,
        4.098869698795381e-12,
        0.4911343241861302,
        2.590711105047106e-12,
        0.028699870219241,
        5.642523465331635e-13,
        5.583417493089745e-13,
        0.14543878679967,
        0.09520044602244468,
        0.10299334208215895,
        2.502875633444782e-12,
        0.031124842405072645,
    ]
    w13 = [
        4.174384706517092e-9,
        1.1148889702508254e-9,
        0.003985416566456653,
        5.674719397924786e-10,
        0.2867040527838013,
        3.141750827487696e-10,
        4.760282798933436e-10,
        0.07144836783605892,
        4.275097972867445e-10,
        5.035133020882635e-10,
        0.34363837207851805,
        2.4993523910536975e-10,
        1.7051918035616923e-10,
        6.241081077584317e-10,
        2.3139811750858842e-10,
        0.29422377472913586,
        2.5045181323018767e-9,
        1.3467942651217462e-9,
        9.2642123037968e-10,
        2.374362841435235e-9,
    ]
    w14 = [
        7.559524064239443e-12,
        8.415658144041507e-12,
        1.5967192144592853e-11,
        9.288382959419136e-12,
        0.8503265787909936,
        3.2299709982304365e-12,
        0.14967342106642417,
        6.11742988650333e-12,
        8.833042848971733e-12,
        6.079510204479378e-12,
        5.651514175493127e-12,
        3.3197209468580894e-12,
        2.342047963705129e-12,
        4.371451162285659e-12,
        2.4100718788992796e-12,
        2.3911759469536495e-11,
        1.1896180535388337e-11,
        5.9781447830161065e-12,
        9.744113426887544e-12,
        7.466493290249241e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-10
    @test rmsd(w12, w22) < 1e-10
    @test rmsd(w13, w23) < 3.5e-4
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        0.03773810157989838,
        8.218519125778296e-14,
        1.8909216453358465e-13,
        2.372179564900224e-13,
        0.06767028644965215,
        5.259644103336042e-13,
        4.737887712069405e-13,
        8.761479553870644e-11,
        2.929747505048438e-14,
        1.363805841188755e-12,
        0.49113432442939414,
        4.953508611797011e-13,
        0.028699870249064247,
        2.988125142775998e-13,
        3.2840057300798275e-13,
        0.14543878662957055,
        0.09520044588421932,
        0.102993342036098,
        6.306042456928766e-13,
        0.031124842649833936,
    ]
    w12 = [
        0.03773810175397356,
        1.4181859209230405e-12,
        6.426425217170415e-12,
        9.995586305649273e-13,
        0.06767028658777575,
        3.724236080414627e-12,
        3.395809480341353e-12,
        3.472999457571455e-11,
        1.7445153778399072e-12,
        5.654937226414557e-12,
        0.49113432397048407,
        3.4747368808332607e-12,
        0.028699870198940262,
        8.644104740812288e-13,
        7.882642662325359e-13,
        0.14543878687911138,
        0.09520044611655315,
        0.10299334232907636,
        4.3301236910744876e-12,
        0.031124842096534128,
    ]
    w13 = [
        1.0345947348204074e-10,
        4.2759962604708345e-11,
        0.011870069189330729,
        1.943167212596463e-11,
        0.28871362956040714,
        1.0876964105279184e-11,
        1.64080478300663e-11,
        0.06347622131871408,
        1.4149488689385676e-11,
        1.7256421483910193e-11,
        0.35128202494391975,
        9.033388683848323e-12,
        5.738323673484521e-12,
        2.2405650334768815e-11,
        8.643971967339894e-12,
        0.28465805450272236,
        7.244768414307791e-11,
        4.0384877031086744e-11,
        3.052956208541654e-11,
        7.138041785589228e-11,
    ]
    w14 = [
        1.3741159393600643e-12,
        1.5485890085566755e-12,
        2.0439914269193055e-12,
        1.7428425550330708e-12,
        0.8533951448337673,
        5.867272514090747e-13,
        0.1466048551414273,
        1.0507807575745433e-12,
        1.673031493219416e-12,
        1.1280247642521313e-12,
        1.002306616327056e-12,
        6.091659363540497e-13,
        4.2501476760985133e-13,
        7.911887623547183e-13,
        4.3262457982875845e-13,
        3.5394943796326598e-12,
        2.5802313963156424e-12,
        1.0982814882386467e-12,
        1.8133990949330632e-12,
        1.3655684789520054e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-9
    @test rmsd(w13, w23) < 3e-5
    @test rmsd(w14, w24) < 2e-7
end

@testset "add" begin
    println("Testing rm = :add, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.9),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :add

    w11 = [
        5.22388542522968e-13,
        0.04441412277975166,
        0.15878181588481088,
        8.409548949847852e-14,
        0.06789584406140951,
        2.801027020755176e-13,
        1.0804458105973687e-13,
        0.06198971205515351,
        1.62204175932949e-13,
        2.6042490544651356e-13,
        0.2102532389260537,
        9.76953646915409e-13,
        0.001213275316395267,
        0.01721619516863442,
        6.417079580362672e-15,
        0.06906921217652473,
        0.10146090796068352,
        0.022477803926550546,
        0.13036103371385052,
        0.11486683802778136,
    ]
    w12 = [
        1.3344463477666105e-12,
        0.04241217797966024,
        0.15457804569737923,
        4.955215077192253e-13,
        0.06853006435148694,
        7.838800550399153e-13,
        5.274896767788705e-13,
        0.06477894276136333,
        6.180974991439404e-13,
        8.30304243856218e-13,
        0.20764904462783298,
        1.2700992767509445e-12,
        0.0007314273601305003,
        0.01852441023081639,
        2.9010117073884407e-13,
        0.07144518684765513,
        0.10791276772924166,
        0.01630490651395628,
        0.13059135945600994,
        0.1165416664383176,
    ]
    w13 = [
        1.4363755590928132e-14,
        2.4977301105994053e-13,
        0.22302881937311372,
        1.1207038411598053e-14,
        0.23131325639478956,
        4.6974024173510274e-14,
        0.002413064970455546,
        0.06938282637060894,
        3.070946044849628e-15,
        1.0738073625258709e-14,
        0.09196993097493229,
        4.807420408858136e-14,
        5.676639923038171e-14,
        5.738109243019145e-15,
        5.304804502869517e-14,
        0.14134964304789158,
        0.14559334623188885,
        5.19116479391436e-14,
        0.09494911263533562,
        4.3200606963346595e-13,
    ]
    w14 = [
        8.938018874479968e-13,
        9.489376381899396e-13,
        1.1416208809906949e-12,
        1.0932579141719246e-12,
        1.8039738980906169e-9,
        4.21209625046447e-13,
        0.9999999981814969,
        6.790089840785148e-13,
        1.028309187909978e-12,
        7.339032355902272e-13,
        6.518558122494332e-13,
        4.438732014046922e-13,
        3.1706734833362675e-13,
        5.483709535787923e-13,
        3.3818157795264076e-13,
        1.5106448518117237e-12,
        1.1958702708278712e-12,
        6.995161774372745e-13,
        1.0557219221607057e-12,
        8.281704116070905e-13,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-10
    @test rmsd(w13, w23) < 1e-10
    @test rmsd(w14, w24) < 1e-7

    w11 = [
        5.22388542522968e-13,
        0.04441412277975166,
        0.15878181588481088,
        8.409548949847852e-14,
        0.06789584406140951,
        2.801027020755176e-13,
        1.0804458105973687e-13,
        0.06198971205515351,
        1.62204175932949e-13,
        2.6042490544651356e-13,
        0.2102532389260537,
        9.76953646915409e-13,
        0.001213275316395267,
        0.01721619516863442,
        6.417079580362672e-15,
        0.06906921217652473,
        0.10146090796068352,
        0.022477803926550546,
        0.13036103371385052,
        0.11486683802778136,
    ]
    w12 = [
        1.8848626600689452e-11,
        0.042412178973133076,
        0.1545780470435833,
        6.697865229521303e-12,
        0.06853006364489697,
        1.0995559474311681e-11,
        6.922346365721642e-12,
        0.06477894072818222,
        8.761239210896531e-12,
        1.239965047467576e-11,
        0.20764904757297173,
        2.1503862944051717e-11,
        0.0007314263041114302,
        0.018524409243683516,
        4.356270650974104e-12,
        0.07144518559378912,
        0.10791276392460497,
        0.016304910596988912,
        0.13059135975157832,
        0.11654166653199113,
    ]
    w13 = [
        5.782362875577471e-7,
        5.029590387049199e-6,
        0.20585379861692302,
        8.85069256415749e-7,
        0.24632178990298118,
        2.5680839356721935e-7,
        0.00023644929913089926,
        0.07390579301514433,
        7.043446520380157e-7,
        7.818260999176178e-7,
        0.09988902036691875,
        2.408204124584827e-7,
        1.4685763239581306e-7,
        8.876499042796985e-7,
        1.8892304158996125e-7,
        0.1408490406271717,
        0.137961058311355,
        1.6370513049351156e-6,
        0.09495639840943555,
        1.531427356728323e-5,
    ]
    w14 = [
        4.020374958114304e-12,
        4.317220706169025e-12,
        5.493849559440366e-12,
        4.8974970087448944e-12,
        0.8503246610733531,
        1.731096248244974e-12,
        0.14967533885357956,
        2.9241569377922458e-12,
        4.73678609035049e-12,
        3.2348532581557843e-12,
        2.8530827018960096e-12,
        1.847723844001607e-12,
        1.254308942798961e-12,
        2.2994176775763027e-12,
        1.2864618531236505e-12,
        1.3807123717979059e-11,
        6.277658189361368e-12,
        3.1580862781336948e-12,
        5.0566490516630055e-12,
        3.8709918867350814e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1.5e-2
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        5.22388542522968e-13,
        0.04441412277975166,
        0.15878181588481088,
        8.409548949847852e-14,
        0.06789584406140951,
        2.801027020755176e-13,
        1.0804458105973687e-13,
        0.06198971205515351,
        1.62204175932949e-13,
        2.6042490544651356e-13,
        0.2102532389260537,
        9.76953646915409e-13,
        0.001213275316395267,
        0.01721619516863442,
        6.417079580362672e-15,
        0.06906921217652473,
        0.10146090796068352,
        0.022477803926550546,
        0.13036103371385052,
        0.11486683802778136,
    ]
    w12 = [
        3.4908376781630004e-11,
        0.042412178233839,
        0.1545780447033654,
        1.2599888307685536e-11,
        0.06853006304646327,
        2.0494744579999843e-11,
        1.3193528269831057e-11,
        0.06477894069605111,
        1.618650918843422e-11,
        2.212121282824932e-11,
        0.20764904784899296,
        3.681738966980832e-11,
        0.0007314258045333664,
        0.018524409503443542,
        7.768117715758334e-12,
        0.07144518442410089,
        0.10791276748761258,
        0.016304913419318667,
        0.13059135882322018,
        0.11654166584496932,
    ]
    w13 = [
        1.6000729582305592e-10,
        9.857470834801803e-10,
        0.2169496656711736,
        2.4400942394711353e-10,
        0.23650505722141868,
        6.774553167108466e-11,
        0.002586972392614626,
        0.06889380523024403,
        1.9223287697580452e-10,
        1.9425644493263975e-10,
        0.09239588502447123,
        6.43565261862226e-11,
        3.8579011197171387e-11,
        2.1676676685180754e-10,
        5.1088535061614295e-11,
        0.1408946833345934,
        0.14605090704128967,
        3.9896829707759e-10,
        0.0957230189413964,
        2.529040695031278e-9,
    ]
    w14 = [
        3.644970710570151e-12,
        4.183052317423306e-12,
        7.268592644245532e-12,
        4.732847540736764e-12,
        0.853395144634563,
        1.555750915751007e-12,
        0.14660485528462577,
        2.9306468770551747e-12,
        4.440022793188141e-12,
        2.9961993954525695e-12,
        2.7158497878627965e-12,
        1.6050700606313968e-12,
        1.1221251700295955e-12,
        2.1036025631435246e-12,
        1.1453281077213894e-12,
        1.551412488171903e-11,
        1.3176361072437342e-11,
        2.93440840964371e-12,
        5.068482658252895e-12,
        3.673720300021395e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-6
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1e-7
    @test rmsd(w14, w24) < 1e-7
end

@testset "cdar" begin
    println("Testing rm = :cdar, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.9),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :cdar

    w11 = [
        1.373267971787297e-15,
        4.665861411847277e-13,
        3.91182853494822e-15,
        7.128418285187495e-15,
        0.003409901166471262,
        1.1310539982642485e-14,
        1.966318841963675e-14,
        0.07904282393545269,
        6.4443480890666e-15,
        1.0902495621753332e-14,
        0.38759317019326794,
        4.528911235400576e-14,
        6.389147415038762e-14,
        1.1234981275436576e-13,
        0.0005545152696214103,
        0.09598828930444549,
        0.26790888253690154,
        2.1758670200819793e-13,
        0.0006560171972080287,
        0.16484640039566517,
    ]
    w12 = [
        1.57196690393102e-13,
        3.9554939855958016e-12,
        1.98537940593893e-13,
        1.179037022934479e-13,
        0.003559479269168112,
        8.456229969292413e-14,
        2.4628431046263988e-14,
        0.07997306840751951,
        2.1255557371259677e-13,
        8.765591282156042e-14,
        0.3871598885015864,
        5.046103718469047e-13,
        5.25886953611196e-13,
        9.414204228060467e-13,
        0.00022182914890751354,
        0.09652576884918802,
        0.26593974832966394,
        1.5149191209722234e-12,
        0.0019205859759721484,
        0.1646996315096691,
    ]
    w13 = [
        2.5391782599983563e-13,
        1.8500006840601276e-13,
        0.0723352065919712,
        3.3696466114914805e-13,
        0.31072487445363906,
        3.7538218337214177e-13,
        3.580544803679843e-13,
        0.12861270846535686,
        3.468480040403855e-13,
        3.430397358541446e-13,
        0.1643840874092871,
        3.5991495547106123e-13,
        3.906584606631591e-13,
        2.882351051599845e-13,
        3.7457484108690546e-13,
        0.26288266381068054,
        1.44660434908236e-13,
        2.4103460145152493e-13,
        2.2675527614791539e-13,
        0.06106045926484028,
    ]
    w14 = [
        5.27863311516283e-12,
        5.5105919488865985e-12,
        1.406731505571064e-12,
        6.2907672982170464e-12,
        7.318679518743824e-9,
        2.548397480076478e-12,
        0.999999992604553,
        3.8099583597906554e-12,
        5.99839795377761e-12,
        4.356792116796033e-12,
        3.819869804438175e-12,
        2.6911382386218524e-12,
        1.9418832721301337e-12,
        3.267001029070439e-12,
        2.0269188441320964e-12,
        7.080357583978661e-12,
        5.733528841336619e-12,
        4.154804202159162e-12,
        5.970008554340553e-12,
        4.881784798273057e-12,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-10
    @test rmsd(w13, w23) < 1e-9
    @test rmsd(w14, w24) < 1e-8

    w11 = [
        1.373267971787297e-15,
        4.665861411847277e-13,
        3.91182853494822e-15,
        7.128418285187495e-15,
        0.003409901166471262,
        1.1310539982642485e-14,
        1.966318841963675e-14,
        0.07904282393545269,
        6.4443480890666e-15,
        1.0902495621753332e-14,
        0.38759317019326794,
        4.528911235400576e-14,
        6.389147415038762e-14,
        1.1234981275436576e-13,
        0.0005545152696214103,
        0.09598828930444549,
        0.26790888253690154,
        2.1758670200819793e-13,
        0.0006560171972080287,
        0.16484640039566517,
    ]
    w12 = [
        2.177933311653075e-12,
        4.892218117033432e-11,
        2.6786226460659525e-12,
        1.6224811036696254e-12,
        0.003559478984134436,
        1.1767434378060779e-12,
        3.4175463835412783e-13,
        0.07997306856580726,
        2.9764294353699596e-12,
        1.210109610664153e-12,
        0.38715988915179167,
        6.694032404562801e-12,
        7.270208134026156e-12,
        1.3102112134425258e-11,
        0.00022182801104349707,
        0.0965257692038803,
        0.26593974540949306,
        1.7886718407118327e-11,
        0.0019205876918575717,
        0.16469963287593295,
    ]
    w13 = [
        1.0205925685394196e-9,
        2.1020381299203943e-9,
        0.0618852111990482,
        5.911811213848735e-10,
        0.25618539221602626,
        2.915683109672606e-10,
        3.775524579536859e-10,
        0.1358978640498941,
        5.549365658559869e-10,
        5.368683092932358e-10,
        0.1825121295731212,
        3.760043472463768e-10,
        2.0193584855232988e-10,
        8.852876206386356e-10,
        2.975821815602591e-10,
        0.17526856405371471,
        2.183546557728486e-8,
        1.5391776290773566e-9,
        1.8232833898096895e-9,
        0.18825080647472145,
    ]
    w14 = [
        6.112100414979321e-12,
        5.7555353736705415e-12,
        1.598184205615386e-11,
        6.762310692445309e-12,
        0.8503286538297934,
        2.835625312052336e-12,
        0.14967134577540064,
        4.338346426176008e-12,
        6.566348461145844e-12,
        4.696967487164646e-12,
        4.278460975707252e-12,
        3.114825040043251e-12,
        1.9921833318501008e-12,
        3.531413166310864e-12,
        2.1438265511247695e-12,
        2.9872907692175716e-10,
        1.0719713895133846e-11,
        4.771550904350998e-12,
        6.949568986542697e-12,
        5.5262057628461865e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1e-5
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        1.373267971787297e-15,
        4.665861411847277e-13,
        3.91182853494822e-15,
        7.128418285187495e-15,
        0.003409901166471262,
        1.1310539982642485e-14,
        1.966318841963675e-14,
        0.07904282393545269,
        6.4443480890666e-15,
        1.0902495621753332e-14,
        0.38759317019326794,
        4.528911235400576e-14,
        6.389147415038762e-14,
        1.1234981275436576e-13,
        0.0005545152696214103,
        0.09598828930444549,
        0.26790888253690154,
        2.1758670200819793e-13,
        0.0006560171972080287,
        0.16484640039566517,
    ]
    w12 = [
        1.976695370654257e-12,
        4.623366448610354e-11,
        2.4949278511534106e-12,
        1.4761932874158001e-12,
        0.00355947909072483,
        1.0677663515546905e-12,
        3.1493446314551723e-13,
        0.07997306789687147,
        2.6830815141432516e-12,
        1.1019288051655083e-12,
        0.38715988925520567,
        6.123329102345206e-12,
        6.5718861843756e-12,
        1.1824450622622968e-11,
        0.00022182857802410677,
        0.09652576859010754,
        0.2659397477153996,
        1.7537133917966684e-11,
        0.0019205860851936886,
        0.1646996326890671,
    ]
    w13 = [
        2.2583045629080932e-11,
        3.928511835676671e-11,
        0.07723521933942656,
        1.2300497105045563e-11,
        0.28336065214047645,
        6.46384933257456e-12,
        8.752141957977872e-12,
        0.12088407968687584,
        1.082283685195609e-11,
        1.1340792406892217e-11,
        0.16260673904579429,
        8.485085951526919e-12,
        4.32303778893678e-12,
        1.9394630599652007e-11,
        6.814710641813337e-12,
        0.23720063764062407,
        1.030185668857268e-10,
        2.6911131288905955e-11,
        2.9377307539859197e-11,
        0.11871267183693007,
    ]
    w14 = [
        1.3425373671971402e-12,
        1.5116598579539139e-12,
        2.2173465294445073e-12,
        1.697278857638958e-12,
        0.8533951450392063,
        5.74670828896119e-13,
        0.14660485493672068,
        1.0347387504782396e-12,
        1.63393191364947e-12,
        1.1025369595664905e-12,
        9.813108436881106e-13,
        5.968332316317895e-13,
        4.172053976591941e-13,
        7.742163491561938e-13,
        4.2450812763250513e-13,
        3.3574775554109274e-12,
        2.235663962441937e-12,
        1.073062878419164e-12,
        1.762707311985775e-12,
        1.3352143788464612e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-9
    @test rmsd(w12, w22) < 1e-9
    @test rmsd(w13, w23) < 1e-7
    @test rmsd(w14, w24) < 1e-7
end

@testset "uci" begin
    println("Testing rm = :uci, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.9),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :uci

    w11 = [
        1.1996961454225473e-13,
        0.02501228871233397,
        0.09201937941231281,
        9.800751612631491e-12,
        0.019404728858732807,
        5.7312057162665816e-12,
        4.443082099285677e-12,
        0.0650842058092222,
        1.5927698401418295e-12,
        3.6291472109864886e-12,
        0.28536546308532706,
        3.862756335246886e-12,
        1.8394955837190113e-11,
        0.008371339729095519,
        1.0460636779707656e-11,
        0.09716505543566842,
        0.17512905414382912,
        0.02459014158134196,
        0.05728372305216908,
        0.15057462012193196,
    ]
    w12 = [
        1.5196102171527127e-11,
        0.023994914392758634,
        0.09614520665808149,
        5.3542703495430725e-12,
        0.01957853444365885,
        6.805773150230215e-12,
        2.916532923953179e-12,
        0.06625960214028988,
        1.0314849253738607e-11,
        8.013138102322103e-12,
        0.2838088485227675,
        1.8337371739645345e-11,
        1.2775323179455955e-11,
        0.0015419931813862376,
        6.068174131241206e-12,
        0.10123982836878155,
        0.1762621510221576,
        0.020477597872813957,
        0.060872102942878856,
        0.1498192203686438,
    ]
    w13 = [
        3.8718346784447964e-12,
        1.2629127657281346e-11,
        0.20538865478573454,
        2.4663399846637723e-12,
        0.28579561534212844,
        1.1815770595700767e-11,
        1.2327547261498044e-12,
        0.14358965013557703,
        4.205927905763605e-12,
        5.771263271155371e-12,
        0.07575582129585942,
        1.1685895191752135e-11,
        1.3360780633484712e-11,
        4.2628507595391265e-13,
        1.266395551121943e-11,
        0.18477327851902547,
        0.10469697936340153,
        6.976277070708711e-12,
        1.9813078467918824e-10,
        2.730365251127367e-10,
    ]
    w14 = [
        8.938018874479968e-13,
        9.489376381899396e-13,
        1.1416208809906949e-12,
        1.0932579141719246e-12,
        1.8039738980906169e-9,
        4.21209625046447e-13,
        0.9999999981814969,
        6.790089840785148e-13,
        1.028309187909978e-12,
        7.339032355902272e-13,
        6.518558122494332e-13,
        4.438732014046922e-13,
        3.1706734833362675e-13,
        5.483709535787923e-13,
        3.3818157795264076e-13,
        1.5106448518117237e-12,
        1.1958702708278712e-12,
        6.995161774372745e-13,
        1.0557219221607057e-12,
        8.281704116070905e-13,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1e-7
    @test rmsd(w13, w23) < 1e-7
    @test rmsd(w14, w24) < 1e-7

    w11 = [
        1.1996961454225473e-13,
        0.02501228871233397,
        0.09201937941231281,
        9.800751612631491e-12,
        0.019404728858732807,
        5.7312057162665816e-12,
        4.443082099285677e-12,
        0.0650842058092222,
        1.5927698401418295e-12,
        3.6291472109864886e-12,
        0.28536546308532706,
        3.862756335246886e-12,
        1.8394955837190113e-11,
        0.008371339729095519,
        1.0460636779707656e-11,
        0.09716505543566842,
        0.17512905414382912,
        0.02459014158134196,
        0.05728372305216908,
        0.15057462012193196,
    ]
    w12 = [
        1.4746477391953726e-11,
        0.023994907959856548,
        0.0961452154363959,
        5.195874734155912e-12,
        0.01957852574319404,
        6.604422945413841e-12,
        2.8303149817623327e-12,
        0.06625960021023022,
        1.0009660909994556e-11,
        7.77606230545514e-12,
        0.2838088400791641,
        1.7794794132738997e-11,
        1.2397320941527215e-11,
        0.001541990228683718,
        5.888645503906936e-12,
        0.10123982371168973,
        0.17626216169710124,
        0.020477604498337652,
        0.06087210312178776,
        0.1498192272303155,
    ]
    w13 = [
        4.468413283327195e-11,
        1.0982394433749132e-10,
        0.19290897892809028,
        3.979881543347896e-11,
        0.2308516321785591,
        1.5465381399160837e-11,
        4.144738888308517e-11,
        0.1372756814522155,
        4.311648424934515e-11,
        3.7426635991268065e-11,
        0.11254117685974711,
        1.5489643302206595e-11,
        1.0566411299393244e-11,
        5.970502714055497e-11,
        1.144590076707744e-11,
        0.15375488200087387,
        0.12948616680505287,
        9.073157062273369e-11,
        0.01383203101122422,
        0.029349450244535818,
    ]
    w14 = [
        4.0311438611410436e-12,
        4.328614551548713e-12,
        5.508419938078554e-12,
        4.9104578177326044e-12,
        0.8503246604627572,
        1.7358490696212619e-12,
        0.14967533946397554,
        2.9319258348804842e-12,
        4.74931559716804e-12,
        3.2434831954336194e-12,
        2.8607046407844208e-12,
        1.8528249905921274e-12,
        1.257832276181738e-12,
        2.3056287945957207e-12,
        1.290078141257803e-12,
        1.3848687638594904e-11,
        6.294433273645531e-12,
        3.1665277424174895e-12,
        5.0700065936173675e-12,
        3.881264883585657e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1.5e-4
    @test rmsd(w13, w23) < 1e-7
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        1.1996961454225473e-13,
        0.02501228871233397,
        0.09201937941231281,
        9.800751612631491e-12,
        0.019404728858732807,
        5.7312057162665816e-12,
        4.443082099285677e-12,
        0.0650842058092222,
        1.5927698401418295e-12,
        3.6291472109864886e-12,
        0.28536546308532706,
        3.862756335246886e-12,
        1.8394955837190113e-11,
        0.008371339729095519,
        1.0460636779707656e-11,
        0.09716505543566842,
        0.17512905414382912,
        0.02459014158134196,
        0.05728372305216908,
        0.15057462012193196,
    ]
    w12 = [
        6.744815118262453e-12,
        0.024110979801299635,
        0.0958767973478239,
        2.3805675553430056e-12,
        0.01966656161760593,
        3.0269836044856027e-12,
        1.300553190037991e-12,
        0.06618838030912906,
        4.5831075303740285e-12,
        3.562317551885763e-12,
        0.2838962027225108,
        8.116801253117057e-12,
        5.698363810197942e-12,
        0.001925826193053793,
        2.6984767026596403e-12,
        0.10102233133159125,
        0.17613317841127563,
        0.0206422497266675,
        0.0607021148669401,
        0.1498353776339903,
    ]
    w13 = [
        3.6453869927381664e-11,
        8.296399960382364e-11,
        0.1937329546703557,
        3.853986643112206e-11,
        0.28311914225345985,
        1.2205990865515858e-11,
        4.561636418409436e-11,
        0.138360115686473,
        3.544983999998584e-11,
        3.0924834385663616e-11,
        0.09651882929278986,
        1.2108598259716118e-11,
        7.471357030787014e-12,
        4.646568855625622e-11,
        9.068280177970343e-12,
        0.17232419914853858,
        0.11594475639587713,
        7.408462641106019e-11,
        8.962498987023209e-10,
        1.2249027749299627e-9,
    ]
    w14 = [
        3.644970710570151e-12,
        4.183052317423306e-12,
        7.268592644245532e-12,
        4.732847540736764e-12,
        0.853395144634563,
        1.555750915751007e-12,
        0.14660485528462577,
        2.9306468770551747e-12,
        4.440022793188141e-12,
        2.9961993954525695e-12,
        2.7158497878627965e-12,
        1.6050700606313968e-12,
        1.1221251700295955e-12,
        2.1036025631435246e-12,
        1.1453281077213894e-12,
        1.551412488171903e-11,
        1.3176361072437342e-11,
        2.93440840964371e-12,
        5.068482658252895e-12,
        3.673720300021395e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-9
end

@testset "edar" begin
    println("Testing rm = :edar, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.9),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :edar

    w11 = [
        0.033608708036103455,
        0.0004537950176223421,
        0.00015245065545274833,
        5.682640269197295e-5,
        0.02356867147678142,
        7.455658472709149e-5,
        2.0332331864825853e-5,
        0.046177161064675794,
        9.435503830477678e-5,
        8.257440656712476e-5,
        0.415600362151364,
        8.318411211694279e-5,
        0.009945132617318324,
        0.00016427329923060117,
        7.844734228485846e-5,
        0.13568869177135937,
        0.21231804702323134,
        0.0177030495458141,
        0.00030039401158856176,
        0.10382898711090033,
    ]
    w12 = [
        0.04405831860534421,
        0.00011545480267887265,
        3.5976769041712916e-5,
        1.8591313538964698e-5,
        0.016479556719400604,
        2.4862701811756283e-5,
        7.086656149813282e-6,
        0.033948922532036775,
        2.9390577258571603e-5,
        3.029561444292933e-5,
        0.42625992949810404,
        3.1673485355517055e-5,
        0.012576507344881931,
        4.2848081071424924e-5,
        2.506592293955887e-5,
        0.1376427594043096,
        0.20739705282971893,
        0.021430883315192766,
        6.649531102142536e-5,
        0.09977832851570062,
    ]
    w13 = [
        4.098599777120683e-11,
        5.6755524565767e-11,
        0.10585595110763674,
        1.4324345009775742e-10,
        0.2712802470316331,
        2.427025885762031e-10,
        1.1545203325635173e-10,
        0.08852761917918103,
        1.7587271548852458e-10,
        1.4654208009400538e-10,
        0.2612188216255504,
        2.0836521785751924e-10,
        4.2648503724116005e-10,
        8.015021820831017e-11,
        3.031510363380287e-10,
        0.273117358929763,
        3.9403560070299277e-11,
        5.0512475796852335e-11,
        8.145111057143646e-11,
        1.516275741559569e-11,
    ]
    w14 = [
        3.7917426602419365e-11,
        4.0261387640849925e-11,
        4.973202097230966e-11,
        4.583163306931674e-11,
        3.3962615154121136e-8,
        1.7641999707685853e-11,
        0.9999999654144928,
        2.8100428819102076e-11,
        4.269928394278934e-11,
        3.0671008637413925e-11,
        2.7181151955391367e-11,
        1.867416049215531e-11,
        1.331590778236953e-11,
        2.2710840524882745e-11,
        1.3874416664779963e-11,
        7.323309582078785e-11,
        5.1771534347105315e-11,
        2.9382211508725023e-11,
        4.413405577138952e-11,
        3.575948388198738e-11,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 5.7e-3
    @test rmsd(w12, w22) < 4.5e-2
    @test rmsd(w13, w23) < 4e-6
    @test rmsd(w14, w24) < 1e-7

    w11 = [
        0.033608708036103455,
        0.0004537950176223421,
        0.00015245065545274833,
        5.682640269197295e-5,
        0.02356867147678142,
        7.455658472709149e-5,
        2.0332331864825853e-5,
        0.046177161064675794,
        9.435503830477678e-5,
        8.257440656712476e-5,
        0.415600362151364,
        8.318411211694279e-5,
        0.009945132617318324,
        0.00016427329923060117,
        7.844734228485846e-5,
        0.13568869177135937,
        0.21231804702323134,
        0.0177030495458141,
        0.00030039401158856176,
        0.10382898711090033,
    ]
    w12 = [
        0.027225875490718737,
        5.876791526111765e-10,
        1.509355987309775e-13,
        2.758046767811853e-9,
        0.01791545177493492,
        2.374433308162569e-9,
        7.483641064990673e-9,
        0.04175582393047989,
        1.5516455621412685e-9,
        1.8020407812446091e-9,
        0.415278033067864,
        3.293407752602042e-10,
        0.012180740304573737,
        5.083992111598117e-10,
        2.2264396487657203e-9,
        0.13172428398060956,
        0.21176524152292142,
        0.03617688989719646,
        3.201349363392951e-10,
        0.10597764008874914,
    ]
    w13 = [
        2.173145184193232e-6,
        2.781869267030248e-6,
        0.09215475696807933,
        7.374354707455978e-7,
        0.2687661697879871,
        4.0361169256068726e-7,
        5.601873534412505e-7,
        0.08609004460841733,
        6.87403104395977e-7,
        7.180356002766802e-7,
        0.3053900747544761,
        3.779878698499656e-7,
        2.364321932015276e-7,
        1.1893656136554397e-6,
        3.3381078598368486e-7,
        0.24755184335583444,
        9.948485441954159e-6,
        2.2073065213600287e-6,
        1.8140964917073466e-6,
        2.2941352615345478e-5,
    ]
    w14 = [
        4.261638906245827e-12,
        4.955919138227724e-12,
        7.573453986108579e-12,
        5.633418063248418e-12,
        0.8503245442260015,
        1.815364102122515e-12,
        0.149675455653965,
        3.5104763668784186e-12,
        5.106949925981989e-12,
        3.480451605992242e-12,
        3.206980613312684e-12,
        1.863892661417361e-12,
        1.3113382795312075e-12,
        2.4609546619870097e-12,
        1.3394411781116047e-12,
        5.2497560489965915e-11,
        7.484570936679652e-12,
        3.412886256601779e-12,
        5.790065587742543e-12,
        4.328156998805511e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 5.7e-3
    @test rmsd(w12, w22) < 3.6e-3
    @test rmsd(w13, w23) < 1e-3
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        0.033608708036103455,
        0.0004537950176223421,
        0.00015245065545274833,
        5.682640269197295e-5,
        0.02356867147678142,
        7.455658472709149e-5,
        2.0332331864825853e-5,
        0.046177161064675794,
        9.435503830477678e-5,
        8.257440656712476e-5,
        0.415600362151364,
        8.318411211694279e-5,
        0.009945132617318324,
        0.00016427329923060117,
        7.844734228485846e-5,
        0.13568869177135937,
        0.21231804702323134,
        0.0177030495458141,
        0.00030039401158856176,
        0.10382898711090033,
    ]
    w12 = [
        0.02718627740740722,
        1.1210459472559174e-9,
        1.2204698998768534e-10,
        2.896876272879051e-9,
        0.01788586136107961,
        2.3960001655146344e-9,
        7.399990004977621e-9,
        0.04181340541303176,
        1.5741182903537986e-9,
        1.7101520968056247e-9,
        0.4152231659598705,
        2.1269689676892835e-10,
        0.012177281289746194,
        6.40835196830973e-10,
        3.32688412178124e-9,
        0.13168289623273985,
        0.21183337034255523,
        0.036197126554739084,
        2.9555476253781347e-10,
        0.10600059374262981,
    ]
    w13 = [
        0.026296449874543715,
        0.02218818594589978,
        0.015558231983073293,
        0.025081675782865086,
        0.24318325268623073,
        0.025100251061381605,
        0.008184829383686705,
        0.022913551365973256,
        0.03042992198463704,
        0.005190175748776066,
        0.2802605509148086,
        0.014906245647211052,
        0.006508719331879848,
        0.008978699116553062,
        0.004175852422303486,
        0.13821095611897674,
        0.03222477838574424,
        0.017023948958441663,
        0.011885251816368889,
        0.06169847147064508,
    ]
    w14 = [
        1.0942307052007845e-12,
        1.2302659661432446e-12,
        1.5681590780515787e-12,
        1.3824557701174908e-12,
        0.8533951448969873,
        4.665641070453522e-13,
        0.1466048550836816,
        8.311124069262431e-13,
        1.3327798389400358e-12,
        8.979260064960962e-13,
        7.957017320364801e-13,
        4.847890965009908e-13,
        3.378585846071048e-13,
        6.293228663786616e-13,
        3.438174630990188e-13,
        2.719931152291267e-12,
        1.823050527515938e-12,
        8.734716102697096e-13,
        1.4340836999341765e-12,
        1.0854935113202699e-12,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 5.7e-3
    @test rmsd(w12, w22) < 3.6e-3
    @test rmsd(w13, w23) < 4.4e-2
    @test rmsd(w14, w24) < 1e-6
end

@testset "rdar" begin
    println("Testing rm = :rdar, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :rdar

    w11 = [
        0.05579002972141407,
        4.559085421181959e-9,
        1.8596335544931795e-9,
        2.9802281464342953e-9,
        0.02857882770931755,
        5.415987709744306e-10,
        5.200639256109981e-8,
        0.02016234404770185,
        5.185391359718703e-9,
        7.612518150324201e-9,
        0.4407875773011993,
        6.004924418499805e-9,
        0.02204964864890511,
        1.5605628094681774e-8,
        3.473464920508876e-9,
        0.1434081587814339,
        0.16474438796286034,
        0.054676628485664056,
        2.768572294301908e-9,
        0.06980229474406624,
    ]
    w12 = [
        0.05657167376176226,
        1.5129832781106026e-7,
        8.334599337513722e-9,
        2.908888564572348e-8,
        0.030715086564658087,
        7.083839998484758e-8,
        2.916011743407911e-7,
        0.02090094714524861,
        5.2757914874963495e-8,
        5.576765951788797e-8,
        0.44105381298654817,
        5.63390251983476e-8,
        0.021512464165009126,
        2.6713952881873538e-8,
        1.6149446499719555e-7,
        0.14450155675146922,
        0.15882038743727697,
        0.061305134158185844,
        3.746269230615747e-8,
        0.06461799533274466,
    ]
    w13 = [
        3.814442512180068e-8,
        1.7687387557087746e-7,
        0.04497318290766362,
        1.0737487494039239e-7,
        0.26999799551963716,
        7.10917863258525e-8,
        2.884447166856297e-7,
        0.11073546168500426,
        4.544916718110216e-8,
        6.956980345216452e-8,
        0.2841536577025366,
        2.1667104138480983e-7,
        2.2547812329714954e-8,
        3.9184478852579e-8,
        3.6766297148353334e-7,
        0.2901379147571108,
        1.4217965706657427e-7,
        1.0467401158942807e-7,
        6.946379554060784e-8,
        2.8095629937517645e-8,
    ]
    w14 = [
        1.769186807322036e-7,
        1.1482951267940385e-7,
        4.0651727864684125e-7,
        3.1427407050352383e-7,
        7.381247345437428e-7,
        2.3048729625230603e-7,
        0.9999942040615849,
        2.8359020942009057e-7,
        3.4232309144199264e-7,
        8.850932452087598e-8,
        2.9633385655641866e-7,
        7.988277401387283e-7,
        1.269141413167078e-7,
        5.393857093974128e-7,
        4.88569186932145e-7,
        4.976769167370377e-7,
        4.1622695269768804e-8,
        5.4148707224637366e-8,
        1.1672185540822607e-7,
        1.4016340722974006e-7,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 2.3e-3
    @test rmsd(w12, w22) < 2.3e-4
    @test rmsd(w13, w23) < 5.8e-3
    @test rmsd(w14, w24) < 1e-4

    w11 = [
        0.05579002972141407,
        4.559085421181959e-9,
        1.8596335544931795e-9,
        2.9802281464342953e-9,
        0.02857882770931755,
        5.415987709744306e-10,
        5.200639256109981e-8,
        0.02016234404770185,
        5.185391359718703e-9,
        7.612518150324201e-9,
        0.4407875773011993,
        6.004924418499805e-9,
        0.02204964864890511,
        1.5605628094681774e-8,
        3.473464920508876e-9,
        0.1434081587814339,
        0.16474438796286034,
        0.054676628485664056,
        2.768572294301908e-9,
        0.06980229474406624,
    ]
    w12 = [
        0.056567179449013426,
        7.810836578438785e-8,
        1.1335546864859456e-8,
        3.0389101906410815e-8,
        0.030603208435540954,
        1.1093958166656065e-8,
        9.454148660966028e-8,
        0.020818059668586013,
        3.304495008344107e-8,
        1.1600870919057663e-8,
        0.44105135272349233,
        4.855622640177919e-8,
        0.02154965623571187,
        1.225804719640805e-8,
        3.924686844467751e-8,
        0.14452179799063328,
        0.158994700969228,
        0.06103286689682698,
        1.348969649543533e-8,
        0.06486079396584817,
    ]
    w13 = [
        1.966635607553692e-8,
        8.98137497417884e-9,
        0.04795059013392795,
        4.015089705038871e-9,
        0.2753757331344829,
        2.3018052961878973e-9,
        4.5329749415613195e-9,
        0.08982851026510076,
        3.34918634426132e-9,
        3.8114307159920624e-9,
        0.3141337264899054,
        1.894101088865196e-9,
        1.3042663617960842e-9,
        4.706489295373536e-9,
        1.6515259314724798e-9,
        0.2727113183694448,
        2.4337613441536403e-8,
        1.133394704881852e-8,
        8.040791306651472e-9,
        2.1680185762548424e-8,
    ]
    w14 = [
        2.0057025193069627e-11,
        1.768014885266603e-11,
        8.504643553928444e-12,
        1.2703802360677914e-11,
        0.8503246017177432,
        3.1462906542154495e-11,
        0.1496753978774049,
        2.6783938585645378e-11,
        1.546817843294095e-11,
        2.6395423090802118e-11,
        2.8351216433003316e-11,
        3.163770740249663e-11,
        3.6322007553986895e-11,
        3.1173366303119326e-11,
        3.2961739792014286e-11,
        2.5223718834242133e-11,
        2.2465452563173306e-12,
        2.6254656866888835e-11,
        1.1740295215825809e-11,
        1.9884428611941238e-11,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 2.3e-3
    @test rmsd(w12, w22) < 1e-3
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-5

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 5.7e-3
    @test rmsd(w12, w22) < 3.6e-3
    @test rmsd(w13, w23) < 4.4e-2
    @test rmsd(w14, w24) < 1e-3
end

@testset "krt full" begin
    println("Testing full rm = :krt, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :ECOS => Dict(
                :solver => ECOS.Optimizer,
                :params => Dict("verbose" => false, "maxit" => 500),
            ),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false, "max_step_fraction" => 0.75),
            ),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :krt

    w11 = [
        9.37887062985676e-10,
        0.040595827124190915,
        7.33779394635287e-10,
        0.07615519909349815,
        7.195445799737569e-10,
        0.0002488568040515834,
        1.316547801225105e-9,
        0.12868741827629487,
        1.3303094094344748e-9,
        3.5220831961377146e-10,
        0.37188983319168933,
        1.3408325442203143e-9,
        2.313796015165089e-9,
        0.040993353331281894,
        5.36075521118924e-10,
        0.02035251368640191,
        2.5540952978598503e-10,
        0.18817927618180288,
        1.0415864199419324e-9,
        0.13289771143281173,
    ]
    w12 = [
        3.115198945882048e-8,
        4.635126639439784e-8,
        3.9333777563899206e-8,
        4.263463329199279e-8,
        0.5745650892881761,
        6.705711583051195e-8,
        0.13934453591682358,
        7.376835584261699e-8,
        4.387981659458447e-8,
        6.083802456600552e-8,
        6.753558883206065e-8,
        4.880517082513492e-8,
        5.98810691153081e-8,
        6.421747331794363e-8,
        4.589508527932446e-8,
        0.2727753987452222,
        0.013314116758396229,
        6.730022170242304e-8,
        5.323508770052366e-8,
        4.740670562203561e-8,
    ]
    w13 = [
        1.514152911271217e-9,
        0.022826110428394445,
        0.012385117301192855,
        0.06435646102200569,
        0.17697154043259147,
        4.277654891621154e-9,
        0.008399339785076367,
        0.13005461944794275,
        6.310899050520475e-10,
        7.733924576613465e-10,
        0.18708295761485602,
        5.3344250558520686e-9,
        8.49989691314517e-9,
        1.996015680907573e-9,
        7.80521667906129e-9,
        0.08368213317488604,
        0.20980264809841562,
        0.06508217306030513,
        0.03935686848814205,
        3.1434701918163973e-10,
    ]
    w14 = [
        1.4787352452290254e-8,
        1.490924726238489e-8,
        1.5271106865978208e-8,
        1.5131823081412687e-8,
        4.1477661002483844e-7,
        1.2453355384674588e-8,
        0.9999993320298523,
        1.406175010490928e-8,
        1.5009974980910758e-8,
        1.4303559762991834e-8,
        1.3975491719132134e-8,
        1.2701349531971336e-8,
        1.1047669990477897e-8,
        1.3415788743833218e-8,
        1.124740653460713e-8,
        1.560383024320098e-8,
        1.5331292122357093e-8,
        1.4196994336520328e-8,
        1.5069820362795756e-8,
        1.4675724302947847e-8,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 2.7e-3
    @test rmsd(w12, w22) < 9e-2
    @test rmsd(w13, w23) < 1.7e-2
    @test rmsd(w14, w24) < 1e-6

    w11 = [
        9.37887062985676e-10,
        0.040595827124190915,
        7.33779394635287e-10,
        0.07615519909349815,
        7.195445799737569e-10,
        0.0002488568040515834,
        1.316547801225105e-9,
        0.12868741827629487,
        1.3303094094344748e-9,
        3.5220831961377146e-10,
        0.37188983319168933,
        1.3408325442203143e-9,
        2.313796015165089e-9,
        0.040993353331281894,
        5.36075521118924e-10,
        0.02035251368640191,
        2.5540952978598503e-10,
        0.18817927618180288,
        1.0415864199419324e-9,
        0.13289771143281173,
    ]
    w12 = [
        4.943744518873196e-7,
        3.059514031998508e-7,
        5.033187391510225e-7,
        1.9787613957619606e-7,
        0.9986734834585569,
        5.479329479693525e-7,
        0.0013184893113222173,
        5.596601206234302e-7,
        2.0475884822998355e-7,
        6.343281929311323e-7,
        3.6762977710816574e-7,
        3.612458538194174e-7,
        5.724465203005085e-7,
        4.612673343585714e-7,
        1.2414535164143045e-7,
        4.5832844243609943e-7,
        3.1461836451228493e-7,
        7.37854392447645e-7,
        4.1416082338473885e-7,
        7.673324173984174e-7,
    ]
    w13 = [
        2.0079180472226802e-8,
        0.011976710634236835,
        1.9641062978050873e-7,
        0.06099265321568782,
        0.19300217384218124,
        7.4487973084661275e-9,
        0.04149612357259595,
        0.12397135227476218,
        3.7984073448090876e-8,
        3.7348602826357486e-8,
        0.22978111128920284,
        6.217279580230975e-9,
        3.770689759454153e-9,
        1.7244712228240225e-8,
        4.120728212879055e-9,
        0.08320863462229565,
        0.18057567442643593,
        0.05910058102583622,
        7.675334918416778e-7,
        0.01589388693857982,
    ]
    w14 = [
        3.9286664335106695e-12,
        4.988144181251556e-12,
        7.843107453277651e-12,
        6.441288679983042e-12,
        0.8503244345705256,
        1.9360718283311517e-12,
        0.14967556535123241,
        1.1551334022739216e-12,
        5.971243602847596e-12,
        2.0062490162708746e-12,
        9.524370559992123e-13,
        1.4183772248144971e-12,
        2.7164077300836885e-12,
        3.905250428358993e-13,
        2.7253486475339273e-12,
        1.4646549434929544e-11,
        9.166043158509525e-12,
        1.6255320648227692e-12,
        6.644839318197542e-12,
        3.686250019736728e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 2.7e-3
    @test rmsd(w12, w22) < 2e-1
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-10

    w11 = [
        9.37887062985676e-10,
        0.040595827124190915,
        7.33779394635287e-10,
        0.07615519909349815,
        7.195445799737569e-10,
        0.0002488568040515834,
        1.316547801225105e-9,
        0.12868741827629487,
        1.3303094094344748e-9,
        3.5220831961377146e-10,
        0.37188983319168933,
        1.3408325442203143e-9,
        2.313796015165089e-9,
        0.040993353331281894,
        5.36075521118924e-10,
        0.02035251368640191,
        2.5540952978598503e-10,
        0.18817927618180288,
        1.0415864199419324e-9,
        0.13289771143281173,
    ]
    w12 = [
        9.458800653277733e-8,
        1.0782449378796313e-7,
        1.0158283317936322e-7,
        1.046635445105148e-7,
        0.5233684023145223,
        1.2461057339046508e-7,
        0.12664438180102888,
        1.3167286453873066e-7,
        1.0468412568095365e-7,
        1.1966649539462582e-7,
        1.2681361173677097e-7,
        1.1050727969294146e-7,
        1.2272619603307217e-7,
        1.223019190499295e-7,
        1.0492793533632722e-7,
        0.20419138626880318,
        0.1457940042571424,
        1.259714765597579e-7,
        1.1265424309560635e-7,
        1.101629045948986e-7,
    ]

    w14 = [
        1.7725244472635677e-6,
        2.2332808134257328e-6,
        1.766747131519019e-6,
        1.9168836115916535e-6,
        0.852898775315055,
        2.4592805272459505e-6,
        0.14705134293690694,
        2.7147347511090495e-6,
        2.752944064807937e-6,
        2.758527429213058e-6,
        2.5781240439607573e-6,
        2.7595865722110965e-6,
        4.289346875090677e-6,
        2.483041231169163e-6,
        2.572683315759476e-6,
        6.719705735051469e-6,
        2.3869389493995773e-6,
        2.546815524413547e-6,
        2.6846797205762933e-6,
        2.485903294297768e-6,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 2.7e-3
    @test rmsd(w12, w22) < 6.1e-2
    @test rmsd(w14, w24) < 1.8e-4
end

@testset "krt relaxed" begin
    println("Testing relaxed rm = :krt, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            # :ECOS => Dict(
            #     :solver => ECOS.Optimizer,
            #     :params => Dict("verbose" => true, "maxit" => 500),
            # ),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false),
            ),
        ),
    )
    asset_statistics!(port)
    rm = :krt
    port.max_num_assets_kurt = 1

    w11 = [
        0.05000006003933561,
        0.05000011653200388,
        0.0499999811494444,
        0.050000050665165635,
        0.04999995500833027,
        0.05000014736153201,
        0.04999933385945339,
        0.050000406481719405,
        0.049999839817117114,
        0.05000004649195019,
        0.05000037997924674,
        0.04999979503089235,
        0.04999949397470346,
        0.05000017341069554,
        0.04999970578355134,
        0.050000007173188775,
        0.05000007895565978,
        0.0500002821038347,
        0.049999963645046906,
        0.050000182537128575,
    ]
    w12 = [
        2.9642239447710655e-6,
        2.961944973825627e-6,
        2.9629758860954194e-6,
        2.9621198647043782e-6,
        0.4774596756646753,
        2.962111196491014e-6,
        0.522487009827231,
        2.961955390189544e-6,
        2.9610715351766874e-6,
        2.9623022912176586e-6,
        2.961664092172224e-6,
        2.9618533306684965e-6,
        2.9616551480715517e-6,
        2.9615877017937714e-6,
        2.958169191445656e-6,
        2.9613709715270997e-6,
        2.961884591018069e-6,
        2.961907348912632e-6,
        2.9615680496225393e-6,
        2.9641425861038096e-6,
    ]
    w13 = [
        0.018900022212015612,
        0.01928031532443446,
        0.023212048738661308,
        0.02206152234086144,
        0.21978018415254422,
        0.03599951609081468,
        0.2979971301026944,
        0.022175076567082907,
        0.020490675641144932,
        0.02084549856026369,
        0.022652315303891103,
        0.03219517175696326,
        0.05774684918202847,
        0.025739910401496997,
        0.054727368306260016,
        0.020762758185093346,
        0.023417365983190525,
        0.021432409038411905,
        0.02130108302456876,
        0.019282779087577927,
    ]
    w14 = [
        1.4742833133591588e-8,
        1.4861223252106373e-8,
        1.5225818305400315e-8,
        1.508493337786444e-8,
        4.1168522411894644e-7,
        1.2393323304878398e-8,
        0.9999993360743196,
        1.4009612732380198e-8,
        1.495965236761461e-8,
        1.4252294581887943e-8,
        1.3922507622838417e-8,
        1.2641000288249372e-8,
        1.0977725644197108e-8,
        1.335927687065135e-8,
        1.1174231589507641e-8,
        1.5555053465019993e-8,
        1.528453349126005e-8,
        1.4145162345449358e-8,
        1.5020870114054354e-8,
        1.4630403986901223e-8,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-6
    @test rmsd(w12, w22) < 6e-4
    @test rmsd(w13, w23) < 1e-6
    @test rmsd(w14, w24) < 1e-5

    w11 = [
        0.05000006003933561,
        0.05000011653200388,
        0.0499999811494444,
        0.050000050665165635,
        0.04999995500833027,
        0.05000014736153201,
        0.04999933385945339,
        0.050000406481719405,
        0.049999839817117114,
        0.05000004649195019,
        0.05000037997924674,
        0.04999979503089235,
        0.04999949397470346,
        0.05000017341069554,
        0.04999970578355134,
        0.050000007173188775,
        0.05000007895565978,
        0.0500002821038347,
        0.049999963645046906,
        0.050000182537128575,
    ]
    w12 = [
        6.893398815940391e-5,
        6.855371428308346e-5,
        6.628236079904856e-5,
        6.835574840408902e-5,
        0.5856720034383224,
        6.855718940835826e-5,
        0.3311306613035934,
        6.851564646012384e-5,
        6.826372362362984e-5,
        6.836791695700935e-5,
        6.853766219630029e-5,
        6.847257913390434e-5,
        6.767382952014367e-5,
        6.855528332382559e-5,
        6.820569450339143e-5,
        0.0820526235396916,
        5.2035718049200346e-5,
        6.855167372145803e-5,
        6.820774965097384e-5,
        6.864124019858442e-5,
    ]
    w14 = [
        3.35365022139209e-6,
        4.046593757194653e-6,
        2.132448685664194e-5,
        2.7477362414985734e-6,
        0.8494478923182281,
        1.693708795170189e-6,
        0.1503459647846432,
        1.4719091776181591e-6,
        2.311833554550305e-6,
        2.154413025264905e-6,
        1.5151842994922282e-6,
        2.5446143629983105e-6,
        1.3898188353187887e-6,
        1.690900602645287e-6,
        2.29859238735903e-6,
        0.0001398830605340488,
        1.055392850694175e-5,
        1.757032889116033e-6,
        2.9398113520313215e-6,
        2.4656217292334974e-6,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 4.2e-4
    @test rmsd(w12, w22) < 1e-8
    @test rmsd(w14, w24) < 1e-9

    w11 = [
        0.05514023675290348,
        0.0416866820129796,
        0.015295307078387419,
        0.03845084467756283,
        0.107027161655376,
        0.006219390653204759,
        0.12539243400976255,
        0.06516138518589928,
        0.016994458968288797,
        0.05222021336611838,
        0.06471330154047447,
        0.0380060957230634,
        0.08332857729501973,
        0.05698827996620065,
        0.09277062357848598,
        0.02617070350792744,
        0.003210039999103272,
        0.06606992504871273,
        0.0025604867285477007,
        0.04259385225198163,
    ]
    w12 = [
        7.410881546819831e-6,
        7.63409229942133e-6,
        8.13759948582249e-6,
        7.6626696356367e-6,
        0.855190884725689,
        7.748394981023279e-6,
        0.14467319850988034,
        7.483801847897388e-6,
        7.547785647830484e-6,
        7.652570008384652e-6,
        7.611392933105107e-6,
        7.5739014336309125e-6,
        7.691805976455955e-6,
        7.671644068689947e-6,
        7.845766792507504e-6,
        5.775772514426258e-6,
        8.23215324727533e-6,
        7.436753747035011e-6,
        7.65206959002351e-6,
        7.1477086743601475e-6,
    ]
    w14 = [
        1.4491957102956583e-6,
        1.963870612586247e-6,
        1.4666951569689761e-6,
        1.6788669179629582e-6,
        0.8533637070347461,
        2.1997720840140544e-6,
        0.14659121953304186,
        2.4312300157359173e-6,
        2.5125579689854973e-6,
        2.5151401746488557e-6,
        2.307600715733255e-6,
        2.4639804674260457e-6,
        4.058928277080703e-6,
        2.2203788526429885e-6,
        2.3824013904162583e-6,
        6.427099136388782e-6,
        2.118021812974547e-6,
        2.2764138106314845e-6,
        2.4277289650486426e-6,
        2.1735501425682977e-6,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-8
    @test rmsd(w12, w22) < 3.8e-2
    @test rmsd(w14, w24) < 3.5e-5
end

@testset "skrt full" begin
    println("Testing full rm = :skrt, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false),
            ),
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
        ),
    )
    asset_statistics!(port)
    rm = :skrt

    w11 = [
        7.982841042152806e-10,
        0.031157128426973213,
        1.141296033121712e-9,
        4.5342029442816233e-10,
        1.1209043377581156e-9,
        3.418961957010118e-11,
        2.4595357426094124e-9,
        0.1192214422711865,
        1.370359054644285e-9,
        9.177929507133638e-10,
        0.5181896209428707,
        8.289036964376457e-10,
        1.7437873799040108e-9,
        1.726359374796173e-10,
        5.146147432634644e-10,
        3.764756480219255e-10,
        1.254934814351072e-10,
        0.1611705181814913,
        8.883562573450345e-10,
        0.17026127723142898,
    ]
    w12 = [
        8.327245014999139e-8,
        9.279508893569388e-8,
        7.803379757593813e-8,
        7.678462312817994e-8,
        0.9999261150004513,
        9.878074641829503e-8,
        7.224366842222795e-5,
        1.0420913309431599e-7,
        8.556551988030541e-8,
        8.673861007167261e-8,
        1.0773693836943378e-7,
        9.075416734792941e-8,
        8.494645777014973e-8,
        1.0318803709225862e-7,
        8.190170724924548e-8,
        9.701788705388987e-8,
        8.777746168186272e-8,
        1.0284530773469907e-7,
        9.14880658592393e-8,
        8.749512720816845e-8,
    ]
    w13 = [
        1.7859906996169386e-9,
        1.271311295955064e-10,
        1.4961640033786136e-9,
        4.435505156384062e-10,
        0.23227235338134186,
        4.341581702589416e-9,
        3.0301013442942956e-9,
        0.08533140943795013,
        1.4706904126578047e-9,
        1.6924741383721566e-9,
        0.18881223358443366,
        3.8264914205151935e-9,
        6.802447217486378e-9,
        1.8264524663167534e-9,
        6.3318468816933905e-9,
        0.05448923535680421,
        0.313966313905159,
        0.11122419643742656,
        9.68073313722539e-10,
        0.013904223753889439,
    ]
    w14 = [
        1.4746529194477868e-8,
        1.4864769608682732e-8,
        1.5229388429089284e-8,
        1.50888378601317e-8,
        4.1187243279095537e-7,
        1.2397646778384592e-8,
        0.9999993358150661,
        1.4012890214782413e-8,
        1.4963956846385612e-8,
        1.425685113917346e-8,
        1.3926054761890902e-8,
        1.2645807001881997e-8,
        1.0983683336761459e-8,
        1.336316426439152e-8,
        1.1179588853266343e-8,
        1.555837142452553e-8,
        1.5287788048913906e-8,
        1.4148691515576842e-8,
        1.5024741036182204e-8,
        1.4633740910885559e-8,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 3.5e-2
    @test rmsd(w12, w22) < 1e-1
    @test rmsd(w13, w23) < 4.3e-2
    @test rmsd(w14, w24) < 2.1e-7

    w11 = [
        7.982841042152806e-10,
        0.031157128426973213,
        1.141296033121712e-9,
        4.5342029442816233e-10,
        1.1209043377581156e-9,
        3.418961957010118e-11,
        2.4595357426094124e-9,
        0.1192214422711865,
        1.370359054644285e-9,
        9.177929507133638e-10,
        0.5181896209428707,
        8.289036964376457e-10,
        1.7437873799040108e-9,
        1.726359374796173e-10,
        5.146147432634644e-10,
        3.764756480219255e-10,
        1.254934814351072e-10,
        0.1611705181814913,
        8.883562573450345e-10,
        0.17026127723142898,
    ]
    w12 = [
        5.604038428178191e-9,
        1.2703811146633239e-8,
        7.83571794187071e-9,
        6.0279916934799135e-9,
        0.5728219250900933,
        1.405025595315925e-9,
        0.08065990976686213,
        7.214724263580556e-9,
        6.344209698148546e-9,
        3.722297989929215e-9,
        7.344780711287127e-9,
        1.2933258419156953e-9,
        7.682784049083467e-10,
        2.7690784478912205e-9,
        8.118468479676071e-10,
        0.18372034529139009,
        0.16279771779302163,
        8.198405722039078e-9,
        2.253163971220572e-8,
        7.483460377754542e-9,
    ]
    w13 = [
        2.528390187821992e-8,
        0.016331909656252128,
        2.5684532580619123e-8,
        3.652828156002616e-8,
        0.28264997229579925,
        7.2972294179580574e-9,
        0.0006853705185957093,
        0.07099718312202988,
        2.125512118595212e-8,
        1.7724711492183763e-8,
        0.2689405079784818,
        6.321545374482966e-9,
        3.451644217413769e-9,
        2.070087645059764e-8,
        3.9560179463249895e-9,
        0.12088914193962133,
        0.2186037921969334,
        0.013245740508424005,
        7.221079301464222e-8,
        0.007656141369207432,
    ]
    w14 = [
        9.723282413225613e-12,
        1.306896393965306e-11,
        2.06677498976376e-11,
        1.6886578959684437e-11,
        0.8503235164298986,
        5.830427763955736e-12,
        0.14967648335035602,
        3.1514994267276456e-12,
        1.5702408325610412e-11,
        4.905026355348536e-12,
        2.319790119144947e-12,
        5.377053074362762e-12,
        9.008777205065292e-12,
        1.7892315056281844e-12,
        8.878178302560143e-12,
        4.526761050954252e-11,
        2.530593509464869e-11,
        4.270073863513472e-12,
        1.8092525598943228e-11,
        9.500455385397667e-12,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 3.5e-2
    @test rmsd(w12, w22) < 7e-6
    @test rmsd(w13, w23) < 1e-7
    @test rmsd(w14, w24) < 1e-4

    w11 = [
        7.982841042152806e-10,
        0.031157128426973213,
        1.141296033121712e-9,
        4.5342029442816233e-10,
        1.1209043377581156e-9,
        3.418961957010118e-11,
        2.4595357426094124e-9,
        0.1192214422711865,
        1.370359054644285e-9,
        9.177929507133638e-10,
        0.5181896209428707,
        8.289036964376457e-10,
        1.7437873799040108e-9,
        1.726359374796173e-10,
        5.146147432634644e-10,
        3.764756480219255e-10,
        1.254934814351072e-10,
        0.1611705181814913,
        8.883562573450345e-10,
        0.17026127723142898,
    ]
    w12 = [
        9.307968025844644e-8,
        1.0129430216803709e-7,
        8.692051335729502e-8,
        8.486381060976242e-8,
        0.9163905991688787,
        1.0719415437245294e-7,
        0.08360759571709242,
        1.1345629443958932e-7,
        9.378050487750424e-8,
        9.720139614812888e-8,
        1.162987388257048e-7,
        1.0039054481045014e-7,
        9.409230724401617e-8,
        1.1245182235302602e-7,
        9.186411536637287e-8,
        1.0622943268903091e-7,
        9.646585528109694e-8,
        1.1227371835374855e-7,
        9.998698209468678e-8,
        9.726985566270334e-8,
    ]
    w13 = [
        4.306206043513433e-9,
        0.09963020336365784,
        4.314177354670469e-9,
        3.646656198678418e-11,
        7.65131352306616e-10,
        4.628797831378148e-9,
        1.0392947724698065e-8,
        0.13532426515129847,
        2.1325955546886343e-9,
        2.670956144085163e-9,
        0.39040681885093154,
        2.3007635796281224e-9,
        1.329202396937025e-10,
        0.02087194906104199,
        1.3456301451495319e-9,
        2.2982427868644713e-9,
        8.172595734773368e-10,
        0.19936958734599977,
        8.100308980997385e-10,
        0.1543971392749445,
    ]
    w14 = [
        5.196060109192332e-6,
        4.879700870790502e-6,
        5.102905879124217e-6,
        4.8337029112352186e-6,
        0.8550851947842012,
        4.784224808907169e-6,
        0.14482930798250065,
        4.829823898619645e-6,
        4.645031868839119e-6,
        4.668191729144458e-6,
        4.801087711908069e-6,
        4.861791985256761e-6,
        4.257838322291474e-6,
        4.790696295182476e-6,
        4.458511821550166e-6,
        4.003965429434134e-6,
        4.8446058170060465e-6,
        4.81102708811913e-6,
        4.727049801657758e-6,
        5.001016950102919e-6,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 3.5e-2
    @test rmsd(w12, w22) < 9.8e-2
    @test rmsd(w13, w23) < 4.4e-2
    @test rmsd(w14, w24) < 5.2e-4
end

@testset "skrt relaxed" begin
    println("Testing relaxed rm = :skrt, for all kelly returns.")
    port = Portfolio(
        returns = RET,
        solvers = OrderedDict(
            :SCS => Dict(:solver => SCS.Optimizer, :params => Dict("verbose" => 0)),
            :COSMO =>
                Dict(:solver => COSMO.Optimizer, :params => Dict("verbose" => false)),
            :Clarabel => Dict(
                :solver => Clarabel.Optimizer,
                :params => Dict("verbose" => false),
            ),
        ),
    )
    asset_statistics!(port)
    rm = :skrt
    port.max_num_assets_kurt = 1

    w11 = [
        0.050000000000000606,
        0.05000000000000117,
        0.050000000000000815,
        0.050000000000000606,
        0.050000000000001085,
        0.05000000000000106,
        0.050000000000000565,
        0.05000000000000026,
        0.0500000000000006,
        0.050000000000000114,
        0.04999999999999998,
        0.04999999999999986,
        0.050000000000000114,
        0.04999999999999911,
        0.04999999999999942,
        0.049999999999999385,
        0.04999999999999919,
        0.04999999999999906,
        0.04999999999999891,
        0.04999999999999817,
    ]
    w12 = [
        6.455953960568686e-7,
        6.455954089302699e-7,
        6.457332512076015e-7,
        6.459447514669266e-7,
        0.47081241480500097,
        6.455528508128865e-7,
        0.5291759634810956,
        6.452097254335057e-7,
        6.459710137599309e-7,
        6.458974454891232e-7,
        6.454286560507449e-7,
        6.456349842090027e-7,
        6.461553944769725e-7,
        6.454265996659646e-7,
        6.458188425856627e-7,
        6.45658545517431e-7,
        6.456318799574831e-7,
        6.453540962414621e-7,
        6.457530303041166e-7,
        6.453520312001723e-7,
    ]
    w13 = [
        0.018900022212015612,
        0.01928031532443446,
        0.023212048738661308,
        0.02206152234086144,
        0.21978018415254422,
        0.03599951609081468,
        0.2979971301026944,
        0.022175076567082907,
        0.020490675641144932,
        0.02084549856026369,
        0.022652315303891103,
        0.03219517175696326,
        0.05774684918202847,
        0.025739910401496997,
        0.054727368306260016,
        0.020762758185093346,
        0.023417365983190525,
        0.021432409038411905,
        0.02130108302456876,
        0.019282779087577927,
    ]
    w14 = [
        1.4742833286822958e-8,
        1.486122376700924e-8,
        1.522581841340201e-8,
        1.5084933116815453e-8,
        4.1168522004155456e-7,
        1.239332335129735e-8,
        0.999999336074322,
        1.4009613028332303e-8,
        1.4959652189675798e-8,
        1.425229516609218e-8,
        1.3922507598209601e-8,
        1.2641000163056434e-8,
        1.0977725787126606e-8,
        1.3359277114810495e-8,
        1.1174232119672775e-8,
        1.5555053571997216e-8,
        1.5284533759579546e-8,
        1.4145161845104134e-8,
        1.502086998953666e-8,
        1.46304039079864e-8,
    ]

    kelly = :none
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :sharpe
    w3 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w23 = w3.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-7
    @test rmsd(w12, w22) < 2.1e-3
    @test rmsd(w13, w23) < 4.3e-2
    @test rmsd(w14, w24) < 2.2e-6

    w11 = [
        0.05017226262057069,
        0.05016351197056789,
        0.05007513173567151,
        0.04995252155033251,
        0.05004993916733474,
        0.05024184814141873,
        0.04903691714667429,
        0.050510868437165284,
        0.049846780236468755,
        0.05005729669421008,
        0.05055302249437607,
        0.049584318239207635,
        0.048970085535307066,
        0.050322335708133915,
        0.0495851406027916,
        0.04994840699223913,
        0.05015837445875571,
        0.050447019587693175,
        0.05002851978169167,
        0.05029569889938957,
    ]
    w12 = [
        6.455953178982716e-7,
        6.455953306111455e-7,
        6.45733172588847e-7,
        6.459446733454538e-7,
        0.47081241481170955,
        6.455527720938434e-7,
        0.5291759634757982,
        6.45209647539787e-7,
        6.459709354520628e-7,
        6.45897367092151e-7,
        6.454285776830473e-7,
        6.456349058924659e-7,
        6.461553164642602e-7,
        6.454265209814979e-7,
        6.458187640814766e-7,
        6.45658466696639e-7,
        6.456318016381477e-7,
        6.453540174401764e-7,
        6.457529516043211e-7,
        6.453519530355134e-7,
    ]
    w14 = [
        1.4491942108529963e-6,
        1.9638692122871565e-6,
        1.4666937030072718e-6,
        1.6788655942688532e-6,
        0.8533637068598828,
        2.1997706888034523e-6,
        0.14659121973352748,
        2.431228564690077e-6,
        2.5125565897768887e-6,
        2.5151387976043706e-6,
        2.307599297654686e-6,
        2.4639789857238116e-6,
        4.0589268710223e-6,
        2.220377451522181e-6,
        2.382400139290716e-6,
        6.42709749883426e-6,
        2.11802039333695e-6,
        2.276412387686396e-6,
        2.4277275648964346e-6,
        2.173548638545329e-6,
    ]

    kelly = :approx
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 1e-9
    @test rmsd(w12, w22) < 5.5e-2
    @test rmsd(w13, w23) < 1e-8
    @test rmsd(w14, w24) < 1.3e-3

    w11 = [
        0.05514023675290348,
        0.0416866820129796,
        0.015295307078387419,
        0.03845084467756283,
        0.107027161655376,
        0.006219390653204759,
        0.12539243400976255,
        0.06516138518589928,
        0.016994458968288797,
        0.05222021336611838,
        0.06471330154047447,
        0.0380060957230634,
        0.08332857729501973,
        0.05698827996620065,
        0.09277062357848598,
        0.02617070350792744,
        0.003210039999103272,
        0.06606992504871273,
        0.0025604867285477007,
        0.04259385225198163,
    ]
    w12 = [
        1.195222572483807e-6,
        1.2573960374322104e-6,
        6.982280152849133e-7,
        5.284881751674626e-7,
        0.8543359745516885,
        1.3249715430556499e-6,
        0.14564235122552724,
        1.3778907769511777e-6,
        1.0187556624885785e-6,
        1.1706217151535522e-6,
        1.1586830702467837e-6,
        1.4626286688192484e-6,
        1.0064358128581675e-6,
        1.6571476677563102e-6,
        1.2396839911644716e-6,
        2.0870164671755957e-6,
        8.465617810567707e-7,
        1.4660272463270957e-6,
        1.276722742597027e-6,
        9.01740838167006e-7,
    ]
    w14 = [
        1.4491942108529963e-6,
        1.9638692122871565e-6,
        1.4666937030072718e-6,
        1.6788655942688532e-6,
        0.8533637068598828,
        2.1997706888034523e-6,
        0.14659121973352748,
        2.431228564690077e-6,
        2.5125565897768887e-6,
        2.5151387976043706e-6,
        2.307599297654686e-6,
        2.4639789857238116e-6,
        4.0589268710223e-6,
        2.220377451522181e-6,
        2.382400139290716e-6,
        6.42709749883426e-6,
        2.11802039333695e-6,
        2.276412387686396e-6,
        2.4277275648964346e-6,
        2.173548638545329e-6,
    ]

    kelly = :exact
    obj = :min_risk
    w1 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :utility
    w2 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    obj = :max_ret
    w4 = opt_port!(port, type = type, rm = rm, obj = obj, kelly = kelly, rf = rf, l = l)
    w21 = w1.weights
    w22 = w2.weights
    w24 = w4.weights

    @test rmsd(w11, w21) < 3.5e-2
    @test rmsd(w12, w22) < 3.8e-2
    @test rmsd(w14, w24) < 3.5e-5
end