using Test
using PortfolioOptimiser, CSV, DataFrames, Statistics

@testset "Efficient return value" begin
    df = CSV.read("./assets/stock_prices.csv", DataFrame)
    dropmissing!(df)
    returns = returns_from_prices(df[!, 2:end])

    # Mean returns.
    mu = ret_model(MRet(), Matrix(returns))
    mutest = [
        0.165077005733385
        0.183572017421321
        0.238036763838874
        0.192316447138601
        0.508570682802054
        -0.153295057043960
        0.305495623268028
        0.059318615800612
        0.189931534062078
        0.084295329365638
        0.054465665833134
        -0.182249168372897
        -0.439434885859736
        -0.028695410193010
        -0.353755082717798
        0.256437396469586
        0.262994437027811
        0.084965198887185
        0.214010363955894
        0.154258862256590
    ]
    @test mu ≈ mutest

    mu = ret_model(MRet(), Matrix(returns); compound = false)
    mutest = [
        0.178914374187325
        0.195208843702195
        0.245787816971219
        0.226167230238702
        0.452494357193942
        -0.143808069153082
        0.465034663597819
        0.078266717104239
        0.208793660771767
        0.111571083023889
        0.066312449760358
        -0.109757830255107
        -0.338454468486514
        -0.011028146100837
        -0.311429033491868
        0.290932770652577
        0.253991539266203
        0.096869664526551
        0.217271589766479
        0.163468530861212
    ]
    @test mu ≈ mutest

    # Exponential returns.
    mu = ret_model(EMRet(), Matrix(returns); span = 500)
    mutest = [
        0.174206788637514
        0.261448055846544
        0.182275222944877
        0.388168987273908
        0.602214112048088
        -0.405425982176985
        0.309416246725018
        0.119263386354215
        0.351783576012055
        0.140163506583907
        0.010482845369419
        -0.119858604418692
        -0.396957355595715
        -0.012867616138760
        -0.290725396632509
        0.513672821109176
        0.407679425007418
        0.098478138659613
        0.319774016932130
        0.099739436963900
    ]
    @test mu ≈ mutest

    mu = ret_model(EMRet(), Matrix(returns); compound = false, span = 500)
    mutest = [
        0.160644027761459
        0.232367378080205
        0.167496377111932
        0.328199137640111
        0.471827651094508
        -0.519374112543301
        0.269725670874286
        0.112695969837963
        0.301605231542693
        0.131205823781312
        0.010428497113714
        -0.127640371175951
        -0.505260162800969
        -0.012950788228994
        -0.343278494299677
        0.414880173944252
        0.342174649145516
        0.093943217781961
        0.277613325432957
        0.095091212893796
    ]
    @test mu ≈ mutest

    # CAPM rets.
    mu = ret_model(CAPMRet(), Matrix(returns))
    mutest = [
        0.094883850444685
        0.095679415838370
        0.103105763584424
        0.113528802174820
        0.105209157372728
        0.089111865352351
        0.191417900856481
        0.066415817812618
        0.122436002682103
        0.104694131070045
        0.062870019348941
        0.144651558003671
        0.197305954089759
        0.082330006545561
        0.144756910925415
        0.113935315988995
        0.096108833370246
        0.071786198182351
        0.107079483654873
        0.084533187625037
    ]
    @test mu ≈ mutest

    mu = ret_model(CAPMRet(), Matrix(returns); compound = false)
    mutest = [
        0.100933917383660
        0.101793758637327
        0.109820100917702
        0.121085244725778
        0.112093433526496
        0.094695598148891
        0.205267212404455
        0.070165876111249
        0.130712081830110
        0.111536796868735
        0.066333603088240
        0.154722491395735
        0.211630977236295
        0.087365814796178
        0.154836356062335
        0.121524601880310
        0.102257869962287
        0.075970143901725
        0.114114868480771
        0.089746996778792
    ]
    @test mu ≈ mutest

    mu = ret_model(ECAPMRet(), Matrix(returns); rspan = 500, cspan = 500)
    mutest = [
        0.09139391988704085
        0.08583852838696727
        0.09499477329572159
        0.10572143376970136
        0.09067107452064896
        0.08302369806022829
        0.15867778967706206
        0.06801860321851717
        0.10549276014308034
        0.09614499992006319
        0.06136800987467894
        0.14198028714125177
        0.1979620159376844
        0.06945672048624046
        0.1351920895772175
        0.09845786650669847
        0.08355249256001421
        0.06688710785255922
        0.09247933409174176
        0.06700270256064539
    ]
    @test mu ≈ mutest

    mu = ret_model(ECAPMRet(), Matrix(returns); compound = false, rspan = 500, cspan = 500)
    mutest = [
        0.08723285636839716
        0.08200125066043745
        0.0906238406484665
        0.10072531741428492
        0.08655214071681114
        0.07935047755036757
        0.15059520936231863
        0.06521992710737305
        0.10050997161007391
        0.09170702842619073
        0.05895695138397315
        0.13487089009987602
        0.18758982663369017
        0.06657422635098838
        0.12847833016556906
        0.09388509383098356
        0.07984845223376856
        0.06415437887103413
        0.08825500919934322
        0.0642632363538282
    ]
    @test mu ≈ mutest

    market_returns = vec(mean(Matrix(returns), dims = 2))
    mu = ret_model(CAPMRet(), Matrix(returns), market_returns)
    mu2 = ret_model(CAPMRet(), Matrix(returns))
    @test mu ≈ mu2

    mu = ret_model(ECAPMRet(), Matrix(returns), market_returns)
    mu2 = ret_model(ECAPMRet(), Matrix(returns))
    @test mu ≈ mu2

    returns = returns_from_prices(df[!, 2:end], false)
    sample = Matrix(returns[(div(895, 2) - 9):(div(895, 2) + 10), :])
    prices = prices_from_returns(sample, false)
    testprices =
        reshape(
            [
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                0.973759763509202,
                0.977242441484168,
                0.988023411032638,
                0.983774152949054,
                0.984501965345403,
                0.998694648098653,
                1.107368421052632,
                0.995090950600042,
                1.006761740233119,
                1.007236282698759,
                1.005927286787767,
                1.021966036351787,
                1.061894108873975,
                0.994518608442393,
                1.034080234841704,
                1.021233490903907,
                0.991602697445295,
                0.984748216335895,
                1.000964172795545,
                0.996038166261816,
                0.976561231837967,
                0.974884652417969,
                0.991083171527959,
                0.998466909357362,
                0.995122019273292,
                1.006201146880412,
                1.073684210526316,
                0.997194879235342,
                1.017280234559017,
                1.021708996412671,
                1.007162127972689,
                1.046403160153935,
                1.041014168530947,
                0.998903686597841,
                1.055788928102513,
                1.023929852519652,
                1.002869889496492,
                0.992805829703991,
                1.00241068487559,
                0.997298688032194,
                0.979700457085854,
                0.98318805279491,
                0.999912562286149,
                1.004471777352949,
                0.997644627982263,
                1.009791244553838,
                1.147368421052632,
                1.002244005614527,
                1.023290747568804,
                1.016884894464728,
                1.014324556001776,
                1.053267520772516,
                1.048471290082028,
                1.003398446390085,
                1.084267031666962,
                1.013144511781142,
                1.01094796915976,
                1.0,
                1.01173244368457,
                1.00504227300192,
                0.981840245407404,
                0.979497752446765,
                0.995803872679464,
                1.005877169000019,
                0.990369424950601,
                1.004569284301582,
                1.056842105263158,
                1.006311316242934,
                1.022539365851443,
                1.010337615573696,
                1.020004896374841,
                1.034870979399834,
                1.022371364653244,
                0.999451895934877,
                1.060924269916215,
                1.012807532656967,
                0.999787159576775,
                0.991942509594461,
                1.007875111856014,
                1.00144058568498,
                0.988048327356164,
                0.985135813186476,
                1.00603202208263,
                1.01111539585213,
                1.006369258876263,
                1.017950419286271,
                1.096842105263158,
                1.011220028072636,
                1.054845844311421,
                1.027567086100484,
                1.034329370543054,
                1.052169195616101,
                1.032065622669649,
                1.006358189626742,
                1.060690945653863,
                1.025615135796914,
                1.017325525338249,
                0.995395636329386,
                1.02941167049318,
                1.010804838846329,
                0.950532103803679,
                0.957457773176597,
                0.979805953141061,
                0.974703001457889,
                0.974146718872953,
                0.973237626409336,
                1.027368421052632,
                1.00925651398682,
                0.97670917518418,
                0.976912328548102,
                1.025438344888914,
                1.026359227147678,
                1.005965697240865,
                0.979938565416826,
                1.011204403493357,
                1.016177958245531,
                0.972257598272085,
                0.977554046039886,
                0.957891257830595,
                0.984692838199028,
                0.940734309520545,
                0.943516142954164,
                0.952618252929612,
                0.948383874347152,
                0.963554480584877,
                0.956919207863612,
                0.993684210526316,
                1.002804885933176,
                0.915101436145609,
                0.947966975278475,
                1.038034085042802,
                0.986271278762838,
                0.936614466815809,
                0.974128491552087,
                0.99183012734647,
                0.989888899441758,
                0.946747276503671,
                0.972661888505669,
                0.925908032785044,
                0.966864707225464,
                0.957317405765754,
                0.959405290478603,
                0.98522596367887,
                0.974575213028308,
                0.98667614685961,
                0.977154165679386,
                1.077894736842105,
                1.002945197743886,
                0.954169732085722,
                0.955892335943158,
                1.037787165905955,
                1.030203241636642,
                0.967188665175242,
                0.996601565306794,
                1.039215670614638,
                1.011796454318484,
                0.961096788689101,
                0.991079066522374,
                0.95660544683618,
                0.98775429658808,
                0.963046905013942,
                0.967708859961325,
                0.997989378424595,
                0.997061504934004,
                0.997337968845898,
                0.997062716438965,
                1.08,
                1.016269154451821,
                0.99098419186181,
                0.970709736956426,
                1.050629743363128,
                1.091433338354384,
                0.994780014914243,
                1.013593504835238,
                1.026844058564319,
                1.027974412564014,
                0.979272780662482,
                1.007481933418973,
                0.98360649989023,
                1.021790039079912,
                0.974294710589589,
                0.980010185241221,
                0.999038377472143,
                1.016098148055378,
                0.997365869501946,
                1.027415118622196,
                1.082105263157895,
                1.02412318144115,
                0.996994704871598,
                0.975189448237801,
                1.067176953486485,
                1.10186719395207,
                1.014914243102162,
                1.027625350220648,
                1.007002664096569,
                1.031344732428109,
                0.936011662494852,
                1.013237472543998,
                0.998714070991778,
                1.028633044188056,
                0.984303785073141,
                0.982982990896592,
                0.998251621629965,
                1.017631340908318,
                1.011386577031866,
                1.027741491137962,
                1.067368421052632,
                1.021177969020297,
                0.984222374381676,
                0.995520214560428,
                1.073598514993614,
                1.110104399236924,
                1.03579418344519,
                1.028721757197841,
                1.038281974238493,
                1.056959903466512,
                0.944408717021502,
                1.023597129414525,
                0.99223518047531,
                1.026292008785781,
                0.978306811580891,
                0.97375703392856,
                0.998338998149655,
                1.008943452495597,
                1.014759328584141,
                1.026436173777044,
                1.04421052631579,
                1.025806409475803,
                0.957174949967108,
                0.970709736956426,
                1.070634667015823,
                1.076331772450948,
                0.967934377330351,
                1.019732331188387,
                0.986227855130368,
                1.023255788546834,
                0.937925112673484,
                1.030503628809488,
                0.964538200006899,
                1.022330249415759,
                0.982276641047004,
                0.979292605995557,
                1.020194055600962,
                1.004727252001811,
                1.028013511616375,
                1.035900804032111,
                1.061052631578948,
                1.035343547084043,
                0.966190680858282,
                0.978635431332995,
                1.076378701178608,
                1.094179027686932,
                0.979865771812081,
                1.031462406189127,
                1.004201481008901,
                1.032355951732552,
                0.924929348399564,
                1.031942382943028,
                0.974904330422202,
                1.021970028626351,
                0.978883945722252,
                0.983495592796829,
                1.012763344809541,
                1.013798403492976,
                1.026564085147746,
                1.038511853239098,
                1.056842105263158,
                1.031276221778668,
                0.977460556901542,
                0.990351351154932,
                1.056399391431071,
                1.112575569059614,
                0.999254287844892,
                1.01907481451469,
                0.993230495737129,
                1.031344732428109,
                0.935368450259779,
                1.029352545576994,
                0.981221221701174,
                1.024851348732637,
                0.993341432372489,
                0.991081498480997,
                1.024914756752468,
                1.009198939920747,
                1.039441941722876,
                1.050914008838205,
                1.073684210526316,
                1.035623818458239,
                0.989481582921117,
                1.02205360955383,
                1.064141310196257,
                1.110104399236925,
                1.048471290082029,
                1.025432992444552,
                1.030112007625731,
                1.043141257229572,
                0.94335758490553,
                1.039424316362,
                1.0014676028331,
                1.017648048466922,
                1.006658654907201,
                0.99415670825619,
                1.030422274940312,
                1.040756383317608,
                1.050549843896952,
                1.051240243192254,
                1.054736842105264,
                1.03870954816735,
                0.992486723555489,
                1.038249351894438,
                1.061643831692911,
                1.10653490425782,
                1.07979120059657,
                1.029269872959843,
                1.014005422152369,
                1.053252428270794,
                0.945381450704235,
                1.040287851656004,
                1.0085943217084,
                1.014226518024788,
                1.014471578097125,
                0.998667404165164,
                1.030946770093075,
                1.044333731097498,
                1.042786876241629,
                1.052872174851942,
                1.082105263157895,
                1.027629494335168,
                1.017280234559017,
                1.054445057155947,
                1.059146489578836,
                1.147721067969306,
                1.107382550335571,
                1.040889997295564,
                1.044584266221269,
                1.062689605822176,
                0.958696772168276,
                1.042877811984595,
                1.023657637632674,
                1.035116181755568,
                1.009319211582561,
                0.993029184888784,
                1.02089343492345,
                1.029385500040328,
                1.035009957561428,
                1.056135830928744,
                1.071578947368422,
                1.032538308903643,
                1.009766958114505,
                1.055478896579424,
                1.063641825406729,
                1.13975838219431,
                1.047725577926921,
                1.040122717106916,
                1.029178311249586,
                1.05830806665364,
                0.962318477836725,
                1.044892215326619,
                1.023009758696496,
                1.017107763762912,
                1.014907972328987,
                1.012711523060311,
                1.025351884127563,
                1.044333731097498,
                1.033016963763335,
                1.064947957935284,
                1.08842105263158,
                1.033660319049391,
                1.025544660979844,
                1.059958533702602,
                1.068137188512477,
                1.140582187840867,
                1.022371364653244,
                1.040889997295564,
                1.004201481008901,
                1.070441570579277,
                0.974142406602205,
                1.062446134715072,
                1.038559089192373,
                1.037097052144558,
            ],
            20,
            :,
        )'
    @test prices ≈ testprices

    returns = returns_from_prices(df[!, 2:end], true)
    sample = Matrix(returns[(div(895, 2) - 9):(div(895, 2) + 10), :])
    testlogret =
        reshape(
            [
                -1.190674651201062e-02,
                4.220726458870949e-03,
                -1.832452038960763e-03,
                -1.530833033943524e-03,
                4.550163742192526e-03,
                9.222570827522869e-03,
                7.466063348416285e-02,
                2.531019120816325e-03,
                -2.248844709788922e-03,
                5.544043500467888e-03,
                4.964103563913635e-03,
                -3.548729001521667e-02,
                1.667930250189542e-02,
                1.175683489416612e-02,
                -5.109197815700073e-03,
                1.124756138961747e-02,
                7.928084642031541e-03,
                -1.149759763308777e-03,
                4.034259629289494e-03,
                3.252138794107795e-03,
                -2.624023649079843e-02,
                -2.275755851583217e-02,
                -1.197658896736242e-02,
                -1.622584705094599e-02,
                -1.549803465459665e-02,
                -1.305351901346952e-03,
                1.073684210526316e-01,
                -4.909049399957954e-03,
                6.761740233119040e-03,
                7.236282698759089e-03,
                5.927286787766661e-03,
                2.196603635178684e-02,
                6.189410887397462e-02,
                -5.481391557606630e-03,
                3.408023484170397e-02,
                2.123349090390736e-02,
                -8.397302554705055e-03,
                -1.525178366410473e-02,
                9.641727955451707e-04,
                -3.961833738184373e-03,
                2.876960451384747e-03,
                -2.412696139781345e-03,
                3.096850197226608e-03,
                1.493509090909084e-02,
                1.078723486769562e-02,
                7.516310211584720e-03,
                -3.041825095057038e-02,
                2.114307877115085e-03,
                1.044784868708071e-02,
                1.436873746757250e-02,
                1.227565054792157e-03,
                2.391187469339373e-02,
                -1.966292134831460e-02,
                4.409246964534264e-03,
                2.099323875398573e-02,
                2.640298854043932e-03,
                1.136260730252636e-02,
                8.182409710856708e-03,
                1.445118735873496e-03,
                1.265535612062774e-03,
                3.214570828270480e-03,
                8.517315721758845e-03,
                8.908829260593887e-03,
                6.014088137835216e-03,
                2.534974264576606e-03,
                3.567972154033372e-03,
                6.862745098039236e-02,
                5.063329630269564e-03,
                5.908414226089231e-03,
                -4.721600734534870e-03,
                7.111494594721934e-03,
                6.559957844136433e-03,
                7.163323782234832e-03,
                4.499692865838734e-03,
                2.697329248908731e-02,
                -1.053328088049188e-02,
                8.054962810105204e-03,
                7.246301422458412e-03,
                9.299341028210728e-03,
                7.764559467139165e-03,
                2.184125061976072e-03,
                -3.753402350297086e-03,
                -4.109048892526168e-03,
                1.399135026743714e-03,
                -7.292379297803131e-03,
                -5.171326529537223e-03,
                -7.889908256880740e-02,
                4.058203995855436e-03,
                -7.342797920797395e-04,
                -6.438564410457537e-03,
                5.600121124402335e-03,
                -1.746616221412500e-02,
                -2.489331436699860e-02,
                -3.933183741121615e-03,
                -2.152860971421378e-02,
                -3.326071653713125e-04,
                -1.103994460987023e-02,
                -8.057490405539158e-03,
                -3.812600705487279e-03,
                -3.583617737969891e-03,
                6.322904339884916e-03,
                5.756073176918397e-03,
                1.027124887117026e-02,
                5.207620784670963e-03,
                1.615541990955549e-02,
                1.332027088006327e-02,
                3.784860557768943e-02,
                4.877925698012264e-03,
                3.159436158536355e-02,
                1.705318129426003e-02,
                1.404353471157149e-02,
                1.671533607628906e-02,
                9.482129832239172e-03,
                6.910081135425461e-03,
                -2.199254640209425e-04,
                1.264564364598209e-02,
                1.754209942934071e-02,
                3.481176279396037e-03,
                2.136828103385335e-02,
                9.350782557852488e-03,
                -3.797002890827383e-02,
                -2.809565913592382e-02,
                -2.606882123620402e-02,
                -3.601210558519208e-02,
                -3.201860521782041e-02,
                -4.392433268830964e-02,
                -6.333973128598847e-02,
                -1.941727844887220e-03,
                -7.407401711692507e-02,
                -4.929581556043383e-02,
                -8.595932695473762e-03,
                -2.453024530271397e-02,
                -2.528901734104039e-02,
                -2.625270453625894e-02,
                -4.665500574250647e-02,
                -9.201480381868410e-03,
                -4.430039937430985e-02,
                -1.792411945394068e-02,
                -6.947697865939284e-02,
                -2.583288053617072e-02,
                -1.030769423139588e-02,
                -1.456109147892581e-02,
                -2.774804554339672e-02,
                -2.700220176953472e-02,
                -1.087335006407553e-02,
                -1.676714720322603e-02,
                -3.278688524590168e-02,
                -6.392456193478835e-03,
                -6.307685092336091e-02,
                -2.962942776313038e-02,
                1.228327399367202e-02,
                -3.905839916911724e-02,
                -6.893995552260934e-02,
                -5.929018481141579e-03,
                -1.915960421053908e-02,
                -2.587052650616672e-02,
                -2.623823337945774e-02,
                -5.004488042411048e-03,
                -3.338920235892495e-02,
                -1.810527129066120e-02,
                1.762782124281248e-02,
                1.684035577249277e-02,
                3.422956745682693e-02,
                2.761681149332573e-02,
                2.399622101357224e-02,
                2.114594173624096e-02,
                8.474576271186440e-02,
                1.399193528852649e-04,
                4.269285829630864e-02,
                8.360376333104602e-03,
                -2.378718968912841e-04,
                4.454348800353514e-02,
                3.264331210191074e-02,
                2.306992758101223e-02,
                4.777586600937633e-02,
                2.213132694899489e-02,
                1.515664480010148e-02,
                1.893482024365101e-02,
                3.315384785981412e-02,
                2.160549372265441e-02,
                5.984952549363154e-03,
                8.654913168740563e-03,
                1.295480957288753e-02,
                2.307291587667692e-02,
                1.080579683640148e-02,
                2.037401206363043e-02,
                1.953125000000000e-03,
                1.328483025583815e-02,
                3.858271598661589e-02,
                1.550111917012909e-02,
                1.237496268896421e-02,
                5.943496801705739e-02,
                2.852737085582113e-02,
                1.704988244044481e-02,
                -1.190475894479293e-02,
                1.598934071816593e-02,
                1.891171855664209e-02,
                1.655051292139076e-02,
                2.822590352517040e-02,
                3.445770128198800e-02,
                1.167939538260043e-02,
                1.271180392043481e-02,
                1.051112436891710e-03,
                1.909274706441888e-02,
                2.797512670693614e-05,
                3.044181843609173e-02,
                1.949317738791478e-03,
                7.728294177703043e-03,
                6.065195650089672e-03,
                4.614882400809872e-03,
                1.574980170501239e-02,
                9.559773584905562e-03,
                2.023988005996991e-02,
                1.384366150579330e-02,
                -1.932269491386251e-02,
                3.278602874645875e-03,
                -4.417677997581315e-02,
                5.712796363001260e-03,
                1.535936485091738e-02,
                6.697075569758404e-03,
                1.027314874520391e-02,
                3.033443631648591e-03,
                -7.875131325473239e-04,
                1.508902319991234e-03,
                1.405773744485717e-02,
                3.176637270081439e-04,
                -1.361867704280140e-02,
                -2.875838057594837e-03,
                -1.281083081736845e-02,
                2.084801713078988e-02,
                6.017335256490952e-03,
                7.475678856823320e-03,
                2.057310800881718e-02,
                1.066932590712888e-03,
                3.106179482651750e-02,
                2.483667219407493e-02,
                8.971100321835790e-03,
                1.022431281041780e-02,
                -6.487232637098939e-03,
                -2.275870307203554e-03,
                -6.092604319106854e-03,
                -9.385673051796273e-03,
                8.752955447000055e-05,
                -8.537363250788133e-03,
                3.334779824913925e-03,
                -1.270083354786622e-03,
                -2.169625246548335e-02,
                4.532452320672453e-03,
                -2.748100949397758e-02,
                -2.492212336939559e-02,
                -2.760666987144722e-03,
                -3.042292851842687e-02,
                -6.551475881929447e-02,
                -8.738442583289929e-03,
                -5.013485777435656e-02,
                -3.188778950756699e-02,
                -6.865252544964062e-03,
                6.747282887470618e-03,
                -2.791372550925264e-02,
                -3.860265242353944e-03,
                4.057857329744285e-03,
                5.684756950780967e-03,
                2.189141913900405e-02,
                -4.178827349894498e-03,
                1.306140545731882e-02,
                9.220865843259984e-03,
                1.612903225806450e-02,
                9.297209999997502e-03,
                9.419104513217702e-03,
                8.164844829330109e-03,
                5.365073950757582e-03,
                1.658155569945019e-02,
                1.232665639445307e-02,
                1.150309217622869e-02,
                1.822461795723429e-02,
                8.893341515948228e-03,
                -1.385586556785634e-02,
                1.396166003997834e-03,
                1.074724714400066e-02,
                -3.523526664830356e-04,
                -3.453910215288403e-03,
                4.291860038093231e-03,
                -7.283624865902949e-03,
                9.028471630575741e-03,
                -1.409929395139620e-03,
                2.520559108384779e-03,
                -3.968253968254065e-03,
                -3.928478925502410e-03,
                1.166423591795396e-02,
                1.197168981096364e-02,
                -1.856159892950293e-02,
                1.681309996552582e-02,
                1.978691019786916e-02,
                -1.200973646747328e-02,
                -1.092508373991907e-02,
                -9.795258144685848e-04,
                1.128637757930262e-02,
                -2.509672447649547e-03,
                6.479498635764802e-03,
                2.819378284663721e-03,
                1.476935719848749e-02,
                7.713207603294858e-03,
                1.199827383682828e-02,
                -4.536862118131313e-03,
                1.254462021557701e-02,
                1.194223788628412e-02,
                1.593625498007967e-02,
                4.215744131162547e-03,
                1.229822107367795e-02,
                3.201112247883242e-02,
                7.328590709142935e-03,
                -2.221125370187593e-03,
                4.925373134328370e-02,
                6.239166977049404e-03,
                3.713288309903451e-02,
                1.143800363792025e-02,
                8.541163264093043e-03,
                9.784568783828052e-03,
                2.063385981076094e-02,
                -7.028629346708004e-03,
                1.340649055874543e-02,
                3.102882840519960e-03,
                5.373635369731122e-03,
                3.126979443650568e-02,
                1.068640943587895e-02,
                3.104291610021015e-04,
                -1.764705882352935e-02,
                2.979585496309278e-03,
                3.037085971322018e-03,
                1.584627478364653e-02,
                -2.346942534244278e-03,
                -3.215458817709571e-03,
                2.987197724039836e-02,
                3.741717443812353e-03,
                -1.563576130957434e-02,
                9.693002717652943e-03,
                2.145385621622919e-03,
                8.307822709270329e-04,
                7.116275009934503e-03,
                -3.362194274619812e-03,
                7.761243746166713e-03,
                4.537208139837379e-03,
                5.090099132347703e-04,
                3.437257591913268e-03,
                -7.389432972095933e-03,
                1.552386973631137e-03,
                2.594810379241519e-02,
                -1.066713389872187e-02,
                2.498120167764850e-02,
                1.559905164588615e-02,
                -2.352335161305730e-03,
                3.722084459605068e-02,
                2.555248618784534e-02,
                1.128967692632976e-02,
                3.015648970001750e-02,
                8.960033984328097e-03,
                1.408460199226624e-02,
                2.489657381336885e-03,
                1.493496007270689e-02,
                2.059664518677917e-02,
                -5.078867289932565e-03,
                -5.645742769680107e-03,
                -9.751556007801310e-03,
                -1.431365339646828e-02,
                -7.457821782558272e-03,
                3.099764771787417e-03,
                -9.727626459143934e-03,
                4.776833085791576e-03,
                -7.385650668587318e-03,
                9.804583145043289e-04,
                4.244300360831899e-03,
                -6.937823132483700e-03,
                -5.387205387205385e-02,
                -7.371385935514008e-04,
                -1.474840802208599e-02,
                -4.123065798829484e-03,
                3.777738460783775e-03,
                1.931581359651879e-03,
                -6.329058782543751e-04,
                -1.739748475587855e-02,
                5.537158792076724e-03,
                1.982050323498963e-02,
                4.367203325631230e-03,
                1.452150924661799e-02,
                -1.925579346878092e-03,
                8.343744003828313e-03,
                1.571709233791752e-02,
                1.086652316986569e-03,
                1.562509323418548e-02,
                4.244174978481841e-03,
                4.226388055046826e-03,
                7.227897240562609e-04,
                -2.419928825622775e-02,
                7.376823676943367e-04,
                -2.426871025911825e-02,
                1.146500183448818e-02,
                1.228691855949782e-02,
                1.679974176376264e-02,
                1.519959156175554e-02,
                1.965306833141578e-02,
            ],
            20,
            :,
        )'
    @test isapprox(testlogret, sample, rtol = 5e-2)
    prices = prices_from_returns(sample, true)
    testprices =
        reshape(
            [
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                1.0,
                0.973759763509202,
                0.977242441484168,
                0.988023411032638,
                0.983774152949054,
                0.984501965345403,
                0.998694648098653,
                1.107368421052632,
                0.995090950600042,
                1.006761740233119,
                1.007236282698759,
                1.005927286787767,
                1.021966036351787,
                1.061894108873975,
                0.994518608442393,
                1.034080234841704,
                1.021233490903907,
                0.991602697445295,
                0.984748216335895,
                1.000964172795545,
                0.996038166261816,
                0.976561231837967,
                0.974884652417969,
                0.991083171527959,
                0.998466909357362,
                0.995122019273292,
                1.006201146880412,
                1.073684210526316,
                0.997194879235342,
                1.017280234559017,
                1.021708996412671,
                1.007162127972689,
                1.046403160153935,
                1.041014168530947,
                0.998903686597841,
                1.055788928102513,
                1.023929852519652,
                1.002869889496492,
                0.992805829703991,
                1.00241068487559,
                0.997298688032194,
                0.979700457085854,
                0.98318805279491,
                0.999912562286149,
                1.004471777352949,
                0.997644627982263,
                1.009791244553838,
                1.147368421052632,
                1.002244005614527,
                1.023290747568804,
                1.016884894464728,
                1.014324556001776,
                1.053267520772516,
                1.048471290082028,
                1.003398446390085,
                1.084267031666962,
                1.013144511781142,
                1.01094796915976,
                1.0,
                1.01173244368457,
                1.00504227300192,
                0.981840245407404,
                0.979497752446765,
                0.995803872679464,
                1.005877169000019,
                0.990369424950601,
                1.004569284301582,
                1.056842105263158,
                1.006311316242934,
                1.022539365851443,
                1.010337615573696,
                1.020004896374841,
                1.034870979399834,
                1.022371364653244,
                0.999451895934877,
                1.060924269916215,
                1.012807532656967,
                0.999787159576775,
                0.991942509594461,
                1.007875111856014,
                1.00144058568498,
                0.988048327356164,
                0.985135813186476,
                1.00603202208263,
                1.01111539585213,
                1.006369258876263,
                1.017950419286271,
                1.096842105263158,
                1.011220028072636,
                1.054845844311421,
                1.027567086100484,
                1.034329370543054,
                1.052169195616101,
                1.032065622669649,
                1.006358189626742,
                1.060690945653863,
                1.025615135796914,
                1.017325525338249,
                0.995395636329386,
                1.02941167049318,
                1.010804838846329,
                0.950532103803679,
                0.957457773176597,
                0.979805953141061,
                0.974703001457889,
                0.974146718872953,
                0.973237626409336,
                1.027368421052632,
                1.00925651398682,
                0.97670917518418,
                0.976912328548102,
                1.025438344888914,
                1.026359227147678,
                1.005965697240865,
                0.979938565416826,
                1.011204403493357,
                1.016177958245531,
                0.972257598272085,
                0.977554046039886,
                0.957891257830595,
                0.984692838199028,
                0.940734309520545,
                0.943516142954164,
                0.952618252929612,
                0.948383874347152,
                0.963554480584877,
                0.956919207863612,
                0.993684210526316,
                1.002804885933176,
                0.915101436145609,
                0.947966975278475,
                1.038034085042802,
                0.986271278762838,
                0.936614466815809,
                0.974128491552087,
                0.99183012734647,
                0.989888899441758,
                0.946747276503671,
                0.972661888505669,
                0.925908032785044,
                0.966864707225464,
                0.957317405765754,
                0.959405290478603,
                0.98522596367887,
                0.974575213028308,
                0.98667614685961,
                0.977154165679386,
                1.077894736842105,
                1.002945197743886,
                0.954169732085722,
                0.955892335943158,
                1.037787165905955,
                1.030203241636642,
                0.967188665175242,
                0.996601565306794,
                1.039215670614638,
                1.011796454318484,
                0.961096788689101,
                0.991079066522374,
                0.95660544683618,
                0.98775429658808,
                0.963046905013942,
                0.967708859961325,
                0.997989378424595,
                0.997061504934004,
                0.997337968845898,
                0.997062716438965,
                1.08,
                1.016269154451821,
                0.99098419186181,
                0.970709736956426,
                1.050629743363128,
                1.091433338354384,
                0.994780014914243,
                1.013593504835238,
                1.026844058564319,
                1.027974412564014,
                0.979272780662482,
                1.007481933418973,
                0.98360649989023,
                1.021790039079912,
                0.974294710589589,
                0.980010185241221,
                0.999038377472143,
                1.016098148055378,
                0.997365869501946,
                1.027415118622196,
                1.082105263157895,
                1.02412318144115,
                0.996994704871598,
                0.975189448237801,
                1.067176953486485,
                1.10186719395207,
                1.014914243102162,
                1.027625350220648,
                1.007002664096569,
                1.031344732428109,
                0.936011662494852,
                1.013237472543998,
                0.998714070991778,
                1.028633044188056,
                0.984303785073141,
                0.982982990896592,
                0.998251621629965,
                1.017631340908318,
                1.011386577031866,
                1.027741491137962,
                1.067368421052632,
                1.021177969020297,
                0.984222374381676,
                0.995520214560428,
                1.073598514993614,
                1.110104399236924,
                1.03579418344519,
                1.028721757197841,
                1.038281974238493,
                1.056959903466512,
                0.944408717021502,
                1.023597129414525,
                0.99223518047531,
                1.026292008785781,
                0.978306811580891,
                0.97375703392856,
                0.998338998149655,
                1.008943452495597,
                1.014759328584141,
                1.026436173777044,
                1.04421052631579,
                1.025806409475803,
                0.957174949967108,
                0.970709736956426,
                1.070634667015823,
                1.076331772450948,
                0.967934377330351,
                1.019732331188387,
                0.986227855130368,
                1.023255788546834,
                0.937925112673484,
                1.030503628809488,
                0.964538200006899,
                1.022330249415759,
                0.982276641047004,
                0.979292605995557,
                1.020194055600962,
                1.004727252001811,
                1.028013511616375,
                1.035900804032111,
                1.061052631578948,
                1.035343547084043,
                0.966190680858282,
                0.978635431332995,
                1.076378701178608,
                1.094179027686932,
                0.979865771812081,
                1.031462406189127,
                1.004201481008901,
                1.032355951732552,
                0.924929348399564,
                1.031942382943028,
                0.974904330422202,
                1.021970028626351,
                0.978883945722252,
                0.983495592796829,
                1.012763344809541,
                1.013798403492976,
                1.026564085147746,
                1.038511853239098,
                1.056842105263158,
                1.031276221778668,
                0.977460556901542,
                0.990351351154932,
                1.056399391431071,
                1.112575569059614,
                0.999254287844892,
                1.01907481451469,
                0.993230495737129,
                1.031344732428109,
                0.935368450259779,
                1.029352545576994,
                0.981221221701174,
                1.024851348732637,
                0.993341432372489,
                0.991081498480997,
                1.024914756752468,
                1.009198939920747,
                1.039441941722876,
                1.050914008838205,
                1.073684210526316,
                1.035623818458239,
                0.989481582921117,
                1.02205360955383,
                1.064141310196257,
                1.110104399236925,
                1.048471290082029,
                1.025432992444552,
                1.030112007625731,
                1.043141257229572,
                0.94335758490553,
                1.039424316362,
                1.0014676028331,
                1.017648048466922,
                1.006658654907201,
                0.99415670825619,
                1.030422274940312,
                1.040756383317608,
                1.050549843896952,
                1.051240243192254,
                1.054736842105264,
                1.03870954816735,
                0.992486723555489,
                1.038249351894438,
                1.061643831692911,
                1.10653490425782,
                1.07979120059657,
                1.029269872959843,
                1.014005422152369,
                1.053252428270794,
                0.945381450704235,
                1.040287851656004,
                1.0085943217084,
                1.014226518024788,
                1.014471578097125,
                0.998667404165164,
                1.030946770093075,
                1.044333731097498,
                1.042786876241629,
                1.052872174851942,
                1.082105263157895,
                1.027629494335168,
                1.017280234559017,
                1.054445057155947,
                1.059146489578836,
                1.147721067969306,
                1.107382550335571,
                1.040889997295564,
                1.044584266221269,
                1.062689605822176,
                0.958696772168276,
                1.042877811984595,
                1.023657637632674,
                1.035116181755568,
                1.009319211582561,
                0.993029184888784,
                1.02089343492345,
                1.029385500040328,
                1.035009957561428,
                1.056135830928744,
                1.071578947368422,
                1.032538308903643,
                1.009766958114505,
                1.055478896579424,
                1.063641825406729,
                1.13975838219431,
                1.047725577926921,
                1.040122717106916,
                1.029178311249586,
                1.05830806665364,
                0.962318477836725,
                1.044892215326619,
                1.023009758696496,
                1.017107763762912,
                1.014907972328987,
                1.012711523060311,
                1.025351884127563,
                1.044333731097498,
                1.033016963763335,
                1.064947957935284,
                1.08842105263158,
                1.033660319049391,
                1.025544660979844,
                1.059958533702602,
                1.068137188512477,
                1.140582187840867,
                1.022371364653244,
                1.040889997295564,
                1.004201481008901,
                1.070441570579277,
                0.974142406602205,
                1.062446134715072,
                1.038559089192373,
                1.037097052144558,
            ],
            20,
            :,
        )'
    @test prices ≈ testprices
end