using Test
using PortfolioOptimiser, CSV, DataFrames, Statistics

@testset "Risk models" begin
    df = CSV.read("./assets/stock_prices.csv", DataFrame)
    dropmissing!(df)
    returns = returns_from_prices(df[!, 2:end])
    cov_mtx = risk_matrix(
        SCov(),
        Matrix(returns),
        1.02^(1 / 252) - 1,
        SFix(),
        252,
        Int(ceil(252 / 1.4)),
    )
    testcov = reshape(
        [
            0.022525453904467,
            0.014702519870182,
            0.019053982917046,
            0.018696916900512,
            0.018409284534755,
            0.012529128830922,
            0.025945495387098,
            0.00906252641551,
            0.016002832942479,
            0.014837626429073,
            0.008289326315192,
            0.016565859447689,
            0.020363864553773,
            0.0106456062799,
            0.018202853128116,
            0.013186329325946,
            0.014352437901067,
            0.010168834926307,
            0.013642351807908,
            0.012663735203131,
            0.014702519870182,
            0.024877719319234,
            0.016870717350807,
            0.017722225672765,
            0.015812096439494,
            0.011678614245765,
            0.027343097346851,
            0.008513232865114,
            0.015709056305636,
            0.014241616539979,
            0.007973271889648,
            0.017286173384212,
            0.023361014259085,
            0.010741372923038,
            0.020726861755274,
            0.014769673119315,
            0.013711441290225,
            0.00833181521624,
            0.013006276915931,
            0.01114284463531,
            0.019053982917046,
            0.016870717350807,
            0.029504687179255,
            0.022036183656905,
            0.020499385981739,
            0.013801364374561,
            0.029751079162577,
            0.008985313368779,
            0.017402321317274,
            0.016112974285734,
            0.00854913841589,
            0.019936495988079,
            0.024214251349298,
            0.009980421638581,
            0.019849836881366,
            0.015303103580172,
            0.015967297259296,
            0.010850821740143,
            0.01418955073874,
            0.014044230051494,
            0.018696916900512,
            0.017722225672765,
            0.022036183656905,
            0.04492421976902,
            0.021583535546375,
            0.015968076421437,
            0.040335092738185,
            0.010597967619348,
            0.020717405376339,
            0.019522089125673,
            0.010356447924047,
            0.022982694239327,
            0.033494500806262,
            0.013259809899829,
            0.031519029969913,
            0.017840237818766,
            0.01711297092672,
            0.011471372004329,
            0.017110588888627,
            0.014039178633428,
            0.018409284534755,
            0.015812096439494,
            0.020499385981739,
            0.021583535546375,
            0.030720052288252,
            0.012473036680992,
            0.030353854237477,
            0.009351268305371,
            0.017476523182104,
            0.015297753200559,
            0.00823423753673,
            0.019132257038425,
            0.023504172143148,
            0.010334316949157,
            0.022182175733993,
            0.014285336585942,
            0.015802398362235,
            0.009753449058108,
            0.014165665150165,
            0.014562406771882,
            0.012529128830922,
            0.011678614245765,
            0.013801364374561,
            0.015968076421437,
            0.012473036680992,
            0.02440228436048,
            0.024270353503385,
            0.008929498787609,
            0.016590855691834,
            0.015246302436768,
            0.009357190994096,
            0.020838468107746,
            0.031461352497691,
            0.0111529534843,
            0.022433204353138,
            0.012770419417478,
            0.011607514518822,
            0.009310312741978,
            0.013864426966984,
            0.010271579915927,
            0.025945495387098,
            0.027343097346851,
            0.029751079162577,
            0.040335092738185,
            0.030353854237477,
            0.024270353503385,
            0.155039128410935,
            0.015774747228493,
            0.03520296177244,
            0.032434455241135,
            0.018291992172521,
            0.036086319478679,
            0.061043316460493,
            0.020962191067428,
            0.052738849401468,
            0.032510076463945,
            0.026615333851302,
            0.018577521292829,
            0.027791112301525,
            0.02004136380838,
            0.00906252641551,
            0.008513232865114,
            0.008985313368779,
            0.010597967619348,
            0.009351268305371,
            0.008929498787609,
            0.015774747228493,
            0.021040043228967,
            0.010153058123292,
            0.00994413171462,
            0.007118337336687,
            0.013703951963209,
            0.025712628094029,
            0.007965166258197,
            0.013724736058423,
            0.013552473863293,
            0.007872045391554,
            0.007553860717186,
            0.009533706229943,
            0.008250553261039,
            0.016002832942479,
            0.015709056305636,
            0.017402321317274,
            0.020717405376339,
            0.017476523182104,
            0.016590855691834,
            0.03520296177244,
            0.010153058123292,
            0.033703059151725,
            0.01999679985416,
            0.009601367101102,
            0.022904778615797,
            0.032114247249851,
            0.014805757364219,
            0.028375007677103,
            0.018982645552864,
            0.016853429564492,
            0.011901752277136,
            0.024550299661909,
            0.012844360207056,
            0.014837626429073,
            0.014241616539979,
            0.016112974285734,
            0.019522089125673,
            0.015297753200559,
            0.015246302436768,
            0.032434455241135,
            0.00994413171462,
            0.01999679985416,
            0.030013916039327,
            0.010146921400224,
            0.022977718154282,
            0.034760579005305,
            0.012746949467944,
            0.026693425701261,
            0.018036547351302,
            0.013293845137808,
            0.010717987931216,
            0.016439844471517,
            0.012170455458605,
            0.008289326315192,
            0.007973271889648,
            0.00854913841589,
            0.010356447924047,
            0.00823423753673,
            0.009357190994096,
            0.018291992172521,
            0.007118337336687,
            0.009601367101102,
            0.010146921400224,
            0.013322768453092,
            0.011365383230523,
            0.019233470534308,
            0.007930364671191,
            0.015464001707986,
            0.008828942689305,
            0.007422085347014,
            0.006545773475848,
            0.008396896606228,
            0.006707225996955,
            0.016565859447689,
            0.017286173384212,
            0.019936495988079,
            0.022982694239327,
            0.019132257038425,
            0.020838468107746,
            0.036086319478679,
            0.013703951963209,
            0.022904778615797,
            0.022977718154282,
            0.011365383230523,
            0.098323500223113,
            0.049266391473751,
            0.014767159777128,
            0.036819645459222,
            0.025548150829406,
            0.016805891212801,
            0.013044893686802,
            0.018942284744052,
            0.016948695207603,
            0.020363864553773,
            0.023361014259085,
            0.024214251349298,
            0.033494500806262,
            0.023504172143148,
            0.031461352497691,
            0.061043316460493,
            0.025712628094029,
            0.032114247249851,
            0.034760579005305,
            0.019233470534308,
            0.049266391473751,
            0.217250051013063,
            0.022891842887802,
            0.0712810230896,
            0.042122318236915,
            0.020267249870451,
            0.017713825770789,
            0.023354170633112,
            0.022831361630414,
            0.0106456062799,
            0.010741372923038,
            0.009980421638581,
            0.013259809899829,
            0.010334316949157,
            0.0111529534843,
            0.020962191067428,
            0.007965166258197,
            0.014805757364219,
            0.012746949467944,
            0.007930364671191,
            0.014767159777128,
            0.022891842887802,
            0.018268949158542,
            0.025453850018682,
            0.011543173328894,
            0.01044740392348,
            0.008305838702664,
            0.012562806535381,
            0.008419459935667,
            0.018202853128116,
            0.020726861755274,
            0.019849836881366,
            0.031519029969913,
            0.022182175733993,
            0.022433204353138,
            0.052738849401468,
            0.013724736058423,
            0.028375007677103,
            0.026693425701261,
            0.015464001707986,
            0.036819645459222,
            0.0712810230896,
            0.025453850018682,
            0.12537329786879,
            0.02861913492648,
            0.018888305321645,
            0.014190840162381,
            0.022219019674271,
            0.016300305338172,
            0.013186329325946,
            0.014769673119315,
            0.015303103580172,
            0.017840237818766,
            0.014285336585942,
            0.012770419417478,
            0.032510076463945,
            0.013552473863293,
            0.018982645552864,
            0.018036547351302,
            0.008828942689305,
            0.025548150829406,
            0.042122318236915,
            0.011543173328894,
            0.02861913492648,
            0.053688934136254,
            0.012850578683661,
            0.010285493010373,
            0.014886458492273,
            0.012393441822333,
            0.014352437901067,
            0.013711441290225,
            0.015967297259296,
            0.01711297092672,
            0.015802398362235,
            0.011607514518822,
            0.026615333851302,
            0.007872045391554,
            0.016853429564492,
            0.013293845137808,
            0.007422085347014,
            0.016805891212801,
            0.020267249870451,
            0.01044740392348,
            0.018888305321645,
            0.012850578683661,
            0.018888968545482,
            0.009215066292241,
            0.013890907862614,
            0.011030687476662,
            0.010168834926307,
            0.00833181521624,
            0.010850821740143,
            0.011471372004329,
            0.009753449058108,
            0.009310312741978,
            0.018577521292829,
            0.007553860717186,
            0.011901752277136,
            0.010717987931216,
            0.006545773475848,
            0.013044893686802,
            0.017713825770789,
            0.008305838702664,
            0.014190840162381,
            0.010285493010373,
            0.009215066292241,
            0.013588093093942,
            0.01013169888453,
            0.008114476181133,
            0.013642351807908,
            0.013006276915931,
            0.01418955073874,
            0.017110588888627,
            0.014165665150165,
            0.013864426966984,
            0.027791112301525,
            0.009533706229943,
            0.024550299661909,
            0.016439844471517,
            0.008396896606228,
            0.018942284744052,
            0.023354170633112,
            0.012562806535381,
            0.022219019674271,
            0.014886458492273,
            0.013890907862614,
            0.01013169888453,
            0.021570979370674,
            0.010773216311524,
            0.012663735203131,
            0.01114284463531,
            0.014044230051494,
            0.014039178633428,
            0.014562406771882,
            0.010271579915927,
            0.02004136380838,
            0.008250553261039,
            0.012844360207056,
            0.012170455458605,
            0.006707225996955,
            0.016948695207603,
            0.022831361630414,
            0.008419459935667,
            0.016300305338172,
            0.012393441822333,
            0.011030687476662,
            0.008114476181133,
            0.010773216311524,
            0.020237813558209,
        ],
        20,
        :,
    )
    @test isapprox(cov_mtx, testcov, rtol = 1e-4)
end