using Test, LinearAlgebra
using PortfolioOptimiser.RiskModels

@testset "Risk models" begin
    rets = [
        -0.0006748400796242 -0.0069003561906746 -0.0062350096988893 -0.0010528295103606 0.0036162836865440 0.0055131331052059 0.0017771874692506
        -0.0136552795561427 0.0063719449271437 -0.0135387973471765 0.0020842993036400 -0.0201429193145458 0.0056784408765250 0.0002050903924777
        0.0223035263456402 -0.0125740965262354 -0.0036276784565668 0.0098423391006926 0.0068464607776117 -0.0117286082571672 -0.0132478894650054
        -0.0037694052340852 0.0047433855140722 -0.0035100901919316 -0.0073897353316849 0.0039647543861933 -0.0226398931901647 0.0079578550398675
        -0.0097545784426500 -0.0096890388933971 0.0041402500355095 0.0128447743398214 0.0040631483356639 0.0213654993368455 0.0011212612666105
        0.0097094575560662 -0.0085259796371582 -0.0061547425212878 -0.0014428011740385 0.0053837782299703 0.0017300626065962 -0.0093646255614063
        -0.0047144316267802 0.0138977829788129 0.0258638373882496 -0.0178493164506068 -0.0278156514291655 0.0003608751035137 -0.0047274631285045
        -0.0057087862005760 0.0080811932473448 -0.0078170276965343 -0.0159509506610048 0.0001072084420873 0.0063141569395188 -0.0034274512824267
        0.0052070235563621 -0.0105749812123991 0.0086771833912368 0.0004212563100071 0.0058167889271601 0.0123186402852710 -0.0093214511453497
        0.0007023413752606 0.0015784461612801 0.0124494036188893 0.0073293684785748 -0.0000545052057682 0.0002886918878566 -0.0004545563311688
        0.0048244208963245 -0.0051800785825117 -0.0038428768996661 0.0101816949438218 -0.0033787479581397 0.0069811023563090 0.0107086738257538
        -0.0139494962887654 -0.0128763133630688 0.0036707309016832 -0.0061589392328065 -0.0113414152813241 0.0121209858963399 -0.0034456095257532
        0.0049239726584480 -0.0016729159404981 -0.0126361300744444 0.0015788103092960 0.0084436841151058 0.0015615090203985 0.0116309728154348
        0.0004334332137242 0.0193219926498295 -0.0022996583271096 -0.0190491317675548 -0.0013100071392300 -0.0020094062057762 -0.0173905782894246
        0.0174254340510027 0.0119158047666807 0.0100378728475036 0.0025650747998706 -0.0016131569743071 0.0089560488161184 0.0053435102907043
        -0.0104795452758912 0.0007253579603801 0.0153702568731145 -0.0124907944932643 -0.0024575352520610 0.0090516177698353 -0.0075278787817123
        -0.0014750087032114 0.0102543355703968 0.0098636018924578 0.0076908231333085 -0.0094889576838703 -0.0037695120552527 -0.0098535207723071
        -0.0026830204066995 -0.0022082607311000 -0.0056567761525415 0.0006415721056171 -0.0014209688964841 -0.0022181584503209 -0.0082123679784803
        0.0087061361381246 0.0022512347199988 0.0061362975667603 -0.0041455835478169 -0.0071994076807952 0.0086123901120495 -0.0047472407990139
        -0.0082829057326971 -0.0091231017006632 0.0019692806048999 -0.0079338678139561 0.0100424896047813 0.0033083268404122 0.0007857151456365
    ]

    sample = risk_matrix(Cov(), rets)
    tsample = [
        0.023607428099405 -0.001244115355250 -0.001087640260681 0.007796488965437 0.008416309714232 -0.005676606313437 -0.001731142985498
        -0.001244115355250 0.022783163645299 0.005466278461866 -0.010647240056788 -0.011305607642281 -0.005592794245965 -0.001894046112805
        -0.001087640260681 0.005466278461866 0.025333188043831 -0.004263716000975 -0.009407387556116 0.004294781606457 -0.004362108196362
        0.007796488965437 -0.010647240056788 -0.004263716000975 0.022373635317811 0.005802649581698 0.002692267146094 0.005161878679267
        0.008416309714232 -0.011305607642281 -0.009407387556116 0.005802649581698 0.022931136672507 -0.002130979817336 0.002071968074261
        -0.005676606313437 -0.005592794245965 0.004294781606457 0.002692267146094 -0.002130979817336 0.021773553836691 0.001323325753942
        -0.001731142985498 -0.001894046112805 -0.004362108196362 0.005161878679267 0.002071968074261 0.001323325753942 0.015294527742421
    ]
    @test sample ≈ tsample

    expcov = risk_matrix(ECov(), rets, span = 180, freq = 1)
    texpcov = [
        0.000087439698572 -0.000001830163115 -0.000004267095654 0.000029329576143 0.000029081211005 -0.000019406090623 -0.000004485316647
        -0.000001830163115 0.000085736384381 0.000020554956437 -0.000038334792751 -0.000041276014254 -0.000020999534186 -0.000008588425666
        -0.000004267095654 0.000020554956437 0.000093964089823 -0.000015341464674 -0.000035455195755 0.000016162104478 -0.000016436637617
        0.000029329576143 -0.000038334792751 -0.000015341464674 0.000083671260105 0.000020273715595 0.000009091073263 0.000020284057530
        0.000029081211005 -0.000041276014254 -0.000035455195755 0.000020273715595 0.000084002749522 -0.000007383050994 0.000008734602751
        -0.000019406090623 -0.000020999534186 0.000016162104478 0.000009091073263 -0.000007383050994 0.000078360299005 0.000005444485975
        -0.000004485316647 -0.000008588425666 -0.000016436637617 0.000020284057530 0.000008734602751 0.000005444485975 0.000057792036559
    ]
    @test abs(norm(expcov - texpcov)) < sqrt(eps() * length(rets)^2)

    semicov = risk_matrix(SCov(), rets, target = 0.000079)
    tsemicov = [
        0.009392423130918 0.004615685276927 0.003366033472398 0.006243835775477 0.007779865052150 0.001256937282860 0.002664052519916
        0.004615685276927 0.009831242449826 0.002527943340722 0.002211856812309 0.002136587630828 0.001948678292464 0.005224814224756
        0.003366033472398 0.002527943340722 0.007166272057486 0.002715439711608 0.003790663635307 0.001807479517290 0.002835834741495
        0.006243835775477 0.002211856812309 0.002715439711608 0.016160923477495 0.008322867937578 0.002641321737866 0.007924187999428
        0.007779865052150 0.002136587630828 0.003790663635307 0.008322867937578 0.018741681193292 0.000543927860856 0.004543017146464
        0.001256937282860 0.001948678292464 0.001807479517290 0.002641321737866 0.000543927860856 0.008568216001881 0.003164039899638
        0.002664052519916 0.005224814224756 0.002835834741495 0.007924187999428 0.004543017146464 0.003164039899638 0.012058281822747
    ]
    semicov ≈ tsemicov

    notPosDef = [
        0.309208705710882 0.832663963912536 0.950851252595975 0.53692467868542 0.215982871394369 0.792051466380984 0.840870510782442
        0.832663963912536 0.344155873757517 0.768979745434743 0.388317438831396 0.254187934120013 0.085251617470318 0.20301773555758
        0.950851252595975 0.768979745434743 0.318685336978623 0.571153451045122 0.459387037186339 0.670033946393184 0.644388046927799
        0.53692467868542 0.388317438831396 0.571153451045122 0.561788402001088 0.170021861332159 0.331439402489706 0.304334652227523
        0.215982871394369 0.254187934120013 0.459387037186339 0.170021861332159 0.590333807766973 0.20063306421833 0.618711410675018
        0.792051466380984 0.085251617470318 0.670033946393184 0.331439402489706 0.20063306421833 0.731581820981073 0.418952751237381
        0.840870510782442 0.20301773555758 0.644388046927799 0.304334652227523 0.618711410675018 0.418952751237381 0.640000418804632
    ]

    spec = make_pos_def(SFix(), notPosDef)
    tspec = [
        0.844125509800367 0.592836698595390 0.799333142815221 0.527433380605342 0.341263245430556 0.648572904631894 0.629790176655786
        0.592836698595391 0.603741622448824 0.586903315893075 0.423141741115955 0.220216081223321 0.232693986560236 0.348607174874477
        0.799333142815221 0.586903315893075 0.772653542485282 0.523582271853269 0.387405719111675 0.574023072629223 0.620404370123831
        0.527433380605342 0.423141741115955 0.523582271853269 0.568102127325992 0.172261239132833 0.350693840705860 0.318323039441885
        0.341263245430555 0.220216081223321 0.387405719111675 0.172261239132833 0.622915337988414 0.179162230816730 0.576713064513347
        0.648572904631894 0.232693986560236 0.574023072629223 0.350693840705861 0.179162230816730 0.815495915614376 0.503420097589199
        0.629790176655786 0.348607174874477 0.620404370123831 0.318323039441885 0.576713064513347 0.503420097589199 0.740366857634077
    ]
    @test spec ≈ tspec

    dfix = make_pos_def(DFix(), notPosDef)
    tdfix = [
        1.251072771592785 0.832663963912536 0.950851252595975 0.536924678685420 0.215982871394369 0.792051466380984 0.840870510782442
        0.832663963912536 1.286019939639420 0.768979745434743 0.388317438831396 0.254187934120013 0.085251617470318 0.203017735557580
        0.950851252595975 0.768979745434743 1.260549402860526 0.571153451045122 0.459387037186339 0.670033946393184 0.644388046927799
        0.536924678685420 0.388317438831396 0.571153451045122 1.503652467882991 0.170021861332159 0.331439402489706 0.304334652227523
        0.215982871394369 0.254187934120013 0.459387037186339 0.170021861332159 1.532197873648875 0.200633064218330 0.618711410675018
        0.792051466380984 0.085251617470318 0.670033946393184 0.331439402489706 0.200633064218330 1.673445886862976 0.418952751237381
        0.840870510782442 0.203017735557580 0.644388046927799 0.304334652227523 0.618711410675018 0.418952751237381 1.581864484686535
    ]
    @test dfix ≈ tdfix
end