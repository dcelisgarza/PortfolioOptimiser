using Test, PortfolioOptimiser, DataFrames, OrderedCollections

@testset "Asset constraints" begin
    asset_classes = Dict(
        "Assets" => [
            "FB",
            "GOOGL",
            "NTFX",
            "BAC",
            "WFC",
            "TLT",
            "SHV",
            "FCN",
            "TKO",
            "ZOO",
            "ZVO",
            "ZX",
            "ZZA",
            "ZZB",
            "ZZC",
        ],
        "Class 1" => [
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Fixed Income",
            "Fixed Income",
            "Equity",
            "Equity",
            "Equity",
            "Fixed Income",
            "Fixed Income",
            "Equity",
            "Fixed Income",
            "Equity",
        ],
        "Class 2" => [
            "Technology",
            "Technology",
            "Technology",
            "Financial",
            "Financial",
            "Treasury",
            "Treasury",
            "Financial",
            "Entertainment",
            "Treasury",
            "Financial",
            "Financial",
            "Entertainment",
            "Technology",
            "Treasury",
        ],
    )

    constraints = Dict(
        "Enabled" => [
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
            true,
        ],
        "Type" => [
            "Classes",
            "All Classes",
            "Assets",
            "Assets",
            "Classes",
            "All Assets",
            "Each asset in a class",
            "Assets",
            "All Assets",
            "All Assets",
            "Classes",
            "All Classes",
            "All Classes",
            "Each asset in a class",
            "Each asset in a class",
        ],
        "Set" => [
            "Class 1",
            "Class 1",
            "",
            "",
            "Class 2",
            "",
            "Class 1",
            "Class 1",
            "Class 2",
            "",
            "Class 1",
            "Class 2",
            "Class 2",
            "Class 2",
            "Class 1",
        ],
        "Position" => [
            "Equity",
            "Fixed Income",
            "BAC",
            "WFC",
            "Financial",
            "",
            "Equity",
            "FCN",
            "TKO",
            "ZOO",
            "Fixed Income",
            "Treasury",
            "Entertainment",
            "Treasury",
            "Equity",
        ],
        "Sign" => [
            "<=",
            "<=",
            "<=",
            "<=",
            ">=",
            ">=",
            ">=",
            "<=",
            ">=",
            "<=",
            ">=",
            "<=",
            ">=",
            "<=",
            ">=",
        ],
        "Weight" => [0.6, 0.5, 0.1, "", "", 0.02, "", "", "", "", "", "", "", 0.27, ""],
        "Type Relative" => [
            "",
            "",
            "",
            "Assets",
            "Classes",
            "",
            "Assets",
            "Classes",
            "Assets",
            "Classes",
            "Assets",
            "Assets",
            "Classes",
            "",
            "Classes",
        ],
        "Relative Set" => [
            "",
            "",
            "",
            "",
            "Class 1",
            "",
            "",
            "Class 1",
            "",
            "Class 2",
            "",
            "Class 2",
            "Class 2",
            "",
            "Class 2",
        ],
        "Relative" => [
            "",
            "",
            "",
            "FB",
            "Fixed Income",
            "",
            "TLT",
            "Equity",
            "NTFX",
            "Financial",
            "WFC",
            "ZOO",
            "Entertainment",
            "",
            "Entertainment",
        ],
        "Factor" => [
            "",
            "",
            "",
            1.2,
            0.5,
            "",
            0.4,
            0.7,
            0.21,
            0.11,
            0.13,
            -0.17,
            0.23,
            "",
            -0.31,
        ],
    )

    constraints = DataFrame(constraints)
    asset_classes = DataFrame(asset_classes)
    sort!(asset_classes, "Assets")

    A, B = asset_constraints(constraints, asset_classes)

    At = transpose(
        hcat(
            [
                [
                    -1.0,
                    -1.0,
                    -1.0,
                    -1.0,
                    -1.0,
                    0.0,
                    -1.0,
                    0.0,
                    -1.0,
                    -1.0,
                    0.0,
                    0.0,
                    -1.0,
                    0.0,
                    -1.0,
                ],
                [
                    -1.0,
                    -1.0,
                    -1.0,
                    -1.0,
                    -1.0,
                    0.0,
                    -1.0,
                    0.0,
                    -1.0,
                    -1.0,
                    0.0,
                    0.0,
                    -1.0,
                    0.0,
                    -1.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -1.0,
                    0.0,
                    -1.0,
                    0.0,
                    0.0,
                    -1.0,
                    -1.0,
                    0.0,
                    -1.0,
                    0.0,
                ],
                [
                    -1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    -0.0,
                    1.2,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    1.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    -0.5,
                    0.0,
                    -0.5,
                    1.0,
                    0.0,
                    0.5,
                    0.5,
                    0.0,
                    -0.5,
                    0.0,
                ],
                [1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0],
                [
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.4,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                ],
                [
                    0.7,
                    0.7,
                    -0.3,
                    0.7,
                    0.7,
                    -0.0,
                    0.7,
                    -0.0,
                    0.7,
                    0.7,
                    -0.0,
                    -0.0,
                    0.7,
                    -0.0,
                    0.7,
                ],
                [
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.79,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.21,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                ],
                [
                    -0.89,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -1.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    -0.89,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.89,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -1.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.89,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    -0.89,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -1.0,
                    -0.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -1.0,
                    -0.0,
                ],
                [
                    0.11,
                    -0.0,
                    0.11,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    0.11,
                    -0.0,
                    0.11,
                    0.11,
                    -0.0,
                    -0.0,
                    -1.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    1.0,
                    -0.13,
                    0.0,
                    1.0,
                    1.0,
                    0.0,
                    1.0,
                    0.0,
                ],
                [
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.17,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -0.0,
                ],
                [
                    -1.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.17,
                    -1.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.0,
                ],
                [
                    -0.0,
                    -1.0,
                    -0.0,
                    -1.0,
                    -1.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.17,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                ],
                [
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -1.0,
                    -0.0,
                    -1.17,
                    -0.0,
                    -0.0,
                    -0.0,
                    -0.0,
                    -1.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.77,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.77,
                    0.0,
                    0.0,
                ],
                [
                    1.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.23,
                    0.0,
                    1.0,
                    0.0,
                    1.0,
                    1.0,
                    -0.23,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    1.0,
                    0.0,
                    1.0,
                    1.0,
                    0.0,
                    -0.23,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -0.23,
                    1.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    -0.23,
                    1.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    -0.23,
                    0.0,
                    1.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    -1.0,
                ],
                [
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    1.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    1.31,
                    0.0,
                    0.0,
                ],
                [
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.0,
                    0.31,
                    0.0,
                    1.0,
                ],
            ]...,
        ),
    )

    Bt = vcat(
        [
            [-0.6],
            [-0.5],
            [-0.5],
            [-0.1],
            [0.0],
            [0.0],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.02],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [-0.27],
            [-0.27],
            [-0.27],
            [-0.27],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
            [0.0],
        ]...,
    )

    @test isapprox(At, A)
    @test isapprox(Bt, B)
end

@testset "Factor constraints" begin
    loadings = Dict(
        "const" => [0.0004, 0.0002, 0.0000, 0.0006, 0.0001, 0.0003, -0.0003],
        "MTUM" => [0.1916, 1.0061, 0.8695, 1.9996, 0.0000, 0.0000, 0.0000],
        "QUAL" => [0.0000, 2.0129, 1.4301, 0.0000, 0.0000, 0.0000, 0.0000],
        "SIZE" => [0.0000, 0.0000, 0.0000, 0.4717, 0.0000, -0.1857, 0.0000],
        "USMV" => [-0.7838, -1.6439, -1.0176, -1.4407, 0.0055, 0.5781, 0.0000],
        "VLUE" => [1.4772, -0.7590, -0.4090, 0.0000, -0.0054, -0.4844, 0.9435],
    )

    loadings = DataFrame(loadings)

    constraints = Dict(
        "Enabled" => [true, true, true, true],
        "Factor" => ["MTUM", "USMV", "VLUE", "const"],
        "Sign" => ["<=", "<=", ">=", ">="],
        "Value" => [0.9, -1.2, 0.3, -0.1],
        "Relative Factor" => ["USMV", "", "", "SIZE"],
    )

    constraints = DataFrame(constraints)

    C, D = factor_constraints(constraints, loadings)

    Ct = transpose(
        hcat(
            [
                [
                    -9.7540e-01,
                    -2.6500e+00,
                    -1.8871e+00,
                    -3.4403e+00,
                    5.5000e-03,
                    5.7810e-01,
                    -0.0000e+00,
                ],
                [
                    7.8380e-01,
                    1.6439e+00,
                    1.0176e+00,
                    1.4407e+00,
                    -5.5000e-03,
                    -5.7810e-01,
                    -0.0000e+00,
                ],
                [
                    1.4772e+00,
                    -7.5900e-01,
                    -4.0900e-01,
                    0.0000e+00,
                    -5.4000e-03,
                    -4.8440e-01,
                    9.4350e-01,
                ],
                [
                    4.0000e-04,
                    2.0000e-04,
                    0.0000e+00,
                    -4.7110e-01,
                    1.0000e-04,
                    1.8600e-01,
                    -3.0000e-04,
                ],
            ]...,
        ),
    )

    Dt = vcat([
        [-0.9]
        [1.2]
        [0.3]
        [-0.1]
    ]...)

    @test isapprox(Ct, C)
    @test Dt == D
end

@testset "Views constraints" begin
    asset_classes = Dict(
        "Assets" => ["FB", "GOOGL", "NTFX", "BAC", "WFC", "TLT", "SHV"],
        "Class 1" => [
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Fixed Income",
            "Fixed Income",
        ],
        "Class 2" => [
            "Technology",
            "Technology",
            "Technology",
            "Financial",
            "Financial",
            "Treasury",
            "Treasury",
        ],
    )

    asset_classes = DataFrame(asset_classes)
    sort!(asset_classes, "Assets")

    views = Dict(
        "Enabled" => [true, true, true, true, true],
        "Type" => ["Assets", "Classes", "Classes", "Assets", "Classes"],
        "Set" => ["", "Class 2", "Class 1", "", "Class 1"],
        "Position" => ["WFC", "Financial", "Equity", "FB", "Fixed Income"],
        "Sign" => ["<=", ">=", ">=", ">=", "<="],
        "Return" => [0.3, 0.1, 0.05, 0.03, 0.017],
        "Type Relative" => ["Assets", "Classes", "Assets", "", ""],
        "Relative Set" => ["", "Class 1", "", "", ""],
        "Relative" => ["FB", "Fixed Income", "TLT", "", ""],
    )

    views = DataFrame(views)
    P, Q = asset_views(views, asset_classes)

    Pt = transpose(
        hcat(
            [
                [-0.0, -1.0, -0.0, -0.0, -0.0, -0.0, 1.0],
                [0.5, 0.0, 0.0, 0.0, -0.5, -0.5, 0.5],
                [0.2, 0.2, 0.2, 0.2, 0.0, -1.0, 0.2],
                [0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0],
                [0.0, 0.0, 0.0, 0.0, 0.5, 0.5, 0.0],
            ]...,
        ),
    )
    Qt = vcat([[0.3], [0.1], [0.05], [0.03], [0.017]]...)
    @test isapprox(Pt, P)
    @test isapprox(Qt, Q)
end

@testset "Factor views" begin
    loadings = OrderedDict(
        "const" => [0.0004, 0.0002, 0.0000, 0.0006, 0.0001, 0.0003, -0.0003],
        "MTUM" => [0.1916, 1.0061, 0.8695, 1.9996, 0.0000, 0.0000, 0.0000],
        "QUAL" => [0.0000, 2.0129, 1.4301, 0.0000, 0.0000, 0.0000, 0.0000],
        "SIZE" => [0.0000, 0.0000, 0.0000, 0.4717, 0.0000, -0.1857, 0.0000],
        "USMV" => [-0.7838, -1.6439, -1.0176, -1.4407, 0.0055, 0.5781, 0.0000],
        "VLUE" => [1.4772, -0.7590, -0.4090, 0.0000, -0.0054, -0.4844, 0.9435],
    )

    loadings = DataFrame(loadings)

    views = OrderedDict(
        "Enabled" => [true, true, true],
        "Factor" => ["MTUM", "USMV", "VLUE"],
        "Sign" => ["<=", "<=", ">="],
        "Value" => [0.9, -1.2, 0.3],
        "Relative Factor" => ["USMV", "", ""],
    )

    views = DataFrame(views)

    P, Q = factor_views(views, loadings)

    Pt = transpose(hcat([[0, -1, 0, 0, 1, 0], [0, 0, 0, 0, -1, 0], [0, 0, 0, 0, 0, 1]]...))
    Qt = vcat([[-0.9], [1.2], [0.3]]...)
    @test isapprox(Pt, P)
    @test isapprox(Qt, Q)

    loadings = OrderedDict(
        "MTUM" => [0.1916, 1.0061, 0.8695, 1.9996, 0.0000, 0.0000, 0.0000],
        "QUAL" => [0.0000, 2.0129, 1.4301, 0.0000, 0.0000, 0.0000, 0.0000],
        "SIZE" => [0.0000, 0.0000, 0.0000, 0.4717, 0.0000, -0.1857, 0.0000],
        "USMV" => [-0.7838, -1.6439, -1.0176, -1.4407, 0.0055, 0.5781, 0.0000],
        "VLUE" => [1.4772, -0.7590, -0.4090, 0.0000, -0.0054, -0.4844, 0.9435],
    )
    loadings = DataFrame(loadings)
    P, Q = factor_views(views, loadings)
    Pt = transpose(hcat([[-1, 0, 0, 1, 0], [0, 0, 0, -1, 0], [0, 0, 0, 0, 1]]...))
    Qt = vcat([[-0.9], [1.2], [0.3]]...)
    @test isapprox(Pt, P)
    @test isapprox(Qt, Q)
end

@testset "HRP constraints" begin
    asset_classes = Dict(
        "Assets" => ["FB", "GOOGL", "NTFX", "BAC", "WFC", "TLT", "SHV"],
        "Class 1" => [
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Fixed Income",
            "Fixed Income",
        ],
        "Class 2" => [
            "Technology",
            "Technology",
            "Technology",
            "Financial",
            "Financial",
            "Treasury",
            "Treasury",
        ],
    )

    asset_classes = DataFrame(asset_classes)
    sort!(asset_classes, "Assets")

    constraints = Dict(
        "Enabled" => [true, true, true, true, true, true],
        "Type" => [
            "Assets",
            "Assets",
            "All Assets",
            "All Assets",
            "Each asset in a class",
            "Each asset in a class",
        ],
        "Set" => ["", "", "", "", "Class 1", "Class 2"],
        "Position" => ["BAC", "FB", "", "", "Fixed Income", "Financial"],
        "Sign" => [">=", "<=", "<=", ">=", "<=", "<="],
        "Weight" => [0.02, 0.085, 0.09, 0.01, 0.07, 0.06],
    )
    constraints = DataFrame(constraints)

    w_min, w_max = hrp_constraints(constraints, asset_classes)

    w_mint = [0.02, 0.01, 0.01, 0.01, 0.01, 0.01, 0.01]
    w_maxt = [0.06, 0.085, 0.09, 0.09, 0.07, 0.07, 0.06]
    @test isapprox(w_mint, w_min)
    @test isapprox(w_maxt, w_max)
end

@testset "RP constraints" begin
    asset_classes = OrderedDict(
        "Assets" => ["FB", "GOOGL", "NTFX", "BAC", "WFC", "TLT", "SHV"],
        "Class 1" => [
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Equity",
            "Fixed Income",
            "Fixed Income",
        ],
        "Class 2" => [
            "Technology",
            "Technology",
            "Technology",
            "Financial",
            "Financial",
            "Treasury",
            "Treasury",
        ],
    )
    asset_classes = DataFrame(asset_classes)
    asset_classes = sort!(asset_classes, "Assets")

    w1 = rp_constraints(asset_classes, :classes, "Class 1")
    w2 = rp_constraints(asset_classes, :classes, 2)
    w3 = rp_constraints(asset_classes, :classes, Symbol("Class 1"))
    w4 = rp_constraints(asset_classes, :classes, "Class 2")
    w5 = rp_constraints(asset_classes, :classes, 3)
    w6 = rp_constraints(asset_classes, :classes, Symbol("Class 2"))
    wt1 = vcat([[0.1], [0.1], [0.1], [0.1], [0.25], [0.25], [0.1]]...)
    wt2 = vcat(
        [
            [0.16666666666666666],
            [0.1111111111111111],
            [0.1111111111111111],
            [0.1111111111111111],
            [0.16666666666666666],
            [0.16666666666666666],
            [0.16666666666666666],
        ]...,
    )
    @test isapprox(wt1, w1)
    @test isapprox(wt1, w2)
    @test isapprox(wt1, w3)
    @test isapprox(wt2, w4)
    @test isapprox(wt2, w5)
    @test isapprox(wt2, w6)
end
