using Test
using PortfolioOptimiser, DataFrames, CSV, Statistics, Clarabel, TimeSeries

@testset "Black Litterman" begin
    df = CSV.read("./assets/stock_prices.csv", DataFrame)
    dropmissing!(df)
    returns = returns_from_prices(df[!, 2:end])
    tickers = names(df)[2:end]

    mu = vec(ret_model(MRet(), Matrix(returns)))
    S = cov(Cov(), Matrix(returns))

    spy_prices = CSV.read("./assets/spy_prices.csv", DataFrame)
    delta = market_implied_risk_aversion(spy_prices[!, 2])
    deltatest = 2.6914596181448527
    @test delta ≈ deltatest

    mcapsdf = DataFrame(
        ticker = tickers,
        mcap = [
            927e9,
            1.19e12,
            574e9,
            533e9,
            867e9,
            96e9,
            43e9,
            339e9,
            301e9,
            51e9,
            61e9,
            78e9,
            0,
            295e9,
            1e9,
            22e9,
            288e9,
            212e9,
            422e9,
            102e9,
        ],
    )

    prior = market_implied_prior_returns(mcapsdf[!, 2], S, delta)
    priortest = [
        0.00039682335678550807
        0.00038011582452625276
        0.00040460204126905843
        0.00041116270265404385
        0.000449667653754408
        0.00025594875627345823
        0.0004218096697371916
        0.00020813338332985505
        0.00036611292072430125
        0.00029081891282242776
        0.00019075916687277735
        0.0003805093978140965
        0.0002720658760990628
        0.0002468149094606777
        0.00026643310643089323
        0.0002659294861168622
        0.00033437581758385986
        0.00023289727843093085
        0.0003299712197101246
        0.0002845535104648398
    ]
    @test prior ≈ priortest

    # 1. SBUX drop by 20%
    # 2. GOOG outperforms FB by 10%
    # 3. BAC and JPM will outperform T and GE by 15%
    views = [-0.20, 0.10, 0.15] / 252
    picking = hcat(
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, -0.5, 0, 0, 0.5, 0, -0.5, 0, 0, 0, 0, 0, 0, 0, 0.5, 0],
    )

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
    )
    testpost_ret = [
        0.0002317526883920042,
        0.00018206025924537078,
        2.9577971581928766e-5,
        0.00023949760695972448,
        0.0001641118477727564,
        -4.25591300394902e-7,
        0.00030827563432922754,
        4.5748786684956106e-5,
        0.00036256817194977437,
        0.0001220708854125656,
        1.4692431125765826e-5,
        5.109184924454943e-5,
        -2.3930126524822923e-5,
        0.00015673801412609663,
        0.0001961595647617427,
        9.185889609266876e-5,
        0.0001417781862236049,
        0.00012734917756066747,
        0.0002796625537167904,
        -0.00023578169814127083,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021170136719412578,
            9.882012717239718e-5,
            0.00014214633780482174,
            0.00011919691639595242,
            0.00015968157790958908,
            6.251486591011643e-5,
            8.29417484366772e-5,
            4.2060675736993705e-5,
            9.114934364992521e-5,
            7.216052754680884e-5,
            4.063802355808646e-5,
            0.0001030684857231879,
            3.5969435512394174e-5,
            5.3723048020144834e-5,
            2.4645695393805058e-5,
            5.035013657305016e-5,
            9.927649592715224e-5,
            5.9376887656585736e-5,
            7.942934302287015e-5,
            8.349444806464863e-5,
            9.882012717239718e-5,
            0.00021343870423924655,
            0.00010998308598541027,
            9.534934186948941e-5,
            0.00010809572113292329,
            5.865290856769179e-5,
            0.0001313440945708752,
            4.584452347498192e-5,
            9.492837825134261e-5,
            7.643380151524883e-5,
            4.216021998479876e-5,
            9.195670660856539e-5,
            7.191261708124687e-5,
            5.9396966008559086e-5,
            5.455418599933881e-5,
            7.484380242749525e-5,
            9.328918201567936e-5,
            5.134665848391831e-5,
            8.627196554504028e-5,
            7.197237107095853e-5,
            0.00014214633780482174,
            0.00010998308598541027,
            0.0002591892353862615,
            0.0001203080392046238,
            0.00015459466437268897,
            6.755823971632698e-5,
            0.00011794643369019617,
            3.890786007567541e-5,
            9.505651789073632e-5,
            7.664435452016829e-5,
            3.931981316629476e-5,
            0.00013886373137110962,
            5.8583221140246954e-5,
            5.287126524877838e-5,
            4.36361869954695e-5,
            5.674713480555026e-5,
            0.00010242890732697987,
            5.466131442287516e-5,
            8.185427362844361e-5,
            8.845124737061574e-5,
            0.00011919691639595242,
            9.534934186948941e-5,
            0.0001203080392046238,
            0.0004044379246729651,
            0.00013367007710144414,
            6.566163517244134e-5,
            0.00020248717178993381,
            3.489102826297826e-5,
            9.849607347991692e-5,
            8.217613884912853e-5,
            2.8831085771079067e-5,
            0.00011174810585041707,
            0.00010121962201046993,
            5.676872456407606e-5,
            9.722891312366262e-5,
            7.845570734824315e-5,
            0.00010172503494301336,
            5.262696187869259e-5,
            8.503354721428357e-5,
            6.94859332900809e-5,
            0.00015968157790958908,
            0.00010809572113292329,
            0.00015459466437268897,
            0.00013367007710144414,
            0.00033407317986743757,
            5.199222076176316e-5,
            0.00012175839281928872,
            3.7021953809211e-5,
            8.864566457858639e-5,
            6.636280103439172e-5,
            3.7576048419465825e-5,
            0.00011999895823085928,
            1.9319144050404992e-5,
            5.157307870967887e-5,
            7.813041107104072e-5,
            5.739123014583014e-5,
            0.00010525195816596131,
            4.6751950013423445e-5,
            7.566635775164522e-5,
            0.00010036002442043424,
            6.251486591011643e-5,
            5.865290856769179e-5,
            6.755823971632698e-5,
            6.566163517244134e-5,
            5.199222076176316e-5,
            0.00018073937547192917,
            9.545166321462885e-5,
            3.8575851121092844e-5,
            0.00010058801716469327,
            8.756709280419767e-5,
            5.320616884260033e-5,
            0.00010761309524193667,
            0.00011615818064888369,
            7.010376511845777e-5,
            0.00010165358555447039,
            4.8078425814760686e-5,
            6.52410554961577e-5,
            5.666312622725952e-5,
            9.215214339288033e-5,
            6.173311292845824e-5,
            8.29417484366772e-5,
            0.0001313440945708752,
            0.00011794643369019617,
            0.00020248717178993381,
            0.00012175839281928872,
            9.545166321462885e-5,
            0.0016644275401152438,
            4.554589403116727e-5,
            0.0001689665491878235,
            0.0001397608279332641,
            6.511985692523234e-5,
            0.0001065822418485371,
            0.00014117611837229435,
            9.046326929559577e-5,
            0.0002430731853660956,
            0.00012097307643726503,
            0.0001316759703496672,
            7.477567449988525e-5,
            0.00012694434910807327,
            5.379582833316428e-5,
            4.2060675736993705e-5,
            4.584452347498192e-5,
            3.890786007567541e-5,
            3.489102826297826e-5,
            3.7021953809211e-5,
            3.8575851121092844e-5,
            4.554589403116727e-5,
            0.00016509504764974003,
            4.17004861075961e-5,
            5.0215686685185025e-5,
            4.275992158085054e-5,
            6.454243835980556e-5,
            0.00011267600508158842,
            3.4791425799989376e-5,
            2.101601518022016e-5,
            5.821657006044113e-5,
            4.6355051103858035e-5,
            4.4876152682228956e-5,
            4.760205020793043e-5,
            4.901108569792229e-5,
            9.114934364992521e-5,
            9.492837825134261e-5,
            9.505651789073632e-5,
            9.849607347991692e-5,
            8.864566457858639e-5,
            0.00010058801716469327,
            0.0001689665491878235,
            4.17004861075961e-5,
            0.000278014484778982,
            0.00012671699077575075,
            4.7281260590112894e-5,
            0.000142671636898182,
            0.00014955983524049378,
            9.209058592149742e-5,
            0.00013643139218960415,
            0.0001191778069849108,
            0.00011055138524475857,
            7.811859166821608e-5,
            0.00020246623567757695,
            7.821243954421723e-5,
            7.216052754680884e-5,
            7.643380151524883e-5,
            7.664435452016829e-5,
            8.217613884912853e-5,
            6.636280103439172e-5,
            8.756709280419767e-5,
            0.0001397608279332641,
            5.0215686685185025e-5,
            0.00012671699077575075,
            0.0002455423256242142,
            4.8093430802244676e-5,
            0.0001291616286302352,
            0.00014695135538612662,
            6.61848283366177e-5,
            0.00010499724877905906,
            0.00010081684067497011,
            7.74537078911513e-5,
            6.068868270979312e-5,
            0.00010894907688895304,
            7.02391208690381e-5,
            4.063802355808646e-5,
            4.216021998479876e-5,
            3.931981316629476e-5,
            2.8831085771079067e-5,
            3.7576048419465825e-5,
            5.320616884260033e-5,
            6.511985692523234e-5,
            4.275992158085054e-5,
            4.7281260590112894e-5,
            4.8093430802244676e-5,
            0.00010632968906640362,
            4.92882014569573e-5,
            5.9405922943878805e-5,
            4.8998035637315155e-5,
            6.318466557098462e-5,
            4.067893929673198e-5,
            4.3031136002971805e-5,
            3.7619471988352814e-5,
            5.195659827317302e-5,
            3.627578315571464e-5,
            0.0001030684857231879,
            9.195670660856539e-5,
            0.00013886373137110962,
            0.00011174810585041707,
            0.00011999895823085928,
            0.00010761309524193667,
            0.0001065822418485371,
            6.454243835980556e-5,
            0.000142671636898182,
            0.0001291616286302352,
            4.92882014569573e-5,
            0.000713293295379737,
            0.00023211529675846117,
            7.628557352510105e-5,
            0.00013164217733675976,
            0.00013857490317005015,
            9.360721764768008e-5,
            6.879911640488407e-5,
            0.00012264737178909523,
            0.00010863699564581928,
            3.5969435512394174e-5,
            7.191261708124687e-5,
            5.8583221140246954e-5,
            0.00010121962201046993,
            1.9319144050404992e-5,
            0.00011615818064888369,
            0.00014117611837229435,
            0.00011267600508158842,
            0.00014955983524049378,
            0.00014695135538612662,
            5.9405922943878805e-5,
            0.00023211529675846117,
            0.0019630854837568374,
            7.89616797471868e-5,
            0.00022371799915574969,
            0.00023592396049583922,
            5.996632679264928e-5,
            5.627205170842355e-5,
            0.00010095154154695027,
            9.515564459139268e-5,
            5.3723048020144834e-5,
            5.9396966008559086e-5,
            5.287126524877838e-5,
            5.676872456407606e-5,
            5.157307870967887e-5,
            7.010376511845777e-5,
            9.046326929559577e-5,
            3.4791425799989376e-5,
            9.209058592149742e-5,
            6.61848283366177e-5,
            4.8998035637315155e-5,
            7.628557352510105e-5,
            7.89616797471868e-5,
            0.00014499819853779352,
            0.0001560049609005892,
            4.762833198453076e-5,
            6.495054776545636e-5,
            5.168340035749547e-5,
            8.843475776415097e-5,
            4.03510937042775e-5,
            2.4645695393805058e-5,
            5.455418599933881e-5,
            4.36361869954695e-5,
            9.722891312366262e-5,
            7.813041107104072e-5,
            0.00010165358555447039,
            0.0002430731853660956,
            2.101601518022016e-5,
            0.00013643139218960415,
            0.00010499724877905906,
            6.318466557098462e-5,
            0.00013164217733675976,
            0.00022371799915574969,
            0.0001560049609005892,
            0.001003540124330722,
            0.00011548960955398309,
            6.756565970361256e-5,
            3.793445584035659e-5,
            0.00011730439217817478,
            3.5300081229179474e-5,
            5.035013657305016e-5,
            7.484380242749525e-5,
            5.674713480555026e-5,
            7.845570734824315e-5,
            5.739123014583014e-5,
            4.8078425814760686e-5,
            0.00012097307643726503,
            5.821657006044113e-5,
            0.0001191778069849108,
            0.00010081684067497011,
            4.067893929673198e-5,
            0.00013857490317005015,
            0.00023592396049583922,
            4.762833198453076e-5,
            0.00011548960955398309,
            0.0005102366328956702,
            7.528066533721829e-5,
            4.9652891342789953e-5,
            9.313296682099016e-5,
            7.673339859690194e-5,
            9.927649592715224e-5,
            9.328918201567936e-5,
            0.00010242890732697987,
            0.00010172503494301336,
            0.00010525195816596131,
            6.52410554961577e-5,
            0.0001316759703496672,
            4.6355051103858035e-5,
            0.00011055138524475857,
            7.74537078911513e-5,
            4.3031136002971805e-5,
            9.360721764768008e-5,
            5.996632679264928e-5,
            6.495054776545636e-5,
            6.756565970361256e-5,
            7.528066533721829e-5,
            0.00016381541715033458,
            6.174977230313215e-5,
            9.903825214433091e-5,
            7.772860412652483e-5,
            5.9376887656585736e-5,
            5.134665848391831e-5,
            5.466131442287516e-5,
            5.262696187869259e-5,
            4.6751950013423445e-5,
            5.666312622725952e-5,
            7.477567449988525e-5,
            4.4876152682228956e-5,
            7.811859166821608e-5,
            6.068868270979312e-5,
            3.7619471988352814e-5,
            6.879911640488407e-5,
            5.627205170842355e-5,
            5.168340035749547e-5,
            3.793445584035659e-5,
            4.9652891342789953e-5,
            6.174977230313215e-5,
            0.00012316407311788397,
            7.289457587232577e-5,
            4.4793873407370824e-5,
            7.942934302287015e-5,
            8.627196554504028e-5,
            8.185427362844361e-5,
            8.503354721428357e-5,
            7.566635775164522e-5,
            9.215214339288033e-5,
            0.00012694434910807327,
            4.760205020793043e-5,
            0.00020246623567757695,
            0.00010894907688895304,
            5.195659827317302e-5,
            0.00012264737178909523,
            0.00010095154154695027,
            8.843475776415097e-5,
            0.00011730439217817478,
            9.313296682099016e-5,
            9.903825214433091e-5,
            7.289457587232577e-5,
            0.00018619042141962059,
            7.120880636829562e-5,
            8.349444806464863e-5,
            7.197237107095853e-5,
            8.845124737061574e-5,
            6.94859332900809e-5,
            0.00010036002442043424,
            6.173311292845824e-5,
            5.379582833316428e-5,
            4.901108569792229e-5,
            7.821243954421723e-5,
            7.02391208690381e-5,
            3.627578315571464e-5,
            0.00010863699564581928,
            9.515564459139268e-5,
            4.03510937042775e-5,
            3.5300081229179474e-5,
            7.673339859690194e-5,
            7.772860412652483e-5,
            4.4793873407370824e-5,
            7.120880636829562e-5,
            0.00015867625736578513,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        2.839290057340333
        1.084183258172175
        -1.541096089773483
        0.5288118715785014
        0.7503917295948589
        -1.4167382629860619
        0.009775712635901865
        0.6555661548870511
        1.8591123895149466
        0.09158033160070628
        -0.8350257347450893
        0.008366187866604164
        -0.02426041514422742
        0.631558922972953
        0.0028821896969285408
        0.08575561981848137
        0.2769477210347458
        0.7161768847637328
        1.817587815132854
        -6.540866343961913
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest =
        0.004055625862504303, 0.0896457816551767, 0.044363949391588525
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(mcapsdf[!, 1], S; rf = 0, tau = 0.01, Q = views, P = picking)
    testpost_ret = [
        -8.266082118908346e-5
        -0.00012307560785296723
        -0.0002863612325949266
        -9.763245606195502e-5
        -0.00018680274035935847
        -0.0002087053713689078
        -4.592573412276241e-5
        -0.00011846548643302374
        0.00011484148094323721
        -9.237715884161506e-5
        -0.00015353056397018
        -0.00021803264481903156
        -0.0002015229825172775
        -4.563263455918167e-5
        -2.5929159472772554e-5
        -8.847016417381403e-5
        -0.00010950814904961965
        -5.796846896032481e-5
        4.868131855906825e-5
        -0.00037415736450385886
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021170136719412578,
            9.882012717239718e-5,
            0.00014214633780482174,
            0.00011919691639595242,
            0.00015968157790958908,
            6.251486591011643e-5,
            8.29417484366772e-5,
            4.2060675736993705e-5,
            9.114934364992521e-5,
            7.216052754680884e-5,
            4.063802355808646e-5,
            0.0001030684857231879,
            3.5969435512394174e-5,
            5.3723048020144834e-5,
            2.4645695393805058e-5,
            5.035013657305016e-5,
            9.927649592715224e-5,
            5.9376887656585736e-5,
            7.942934302287015e-5,
            8.349444806464863e-5,
            9.882012717239718e-5,
            0.00021343870423924655,
            0.00010998308598541027,
            9.534934186948941e-5,
            0.00010809572113292329,
            5.865290856769179e-5,
            0.0001313440945708752,
            4.584452347498192e-5,
            9.492837825134261e-5,
            7.643380151524883e-5,
            4.216021998479876e-5,
            9.195670660856539e-5,
            7.191261708124687e-5,
            5.9396966008559086e-5,
            5.455418599933881e-5,
            7.484380242749525e-5,
            9.328918201567936e-5,
            5.134665848391831e-5,
            8.627196554504028e-5,
            7.197237107095853e-5,
            0.00014214633780482174,
            0.00010998308598541027,
            0.0002591892353862615,
            0.0001203080392046238,
            0.00015459466437268897,
            6.755823971632698e-5,
            0.00011794643369019617,
            3.890786007567541e-5,
            9.505651789073632e-5,
            7.664435452016829e-5,
            3.931981316629476e-5,
            0.00013886373137110962,
            5.8583221140246954e-5,
            5.287126524877838e-5,
            4.36361869954695e-5,
            5.674713480555026e-5,
            0.00010242890732697987,
            5.466131442287516e-5,
            8.185427362844361e-5,
            8.845124737061574e-5,
            0.00011919691639595242,
            9.534934186948941e-5,
            0.0001203080392046238,
            0.0004044379246729651,
            0.00013367007710144414,
            6.566163517244134e-5,
            0.00020248717178993381,
            3.489102826297826e-5,
            9.849607347991692e-5,
            8.217613884912853e-5,
            2.8831085771079067e-5,
            0.00011174810585041707,
            0.00010121962201046993,
            5.676872456407606e-5,
            9.722891312366262e-5,
            7.845570734824315e-5,
            0.00010172503494301336,
            5.262696187869259e-5,
            8.503354721428357e-5,
            6.94859332900809e-5,
            0.00015968157790958908,
            0.00010809572113292329,
            0.00015459466437268897,
            0.00013367007710144414,
            0.00033407317986743757,
            5.199222076176316e-5,
            0.00012175839281928872,
            3.7021953809211e-5,
            8.864566457858639e-5,
            6.636280103439172e-5,
            3.7576048419465825e-5,
            0.00011999895823085928,
            1.9319144050404992e-5,
            5.157307870967887e-5,
            7.813041107104072e-5,
            5.739123014583014e-5,
            0.00010525195816596131,
            4.6751950013423445e-5,
            7.566635775164522e-5,
            0.00010036002442043424,
            6.251486591011643e-5,
            5.865290856769179e-5,
            6.755823971632698e-5,
            6.566163517244134e-5,
            5.199222076176316e-5,
            0.00018073937547192917,
            9.545166321462885e-5,
            3.8575851121092844e-5,
            0.00010058801716469327,
            8.756709280419767e-5,
            5.320616884260033e-5,
            0.00010761309524193667,
            0.00011615818064888369,
            7.010376511845777e-5,
            0.00010165358555447039,
            4.8078425814760686e-5,
            6.52410554961577e-5,
            5.666312622725952e-5,
            9.215214339288033e-5,
            6.173311292845824e-5,
            8.29417484366772e-5,
            0.0001313440945708752,
            0.00011794643369019617,
            0.00020248717178993381,
            0.00012175839281928872,
            9.545166321462885e-5,
            0.0016644275401152438,
            4.554589403116727e-5,
            0.0001689665491878235,
            0.0001397608279332641,
            6.511985692523234e-5,
            0.0001065822418485371,
            0.00014117611837229435,
            9.046326929559577e-5,
            0.0002430731853660956,
            0.00012097307643726503,
            0.0001316759703496672,
            7.477567449988525e-5,
            0.00012694434910807327,
            5.379582833316428e-5,
            4.2060675736993705e-5,
            4.584452347498192e-5,
            3.890786007567541e-5,
            3.489102826297826e-5,
            3.7021953809211e-5,
            3.8575851121092844e-5,
            4.554589403116727e-5,
            0.00016509504764974003,
            4.17004861075961e-5,
            5.0215686685185025e-5,
            4.275992158085054e-5,
            6.454243835980556e-5,
            0.00011267600508158842,
            3.4791425799989376e-5,
            2.101601518022016e-5,
            5.821657006044113e-5,
            4.6355051103858035e-5,
            4.4876152682228956e-5,
            4.760205020793043e-5,
            4.901108569792229e-5,
            9.114934364992521e-5,
            9.492837825134261e-5,
            9.505651789073632e-5,
            9.849607347991692e-5,
            8.864566457858639e-5,
            0.00010058801716469327,
            0.0001689665491878235,
            4.17004861075961e-5,
            0.000278014484778982,
            0.00012671699077575075,
            4.7281260590112894e-5,
            0.000142671636898182,
            0.00014955983524049378,
            9.209058592149742e-5,
            0.00013643139218960415,
            0.0001191778069849108,
            0.00011055138524475857,
            7.811859166821608e-5,
            0.00020246623567757695,
            7.821243954421723e-5,
            7.216052754680884e-5,
            7.643380151524883e-5,
            7.664435452016829e-5,
            8.217613884912853e-5,
            6.636280103439172e-5,
            8.756709280419767e-5,
            0.0001397608279332641,
            5.0215686685185025e-5,
            0.00012671699077575075,
            0.0002455423256242142,
            4.8093430802244676e-5,
            0.0001291616286302352,
            0.00014695135538612662,
            6.61848283366177e-5,
            0.00010499724877905906,
            0.00010081684067497011,
            7.74537078911513e-5,
            6.068868270979312e-5,
            0.00010894907688895304,
            7.02391208690381e-5,
            4.063802355808646e-5,
            4.216021998479876e-5,
            3.931981316629476e-5,
            2.8831085771079067e-5,
            3.7576048419465825e-5,
            5.320616884260033e-5,
            6.511985692523234e-5,
            4.275992158085054e-5,
            4.7281260590112894e-5,
            4.8093430802244676e-5,
            0.00010632968906640362,
            4.92882014569573e-5,
            5.9405922943878805e-5,
            4.8998035637315155e-5,
            6.318466557098462e-5,
            4.067893929673198e-5,
            4.3031136002971805e-5,
            3.7619471988352814e-5,
            5.195659827317302e-5,
            3.627578315571464e-5,
            0.0001030684857231879,
            9.195670660856539e-5,
            0.00013886373137110962,
            0.00011174810585041707,
            0.00011999895823085928,
            0.00010761309524193667,
            0.0001065822418485371,
            6.454243835980556e-5,
            0.000142671636898182,
            0.0001291616286302352,
            4.92882014569573e-5,
            0.000713293295379737,
            0.00023211529675846117,
            7.628557352510105e-5,
            0.00013164217733675976,
            0.00013857490317005015,
            9.360721764768008e-5,
            6.879911640488407e-5,
            0.00012264737178909523,
            0.00010863699564581928,
            3.5969435512394174e-5,
            7.191261708124687e-5,
            5.8583221140246954e-5,
            0.00010121962201046993,
            1.9319144050404992e-5,
            0.00011615818064888369,
            0.00014117611837229435,
            0.00011267600508158842,
            0.00014955983524049378,
            0.00014695135538612662,
            5.9405922943878805e-5,
            0.00023211529675846117,
            0.0019630854837568374,
            7.89616797471868e-5,
            0.00022371799915574969,
            0.00023592396049583922,
            5.996632679264928e-5,
            5.627205170842355e-5,
            0.00010095154154695027,
            9.515564459139268e-5,
            5.3723048020144834e-5,
            5.9396966008559086e-5,
            5.287126524877838e-5,
            5.676872456407606e-5,
            5.157307870967887e-5,
            7.010376511845777e-5,
            9.046326929559577e-5,
            3.4791425799989376e-5,
            9.209058592149742e-5,
            6.61848283366177e-5,
            4.8998035637315155e-5,
            7.628557352510105e-5,
            7.89616797471868e-5,
            0.00014499819853779352,
            0.0001560049609005892,
            4.762833198453076e-5,
            6.495054776545636e-5,
            5.168340035749547e-5,
            8.843475776415097e-5,
            4.03510937042775e-5,
            2.4645695393805058e-5,
            5.455418599933881e-5,
            4.36361869954695e-5,
            9.722891312366262e-5,
            7.813041107104072e-5,
            0.00010165358555447039,
            0.0002430731853660956,
            2.101601518022016e-5,
            0.00013643139218960415,
            0.00010499724877905906,
            6.318466557098462e-5,
            0.00013164217733675976,
            0.00022371799915574969,
            0.0001560049609005892,
            0.001003540124330722,
            0.00011548960955398309,
            6.756565970361256e-5,
            3.793445584035659e-5,
            0.00011730439217817478,
            3.5300081229179474e-5,
            5.035013657305016e-5,
            7.484380242749525e-5,
            5.674713480555026e-5,
            7.845570734824315e-5,
            5.739123014583014e-5,
            4.8078425814760686e-5,
            0.00012097307643726503,
            5.821657006044113e-5,
            0.0001191778069849108,
            0.00010081684067497011,
            4.067893929673198e-5,
            0.00013857490317005015,
            0.00023592396049583922,
            4.762833198453076e-5,
            0.00011548960955398309,
            0.0005102366328956702,
            7.528066533721829e-5,
            4.9652891342789953e-5,
            9.313296682099016e-5,
            7.673339859690194e-5,
            9.927649592715224e-5,
            9.328918201567936e-5,
            0.00010242890732697987,
            0.00010172503494301336,
            0.00010525195816596131,
            6.52410554961577e-5,
            0.0001316759703496672,
            4.6355051103858035e-5,
            0.00011055138524475857,
            7.74537078911513e-5,
            4.3031136002971805e-5,
            9.360721764768008e-5,
            5.996632679264928e-5,
            6.495054776545636e-5,
            6.756565970361256e-5,
            7.528066533721829e-5,
            0.00016381541715033458,
            6.174977230313215e-5,
            9.903825214433091e-5,
            7.772860412652483e-5,
            5.9376887656585736e-5,
            5.134665848391831e-5,
            5.466131442287516e-5,
            5.262696187869259e-5,
            4.6751950013423445e-5,
            5.666312622725952e-5,
            7.477567449988525e-5,
            4.4876152682228956e-5,
            7.811859166821608e-5,
            6.068868270979312e-5,
            3.7619471988352814e-5,
            6.879911640488407e-5,
            5.627205170842355e-5,
            5.168340035749547e-5,
            3.793445584035659e-5,
            4.9652891342789953e-5,
            6.174977230313215e-5,
            0.00012316407311788397,
            7.289457587232577e-5,
            4.4793873407370824e-5,
            7.942934302287015e-5,
            8.627196554504028e-5,
            8.185427362844361e-5,
            8.503354721428357e-5,
            7.566635775164522e-5,
            9.215214339288033e-5,
            0.00012694434910807327,
            4.760205020793043e-5,
            0.00020246623567757695,
            0.00010894907688895304,
            5.195659827317302e-5,
            0.00012264737178909523,
            0.00010095154154695027,
            8.843475776415097e-5,
            0.00011730439217817478,
            9.313296682099016e-5,
            9.903825214433091e-5,
            7.289457587232577e-5,
            0.00018619042141962059,
            7.120880636829562e-5,
            8.349444806464863e-5,
            7.197237107095853e-5,
            8.845124737061574e-5,
            6.94859332900809e-5,
            0.00010036002442043424,
            6.173311292845824e-5,
            5.379582833316428e-5,
            4.901108569792229e-5,
            7.821243954421723e-5,
            7.02391208690381e-5,
            3.627578315571464e-5,
            0.00010863699564581928,
            9.515564459139268e-5,
            4.03510937042775e-5,
            3.5300081229179474e-5,
            7.673339859690194e-5,
            7.772860412652483e-5,
            4.4793873407370824e-5,
            7.120880636829562e-5,
            0.00015867625736578513,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.39150004402872096,
        4.6895436760156055e-17,
        0.39150004402872096,
        5.5357767191555675e-18,
        -1.6804894098435003e-17,
        0.3704847078591793,
        -3.291491816172276e-18,
        -4.3716925134921596e-17,
        -0.37048470785917914,
        -3.535974243476658e-17,
        0.3704847078591794,
        2.5582596145939483e-17,
        -1.1945455638290133e-17,
        -2.5604273389586943e-17,
        -7.033736113034615e-18,
        2.7239824302241563e-17,
        1.9771585259870072e-17,
        7.167596687923214e-17,
        -0.3704847078591795,
        1.0,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest =
        -0.0006486916558200404, 0.015667131547371316, -0.04642053305071756
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = :market, # either a vector, `nothing`, `:Equal`, or `:market`
        market_caps = mcapsdf[!, 2],
        Q = views,
        P = picking,
    )
    testpost_ret = [
        1.2538530233526161e-5
        -3.2532456429194834e-5
        -0.00019036955254367875
        4.5496395443302005e-6
        -7.658316207767441e-5
        -0.0001546642683918457
        6.0943846590431834e-5
        -8.213663843731253e-5
        0.0001837592652697653
        -3.574969263174281e-5
        -0.00011665496657564046
        -0.0001376023587514728
        -0.00015621619800306046
        3.881623614708767e-6
        3.0323715932984623e-5
        -4.4002798799427635e-5
        -3.850314697486741e-5
        -1.4357792090986448e-5
        0.00011103859545055761
        -0.0003374369805765025
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021170136719412578,
            9.882012717239718e-5,
            0.00014214633780482174,
            0.00011919691639595242,
            0.00015968157790958908,
            6.251486591011643e-5,
            8.29417484366772e-5,
            4.2060675736993705e-5,
            9.114934364992521e-5,
            7.216052754680884e-5,
            4.063802355808646e-5,
            0.0001030684857231879,
            3.5969435512394174e-5,
            5.3723048020144834e-5,
            2.4645695393805058e-5,
            5.035013657305016e-5,
            9.927649592715224e-5,
            5.9376887656585736e-5,
            7.942934302287015e-5,
            8.349444806464863e-5,
            9.882012717239718e-5,
            0.00021343870423924655,
            0.00010998308598541027,
            9.534934186948941e-5,
            0.00010809572113292329,
            5.865290856769179e-5,
            0.0001313440945708752,
            4.584452347498192e-5,
            9.492837825134261e-5,
            7.643380151524883e-5,
            4.216021998479876e-5,
            9.195670660856539e-5,
            7.191261708124687e-5,
            5.9396966008559086e-5,
            5.455418599933881e-5,
            7.484380242749525e-5,
            9.328918201567936e-5,
            5.134665848391831e-5,
            8.627196554504028e-5,
            7.197237107095853e-5,
            0.00014214633780482174,
            0.00010998308598541027,
            0.0002591892353862615,
            0.0001203080392046238,
            0.00015459466437268897,
            6.755823971632698e-5,
            0.00011794643369019617,
            3.890786007567541e-5,
            9.505651789073632e-5,
            7.664435452016829e-5,
            3.931981316629476e-5,
            0.00013886373137110962,
            5.8583221140246954e-5,
            5.287126524877838e-5,
            4.36361869954695e-5,
            5.674713480555026e-5,
            0.00010242890732697987,
            5.466131442287516e-5,
            8.185427362844361e-5,
            8.845124737061574e-5,
            0.00011919691639595242,
            9.534934186948941e-5,
            0.0001203080392046238,
            0.0004044379246729651,
            0.00013367007710144414,
            6.566163517244134e-5,
            0.00020248717178993381,
            3.489102826297826e-5,
            9.849607347991692e-5,
            8.217613884912853e-5,
            2.8831085771079067e-5,
            0.00011174810585041707,
            0.00010121962201046993,
            5.676872456407606e-5,
            9.722891312366262e-5,
            7.845570734824315e-5,
            0.00010172503494301336,
            5.262696187869259e-5,
            8.503354721428357e-5,
            6.94859332900809e-5,
            0.00015968157790958908,
            0.00010809572113292329,
            0.00015459466437268897,
            0.00013367007710144414,
            0.00033407317986743757,
            5.199222076176316e-5,
            0.00012175839281928872,
            3.7021953809211e-5,
            8.864566457858639e-5,
            6.636280103439172e-5,
            3.7576048419465825e-5,
            0.00011999895823085928,
            1.9319144050404992e-5,
            5.157307870967887e-5,
            7.813041107104072e-5,
            5.739123014583014e-5,
            0.00010525195816596131,
            4.6751950013423445e-5,
            7.566635775164522e-5,
            0.00010036002442043424,
            6.251486591011643e-5,
            5.865290856769179e-5,
            6.755823971632698e-5,
            6.566163517244134e-5,
            5.199222076176316e-5,
            0.00018073937547192917,
            9.545166321462885e-5,
            3.8575851121092844e-5,
            0.00010058801716469327,
            8.756709280419767e-5,
            5.320616884260033e-5,
            0.00010761309524193667,
            0.00011615818064888369,
            7.010376511845777e-5,
            0.00010165358555447039,
            4.8078425814760686e-5,
            6.52410554961577e-5,
            5.666312622725952e-5,
            9.215214339288033e-5,
            6.173311292845824e-5,
            8.29417484366772e-5,
            0.0001313440945708752,
            0.00011794643369019617,
            0.00020248717178993381,
            0.00012175839281928872,
            9.545166321462885e-5,
            0.0016644275401152438,
            4.554589403116727e-5,
            0.0001689665491878235,
            0.0001397608279332641,
            6.511985692523234e-5,
            0.0001065822418485371,
            0.00014117611837229435,
            9.046326929559577e-5,
            0.0002430731853660956,
            0.00012097307643726503,
            0.0001316759703496672,
            7.477567449988525e-5,
            0.00012694434910807327,
            5.379582833316428e-5,
            4.2060675736993705e-5,
            4.584452347498192e-5,
            3.890786007567541e-5,
            3.489102826297826e-5,
            3.7021953809211e-5,
            3.8575851121092844e-5,
            4.554589403116727e-5,
            0.00016509504764974003,
            4.17004861075961e-5,
            5.0215686685185025e-5,
            4.275992158085054e-5,
            6.454243835980556e-5,
            0.00011267600508158842,
            3.4791425799989376e-5,
            2.101601518022016e-5,
            5.821657006044113e-5,
            4.6355051103858035e-5,
            4.4876152682228956e-5,
            4.760205020793043e-5,
            4.901108569792229e-5,
            9.114934364992521e-5,
            9.492837825134261e-5,
            9.505651789073632e-5,
            9.849607347991692e-5,
            8.864566457858639e-5,
            0.00010058801716469327,
            0.0001689665491878235,
            4.17004861075961e-5,
            0.000278014484778982,
            0.00012671699077575075,
            4.7281260590112894e-5,
            0.000142671636898182,
            0.00014955983524049378,
            9.209058592149742e-5,
            0.00013643139218960415,
            0.0001191778069849108,
            0.00011055138524475857,
            7.811859166821608e-5,
            0.00020246623567757695,
            7.821243954421723e-5,
            7.216052754680884e-5,
            7.643380151524883e-5,
            7.664435452016829e-5,
            8.217613884912853e-5,
            6.636280103439172e-5,
            8.756709280419767e-5,
            0.0001397608279332641,
            5.0215686685185025e-5,
            0.00012671699077575075,
            0.0002455423256242142,
            4.8093430802244676e-5,
            0.0001291616286302352,
            0.00014695135538612662,
            6.61848283366177e-5,
            0.00010499724877905906,
            0.00010081684067497011,
            7.74537078911513e-5,
            6.068868270979312e-5,
            0.00010894907688895304,
            7.02391208690381e-5,
            4.063802355808646e-5,
            4.216021998479876e-5,
            3.931981316629476e-5,
            2.8831085771079067e-5,
            3.7576048419465825e-5,
            5.320616884260033e-5,
            6.511985692523234e-5,
            4.275992158085054e-5,
            4.7281260590112894e-5,
            4.8093430802244676e-5,
            0.00010632968906640362,
            4.92882014569573e-5,
            5.9405922943878805e-5,
            4.8998035637315155e-5,
            6.318466557098462e-5,
            4.067893929673198e-5,
            4.3031136002971805e-5,
            3.7619471988352814e-5,
            5.195659827317302e-5,
            3.627578315571464e-5,
            0.0001030684857231879,
            9.195670660856539e-5,
            0.00013886373137110962,
            0.00011174810585041707,
            0.00011999895823085928,
            0.00010761309524193667,
            0.0001065822418485371,
            6.454243835980556e-5,
            0.000142671636898182,
            0.0001291616286302352,
            4.92882014569573e-5,
            0.000713293295379737,
            0.00023211529675846117,
            7.628557352510105e-5,
            0.00013164217733675976,
            0.00013857490317005015,
            9.360721764768008e-5,
            6.879911640488407e-5,
            0.00012264737178909523,
            0.00010863699564581928,
            3.5969435512394174e-5,
            7.191261708124687e-5,
            5.8583221140246954e-5,
            0.00010121962201046993,
            1.9319144050404992e-5,
            0.00011615818064888369,
            0.00014117611837229435,
            0.00011267600508158842,
            0.00014955983524049378,
            0.00014695135538612662,
            5.9405922943878805e-5,
            0.00023211529675846117,
            0.0019630854837568374,
            7.89616797471868e-5,
            0.00022371799915574969,
            0.00023592396049583922,
            5.996632679264928e-5,
            5.627205170842355e-5,
            0.00010095154154695027,
            9.515564459139268e-5,
            5.3723048020144834e-5,
            5.9396966008559086e-5,
            5.287126524877838e-5,
            5.676872456407606e-5,
            5.157307870967887e-5,
            7.010376511845777e-5,
            9.046326929559577e-5,
            3.4791425799989376e-5,
            9.209058592149742e-5,
            6.61848283366177e-5,
            4.8998035637315155e-5,
            7.628557352510105e-5,
            7.89616797471868e-5,
            0.00014499819853779352,
            0.0001560049609005892,
            4.762833198453076e-5,
            6.495054776545636e-5,
            5.168340035749547e-5,
            8.843475776415097e-5,
            4.03510937042775e-5,
            2.4645695393805058e-5,
            5.455418599933881e-5,
            4.36361869954695e-5,
            9.722891312366262e-5,
            7.813041107104072e-5,
            0.00010165358555447039,
            0.0002430731853660956,
            2.101601518022016e-5,
            0.00013643139218960415,
            0.00010499724877905906,
            6.318466557098462e-5,
            0.00013164217733675976,
            0.00022371799915574969,
            0.0001560049609005892,
            0.001003540124330722,
            0.00011548960955398309,
            6.756565970361256e-5,
            3.793445584035659e-5,
            0.00011730439217817478,
            3.5300081229179474e-5,
            5.035013657305016e-5,
            7.484380242749525e-5,
            5.674713480555026e-5,
            7.845570734824315e-5,
            5.739123014583014e-5,
            4.8078425814760686e-5,
            0.00012097307643726503,
            5.821657006044113e-5,
            0.0001191778069849108,
            0.00010081684067497011,
            4.067893929673198e-5,
            0.00013857490317005015,
            0.00023592396049583922,
            4.762833198453076e-5,
            0.00011548960955398309,
            0.0005102366328956702,
            7.528066533721829e-5,
            4.9652891342789953e-5,
            9.313296682099016e-5,
            7.673339859690194e-5,
            9.927649592715224e-5,
            9.328918201567936e-5,
            0.00010242890732697987,
            0.00010172503494301336,
            0.00010525195816596131,
            6.52410554961577e-5,
            0.0001316759703496672,
            4.6355051103858035e-5,
            0.00011055138524475857,
            7.74537078911513e-5,
            4.3031136002971805e-5,
            9.360721764768008e-5,
            5.996632679264928e-5,
            6.495054776545636e-5,
            6.756565970361256e-5,
            7.528066533721829e-5,
            0.00016381541715033458,
            6.174977230313215e-5,
            9.903825214433091e-5,
            7.772860412652483e-5,
            5.9376887656585736e-5,
            5.134665848391831e-5,
            5.466131442287516e-5,
            5.262696187869259e-5,
            4.6751950013423445e-5,
            5.666312622725952e-5,
            7.477567449988525e-5,
            4.4876152682228956e-5,
            7.811859166821608e-5,
            6.068868270979312e-5,
            3.7619471988352814e-5,
            6.879911640488407e-5,
            5.627205170842355e-5,
            5.168340035749547e-5,
            3.793445584035659e-5,
            4.9652891342789953e-5,
            6.174977230313215e-5,
            0.00012316407311788397,
            7.289457587232577e-5,
            4.4793873407370824e-5,
            7.942934302287015e-5,
            8.627196554504028e-5,
            8.185427362844361e-5,
            8.503354721428357e-5,
            7.566635775164522e-5,
            9.215214339288033e-5,
            0.00012694434910807327,
            4.760205020793043e-5,
            0.00020246623567757695,
            0.00010894907688895304,
            5.195659827317302e-5,
            0.00012264737178909523,
            0.00010095154154695027,
            8.843475776415097e-5,
            0.00011730439217817478,
            9.313296682099016e-5,
            9.903825214433091e-5,
            7.289457587232577e-5,
            0.00018619042141962059,
            7.120880636829562e-5,
            8.349444806464863e-5,
            7.197237107095853e-5,
            8.845124737061574e-5,
            6.94859332900809e-5,
            0.00010036002442043424,
            6.173311292845824e-5,
            5.379582833316428e-5,
            4.901108569792229e-5,
            7.821243954421723e-5,
            7.02391208690381e-5,
            3.627578315571464e-5,
            0.00010863699564581928,
            9.515564459139268e-5,
            4.03510937042775e-5,
            3.5300081229179474e-5,
            7.673339859690194e-5,
            7.772860412652483e-5,
            4.4793873407370824e-5,
            7.120880636829562e-5,
            0.00015867625736578513,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.6294139094485687,
        -0.09837977027829774,
        0.5053231235765305,
        -0.044064216435573664,
        -0.07167668977418844,
        0.48139995581445977,
        -0.003554899262156977,
        -0.028025833717935343,
        -0.5142207699325133,
        -0.004216275869069968,
        0.4842934784697037,
        -0.006448421917401054,
        -1.2305559159888653e-17,
        -0.024388262379914153,
        -8.267207586413058e-05,
        -0.001818785669010557,
        -0.023809557848865275,
        -0.01752648008319239,
        -0.5242240911120722,
        1.5208340779439298,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest =
        -0.0008881643934894483, 0.021740853859767255, -0.04446694420144763
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = :Equal, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
    )
    testpost_ret = [
        0.03693988960896787,
        0.03897005711576849,
        0.03635009365738172,
        0.039420802902761995,
        0.034338287364438405,
        0.0397673588077047,
        0.042307103913311724,
        0.04215212992660289,
        0.03971355845386376,
        0.03937924686078631,
        0.043731348696389956,
        0.03328051409152145,
        0.035206962179512524,
        0.04392272856964718,
        0.04494857860894522,
        0.03849840189070126,
        0.03817978620106414,
        0.043169950958959764,
        0.04022758895148475,
        0.024786029091482337,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021170136719412578,
            9.882012717239718e-5,
            0.00014214633780482174,
            0.00011919691639595242,
            0.00015968157790958908,
            6.251486591011643e-5,
            8.29417484366772e-5,
            4.2060675736993705e-5,
            9.114934364992521e-5,
            7.216052754680884e-5,
            4.063802355808646e-5,
            0.0001030684857231879,
            3.5969435512394174e-5,
            5.3723048020144834e-5,
            2.4645695393805058e-5,
            5.035013657305016e-5,
            9.927649592715224e-5,
            5.9376887656585736e-5,
            7.942934302287015e-5,
            8.349444806464863e-5,
            9.882012717239718e-5,
            0.00021343870423924655,
            0.00010998308598541027,
            9.534934186948941e-5,
            0.00010809572113292329,
            5.865290856769179e-5,
            0.0001313440945708752,
            4.584452347498192e-5,
            9.492837825134261e-5,
            7.643380151524883e-5,
            4.216021998479876e-5,
            9.195670660856539e-5,
            7.191261708124687e-5,
            5.9396966008559086e-5,
            5.455418599933881e-5,
            7.484380242749525e-5,
            9.328918201567936e-5,
            5.134665848391831e-5,
            8.627196554504028e-5,
            7.197237107095853e-5,
            0.00014214633780482174,
            0.00010998308598541027,
            0.0002591892353862615,
            0.0001203080392046238,
            0.00015459466437268897,
            6.755823971632698e-5,
            0.00011794643369019617,
            3.890786007567541e-5,
            9.505651789073632e-5,
            7.664435452016829e-5,
            3.931981316629476e-5,
            0.00013886373137110962,
            5.8583221140246954e-5,
            5.287126524877838e-5,
            4.36361869954695e-5,
            5.674713480555026e-5,
            0.00010242890732697987,
            5.466131442287516e-5,
            8.185427362844361e-5,
            8.845124737061574e-5,
            0.00011919691639595242,
            9.534934186948941e-5,
            0.0001203080392046238,
            0.0004044379246729651,
            0.00013367007710144414,
            6.566163517244134e-5,
            0.00020248717178993381,
            3.489102826297826e-5,
            9.849607347991692e-5,
            8.217613884912853e-5,
            2.8831085771079067e-5,
            0.00011174810585041707,
            0.00010121962201046993,
            5.676872456407606e-5,
            9.722891312366262e-5,
            7.845570734824315e-5,
            0.00010172503494301336,
            5.262696187869259e-5,
            8.503354721428357e-5,
            6.94859332900809e-5,
            0.00015968157790958908,
            0.00010809572113292329,
            0.00015459466437268897,
            0.00013367007710144414,
            0.00033407317986743757,
            5.199222076176316e-5,
            0.00012175839281928872,
            3.7021953809211e-5,
            8.864566457858639e-5,
            6.636280103439172e-5,
            3.7576048419465825e-5,
            0.00011999895823085928,
            1.9319144050404992e-5,
            5.157307870967887e-5,
            7.813041107104072e-5,
            5.739123014583014e-5,
            0.00010525195816596131,
            4.6751950013423445e-5,
            7.566635775164522e-5,
            0.00010036002442043424,
            6.251486591011643e-5,
            5.865290856769179e-5,
            6.755823971632698e-5,
            6.566163517244134e-5,
            5.199222076176316e-5,
            0.00018073937547192917,
            9.545166321462885e-5,
            3.8575851121092844e-5,
            0.00010058801716469327,
            8.756709280419767e-5,
            5.320616884260033e-5,
            0.00010761309524193667,
            0.00011615818064888369,
            7.010376511845777e-5,
            0.00010165358555447039,
            4.8078425814760686e-5,
            6.52410554961577e-5,
            5.666312622725952e-5,
            9.215214339288033e-5,
            6.173311292845824e-5,
            8.29417484366772e-5,
            0.0001313440945708752,
            0.00011794643369019617,
            0.00020248717178993381,
            0.00012175839281928872,
            9.545166321462885e-5,
            0.0016644275401152438,
            4.554589403116727e-5,
            0.0001689665491878235,
            0.0001397608279332641,
            6.511985692523234e-5,
            0.0001065822418485371,
            0.00014117611837229435,
            9.046326929559577e-5,
            0.0002430731853660956,
            0.00012097307643726503,
            0.0001316759703496672,
            7.477567449988525e-5,
            0.00012694434910807327,
            5.379582833316428e-5,
            4.2060675736993705e-5,
            4.584452347498192e-5,
            3.890786007567541e-5,
            3.489102826297826e-5,
            3.7021953809211e-5,
            3.8575851121092844e-5,
            4.554589403116727e-5,
            0.00016509504764974003,
            4.17004861075961e-5,
            5.0215686685185025e-5,
            4.275992158085054e-5,
            6.454243835980556e-5,
            0.00011267600508158842,
            3.4791425799989376e-5,
            2.101601518022016e-5,
            5.821657006044113e-5,
            4.6355051103858035e-5,
            4.4876152682228956e-5,
            4.760205020793043e-5,
            4.901108569792229e-5,
            9.114934364992521e-5,
            9.492837825134261e-5,
            9.505651789073632e-5,
            9.849607347991692e-5,
            8.864566457858639e-5,
            0.00010058801716469327,
            0.0001689665491878235,
            4.17004861075961e-5,
            0.000278014484778982,
            0.00012671699077575075,
            4.7281260590112894e-5,
            0.000142671636898182,
            0.00014955983524049378,
            9.209058592149742e-5,
            0.00013643139218960415,
            0.0001191778069849108,
            0.00011055138524475857,
            7.811859166821608e-5,
            0.00020246623567757695,
            7.821243954421723e-5,
            7.216052754680884e-5,
            7.643380151524883e-5,
            7.664435452016829e-5,
            8.217613884912853e-5,
            6.636280103439172e-5,
            8.756709280419767e-5,
            0.0001397608279332641,
            5.0215686685185025e-5,
            0.00012671699077575075,
            0.0002455423256242142,
            4.8093430802244676e-5,
            0.0001291616286302352,
            0.00014695135538612662,
            6.61848283366177e-5,
            0.00010499724877905906,
            0.00010081684067497011,
            7.74537078911513e-5,
            6.068868270979312e-5,
            0.00010894907688895304,
            7.02391208690381e-5,
            4.063802355808646e-5,
            4.216021998479876e-5,
            3.931981316629476e-5,
            2.8831085771079067e-5,
            3.7576048419465825e-5,
            5.320616884260033e-5,
            6.511985692523234e-5,
            4.275992158085054e-5,
            4.7281260590112894e-5,
            4.8093430802244676e-5,
            0.00010632968906640362,
            4.92882014569573e-5,
            5.9405922943878805e-5,
            4.8998035637315155e-5,
            6.318466557098462e-5,
            4.067893929673198e-5,
            4.3031136002971805e-5,
            3.7619471988352814e-5,
            5.195659827317302e-5,
            3.627578315571464e-5,
            0.0001030684857231879,
            9.195670660856539e-5,
            0.00013886373137110962,
            0.00011174810585041707,
            0.00011999895823085928,
            0.00010761309524193667,
            0.0001065822418485371,
            6.454243835980556e-5,
            0.000142671636898182,
            0.0001291616286302352,
            4.92882014569573e-5,
            0.000713293295379737,
            0.00023211529675846117,
            7.628557352510105e-5,
            0.00013164217733675976,
            0.00013857490317005015,
            9.360721764768008e-5,
            6.879911640488407e-5,
            0.00012264737178909523,
            0.00010863699564581928,
            3.5969435512394174e-5,
            7.191261708124687e-5,
            5.8583221140246954e-5,
            0.00010121962201046993,
            1.9319144050404992e-5,
            0.00011615818064888369,
            0.00014117611837229435,
            0.00011267600508158842,
            0.00014955983524049378,
            0.00014695135538612662,
            5.9405922943878805e-5,
            0.00023211529675846117,
            0.0019630854837568374,
            7.89616797471868e-5,
            0.00022371799915574969,
            0.00023592396049583922,
            5.996632679264928e-5,
            5.627205170842355e-5,
            0.00010095154154695027,
            9.515564459139268e-5,
            5.3723048020144834e-5,
            5.9396966008559086e-5,
            5.287126524877838e-5,
            5.676872456407606e-5,
            5.157307870967887e-5,
            7.010376511845777e-5,
            9.046326929559577e-5,
            3.4791425799989376e-5,
            9.209058592149742e-5,
            6.61848283366177e-5,
            4.8998035637315155e-5,
            7.628557352510105e-5,
            7.89616797471868e-5,
            0.00014499819853779352,
            0.0001560049609005892,
            4.762833198453076e-5,
            6.495054776545636e-5,
            5.168340035749547e-5,
            8.843475776415097e-5,
            4.03510937042775e-5,
            2.4645695393805058e-5,
            5.455418599933881e-5,
            4.36361869954695e-5,
            9.722891312366262e-5,
            7.813041107104072e-5,
            0.00010165358555447039,
            0.0002430731853660956,
            2.101601518022016e-5,
            0.00013643139218960415,
            0.00010499724877905906,
            6.318466557098462e-5,
            0.00013164217733675976,
            0.00022371799915574969,
            0.0001560049609005892,
            0.001003540124330722,
            0.00011548960955398309,
            6.756565970361256e-5,
            3.793445584035659e-5,
            0.00011730439217817478,
            3.5300081229179474e-5,
            5.035013657305016e-5,
            7.484380242749525e-5,
            5.674713480555026e-5,
            7.845570734824315e-5,
            5.739123014583014e-5,
            4.8078425814760686e-5,
            0.00012097307643726503,
            5.821657006044113e-5,
            0.0001191778069849108,
            0.00010081684067497011,
            4.067893929673198e-5,
            0.00013857490317005015,
            0.00023592396049583922,
            4.762833198453076e-5,
            0.00011548960955398309,
            0.0005102366328956702,
            7.528066533721829e-5,
            4.9652891342789953e-5,
            9.313296682099016e-5,
            7.673339859690194e-5,
            9.927649592715224e-5,
            9.328918201567936e-5,
            0.00010242890732697987,
            0.00010172503494301336,
            0.00010525195816596131,
            6.52410554961577e-5,
            0.0001316759703496672,
            4.6355051103858035e-5,
            0.00011055138524475857,
            7.74537078911513e-5,
            4.3031136002971805e-5,
            9.360721764768008e-5,
            5.996632679264928e-5,
            6.495054776545636e-5,
            6.756565970361256e-5,
            7.528066533721829e-5,
            0.00016381541715033458,
            6.174977230313215e-5,
            9.903825214433091e-5,
            7.772860412652483e-5,
            5.9376887656585736e-5,
            5.134665848391831e-5,
            5.466131442287516e-5,
            5.262696187869259e-5,
            4.6751950013423445e-5,
            5.666312622725952e-5,
            7.477567449988525e-5,
            4.4876152682228956e-5,
            7.811859166821608e-5,
            6.068868270979312e-5,
            3.7619471988352814e-5,
            6.879911640488407e-5,
            5.627205170842355e-5,
            5.168340035749547e-5,
            3.793445584035659e-5,
            4.9652891342789953e-5,
            6.174977230313215e-5,
            0.00012316407311788397,
            7.289457587232577e-5,
            4.4793873407370824e-5,
            7.942934302287015e-5,
            8.627196554504028e-5,
            8.185427362844361e-5,
            8.503354721428357e-5,
            7.566635775164522e-5,
            9.215214339288033e-5,
            0.00012694434910807327,
            4.760205020793043e-5,
            0.00020246623567757695,
            0.00010894907688895304,
            5.195659827317302e-5,
            0.00012264737178909523,
            0.00010095154154695027,
            8.843475776415097e-5,
            0.00011730439217817478,
            9.313296682099016e-5,
            9.903825214433091e-5,
            7.289457587232577e-5,
            0.00018619042141962059,
            7.120880636829562e-5,
            8.349444806464863e-5,
            7.197237107095853e-5,
            8.845124737061574e-5,
            6.94859332900809e-5,
            0.00010036002442043424,
            6.173311292845824e-5,
            5.379582833316428e-5,
            4.901108569792229e-5,
            7.821243954421723e-5,
            7.02391208690381e-5,
            3.627578315571464e-5,
            0.00010863699564581928,
            9.515564459139268e-5,
            4.03510937042775e-5,
            3.5300081229179474e-5,
            7.673339859690194e-5,
            7.772860412652483e-5,
            4.4793873407370824e-5,
            7.120880636829562e-5,
            0.00015867625736578513,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        0.002932465194024619,
        0.04628473263525818,
        0.023279793873893423,
        0.0407773999969404,
        0.01538905383578345,
        0.05621240721348614,
        -0.011968350927789344,
        0.17404628577499617,
        -0.003340492291060658,
        0.022915488759226006,
        0.33953906742936674,
        -0.026055743774098937,
        -0.011255941052237317,
        0.17979554691588123,
        0.0009534179511302501,
        0.03134358882166059,
        0.01795566627366855,
        0.25091157968277006,
        -0.06904763858555793,
        -0.08066832772734167,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl; verbose = true)
    mutest, sigmatest, srtest =
        0.044201429838100784, 0.008001064664454225, 5.514621709300468
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        omega = :idzorek,
        view_confidence = ones(length(views)),
    )
    testpost_ret = [
        5.2623021290736116e-5,
        -1.5350396181990935e-5,
        -0.00034420237553466076,
        7.099947292104318e-5,
        -0.00013339507562952404,
        -0.0002892538322045458,
        0.00021981751359575,
        -0.00013097838339871633,
        0.00043162289975562346,
        -4.0222489463752266e-5,
        -0.0001915000947685146,
        -0.00027953369234558066,
        -0.0003276687988261679,
        7.124779830636199e-5,
        0.00014202175705378177,
        -7.079600423327967e-5,
        -4.660226408293534e-5,
        2.317388072107512e-5,
        0.00027809936374750637,
        -0.0007936507936507937,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021133549021720005,
            9.863960140313506e-5,
            0.00014213341156490026,
            0.00011900122205898954,
            0.0001593972575346622,
            6.23745695404024e-5,
            8.284313233676766e-5,
            4.19265869098592e-5,
            9.088483369803363e-5,
            7.196717980583871e-5,
            4.0554856413207046e-5,
            0.0001028359328480232,
            3.5752846405278174e-5,
            5.360439989962521e-5,
            2.4573155282221062e-5,
            5.0138810202768306e-5,
            9.906096997762311e-5,
            5.924021376829813e-5,
            7.91986981692676e-5,
            8.308464134357755e-5,
            9.863960140313506e-5,
            0.00021326063466039786,
            0.00010975304870422473,
            9.517540815573684e-5,
            0.00010786476734652493,
            5.8539732272535946e-5,
            0.00013117911696395852,
            4.574188001607561e-5,
            9.465056441338084e-5,
            7.625378250007543e-5,
            4.210725017161184e-5,
            9.168855224274125e-5,
            7.168655826135214e-5,
            5.929286149941826e-5,
            5.444671808267468e-5,
            7.464181544208886e-5,
            9.309361971070236e-5,
            5.1235885294248743e-5,
            8.603969798987176e-5,
            7.162794996636207e-5,
            0.00014213341156490026,
            0.00010975304870422473,
            0.00025860111062741463,
            0.00012011272057432279,
            0.00015434382769019035,
            6.739729233371564e-5,
            0.00011767864110998153,
            3.8793260403249615e-5,
            9.478075742414288e-5,
            7.643472983884343e-5,
            3.9245578062301925e-5,
            0.0001384620818712871,
            5.826187540654566e-5,
            5.276034940972739e-5,
            4.347243694066807e-5,
            5.651066436686653e-5,
            0.00010220431114500363,
            5.455190820497252e-5,
            8.161863291280881e-5,
            8.802924838121874e-5,
            0.00011900122205898954,
            9.517540815573684e-5,
            0.00012011272057432279,
            0.0004042645493829052,
            0.00013344223290870057,
            6.555915019758153e-5,
            0.00020232666716177755,
            3.479188815498416e-5,
            9.820198262870081e-5,
            8.199681923820838e-5,
            2.8785995238170118e-5,
            0.0001114922078643937,
            0.00010100349318073235,
            5.666380999283473e-5,
            9.712331614989786e-5,
            7.825379884953555e-5,
            0.0001015304744645658,
            5.251515579797494e-5,
            8.479057589202238e-5,
            6.915494255001464e-5,
            0.0001593972575346622,
            0.00010786476734652493,
            0.00015434382769019035,
            0.00013344223290870057,
            0.0003337533294446741,
            5.181540724383289e-5,
            0.0001215774137354895,
            3.687139981250806e-5,
            8.834249302050927e-5,
            6.613132869837518e-5,
            3.747838621272975e-5,
            0.00011965796092204186,
            1.902225182269032e-5,
            5.1438391725670196e-5,
            7.801059202195993e-5,
            5.713583181623508e-5,
            0.00010499723701130079,
            4.660378083853306e-5,
            7.540192640308232e-5,
            9.987135196989665e-5,
            6.23745695404024e-5,
            5.8539732272535946e-5,
            6.739729233371564e-5,
            6.555915019758153e-5,
            5.181540724383289e-5,
            0.0001805828519021403,
            9.540625311019116e-5,
            3.8474073769349636e-5,
            0.00010059849642758539,
            8.74687167734292e-5,
            5.309488762692122e-5,
            0.00010743410984788985,
            0.00011599108424372645,
            7.004961132156828e-5,
            0.00010162407798453852,
            4.797861687970055e-5,
            6.512722940812593e-5,
            5.65970275060714e-5,
            9.213015566401044e-5,
            6.141657336119637e-5,
            8.284313233676766e-5,
            0.00013117911696395852,
            0.00011767864110998153,
            0.00020232666716177755,
            0.0001215774137354895,
            9.540625311019116e-5,
            0.0016642182548551592,
            4.54819693205454e-5,
            0.00016858910913993398,
            0.00013958731331133596,
            6.512706469310842e-5,
            0.00010632769427344926,
            0.00014097744763119996,
            9.036322017162633e-5,
            0.0002429392119182956,
            0.00012077025758910159,
            0.00013149334094021242,
            7.467744837541853e-5,
            0.00012665045746240898,
            5.355434946403464e-5,
            4.19265869098592e-5,
            4.574188001607561e-5,
            3.8793260403249615e-5,
            3.479188815498416e-5,
            3.687139981250806e-5,
            3.8474073769349636e-5,
            4.54819693205454e-5,
            0.00016501803905809653,
            4.1616875456963734e-5,
            5.011714641546493e-5,
            4.269521003760697e-5,
            6.438871445035106e-5,
            0.00011253771538338743,
            3.4734791599801764e-5,
            2.0973503184343263e-5,
            5.811083400409262e-5,
            4.6244631197547835e-5,
            4.4811376692372073e-5,
            4.751884222948921e-5,
            4.87670036899308e-5,
            9.088483369803363e-5,
            9.465056441338084e-5,
            9.478075742414288e-5,
            9.820198262870081e-5,
            8.834249302050927e-5,
            0.00010059849642758539,
            0.00016858910913993398,
            4.1616875456963734e-5,
            0.0002771585926144057,
            0.00012639714091997365,
            4.736889086720382e-5,
            0.00014228160974087301,
            0.00014926335820683855,
            9.189784302662047e-5,
            0.0001361834915207142,
            0.00011879609282405349,
            0.00011021853948191348,
            7.793047594615858e-5,
            0.00020181860848003815,
            7.788398396676963e-5,
            7.196717980583871e-5,
            7.625378250007543e-5,
            7.643472983884343e-5,
            8.199681923820838e-5,
            6.613132869837518e-5,
            8.74687167734292e-5,
            0.00013958731331133596,
            5.011714641546493e-5,
            0.00012639714091997365,
            0.0002453558887187418,
            4.8054058543402755e-5,
            0.00012889591317538792,
            0.00014672902409478447,
            6.607580692096518e-5,
            0.0001048834602447198,
            0.00010060586503160887,
            7.725218943040642e-5,
            6.0573580128133294e-5,
            0.00010868747641396742,
            6.990665190312155e-5,
            4.0554856413207046e-5,
            4.210725017161184e-5,
            3.9245578062301925e-5,
            2.8785995238170118e-5,
            3.747838621272975e-5,
            5.309488762692122e-5,
            6.512706469310842e-5,
            4.269521003760697e-5,
            4.736889086720382e-5,
            4.8054058543402755e-5,
            0.00010624251196863336,
            4.920202491879023e-5,
            5.9317865434183316e-5,
            4.897751464967292e-5,
            6.318914187223566e-5,
            4.064454569021642e-5,
            4.298186574084912e-5,
            3.758958943748649e-5,
            5.2001641841244655e-5,
            3.608267760244097e-5,
            0.0001028359328480232,
            9.168855224274125e-5,
            0.0001384620818712871,
            0.0001114922078643937,
            0.00011965796092204186,
            0.00010743410984788985,
            0.00010632769427344926,
            6.438871445035106e-5,
            0.00014228160974087301,
            0.00012889591317538792,
            4.920202491879023e-5,
            0.0007128786009422887,
            0.000231767804818951,
            7.613402024417844e-5,
            0.0001314783605031006,
            0.00013827725197522545,
            9.331866518704433e-5,
            6.863887873803744e-5,
            0.00012231822862710293,
            0.00010811590662763481,
            3.5752846405278174e-5,
            7.168655826135214e-5,
            5.826187540654566e-5,
            0.00010100349318073235,
            1.902225182269032e-5,
            0.00011599108424372645,
            0.00014097744763119996,
            0.00011253771538338743,
            0.00014926335820683855,
            0.00014672902409478447,
            5.9317865434183316e-5,
            0.000231767804818951,
            0.0019627898112195155,
            7.883472417462956e-5,
            0.0002235895378765209,
            0.00023567715282424843,
            5.972325282961776e-5,
            5.613550007588415e-5,
            0.00010069518112754169,
            9.469486831797881e-5,
            5.360439989962521e-5,
            5.929286149941826e-5,
            5.276034940972739e-5,
            5.666380999283473e-5,
            5.1438391725670196e-5,
            7.004961132156828e-5,
            9.036322017162633e-5,
            3.4734791599801764e-5,
            9.189784302662047e-5,
            6.607580692096518e-5,
            4.897751464967292e-5,
            7.613402024417844e-5,
            7.883472417462956e-5,
            0.00014493403084436747,
            0.0001559389822637568,
            4.750473668859122e-5,
            6.483277771062897e-5,
            5.161557428057194e-5,
            8.827796059471484e-5,
            4.0160624374823635e-5,
            2.4573155282221062e-5,
            5.444671808267468e-5,
            4.347243694066807e-5,
            9.712331614989786e-5,
            7.801059202195993e-5,
            0.00010162407798453852,
            0.0002429392119182956,
            2.0973503184343263e-5,
            0.0001361834915207142,
            0.0001048834602447198,
            6.318914187223566e-5,
            0.0001314783605031006,
            0.0002235895378765209,
            0.0001559389822637568,
            0.00100345399253099,
            0.00011535674524665044,
            6.744571340337864e-5,
            3.786924669508896e-5,
            0.00011711126554342359,
            3.514138436951464e-5,
            5.0138810202768306e-5,
            7.464181544208886e-5,
            5.651066436686653e-5,
            7.825379884953555e-5,
            5.7135831816235074e-5,
            4.797861687970055e-5,
            0.00012077025758910159,
            5.811083400409262e-5,
            0.00011879609282405349,
            0.00010060586503160887,
            4.064454569021642e-5,
            0.00013827725197522545,
            0.00023567715282424843,
            4.750473668859122e-5,
            0.00011535674524665044,
            0.000509996551125716,
            7.505352948390742e-5,
            4.952355948796203e-5,
            9.282419941264771e-5,
            7.637299060493214e-5,
            9.906096997762311e-5,
            9.309361971070236e-5,
            0.00010220431114500363,
            0.0001015304744645658,
            0.00010499723701130079,
            6.512722940812593e-5,
            0.00013149334094021242,
            4.6244631197547835e-5,
            0.00011021853948191348,
            7.725218943040642e-5,
            4.298186574084912e-5,
            9.331866518704433e-5,
            5.972325282961776e-5,
            6.483277771062897e-5,
            6.744571340337864e-5,
            7.505352948390742e-5,
            0.00016359696534864977,
            6.162458972235064e-5,
            9.876375560950491e-5,
            7.735879911530285e-5,
            5.924021376829813e-5,
            5.1235885294248743e-5,
            5.455190820497252e-5,
            5.251515579797494e-5,
            4.660378083853306e-5,
            5.65970275060714e-5,
            7.467744837541853e-5,
            4.4811376692372073e-5,
            7.793047594615858e-5,
            6.0573580128133294e-5,
            3.758958943748649e-5,
            6.863887873803744e-5,
            5.613550007588415e-5,
            5.161557428057194e-5,
            3.786924669508896e-5,
            4.952355948796203e-5,
            6.162458972235064e-5,
            0.00012309118083836008,
            7.273883528940723e-5,
            4.458002213257779e-5,
            7.91986981692676e-5,
            8.603969798987176e-5,
            8.161863291280881e-5,
            8.479057589202238e-5,
            7.540192640308232e-5,
            9.213015566401044e-5,
            0.00012665045746240898,
            4.751884222948921e-5,
            0.00020181860848003815,
            0.00010868747641396742,
            5.2001641841244655e-5,
            0.00012231822862710293,
            0.00010069518112754169,
            8.827796059471484e-5,
            0.00011711126554342359,
            9.282419941264771e-5,
            9.876375560950491e-5,
            7.273883528940723e-5,
            0.00018569459832774876,
            7.08986722669357e-5,
            8.308464134357755e-5,
            7.162794996636207e-5,
            8.802924838121874e-5,
            6.915494255001464e-5,
            9.987135196989665e-5,
            6.141657336119637e-5,
            5.355434946403464e-5,
            4.87670036899308e-5,
            7.788398396676963e-5,
            6.990665190312155e-5,
            3.608267760244097e-5,
            0.00010811590662763481,
            9.469486831797881e-5,
            4.0160624374823635e-5,
            3.514138436951464e-5,
            7.637299060493214e-5,
            7.735879911530285e-5,
            4.458002213257779e-5,
            7.08986722669357e-5,
            0.00015789185651061675,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.7150423075454428,
        -0.16387871569244872,
        0.5188150013949973,
        -0.0799320684063198,
        -0.11342476651000998,
        0.5504169224679746,
        -0.0014776387844715956,
        -0.0990914946385066,
        -0.6172835736218988,
        -0.013842740156968061,
        0.4624887043260939,
        -0.0012645833741542324,
        0.003667060569358309,
        -0.09546270374567752,
        -0.00043565471275668587,
        -0.012962311245199828,
        -0.041861776129656844,
        -0.10825305334595087,
        -0.6110069650613789,
        2.1398326642124172,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest =
        -0.0025807861252230544, 0.027717538288499193, -0.09594542774785861
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = 1:20,
    )
    testpost_ret = [
        5.529413290070115,
        5.842112516537435,
        5.680312664450679,
        5.685377589294659,
        6.105084642571054,
        8.157264177218734,
        8.933336978703016,
        7.54359113937393,
        12.857433901780807,
        9.938787170833166,
        8.087819998616695,
        11.813318137516935,
        12.787941166493113,
        10.333870542540334,
        12.754908446788503,
        12.551688915726467,
        11.566436655895044,
        11.333170432974487,
        12.953124575465582,
        11.816269589221731,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021074490136888447,
            9.81382090917641e-5,
            0.0001409981347149279,
            0.0001183744979667438,
            0.0001586758992786446,
            6.206323278477474e-5,
            8.221052379811899e-5,
            4.180141121853848e-5,
            9.061845578413501e-5,
            7.16941797695604e-5,
            4.0333378785804157e-5,
            0.00010235168248205017,
            3.577288625691616e-5,
            5.3349579721658665e-5,
            2.4386170527727782e-5,
            5.006913515719362e-5,
            9.86340097408057e-5,
            5.8990745334349316e-5,
            7.895022064444856e-5,
            8.316699011537633e-5,
            9.81382090917641e-5,
            0.00021238570551370631,
            0.0001092827462221071,
            9.467891487268938e-5,
            0.00010738751789192052,
            5.8205601655914464e-5,
            0.00013037753083818294,
            4.553722408053925e-5,
            9.43785888456824e-5,
            7.593035110897395e-5,
            4.1820524433053004e-5,
            9.137158847244043e-5,
            7.146966775177475e-5,
            5.897375620435689e-5,
            5.412031512426017e-5,
            7.439542171759217e-5,
            9.268660405010528e-5,
            5.098773954894069e-5,
            8.575863393151433e-5,
            7.168711833332287e-5,
            0.0001409981347149279,
            0.0001092827462221071,
            0.00025823529154065923,
            0.00011946341336320619,
            0.00015356467075259634,
            6.709360125798358e-5,
            0.0001171613078796223,
            3.8649524901547367e-5,
            9.450882779280298e-5,
            7.616082700539134e-5,
            3.9012597588200026e-5,
            0.00013809589515048954,
            5.834064801767748e-5,
            5.2489468486364894e-5,
            4.334793447131401e-5,
            5.6447400554301286e-5,
            0.00010177389860054412,
            5.4273521739127156e-5,
            8.136417816281465e-5,
            8.811773967228358e-5,
            0.0001183744979667438,
            9.467891487268938e-5,
            0.00011946341336320619,
            0.0004023968410849222,
            0.00013275341743457014,
            6.515187350430283e-5,
            0.00020098628348854427,
            3.465209514437387e-5,
            9.791260385240117e-5,
            8.161647003051078e-5,
            2.8565963862493822e-5,
            0.00011099528602700082,
            0.00010055959795169835,
            5.634721671705775e-5,
            9.649070385541043e-5,
            7.796568763484897e-5,
            0.00010104263576704765,
            5.2255319236538084e-5,
            8.451663878170168e-5,
            6.918507322367079e-5,
            0.0001586758992786446,
            0.00010738751789192052,
            0.00015356467075259634,
            0.00013275341743457014,
            0.00033243539131937725,
            5.163208339787523e-5,
            0.00012085610879066828,
            3.6811986969726856e-5,
            8.81745298633766e-5,
            6.596514441146535e-5,
            3.7301374373786855e-5,
            0.00011927547291571292,
            1.931388157568224e-5,
            5.122281788898874e-5,
            7.76034105652646e-5,
            5.710923050847867e-5,
            0.0001045941629917129,
            4.6450250534711396e-5,
            7.52482976632864e-5,
            0.00010000501192462883,
            6.206323278477474e-5,
            5.8205601655914464e-5,
            6.709360125798358e-5,
            6.515187350430283e-5,
            5.163208339787523e-5,
            0.00017982312840586208,
            9.461690755839191e-5,
            3.8304499658411927e-5,
            9.970680675008901e-5,
            8.690033627055448e-5,
            5.284509475260808e-5,
            0.00010683432082071662,
            0.00011530593789620128,
            6.954699046902326e-5,
            0.00010079397469931296,
            4.768201667335564e-5,
            6.474410050350278e-5,
            5.6225536255946845e-5,
            9.138217657271527e-5,
            6.14784973468696e-5,
            8.221052379811899e-5,
            0.00013037753083818294,
            0.0001171613078796223,
            0.00020098628348854427,
            0.00012085610879066828,
            9.461690755839191e-5,
            0.001656009270026861,
            4.5172917937773394e-5,
            0.00016788785912719481,
            0.00013872647285070275,
            6.452640059068012e-5,
            0.00010578937340160141,
            0.00014008661020530516,
            8.97237313528689e-5,
            0.00024120063369514552,
            0.0001201078441426298,
            0.00013072377609027564,
            7.4194102236463e-5,
            0.00012607442804400053,
            5.349244378993936e-5,
            4.180141121853848e-5,
            4.553722408053925e-5,
            3.8649524901547367e-5,
            3.465209514437387e-5,
            3.6811986969726856e-5,
            3.8304499658411927e-5,
            4.5172917937773394e-5,
            0.00016428442428598636,
            4.1386230110354375e-5,
            4.986632393706567e-5,
            4.246053780396829e-5,
            6.411503468541953e-5,
            0.00011189370101200155,
            3.453074833884595e-5,
            2.0812073379965922e-5,
            5.7822834332716233e-5,
            4.6051585562719986e-5,
            4.456281224956245e-5,
            4.726854028649628e-5,
            4.882756160737811e-5,
            9.061845578413501e-5,
            9.43785888456824e-5,
            9.450882779280298e-5,
            9.791260385240117e-5,
            8.81745298633766e-5,
            9.970680675008901e-5,
            0.00016788785912719481,
            4.1386230110354375e-5,
            0.00027709107309086586,
            0.00012597278362232758,
            4.674134712720021e-5,
            0.00014184019014257634,
            0.0001486091784419933,
            9.148053588429555e-5,
            0.00013547759552395513,
            0.00011857564669714972,
            0.0001099531813248836,
            7.763269635570395e-5,
            0.00020166199612891875,
            7.792037391899794e-5,
            7.16941797695604e-5,
            7.593035110897395e-5,
            7.616082700539134e-5,
            8.161647003051078e-5,
            6.596514441146535e-5,
            8.690033627055448e-5,
            0.00013872647285070275,
            4.986632393706567e-5,
            0.00012597278362232758,
            0.0002443271346083394,
            4.7689784479700916e-5,
            0.00012831169559255468,
            0.00014591722475786552,
            6.569388485442218e-5,
            0.00010417883673125215,
            0.00010017245414535987,
            7.695493012315975e-5,
            6.0264602540594754e-5,
            0.00010828827403898742,
            6.996444548716584e-5,
            4.0333378785804157e-5,
            4.1820524433053004e-5,
            3.9012597588200026e-5,
            2.8565963862493822e-5,
            3.7301374373786855e-5,
            5.284509475260808e-5,
            6.452640059068012e-5,
            4.246053780396829e-5,
            4.674134712720021e-5,
            4.7689784479700916e-5,
            0.00010581302197047126,
            4.88844878557855e-5,
            5.8929720942704764e-5,
            4.859859735422689e-5,
            6.26234712004845e-5,
            4.033425546120333e-5,
            4.2677728360559763e-5,
            3.731203139482993e-5,
            5.145110569535477e-5,
            3.6107394497313565e-5,
            0.00010235168248205017,
            9.137158847244043e-5,
            0.00013809589515048954,
            0.00011099528602700082,
            0.00011927547291571292,
            0.00010683432082071662,
            0.00010578937340160141,
            6.411503468541953e-5,
            0.00014184019014257634,
            0.00012831169559255468,
            4.88844878557855e-5,
            0.0007098841837216566,
            0.00023053636837979928,
            7.573628036970877e-5,
            0.0001306535362689841,
            0.0001377049986292533,
            9.302601690346542e-5,
            6.833063721308161e-5,
            0.00012191655914914062,
            0.0001082325695844483,
            3.577288625691616e-5,
            7.146966775177475e-5,
            5.834064801767748e-5,
            0.00010055959795169835,
            1.931388157568224e-5,
            0.00011530593789620128,
            0.00014008661020530516,
            0.00011189370101200155,
            0.0001486091784419933,
            0.00014591722475786552,
            5.892972094270476e-5,
            0.00023053636837979928,
            0.0019532427938011103,
            7.836227649971985e-5,
            0.00022199457889378788,
            0.00023427920273247352,
            5.96011091191255e-5,
            5.586765985357861e-5,
            0.0001002608314292949,
            9.480136055673367e-5,
            5.3349579721658665e-5,
            5.897375620435689e-5,
            5.2489468486364894e-5,
            5.634721671705775e-5,
            5.122281788898874e-5,
            6.954699046902326e-5,
            8.97237313528689e-5,
            3.453074833884595e-5,
            9.148053588429555e-5,
            6.569388485442218e-5,
            4.859859735422689e-5,
            7.573628036970877e-5,
            7.836227649971985e-5,
            0.0001442108613733374,
            0.00015485376990305067,
            4.729322608478776e-5,
            6.449864086350313e-5,
            5.130374577267955e-5,
            8.78490652070614e-5,
            4.01619890036788e-5,
            2.4386170527727782e-5,
            5.412031512426017e-5,
            4.334793447131401e-5,
            9.649070385541043e-5,
            7.76034105652646e-5,
            0.00010079397469931296,
            0.00024120063369514552,
            2.0812073379965922e-5,
            0.00013547759552395513,
            0.00010417883673125215,
            6.26234712004845e-5,
            0.0001306535362689841,
            0.00022199457889378788,
            0.00015485376990305067,
            0.0009982976126975815,
            0.00011464136346664186,
            6.704645005033517e-5,
            3.7597519010038085e-5,
            0.00011645959143481226,
            3.5098331927739175e-5,
            5.006913515719362e-5,
            7.439542171759217e-5,
            5.6447400554301286e-5,
            7.796568763484897e-5,
            5.710923050847867e-5,
            4.768201667335564e-5,
            0.0001201078441426298,
            5.7822834332716233e-5,
            0.00011857564669714972,
            0.00010017245414535987,
            4.033425546120333e-5,
            0.0001377049986292533,
            0.00023427920273247352,
            4.729322608478776e-5,
            0.00011464136346664186,
            0.0005077968112396221,
            7.485162008126999e-5,
            4.9333995231181114e-5,
            9.264001679880925e-5,
            7.646390044515899e-5,
            9.86340097408057e-5,
            9.268660405010528e-5,
            0.00010177389860054412,
            0.00010104263576704765,
            0.0001045941629917129,
            6.474410050350278e-5,
            0.00013072377609027564,
            4.6051585562719986e-5,
            0.0001099531813248836,
            7.695493012315975e-5,
            4.2677728360559763e-5,
            9.302601690346542e-5,
            5.96011091191255e-5,
            6.449864086350313e-5,
            6.704645005033517e-5,
            7.485162008126999e-5,
            0.0001630227024004303,
            6.133877070309118e-5,
            9.848243454745864e-5,
            7.744292605807695e-5,
            5.8990745334349316e-5,
            5.098773954894069e-5,
            5.4273521739127156e-5,
            5.2255319236538084e-5,
            4.6450250534711396e-5,
            5.6225536255946845e-5,
            7.4194102236463e-5,
            4.456281224956245e-5,
            7.763269635570395e-5,
            6.0264602540594754e-5,
            3.731203139482993e-5,
            6.833063721308161e-5,
            5.586765985357861e-5,
            5.130374577267955e-5,
            3.7597519010038085e-5,
            4.933399523118111e-5,
            6.133877070309118e-5,
            0.00012253876865855981,
            7.243102308925226e-5,
            4.460454017572025e-5,
            7.895022064444856e-5,
            8.575863393151433e-5,
            8.136417816281465e-5,
            8.451663878170168e-5,
            7.52482976632864e-5,
            9.138217657271527e-5,
            0.00012607442804400053,
            4.726854028649628e-5,
            0.00020166199612891875,
            0.00010828827403898742,
            5.145110569535477e-5,
            0.00012191655914914062,
            0.0001002608314292949,
            8.78490652070614e-5,
            0.00011645959143481226,
            9.264001679880925e-5,
            9.848243454745864e-5,
            7.243102308925226e-5,
            0.00018544095631623598,
            7.094406938535761e-5,
            8.316699011537633e-5,
            7.168711833332287e-5,
            8.811773967228358e-5,
            6.918507322367079e-5,
            0.00010000501192462883,
            6.14784973468696e-5,
            5.349244378993936e-5,
            4.882756160737811e-5,
            7.792037391899794e-5,
            6.996444548716584e-5,
            3.6107394497313565e-5,
            0.0001082325695844483,
            9.480136055673367e-5,
            4.01619890036788e-5,
            3.5098331927739175e-5,
            7.646390044515899e-5,
            7.744292605807695e-5,
            4.460454017572025e-5,
            7.094406938535761e-5,
            0.00015852976902333473,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.14061451624865748,
        -0.11840330684435339,
        -0.06792019283559661,
        -0.027421669427723117,
        -0.02175436069819982,
        -0.07852336093259579,
        -0.0076465412964296705,
        0.018195313127833887,
        -0.09104101668396171,
        0.0016402371861670075,
        0.1802006728823672,
        0.001722053667596852,
        0.0007110230228704811,
        0.16638637640121084,
        0.014727991413784896,
        0.0444722496665329,
        0.21805318021518574,
        0.35615305425492605,
        0.21318569817008887,
        0.337877114958953,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest = 13.395044420416847, 0.009359958547042654, 1431.092431462434
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        absolute_views = Dict("GE" => 0.5, "SBUX" => -0.3, "BBY" => 1.3, "BAC" => -2.3),
    )
    testpost_ret = [
        -0.24902795177862921,
        -0.226485871857524,
        -0.24690838012995656,
        -0.21751909621324947,
        -0.2633715369189125,
        0.02635258456800862,
        -0.39789169718966994,
        -0.03252300599850995,
        -0.9386532506741548,
        -0.2590027952065602,
        -0.04312069116832892,
        -0.2435637339728942,
        -0.07284807297148128,
        -0.20930470344405785,
        -0.21965804550636905,
        0.39526039220343256,
        -0.28889656871255065,
        -0.17571161487636688,
        -0.6325106384194501,
        -0.19222877819048353,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.0002117262091603301,
            9.868798620581754e-5,
            0.00014181108610847133,
            0.00011907434779793545,
            0.00015960785644690163,
            6.221359988201259e-5,
            8.265073513019273e-5,
            4.199817033532118e-5,
            9.088119076503226e-5,
            7.197905540189056e-5,
            4.052033854578172e-5,
            0.00010280521031330452,
            3.5680004288589846e-5,
            5.3586708654750825e-5,
            2.4388331262088843e-5,
            5.0163410168042564e-5,
            9.914639274226669e-5,
            5.927708286624268e-5,
            7.922215077792584e-5,
            8.34186439341572e-5,
            9.868798620581754e-5,
            0.00021331770959079232,
            0.00010989210212110302,
            9.521649949253193e-5,
            0.00010800250103910958,
            5.8354398952980146e-5,
            0.00013110593298903877,
            4.5761424244620775e-5,
            9.46587184835309e-5,
            7.624416266782345e-5,
            4.202394601429286e-5,
            9.174481347530968e-5,
            7.16168761327395e-5,
            5.925182103237739e-5,
            5.431477789717816e-5,
            7.45446329428871e-5,
            9.315438740666597e-5,
            5.122873472045819e-5,
            8.60633239744851e-5,
            7.189392173798818e-5,
            0.00014181108610847133,
            0.00010989210212110302,
            0.00025942092539896113,
            0.00012017579537095614,
            0.00015448172391195847,
            6.725546771481301e-5,
            0.00011780847045250544,
            3.881995078393798e-5,
            9.478391975753197e-5,
            7.646599634905629e-5,
            3.918503631574837e-5,
            0.00013875355531634966,
            5.8376136325777576e-5,
            5.271759577328483e-5,
            4.345305752707925e-5,
            5.655858717165653e-5,
            0.00010229892054327542,
            5.452641810712433e-5,
            8.16388922282553e-5,
            8.838196970692474e-5,
            0.00011907434779793545,
            9.521649949253193e-5,
            0.00012017579537095614,
            0.0004042947293793812,
            0.0001335724896717984,
            6.532053238681286e-5,
            0.0002022218675817821,
            3.480055939652311e-5,
            9.821670837570248e-5,
            8.196983495957213e-5,
            2.8679153791931458e-5,
            0.00011150782442190892,
            0.00010089110974239857,
            5.661079485069366e-5,
            9.696285006093409e-5,
            7.81367158960604e-5,
            0.00010158027276610887,
            5.2500361718999834e-5,
            8.481484322263105e-5,
            6.939960519078834e-5,
            0.00015960785644690163,
            0.00010800250103910958,
            0.00015448172391195847,
            0.0001335724896717984,
            0.0003340051406594137,
            5.176450057566398e-5,
            0.00012156775945042876,
            3.6963556358375946e-5,
            8.843797710505525e-5,
            6.622152733249522e-5,
            3.747164878043194e-5,
            0.00011983235873673495,
            1.9103179141078175e-5,
            5.146344474789565e-5,
            7.794687920048554e-5,
            5.721240768959523e-5,
            0.00010515066463395273,
            4.666542730654332e-5,
            7.550780094360795e-5,
            0.00010030190115955434,
            6.221359988201259e-5,
            5.8354398952980146e-5,
            6.725546771481301e-5,
            6.532053238681286e-5,
            5.176450057566398e-5,
            0.00017991415662500757,
            9.48800781417723e-5,
            3.841359704396717e-5,
            9.98535233330562e-5,
            8.70975758661137e-5,
            5.298518960866456e-5,
            0.00010708042034505062,
            0.00011556709394183916,
            6.972670107273104e-5,
            0.0001010752478724342,
            4.7756204481175077e-5,
            6.489742020442034e-5,
            5.636538274389259e-5,
            9.154604031234434e-5,
            6.154580305270515e-5,
            8.265073513019273e-5,
            0.00013110593298903877,
            0.00011780847045250544,
            0.0002022218675817821,
            0.00012156775945042876,
            9.48800781417723e-5,
            0.0016639638990577216,
            4.5383661592363666e-5,
            0.00016840617004946598,
            0.00013938517331590412,
            6.485812530556023e-5,
            0.00010617675744416846,
            0.00014060859592513188,
            9.017424448983094e-5,
            0.00024260743978030954,
            0.00012040120907896603,
            0.0001314054015318972,
            7.45390829354736e-5,
            0.00012651401409744645,
            5.36423819457226e-5,
            4.199817033532118e-5,
            4.5761424244620775e-5,
            3.881995078393798e-5,
            3.480055939652311e-5,
            3.6963556358375946e-5,
            3.841359704396717e-5,
            4.5383661592363666e-5,
            0.00016504592784759523,
            4.1507109222926616e-5,
            5.0090717941238737e-5,
            4.270132485292635e-5,
            6.439171371078587e-5,
            0.00011247502699568089,
            3.4703329208849515e-5,
            2.085911948697953e-5,
            5.796028777400753e-5,
            4.626422878171604e-5,
            4.480349570812279e-5,
            4.745012359412684e-5,
            4.8959621268560993e-5,
            9.088119076503226e-5,
            9.46587184835309e-5,
            9.478391975753197e-5,
            9.821670837570248e-5,
            8.843797710505525e-5,
            9.98535233330562e-5,
            0.00016840617004946598,
            4.1507109222926616e-5,
            0.0002774484803659154,
            0.00012629891521181384,
            4.687893642744835e-5,
            0.00014220093455948803,
            0.00014890443904119004,
            9.17530800563191e-5,
            0.00013588132937723555,
            0.00011870073220506315,
            0.00011025811460681009,
            7.785332467523791e-5,
            0.0002020476404997306,
            7.803840648748022e-5,
            7.197905540189056e-5,
            7.624416266782345e-5,
            7.646599634905629e-5,
            8.196983495957213e-5,
            6.622152733249522e-5,
            8.70975758661137e-5,
            0.00013938517331590412,
            5.0090717941238737e-5,
            0.00012629891521181384,
            0.0002452481793996097,
            4.78921801746984e-5,
            0.0001288228237155758,
            0.00014649467878909294,
            6.59603410360946e-5,
            0.0001046226343490784,
            0.00010037010106517865,
            7.724464277561123e-5,
            6.050788275676239e-5,
            0.00010862215517437584,
            7.011730060911553e-5,
            4.052033854578172e-5,
            4.202394601429286e-5,
            3.918503631574837e-5,
            2.8679153791931458e-5,
            3.747164878043194e-5,
            5.298518960866456e-5,
            6.485812530556023e-5,
            4.270132485292635e-5,
            4.687893642744835e-5,
            4.78921801746984e-5,
            0.00010628250802898955,
            4.9060003904428147e-5,
            5.915273627825594e-5,
            4.885065831056238e-5,
            6.294699160629315e-5,
            4.042538504033535e-5,
            4.287254099329978e-5,
            3.749860246565515e-5,
            5.1645718243339706e-5,
            3.6199288218760466e-5,
            0.00010280521031330452,
            9.174481347530968e-5,
            0.00013875355531634966,
            0.00011150782442190892,
            0.00011983235873673495,
            0.00010708042034505062,
            0.00010617675744416846,
            6.439171371078587e-5,
            0.00014220093455948803,
            0.0001288228237155758,
            4.9060003904428147e-5,
            0.0007129230956935895,
            0.00023158522776928542,
            7.602862367053432e-5,
            0.000131221782539635,
            0.00013798907889507397,
            9.336777298097818e-5,
            6.858724717859632e-5,
            0.00012227559543379716,
            0.00010849636115195021,
            3.5680004288589846e-5,
            7.16168761327395e-5,
            5.8376136325777576e-5,
            0.00010089110974239857,
            1.9103179141078175e-5,
            0.00011556709394183916,
            0.00014060859592513188,
            0.00011247502699568089,
            0.00014890443904119004,
            0.00014649467878909294,
            5.915273627825594e-5,
            0.00023158522776928542,
            0.0019623055170575185,
            7.864356799451293e-5,
            0.00022314880090851317,
            0.00023482005287588068,
            5.964138560132656e-5,
            5.6003452009711425e-5,
            0.00010043874795679638,
            9.496428977587908e-5,
            5.3586708654750825e-5,
            5.925182103237739e-5,
            5.271759577328483e-5,
            5.661079485069366e-5,
            5.146344474789565e-5,
            6.972670107273104e-5,
            9.017424448983094e-5,
            3.4703329208849515e-5,
            9.17530800563191e-5,
            6.59603410360946e-5,
            4.885065831056238e-5,
            7.602862367053432e-5,
            7.864356799451293e-5,
            0.00014482048433941435,
            0.0001557201551395429,
            4.7400453839232024e-5,
            6.478837347977168e-5,
            5.154285658382895e-5,
            8.816953983112476e-5,
            4.025991596761368e-5,
            2.4388331262088843e-5,
            5.431477789717816e-5,
            4.345305752707925e-5,
            9.696285006093409e-5,
            7.794687920048554e-5,
            0.0001010752478724342,
            0.00024260743978030954,
            2.085911948697953e-5,
            0.00013588132937723555,
            0.0001046226343490784,
            6.294699160629315e-5,
            0.000131221782539635,
            0.00022314880090851317,
            0.0001557201551395429,
            0.0010030721319082526,
            0.00011490832909873643,
            6.729698026760826e-5,
            3.770251635040856e-5,
            0.0001168729259321019,
            3.514622785755221e-5,
            5.0163410168042564e-5,
            7.45446329428871e-5,
            5.655858717165653e-5,
            7.81367158960604e-5,
            5.721240768959523e-5,
            4.7756204481175077e-5,
            0.00012040120907896603,
            5.796028777400753e-5,
            0.00011870073220506315,
            0.00010037010106517865,
            4.042538504033535e-5,
            0.00013798907889507397,
            0.00023482005287588068,
            4.7400453839232024e-5,
            0.00011490832909873643,
            0.0005078872627942916,
            7.498669399431494e-5,
            4.9433153388070616e-5,
            9.2770566384226e-5,
            7.652703852401195e-5,
            9.914639274226669e-5,
            9.315438740666597e-5,
            0.00010229892054327542,
            0.00010158027276610887,
            0.00010515066463395273,
            6.489742020442034e-5,
            0.0001314054015318972,
            4.626422878171604e-5,
            0.00011025811460681009,
            7.724464277561123e-5,
            4.287254099329978e-5,
            9.336777298097818e-5,
            5.964138560132656e-5,
            6.478837347977168e-5,
            6.729698026760826e-5,
            7.498669399431494e-5,
            0.00016366735191073646,
            6.162011388011723e-5,
            9.88120004439598e-5,
            7.764191062330671e-5,
            5.927708286624268e-5,
            5.122873472045819e-5,
            5.452641810712433e-5,
            5.2500361718999834e-5,
            4.666542730654332e-5,
            5.636538274389259e-5,
            7.45390829354736e-5,
            4.480349570812279e-5,
            7.785332467523791e-5,
            6.050788275676239e-5,
            3.749860246565515e-5,
            6.858724717859632e-5,
            5.6003452009711425e-5,
            5.154285658382895e-5,
            3.770251635040856e-5,
            4.9433153388070616e-5,
            6.162011388011723e-5,
            0.0001230527775814757,
            7.268680030468411e-5,
            4.4719684437292144e-5,
            7.922215077792584e-5,
            8.60633239744851e-5,
            8.16388922282553e-5,
            8.481484322263105e-5,
            7.550780094360795e-5,
            9.154604031234434e-5,
            0.00012651401409744645,
            4.745012359412684e-5,
            0.0002020476404997306,
            0.00010862215517437584,
            5.1645718243339706e-5,
            0.00012227559543379716,
            0.00010043874795679638,
            8.816953983112476e-5,
            0.0001168729259321019,
            9.2770566384226e-5,
            9.88120004439598e-5,
            7.268680030468411e-5,
            0.00018587242069290728,
            7.107155264694754e-5,
            8.34186439341572e-5,
            7.189392173798818e-5,
            8.838196970692474e-5,
            6.939960519078834e-5,
            0.00010030190115955434,
            6.154580305270515e-5,
            5.36423819457226e-5,
            4.8959621268560993e-5,
            7.803840648748022e-5,
            7.011730060911553e-5,
            3.6199288218760466e-5,
            0.00010849636115195021,
            9.496428977587908e-5,
            4.025991596761368e-5,
            3.514622785755221e-5,
            7.652703852401195e-5,
            7.764191062330671e-5,
            4.4719684437292144e-5,
            7.107155264694754e-5,
            0.00015862574629226677,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        -0.0003364720609681425,
        -0.0004698620018939448,
        -0.00022613763794583847,
        -0.00022917583603375413,
        -0.0003252038413383212,
        -2.255477335316608,
        -4.236586273214559e-6,
        -0.00028410845084264624,
        4.203065034936713,
        -3.968897104415702e-5,
        -0.00034844932432627934,
        -3.6257281686793797e-6,
        1.0513948763229373e-5,
        -0.0002737042263158898,
        -1.2490798124422643e-6,
        -1.5264380590140003,
        -0.00012002326142184375,
        -0.00031037585412677424,
        -7.737221700459491e-5,
        0.5818895305226485,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest = -4.719241132023135, 0.06363478842256727, -74.16257418232372
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        omega = :idzorek,
        view_confidence = [0, 1, 0.5],
    )
    testpost_ret = [
        0.0005953815076515229,
        0.0004118999372314571,
        0.00019855611082612604,
        0.00047087253266720245,
        0.0005129203055053204,
        0.0002162482961056503,
        0.00043998592679718435,
        0.0002205767530939013,
        0.0005896265912334741,
        0.00035083353920025524,
        0.0001515876757226251,
        0.0003782081149069817,
        0.00027512418795420246,
        0.00029152846898286854,
        0.00028708946061170733,
        0.00033820403235557166,
        0.0003982083950311105,
        0.0002827549461371114,
        0.0004952872615204907,
        0.00030968011156945236,
    ]
    @test bl.post_ret ≈ testpost_ret
    testpost_cov = reshape(
        [
            0.00021178329111024642,
            9.901823957692989e-5,
            0.00014258121245794663,
            0.00011936939552118308,
            0.00015992392845977168,
            6.268766026880681e-5,
            8.313085969362381e-5,
            4.2180692523925534e-5,
            9.132484212573405e-5,
            7.233999608112355e-5,
            4.073539719804374e-5,
            0.00010340339040136938,
            3.6248859653221007e-5,
            5.3819494825277054e-5,
            2.4762519403963742e-5,
            5.054748715241863e-5,
            9.947274493375753e-5,
            5.947823373230083e-5,
            7.959295078929644e-5,
            8.390808435332844e-5,
            9.901823957692989e-5,
            0.0002135847752940896,
            0.00011013168687801956,
            9.549254775402597e-5,
            0.00010830909301237456,
            5.8788621858651155e-5,
            0.00013143857025927014,
            4.595126160765647e-5,
            9.506980118673777e-5,
            7.657666391313141e-5,
            4.224428299391681e-5,
            9.217214392272129e-5,
            7.210576141913135e-5,
            5.947981779215303e-5,
            5.4617453035966606e-5,
            7.499822760525223e-5,
            9.344862105085624e-5,
            5.1440778206769955e-5,
            8.640583196246177e-5,
            7.2310976368601e-5,
            0.00014258121245794663,
            0.00011013168687801956,
            0.00025904891152046106,
            0.00012048089403651633,
            0.00015487049861529983,
            6.771038306212006e-5,
            0.00011796636846683768,
            3.904736601731595e-5,
            9.52207658518433e-5,
            7.680754611412827e-5,
            3.942611884713862e-5,
            0.00013902953942463328,
            5.875788865448849e-5,
            5.2975444335379234e-5,
            4.366180106241075e-5,
            5.6919341316516854e-5,
            0.00010261608610113804,
            5.478992816897522e-5,
            8.201288553283765e-5,
            8.885269139096963e-5,
            0.00011936939552118308,
            9.549254775402597e-5,
            0.00012048089403651633,
            0.0004045757893607328,
            0.00013387378641572018,
            6.579337418826918e-5,
            0.0002025868943397762,
            3.499279095418927e-5,
            9.863282332764634e-5,
            8.231453486859548e-5,
            2.891156248844045e-5,
            0.00011196429077486432,
            0.00010141101172507249,
            5.684809717456752e-5,
            9.72945507061646e-5,
            7.860569547980764e-5,
            0.00010187901851877394,
            5.271617241061997e-5,
            8.516269757248484e-5,
            6.98125866562685e-5,
            0.00015992392845977168,
            0.00010830909301237456,
            0.00015487049861529983,
            0.00013387378641572018,
            0.00033437301319162765,
            5.218762414847168e-5,
            0.00012191175480307581,
            3.7171637105339704e-5,
            8.884813896424812e-5,
            6.656788629349552e-5,
            3.769465197400353e-5,
            0.00012032441382772619,
            1.9605677137803002e-5,
            5.1690093290128445e-5,
            7.823063963414964e-5,
            5.76137596529515e-5,
            0.00010547982147963835,
            4.688280902120455e-5,
            7.585738047186003e-5,
            0.00010084315263867722,
            6.268766026880681e-5,
            5.8788621858651155e-5,
            6.771038306212006e-5,
            6.579337418826918e-5,
            5.218762414847168e-5,
            0.00018086478540232988,
            9.554311913644233e-5,
            3.8673527129775994e-5,
            0.00010071842776801842,
            8.769896255376908e-5,
            5.328326700388015e-5,
            0.0001078158334478308,
            0.00011633868331658036,
            7.017978114090823e-5,
            0.00010171423797720604,
            4.822117117458911e-5,
            6.53879823807174e-5,
            5.6748984652696624e-5,
            9.227543422287557e-5,
            6.204495613043998e-5,
            8.313085969362381e-5,
            0.00013143857025927014,
            0.00011796636846683768,
            0.0002025868943397762,
            0.00012191175480307581,
            9.554311913644233e-5,
            0.0016644687376602633,
            4.562301011032782e-5,
            0.00016906334334072207,
            0.00013985789435108919,
            6.51796593095248e-5,
            0.00010670763750677645,
            0.00014129533735390595,
            9.05220545537895e-5,
            0.0002431039789726735,
            0.0001210769032527232,
            0.00013178561975589,
            7.484513747887581e-5,
            0.0001270367919382931,
            5.4029720204023434e-5,
            4.2180692523925534e-5,
            4.595126160765647e-5,
            3.904736601731595e-5,
            3.499279095418927e-5,
            3.7171637105339704e-5,
            3.8673527129775994e-5,
            4.562301011032782e-5,
            0.00016516976454270075,
            4.180166648573691e-5,
            5.031818629469756e-5,
            4.281914388233502e-5,
            6.470552425963851e-5,
            0.00011281945560425862,
            3.484985789363424e-5,
            2.106635621062972e-5,
            5.832781040362128e-5,
            4.646890813467998e-5,
            4.4941442676601886e-5,
            4.769749124611086e-5,
            4.9252470632508336e-5,
            9.132484212573405e-5,
            9.506980118673777e-5,
            9.52207658518433e-5,
            9.863282332764634e-5,
            8.884813896424812e-5,
            0.00010071842776801842,
            0.00016906334334072207,
            4.180166648573691e-5,
            0.00027814998324521647,
            0.00012685405910011144,
            4.736119564318926e-5,
            0.00014288394868049991,
            0.00014974835889196351,
            9.216941080919027e-5,
            0.0001364953545371525,
            0.00011932626224374216,
            0.00011070400479426012,
            7.820741922822376e-5,
            0.00020259427469348113,
            7.853628760346655e-5,
            7.233999608112355e-5,
            7.657666391313141e-5,
            7.680754611412827e-5,
            8.231453486859548e-5,
            6.656788629349552e-5,
            8.769896255376908e-5,
            0.00013985789435108919,
            5.031818629469756e-5,
            0.00012685405910011144,
            0.00024568095619342616,
            4.817437401279643e-5,
            0.00012937560200766408,
            0.0001471415936782166,
            6.626464171138771e-5,
            0.00010506149951081578,
            0.00010096694835984674,
            7.760811464126704e-5,
            6.0778721970052725e-5,
            0.00010907862903611104,
            7.05667984174132e-5,
            4.073539719804374e-5,
            4.224428299391681e-5,
            3.942611884713862e-5,
            2.891156248844045e-5,
            3.769465197400353e-5,
            5.328326700388015e-5,
            6.51796593095248e-5,
            4.281914388233502e-5,
            4.736119564318926e-5,
            4.817437401279643e-5,
            0.00010637658451480605,
            4.941598946652513e-5,
            5.951863246600621e-5,
            4.904429781183042e-5,
            6.322383854017388e-5,
            4.076673278586627e-5,
            4.3121110994649835e-5,
            3.767129379065968e-5,
            5.203203831508571e-5,
            3.646658561485709e-5,
            0.00010340339040136938,
            9.217214392272129e-5,
            0.00013902953942463328,
            0.00011196429077486432,
            0.00012032441382772619,
            0.0001078158334478308,
            0.00010670763750677645,
            6.470552425963851e-5,
            0.00014288394868049991,
            0.00012937560200766408,
            4.941598946652513e-5,
            0.0007136012716778458,
            0.00023239616689700807,
            7.641141139858063e-5,
            0.00013172839546518058,
            0.00013880542720369395,
            9.384694356847736e-5,
            6.894394765996968e-5,
            0.0001228489141208791,
            0.00010914682739474111,
            3.6248859653221007e-5,
            7.210576141913135e-5,
            5.875788865448849e-5,
            0.00010141101172507249,
            1.9605677137803002e-5,
            0.00011633868331658036,
            0.00014129533735390595,
            0.00011281945560425862,
            0.00014974835889196351,
            0.0001471415936782166,
            5.951863246600621e-5,
            0.00023239616689700807,
            0.001963339237733695,
            7.907272075548746e-5,
            0.00022379875403523363,
            0.0002361292820950977,
            6.017901702760869e-5,
            5.639896296262716e-5,
            0.00010113022706042561,
            9.560763498736539e-5,
            5.3819494825277054e-5,
            5.947981779215303e-5,
            5.2975444335379234e-5,
            5.684809717456752e-5,
            5.1690093290128445e-5,
            7.017978114090823e-5,
            9.05220545537895e-5,
            3.484985789363424e-5,
            9.216941080919027e-5,
            6.626464171138771e-5,
            4.904429781183042e-5,
            7.641141139858063e-5,
            7.907272075548746e-5,
            0.00014504383473771997,
            0.00015604349036675192,
            4.7714891327034544e-5,
            6.503927732393446e-5,
            5.1734542551195576e-5,
            8.850915659356672e-5,
            4.053926324999863e-5,
            2.4762519403963742e-5,
            5.4617453035966606e-5,
            4.366180106241075e-5,
            9.72945507061646e-5,
            7.823063963414964e-5,
            0.00010171423797720604,
            0.0002431039789726735,
            2.106635621062972e-5,
            0.0001364953545371525,
            0.00010506149951081578,
            6.322383854017388e-5,
            0.00013172839546518058,
            0.00022379875403523363,
            0.00015604349036675192,
            0.0010035623760289057,
            0.0001155585031095594,
            6.763803710828807e-5,
            3.7979590036208115e-5,
            0.00011736535429092474,
            3.5454313238549136e-5,
            5.054748715241863e-5,
            7.499822760525223e-5,
            5.6919341316516854e-5,
            7.860569547980764e-5,
            5.76137596529515e-5,
            4.822117117458911e-5,
            0.0001210769032527232,
            5.832781040362128e-5,
            0.00011932626224374216,
            0.00010096694835984674,
            4.076673278586627e-5,
            0.00013880542720369395,
            0.0002361292820950977,
            4.7714891327034544e-5,
            0.0001155585031095594,
            0.0005103991070815506,
            7.544792854316079e-5,
            4.975069081540455e-5,
            9.327332707834713e-5,
            7.708841679533921e-5,
            9.947274493375753e-5,
            9.344862105085624e-5,
            0.00010261608610113804,
            0.00010187901851877394,
            0.00010547982147963835,
            6.53879823807174e-5,
            0.00013178561975589,
            4.646890813467998e-5,
            0.00011070400479426012,
            7.760811464126704e-5,
            4.3121110994649835e-5,
            9.384694356847736e-5,
            6.017901702760869e-5,
            6.503927732393446e-5,
            6.763803710828807e-5,
            7.544792854316079e-5,
            0.00016398730717602142,
            6.184968948021504e-5,
            9.918244784824293e-5,
            7.809331544735091e-5,
            5.947823373230083e-5,
            5.1440778206769955e-5,
            5.478992816897522e-5,
            5.271617241061997e-5,
            4.688280902120455e-5,
            5.6748984652696624e-5,
            7.484513747887581e-5,
            4.4941442676601886e-5,
            7.820741922822376e-5,
            6.0778721970052725e-5,
            3.767129379065968e-5,
            6.894394765996968e-5,
            5.639896296262716e-5,
            5.1734542551195576e-5,
            3.7979590036208115e-5,
            4.975069081540455e-5,
            6.184968948021504e-5,
            0.00012322101328574207,
            7.297830317972878e-5,
            4.500562767122397e-5,
            7.959295078929644e-5,
            8.640583196246177e-5,
            8.201288553283765e-5,
            8.516269757248484e-5,
            7.585738047186003e-5,
            9.227543422287557e-5,
            0.0001270367919382931,
            4.769749124611086e-5,
            0.00020259427469348113,
            0.00010907862903611104,
            5.203203831508571e-5,
            0.0001228489141208791,
            0.00010113022706042561,
            8.850915659356672e-5,
            0.00011736535429092474,
            9.327332707834713e-5,
            9.918244784824293e-5,
            7.297830317972878e-5,
            0.0001863113774617771,
            7.151473682728727e-5,
            8.390808435332844e-5,
            7.2310976368601e-5,
            8.885269139096963e-5,
            6.98125866562685e-5,
            0.00010084315263867722,
            6.204495613043998e-5,
            5.4029720204023434e-5,
            4.9252470632508336e-5,
            7.853628760346655e-5,
            7.05667984174132e-5,
            3.646658561485709e-5,
            0.00010914682739474111,
            9.560763498736539e-5,
            4.053926324999863e-5,
            3.5454313238549136e-5,
            7.708841679533921e-5,
            7.809331544735091e-5,
            4.500562767122397e-5,
            7.151473682728727e-5,
            0.00015945003781056325,
        ],
        20,
        :,
    )
    @test bl.post_cov ≈ testpost_cov
    testblweights = [
        0.6392650371508216,
        0.1363338874970492,
        -0.47601972876818643,
        0.06649704066490786,
        0.0943602669292048,
        -0.1455001065322027,
        0.0012292764130608768,
        0.08243613958577743,
        0.2011277727437913,
        0.01151604447982568,
        -0.07235091354933695,
        0.001052031477877397,
        -0.0030506989330207476,
        0.07941727794018245,
        0.0003624296196462661,
        0.010783598562740297,
        0.0348256248724685,
        0.09005781826955676,
        0.19590614013740415,
        0.05175106143843223,
    ]
    @test bl.weights ≈ testblweights
    mu, sigma, sr = portfolio_performance(bl)
    mutest, sigmatest, srtest =
        0.0006997303126077889, 0.013195239111246279, 0.047073445610677736
    @test mu ≈ mutest
    @test sigma ≈ sigmatest
    @test sr ≈ srtest

    @test_throws DomainError bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        omega = :idzorek,
        view_confidence = [0, 2, 0.5],
    )

    @test_throws DomainError bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        omega = :idzorek,
        view_confidence = [-eps(), 1, 0.5],
    )

    @test_throws ArgumentError bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = prior, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        omega = :wocao,
        view_confidence = [-eps(), 1, 0.5],
    )

    @test_throws ArgumentError bl = BlackLitterman(
        mcapsdf[!, 1],
        S;
        rf = 0,
        tau = 0.01,
        pi = :wocao, # either a vector, `nothing`, `:Equal`, or `:market`
        Q = views,
        P = picking,
        omega = :idzorek,
        view_confidence = [-eps(), 1, 0.5],
    )
end
