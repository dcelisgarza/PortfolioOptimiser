using Test
using PortfolioOptimiser

@testset "Critical Line Optimiser" begin
    tickers = ["AAPL", "GOOG", "AMD", "MSFT"]

    n = length(tickers)

    mean_ret = [0.00016267415798468016,
                -4.315482219139839e-6,
                0.0004012244571798837,
                -3.379769447160064e-5]
    cov_mtx = reshape([0.02616196734066198
                       0.00045493181653609557
                       -0.00027281056348097066
                       0.0006531571224469545
                       0.00045493181653609557
                       0.025847485395596045
                       0.0007385818838701795
                       -0.000751222313958196
                       -0.00027281056348097066
                       0.0007385818838701795
                       0.025307450453724196
                       -0.0005531333990346717
                       0.0006531571224469545
                       -0.000751222313958196
                       -0.0005531333990346717
                       0.026249042420138577],
                      n,
                      n)

    cla = CriticalLine(tickers, mean_ret, cov_mtx)
    max_sharpe!(cla)
    @test cla.w ≈ [[0.0, 0.0, 1.0, 0.0],
                   [1.11022302e-16, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                   [0.29966852, 0.0, 0.70033148, 0.0],
                   [0.30109151, 0.013462, 0.68544649, 0.0],
                   [0.24057164, 0.24734146, 0.25785421, 0.25423269]]
    @test all(sum.(cla.w) .≈ 1)
    @test cla.weights ≈ [0.28619054, 0.0, 0.71380946, 0.0]
    @test sum(cla.weights) == 1
    mu, sigma, sr = portfolio_performance(cla; verbose = true)
    @test mu ≈ port_return(cla.weights, cla.mean_ret)
    @test sigma ≈ sqrt(port_variance(cla.weights, cla.cov_mtx))
    @test sr ≈ (mu - (1.02^(1 / 252) - 1)) / sigma

    min_risk!(cla)
    @test cla.weights ≈ [0.24057164, 0.24734146, 0.25785421, 0.25423269]
    @test sum(cla.weights) == 1

    efficient_frontier!(cla, 150)
    @test cla.frontier_values[1].mu ≈ [0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0004012244571798837,
                                       0.0003987594221518059,
                                       0.00039629438712372815,
                                       0.0003938293520956503,
                                       0.00039136431706757256,
                                       0.00038889928203949485,
                                       0.000386434247011417,
                                       0.0003839692119833392,
                                       0.0003815041769552615,
                                       0.0003790391419271837,
                                       0.0003765741068991059,
                                       0.00037410907187102814,
                                       0.0003716440368429504,
                                       0.00036917900181487255,
                                       0.0003667139667867948,
                                       0.00036424893175871707,
                                       0.00036178389673063925,
                                       0.0003593188617025615,
                                       0.00035685382667448366,
                                       0.0003543887916464059,
                                       0.00035192375661832813,
                                       0.0003494587215902504,
                                       0.0003469936865621726,
                                       0.0003445286515340948,
                                       0.000342063616506017,
                                       0.0003395985814779392,
                                       0.0003371335464498615,
                                       0.0003346685114217837,
                                       0.0003322034763937059,
                                       0.0003297384413656281,
                                       0.00032953848165209157,
                                       0.00032933852193855497,
                                       0.00032913856222501836,
                                       0.00032893860251148176,
                                       0.00032873864279794516,
                                       0.00032853868308440866,
                                       0.00032833872337087206,
                                       0.0003281387636573355,
                                       0.0003279388039437989,
                                       0.0003277388442302623,
                                       0.0003275388845167257,
                                       0.00032733892480318915,
                                       0.0003271389650896526,
                                       0.000326939005376116,
                                       0.00032673904566257934,
                                       0.0003265390859490428,
                                       0.00032633912623550624,
                                       0.00032613916652196964,
                                       0.0003259392068084331,
                                       0.0003257392470948965,
                                       0.0003255392873813599,
                                       0.00032533932766782333,
                                       0.0003251393679542868,
                                       0.0003249394082407502,
                                       0.0003247394485272136,
                                       0.00032453948881367697,
                                       0.00032433952910014037,
                                       0.0003241395693866039,
                                       0.0003239396096730672,
                                       0.0003173531517300188,
                                       0.00031076669378697034,
                                       0.00030418023584392184,
                                       0.0002975937779008734,
                                       0.00029100731995782497,
                                       0.0002844208620147765,
                                       0.0002778344040717281,
                                       0.00027124794612867954,
                                       0.00026466148818563115,
                                       0.0002580750302425827,
                                       0.0002514885722995343,
                                       0.0002449021143564858,
                                       0.00023831565641343734,
                                       0.00023172919847038888,
                                       0.00022514274052734044,
                                       0.00021855628258429194,
                                       0.00021196982464124353,
                                       0.0002053833666981951,
                                       0.00019879690875514663,
                                       0.00019221045081209816,
                                       0.0001856239928690497,
                                       0.00017903753492600128,
                                       0.0001724510769829528,
                                       0.00016586461903990435,
                                       0.00015927816109685588,
                                       0.00015269170315380742,
                                       0.00014610524521075898,
                                       0.00013951878726771054,
                                       0.0001329323293246621]
    @test cla.frontier_values[1].sigma ≈ [0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.1590831557825158,
                                          0.15743043724229785,
                                          0.15579583731612412,
                                          0.15417993228016924,
                                          0.15258331608979134,
                                          0.15100660057809073,
                                          0.14945041560831845,
                                          0.14791540917362678,
                                          0.1464022474371825,
                                          0.14491161470520164,
                                          0.14344421332502005,
                                          0.1420007634998951,
                                          0.14058200301186022,
                                          0.13918868684363123,
                                          0.13782158669031658,
                                          0.13648149035152238,
                                          0.1351692009943951,
                                          0.13388553627822505,
                                          0.13263132733146749,
                                          0.13140741757244945,
                                          0.13021466136563706,
                                          0.1290539225061727,
                                          0.1279260725264602,
                                          0.1268319888199161,
                                          0.12577255257861206,
                                          0.12474864654343303,
                                          0.12376115256756165,
                                          0.12281094899657116,
                                          0.1218989078711527,
                                          0.12102589196149469,
                                          0.12095670995534578,
                                          0.12088758747938612,
                                          0.12081852463579064,
                                          0.12074952152687972,
                                          0.12068057825511926,
                                          0.1206116949231204,
                                          0.12054287163363955,
                                          0.12047410848957822,
                                          0.120405405593983,
                                          0.12033676305004537,
                                          0.12026818096110174,
                                          0.12019965943063313,
                                          0.12013119856226523,
                                          0.12006279845976825,
                                          0.11999445922705675,
                                          0.11992618096818966,
                                          0.11985796378736999,
                                          0.11978980778894482,
                                          0.11972171307740515,
                                          0.11965367975738578,
                                          0.11958570793366514,
                                          0.1195177977111653,
                                          0.1194499491949516,
                                          0.11938216249023277,
                                          0.11931443770236061,
                                          0.1192467749368299,
                                          0.11917917429927838,
                                          0.11911163589548635,
                                          0.11904415983137676,
                                          0.11684050529676333,
                                          0.11467403478637336,
                                          0.11254689564136605,
                                          0.1104613600811139,
                                          0.10841982895932484,
                                          0.1064248346971128,
                                          0.10447904314830368,
                                          0.10258525411676478,
                                          0.10074640021041001,
                                          0.09896554368389927,
                                          0.09724587089476981,
                                          0.09559068397942075,
                                          0.09400338935040332,
                                          0.09248748262987992,
                                          0.09104652967137158,
                                          0.08968414338848499,
                                          0.0884039562100674,
                                          0.0872095881196298,
                                          0.08610461041395068,
                                          0.08509250552909908,
                                          0.08417662352482475,
                                          0.08336013607833895,
                                          0.08264598909866756,
                                          0.08203685531109635,
                                          0.08153508835286327,
                                          0.08114268004092216,
                                          0.08086122249803367,
                                          0.0806918767390394,
                                          0.08063534911934674]

    @test cla.frontier_values[1].weights ≈ [[0.0, 0.0, 1.0, 0.0],
                                            [3.82835526e-18, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [7.65671051e-18, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [1.14850658e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [1.5313421e-17, 0.0000000e+00, 1.0000000e+00, 0.0000000e+00],
                                            [1.91417763e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [2.29701315e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [2.67984868e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [3.06268421e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [3.44551973e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [3.82835526e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [4.21119078e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [4.59402631e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [4.97686183e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [5.35969736e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [5.74253289e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [6.12536841e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [6.50820394e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [6.89103946e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [7.27387499e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [7.65671051e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [8.03954604e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [8.42238157e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [8.80521709e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [9.18805262e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [9.57088814e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [9.95372367e-17, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [1.03365592e-16, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [1.07193947e-16, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [1.11022302e-16, 0.00000000e+00, 1.00000000e+00, 0.00000000e+00],
                                            [0.0103334, 0.0, 0.9896666, 0.0],
                                            [0.02066679, 0.0, 0.97933321, 0.0],
                                            [0.03100019, 0.0, 0.96899981, 0.0],
                                            [0.04133359, 0.0, 0.95866641, 0.0],
                                            [0.05166699, 0.0, 0.94833301, 0.0],
                                            [0.06200038, 0.0, 0.93799962, 0.0],
                                            [0.07233378, 0.0, 0.92766622, 0.0],
                                            [0.08266718, 0.0, 0.91733282, 0.0],
                                            [0.09300058, 0.0, 0.90699942, 0.0],
                                            [0.10333397, 0.0, 0.89666603, 0.0],
                                            [0.11366737, 0.0, 0.88633263, 0.0],
                                            [0.12400077, 0.0, 0.87599923, 0.0],
                                            [0.13433417, 0.0, 0.86566583, 0.0],
                                            [0.14466756, 0.0, 0.85533244, 0.0],
                                            [0.15500096, 0.0, 0.84499904, 0.0],
                                            [0.16533436, 0.0, 0.83466564, 0.0],
                                            [0.17566775, 0.0, 0.82433225, 0.0],
                                            [0.18600115, 0.0, 0.81399885, 0.0],
                                            [0.19633455, 0.0, 0.80366545, 0.0],
                                            [0.20666795, 0.0, 0.79333205, 0.0],
                                            [0.21700134, 0.0, 0.78299866, 0.0],
                                            [0.22733474, 0.0, 0.77266526, 0.0],
                                            [0.23766814, 0.0, 0.76233186, 0.0],
                                            [0.24800154, 0.0, 0.75199846, 0.0],
                                            [0.25833493, 0.0, 0.74166507, 0.0],
                                            [0.26866833, 0.0, 0.73133167, 0.0],
                                            [0.27900173, 0.0, 0.72099827, 0.0],
                                            [0.28933513, 0.0, 0.71066487, 0.0],
                                            [0.29966852, 0.0, 0.70033148, 0.0],
                                            [2.99717591e-01, 4.64206904e-04, 6.99818202e-01, 0.00000000e+00],
                                            [0.29976666, 0.00092841, 0.69930493, 0.0],
                                            [0.29981573, 0.00139262, 0.69879165, 0.0],
                                            [0.2998648, 0.00185683, 0.69827838, 0.0],
                                            [0.29991386, 0.00232103, 0.6977651, 0.0],
                                            [0.29996293, 0.00278524, 0.69725183, 0.0],
                                            [0.300012, 0.00324945, 0.69673855, 0.0],
                                            [0.30006107, 0.00371366, 0.69622527, 0.0],
                                            [0.30011014, 0.00417786, 0.695712, 0.0],
                                            [0.30015921, 0.00464207, 0.69519872, 0.0],
                                            [0.30020828, 0.00510628, 0.69468545, 0.0],
                                            [0.30025734, 0.00557048, 0.69417217, 0.0],
                                            [0.30030641, 0.00603469, 0.6936589, 0.0],
                                            [0.30035548, 0.0064989, 0.69314562, 0.0],
                                            [0.30040455, 0.0069631, 0.69263235, 0.0],
                                            [0.30045362, 0.00742731, 0.69211907, 0.0],
                                            [0.30050269, 0.00789152, 0.6916058, 0.0],
                                            [0.30055175, 0.00835572, 0.69109252, 0.0],
                                            [0.30060082, 0.00881993, 0.69057925, 0.0],
                                            [0.30064989, 0.00928414, 0.69006597, 0.0],
                                            [0.30069896, 0.00974834, 0.6895527, 0.0],
                                            [0.30074803, 0.01021255, 0.68903942, 0.0],
                                            [0.3007971, 0.01067676, 0.68852615, 0.0],
                                            [0.30084616, 0.01114097, 0.68801287, 0.0],
                                            [0.30089523, 0.01160517, 0.6874996, 0.0],
                                            [0.3009443, 0.01206938, 0.68698632, 0.0],
                                            [0.30099337, 0.01253359, 0.68647304, 0.0],
                                            [0.30104244, 0.01299779, 0.68595977, 0.0],
                                            [0.30109151, 0.013462, 0.68544649, 0.0],
                                            [0.29900461, 0.02152681, 0.67070193, 0.00876664],
                                            [0.29691772, 0.02959162, 0.65595737, 0.01753329],
                                            [0.29483083, 0.03765643, 0.64121281, 0.02629993],
                                            [0.29274394, 0.04572124, 0.62646825, 0.03506658],
                                            [0.29065705, 0.05378604, 0.61172369, 0.04383322],
                                            [0.28857015, 0.06185085, 0.59697913, 0.05259987],
                                            [0.28648326, 0.06991566, 0.58223456, 0.06136651],
                                            [0.28439637, 0.07798047, 0.56749, 0.07013316],
                                            [0.28230948, 0.08604528, 0.55274544, 0.0788998],
                                            [0.28022259, 0.09411009, 0.53800088, 0.08766644],
                                            [0.2781357, 0.1021749, 0.52325632, 0.09643309],
                                            [0.2760488, 0.11023971, 0.50851176, 0.10519973],
                                            [0.27396191, 0.11830451, 0.4937672, 0.11396638],
                                            [0.27187502, 0.12636932, 0.47902263, 0.12273302],
                                            [0.26978813, 0.13443413, 0.46427807, 0.13149967],
                                            [0.26770124, 0.14249894, 0.44953351, 0.14026631],
                                            [0.26561435, 0.15056375, 0.43478895, 0.14903296],
                                            [0.26352745, 0.15862856, 0.42004439, 0.1577996],
                                            [0.26144056, 0.16669337, 0.40529983, 0.16656624],
                                            [0.25935367, 0.17475818, 0.39055526, 0.17533289],
                                            [0.25726678, 0.18282298, 0.3758107, 0.18409953],
                                            [0.25517989, 0.19088779, 0.36106614, 0.19286618],
                                            [0.25309299, 0.1989526, 0.34632158, 0.20163282],
                                            [0.2510061, 0.20701741, 0.33157702, 0.21039947],
                                            [0.24891921, 0.21508222, 0.31683246, 0.21916611],
                                            [0.24683232, 0.22314703, 0.3020879, 0.22793276],
                                            [0.24474543, 0.23121184, 0.28734333, 0.2366994],
                                            [0.24265854, 0.23927665, 0.27259877, 0.24546604],
                                            [0.24057164, 0.24734146, 0.25785421, 0.25423269]]
    @test all(sum.(cla.frontier_values[1].weights) .≈ 1)
end
